<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <meta name="description" content="Official Handbook of the No Cookie Crew" />
    <title>Unhosted 6: Controlling your server over a WebSocket</title>
    <link rel="stylesheet" href="../hljs/default.min.css" />
    <link rel="hub" href="http://pubsubhubbub.appspot.com/"/>
    <link rel="updates alternate" type="application/atom+xml" href="../feed.atom" />
    <link rel="author" type="text/html" href="https://michielbdejong.com/"/>

    <script src="../hljs/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="stylesheet" href="../adventures.css" />
  </head>

  <body>
    <article>
      <header>
        <h1>Unhosted Adventures</h1>
        <h2>Official Handbook of the No Cookie Crew</h2>
      </header>
      <h2>Episode 6: Controlling your server over a WebSocket</h2>
      <p><em><strong>No Cookie Crew  - Warning #3:</strong> This tutorial is the last time you still need to update your personal server using an
        ssh/scp client.</em></p>
        
      <h3>Adding a Dispatcher</h3>
      <p>Last week we created a single server-side script that listens for WebSocket connections and is able to send updates to both the Twitter and
        the Facebook worlds. This week we will add execution of shell commands and retrieving and saving of files from and to the server's filesystem.
        This means it is time to introduce some modularity. We will create five separate services, each of which can be updated and restarted
        independently:</p>
      <ul>
        <li>a Facebook gateway</li>
        <li>a Twitter gateway</li>
        <li>a shell server (for executing unix commands on the server)</li>
        <li>a file server (for saving and retrieving files to and from the server's filesystem)</li>
      </ul>
      <p>Each of these servers exposes a http server on a unix socket on your server. Unix sockets are slightly more efficient than TCP sockets, and
        also it is convenient for us that we can give them string names instead of having to use numeric ports. We will run a dispatcher that receives
        the actual WebSocket messages from your unhosted web apps, and checks the 'world' field in order to dispatch them to the right unix
        socket:</p><pre><code>
var sockjs = require('sockjs'),
    fs = require('fs'),
    https = require('https'),
    http = require('http'),
    config = require('./config').config;
    
function dispatch(world, reqStr, cb) {
  var sockPath = config.sockDir+world+'.sock';
  fs.exists(sockPath, function(exists) {
    if(exists) {
      var req = http.request({
        socketPath: sockPath,
        method: 'POST'
      }, function(res) {
        res.setEncoding('utf8'); 
        var resStr = '';
        res.on('data', function(chunk) {
          resStr += chunk;
        });
        res.on('end', function() {
          cb(resStr);
        });
      });
      req.end(reqStr);
    } else {
      cb(JSON.stringify({
        type: 'failure',
        error: 'world "'+world+'" does not exist'
      }));
    }
  });
}
            
var httpsServer = https.createServer({ 
  key: fs.readFileSync(config.tlsDir+'tls.key'), 
  cert: fs.readFileSync(config.tlsDir+'tls.cert'), 
  ca: fs.readFileSync(config.tlsDir+'ca.pem') 
}, function(req, res) {
  res.writeHead(200); 
  res.end('connect a WebSocket please'); 
});
httpsServer.listen(config.port);

var sockServer = sockjs.createServer();
sockServer.on('connection', function(conn) {
  conn.on('data', function(chunk) {
    var obj;
    try {
      obj = JSON.parse(chunk);
    } catch(e) {
    }
    if(typeof(obj) == 'object' && obj.secret == config.secret) {
      if(obj.world == 'ping') {
        obj.type = 'success';
        conn.write(JSON.stringify(obj));
        return;
      } else {
        dispatch(obj.world, chunk, function(resStr) {
          conn.write(resStr);
        });
        return;
      }
    }
    conn.write(JSON.stringify({
      type: 'failure',
      error: 'unparseable :'+chunk
    }));
  });
});
sockServer.installHandlers(httpsServer, {
  prefix: '/sock'
});
console.log('up');
</code></pre>

    </article>      
	
    <div class="logo">
      <img src="/img/island-color.png" />
    </div>
    
    <nav>
      <div id="episodes">
        <h4>Episodes:</h4>
        <p>(loading index)</p>
      </div>
            
      <div>
        <h4>Follow:</h4> 
        <ul>
          <li style="list-style-image: url('/img/atom.gif')"><a target="_blank" href="../feed.atom">atom</a></li>
          <li style="list-style-image: url('/img/rss2.gif')"><a target="_blank" href="../feed.rss">rss</a></li>
          <li style="list-style-image: url('/img/facebook.gif')"><a target="_blank" href="https://www.facebook.com/unhostedwebapps">facebook</a></li>
          <li style="list-style-image: url('/img/twitter.png')"><a target="_blank" href="https://twitter.com/unhosted">twitter</a></li>
          <li style="list-style-image: url('/img/statusnet.png')"><a target="_blank" href="https://identi.ca/unhosted">identica</a></li>
          <li style="list-style-image: url('/img/diaspora.png')"><a target="_blank" href="https://joindiaspora.com/u/unhosted">diaspora</a></li>
          <li style="list-style-image: url('/img/mailinglist.jpg')"><a target="_blank" href="https://groups.google.com/forum/#!forum/unhosted">mailing list</a></li>
          <li style="list-style-image: url('/img/irc.png')"><a target="_blank" href="http://webchat.freenode.net/?channels=#unhosted">irc channel</a></li>
        </ul>
      </div>
      
      <div>
        <h4>Author:</h4>
        <div class="logo">
          <img src="/img/michiel.jpg" />
        </div>
        <p>
          <a href="https://michielbdejong.com/">Michiel B. de Jong</a>
        </p>
      </div>
      
      <div>      
        <h4>Location:</h4>
        <div class="logo">
          <img src="/img/hackerbeach.png">
        </div>
        <p>
          <a href="http://hackerbeach.org/">Hacker Beach</a>
        </p>
      </div>
      
      <div>
        <h4>Unho코콘12 unconference:</h4>
        <p>
          <a class="logo" href="http://2012.unhosted.org/">
            <img src="/img/2012.png"/>
          </a>
          &nbsp;
        </p>
      </div>
      
      <div>
        <h4>Unho코콘13 unconference:</h4>
        <p>
          <a class="logo" href="http://2013.unhosted.org/">
            <img src="/img/2013.png"/>
          </a>
          &nbsp;
        </p>
      </div>
      
      <div>
        <h4>Spin-off projects:</h4>
        <p>
          <a class="logo" href="http://remotestorage.io/">
            <img src="/img/remotestorage.png"/>
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://tos-dr.info/">
            <img src="/img/tosdr.png"/>
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://opentabs.net/">
            <img src="/img/opentabs.png"/>
          </a>
          &nbsp;
        </p>
      </div>
      
      <div>
        <h4>Supporters:</h4>
        <p>
          <a class="logo" href="http://nlnet.nl/">
            <img src="/img/nlnet.gif" />
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://wauland.de/">
            <img src="/img/wau.png" />
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://www.gabrielweinberg.com/blog/2012/03/duckduckgo-foss-donations-2011.html">
            <img src="/img/duckduckgo.jpg" />
          </a>
          &nbsp;
        </p>

        <p>
          and <a href="/thankyou.html">many more</a>&hellip;
        </p>
      </div>
    </nav>
    
    <footer>
      <strong>You can follow</strong>
      <img src="/img/twitter.png" /><a target="_blank" href="https://twitter.com/unhosted">@unhosted</a>
      <strong>on twitter and in</strong>
      <a href="#">many other ways</a><strong>. So stay tuned! :)</strong>
      </strong>
    </footer>
  </body>
  <script src="../episodes.js"></script>
</html>