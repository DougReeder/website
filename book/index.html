<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8" />
    <meta name="description" content="weekly handbook about unhosted web apps" />
    <title>unhosted web apps</title>
    <link rel="stylesheet" href="./hljs/default.min.css" />
    <link rel="author" type="text/html" href="https://michielbdejong.com/"/>

    <script src="./hljs/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="stylesheet" href="./book.css" />
  </head>

  <body>
    <article>
    <div class="logo">
      <img src="./island-color.png" />
    </div>
    
      <header>
        <h1>unhosted web apps</h1>
        <h2>freedom from web 2.0's monopoly platforms</h2>
      </header>
    <nav>
      <div>

<h4>Adventures:</h4>
        <p> 1. <a href="#episode-1">intro</a></p>
        <p> 2. <a href="#episode-2">editor</a></p>
        <p> 3. <a href="#episode-3">server</a></p>
        <p> 4. <a href="#episode-4">WebSockets</a></p>
        <p> 5. <a href="#episode-5">social</a></p>
        <p> 6. <a href="#episode-6">webshell</a></p>
        <p> 7. <a href="#episode-7">remoteStorage</a></p>
        <p> 8. <a href="#episode-8">your data</a></p>
        <p> 9. <a href="#episode-9">email</a></p>
        <p> 10. <a href="#episode-10">web linking</a></p>
        <p> 11. <a href="#episode-11">app hosting</a></p>
        <p> 12. <a href="#episode-12">app discovery</a></p>
        <p> 13. <a href="#episode-13">users</a></p>
        <p> 14. <a href="#episode-14">p2p</a></p>
        <p> 15. <a href="#episode-15">unhosted oauth</a></p>
        <p> 16. <a href="#episode-16">save the web</a></p>

<h4>Decentralize:</h4>
        <p> 17. <a href="#episode-17">cryptography</a></p>
        <p> 18. <a href="#episode-18">dht</a></p>
        <p> 19. <a href="#episode-19">internet</a></p>
        <p> 20. <a href="#episode-20">identity</a></p>
        <p> 21. <a href="#episode-21">browser sessions</a></p>
        <p> 22. <a href="#episode-22">search</a></p>
        <p> 23. <a href="#episode-23">neutrality</a></p>
        <p> 24. <a href="#episode-24">federation</a></p>
        <p> 25. <a href="#episode-25">anonymity</a></p>
        <p> 26. <a href="#episode-26">reputation</a></p>

<h4>Practice:</h4>
        <p> 27. <a href="#episode-27">browser storage</a></p>
        <p> 28. <a href="#episode-28">sync</a></p>
        <p> 29. <a href="#episode-29">offline first</a></p>
        <p> 30. <a href="#episode-30">baas</a></p>
        <p> 31. <a href="#episode-31">per-user backend</a></p>
        <p> 32. <a href="#episode-32">per-user clients</a></p>
        <p> 33. <a href="#episode-33">client-side frontend</a></p>
        <p> 34. <a href="#episode-34">conclusions</a></p>
      </div>
      <div>
        <h4>Supporters:</h4>
        <p>
          <a class="logo" href="http://nlnet.nl/">
            <img src="./nlnet.png" />
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://wauland.de/">
            <img src="./wau.png" />
          </a>
          &nbsp;
        </p>

        <p>
          <a class="logo" href="http://www.gabrielweinberg.com/blog/2012/03/duckduckgo-foss-donations-2011.html">
            <img src="./duckduckgo.jpg" />
          </a>
          &nbsp;
        </p>

        <p>
          and <a href="https://unhosted.org/thankyou.html">many more</a>&hellip;
        </p>
      </div>
    </nav>
    <div style="clear:right"></div>
<div class="episode">      <h2><a name="episode-1" "id="#episode-1" href="#episode-1">1.</a> Personal servers and unhosted web apps</h2>

      <p>(<a href="http://unhosted.bencharp.com/">en Fran&#231;ais</a>)</p>
      <h3>Hosted software threatens software freedom</h3>
      <p>The Linux operating system and the Firefox browser have an important thing
        in common: they are free software products. They are, in a sense, owned by humankind
        as a whole. Both have played an important role in solving the situation
        that existed in the nineties, where it had become pretty much impossible to create or use
        software without paying tribute to the Microsoft monopoly which held everything in its grip.</p>        
      <p>The possibility to freely create, improve, share, and use software is called Software Freedom.
        <!-- actually, software freedom was originally defined as the freedom to use, study, share and improve,
        but i feel that 1) it has now become a relevant threat that we need to obey to some platform in order to
        publish apps (because of app store policies for instance), and 2) i don't necessarily feel that it is a
        right to study the software you are offered; you are free to not buy closed-source software, but offering
        it is not a crime. instead of complaining about closed software being closed source, we should get up off
        our arses, and we ourselves can create the software we want to create. That is why i replaced freedom to
        study with freedom to create here. -->
        It is very much comparable to for instance Freedom of Press. And as software becomes ever more important
        in our society, so does Software Freedom. We have come a long way since the free software movement was
        started, but in the last five or ten years, a new threat has come up: hosted software.</p>       
      <p>When you use your computer, some software runs on your computer, but you are also using software that
        runs on servers. Servers are computers just like the ones we use every day, but usually
        racked into large air-conditioned rooms, and stripped of their screen and keyboard, so their only interface
        is a network cable. Whenever you "go online", 
        your computer is communicating over the internet with one or more of these servers, which
        produce the things you see as websites.
        Unfortunately, most servers are controlled by powerful companies like Google, Facebook and Apple, and these
        companies have full control over most things that happen online.</p>
      <p>This means that even though you can run Linux
        and Firefox on your own computer, humankind is still not free to create, improve, share and use just any software.
        In almost everything we do with our computers, we have to go through the companies that control the hosted software
        that currently occupies most central parts
        of our global infrastructure. The companies themselves are not to blame for this, they are inanimate entities whose
        aim it is to make money by offering attractive products.
        What is failing are the non-commercial alternatives to their services.</p>
      
      <h3>One server per human</h3>
      <p>The solution to the control of hosted software over our infrastructure is quite simple: we have to decentralize the power.
        Just like freedom of press can be achieved by giving people the tools to print and distribute underground pamphlets, we
        can give people their freedom of software back by teaching them to control their own server.</p>        
      <p>Building an operating system like Linux, or a browser like Firefox is quite hard, and it took some of the world's best software
        engineers many years to achieve this. But building a web server which each human can choose to use for their online software needs
        is not hard at all: from an engineering perspective, it is a solved problem. The real challenge is organizational.</p>
        
      <h3>The network effect</h3>
      <p>A lot of people are actually working on software for "personal servers" like this. Many of them already have functional products. You
        can go to one of these projects right now, follow the install instructions for their personal server software, and you will have your own
        personal server, independent
        from any of the hosted software monopolies. But there are several reasons why not many people do this yet.
        They all have to do with the network effect.</p>
      <p>First, there is the spreading of effort, thinned out across many unrelated projects. But this has not stopped most of these projects
        from already publishing something that works. So let's say you choose the personal server software from project X, you install it, and run it.</p>
      <p>Then we get to the second problem: if I happen to run the software from project Y, and I now want to communicate with you, then
        this will only work if these two projects have taken the effort of making their products compatible with each other.</p>
      <p>Luckily, again, in practice most of these personal server projects are aware of this need, and cooperate to develop standard protocols
        that describe how servers should interact with each other. But these protocols often cover only a portion of the functionality that these
        personal
        servers have, and also, they often lead to a lot of discussion and alternative versions. This means that there are now effectively groups
        of personal server projects. So your server and my server no longer have to run exactly the same software
        in order to understand each other,
        but their software now has to be from the same group of projects.</p>
      <p>But the fourth problem is probably bigger than all the previous ones put together:
        since at present only early adopters run their own servers, chances are that you
        want to communicate with the majority of other people, who are (still) using the hosted software platforms from web 2.0's big monopolies.
        With the notable exception of <a href="http://friendica.com/">Friendica</a>,<!-- are they still the only exception? let me know if not! :) --> most personal server projects
        do not really provide a way to switch to them without your friends also
        switching to a server from the same group of projects.</p>
      
      <h3>Simple servers plus unhosted apps</h3>
      <p>So how can we solve all those problems? There are too many different applications to choose from, and we have reached a situation where
        choosing which application you want to use dictates, through all these manifestations of the network effect, which people you will be able
        to communicate with. The answer, or at least the answer we propose in this blog series, is to move the application out of the server,
        and into the browser.</p>
      <p>Browsers are now very powerful environments, not just for viewing web pages, but actually for running entire software applications.
        We call these "unhosted web applications", because they are not hosted on a server, yet they are still web applications, and not desktop
        applications, because they are written in html, css and javascript, and they can only run inside a browser's execution environment.</p>
        <!-- actually i should say "inside the web runtime", because there are now web runtimes for which it is no longer accurate to call them
        web browsers, but i felt that that became too complicated to explain here -->
      <p>Since we move all the application features out of the personal server and into the browser, the actual personal server becomes very
        simple. It is basically reduced to a gateway that can broker connections between unhosted web apps and the outside world. And if an incoming
        message arrives while the user is not online with any unhosted web app, it can queue it up and keep it safe until the next time the user
        connects.</p>
      <p>Unhosted web apps also lack a good place to store valuable user data, and servers are good for that. So apart from brokering our connections
        with the outside world, the server can also function as cloud storage for unhosted web apps. This makes sure your data is safe if your device
        is broken or lost, and also lets you easily synchronize data between multiple devices. We developed the
        <a href="http://remotestorage.io">remoteStorage</a> protocol for this, which we recently submitted as an IETF Internet Draft.</p>
      
      <p>The unhosted web apps we use can be independent of our personal server. They can come from any trusted source, and can be running in our browser
        without the need to choose a specific application at the time of choosing and installing the personal server software. This
        separation of concerns is what ultimately allows people to freely choose:</p>
      <ul>
        <li>Which personal server you run</li>
        <li>Which application you want to use today</li>
        <li>Who you interact with</li>
      </ul> 
    
      <h3>No Cookie Crew</h3>
      <p>This blog is the official handbook of a group of early adopters of unhosted web apps called the No Cookie Crew. We call ourselves that because
        we have disabled all cookies in our browser, including first-party cookies.
        We configure our browser to only make an exception for a handful of "second party" cookies.
        To give an example: if you publish something "on" Twitter, then Twitter acts as a third party, because they, as a
        company, are not the intended audience. But if you send a user support question to Twitter, then you are communicating "with" them, as a second
        party. Other examples of second-party interactions are online banking, online check-in at an airline website, or buying an ebook from Amazon.
        But if you are logging in to eBay to buy an electric guitar from a guitar dealer, then eBay is more a third party in that interaction.</p>
      <p>There are situations where going through a third party is unavoidable, for instance if a certain guitar dealer only sells on eBay, or a certain
        friend of yours only posts on Facebook. For each of these "worlds", we will develop application-agnostic gateway modules that we can add to our
        personal server. Usually this will require having a "puppet" account in that world, which this gateway module can control. Sometimes, it is
        necessary to use an API key before your personal server can connect to control your "puppet", but these are usually easy to obtain. To the people
        in each world, your puppet will look just like any other user account in there. But the gateway module on your personal server allows unhosted
        web apps to control it, and to "see" what it sees.</p>
      <p>In no case will we force other people to change how they communicate with us. Part of the goal of this exercise is to show that it is possible
        to completely log out of web 2.0 without having to lose contact with anybody who stays behind.</p>
      <p>To add to the fun, we also disabled Flash, Quicktime, and other proprietary plugins, and will not use any desktop apps.</p>
      <p>Whenever we have to violate these rules, we make a note of it, and try to learn from it. And before you ask, at this moment, the No Cookie Crew
        still has only one member: me. :) Logging out of web 2.0 is still pretty much a full-time occupation, because most things you do require a
        script that you have to write, upload and run first. But if that sounds like fun to you, you are very much invited to join! Otherwise, you can
        also just watch from a distance by following this blog.</p>
     
      <h3>This blog</h3>
      <p>Each blog post in this series will be written like a tutorial, including code snippets, so that you can follow along with the unhosted web apps
        and personal server tools in your own browser and on your own server. We will mainly be using nodejs on the server-side. We will publish one
        episode every Tuesday. As we build up material and discuss various topics, we will be building up the official Handbook of the No Cookie Crew.
        Hopefully, any web enthusiast, even if you haven't taken the leap yet to join
        the No Cookie Crew, will find many relevant and diverse topics discussed here, and food for thought. We will start off next week by building an
        unhosted text editor from scratch. It is the editor I am using right now to write this, and it is indeed an unhosted web app:
        it is not hosted on any server.</p>
      <p>For two years already our research on unhosted web apps is fully funded by donations from
        <a href="/thankyou.html">many awesome
          and generous people</a>, as well as several companies and foundations. This blog series is a write-up of all the
        tricks and insights we discovered so far.</p>
<p><a href="https://groups.google.com/d/topic/unhosted/L1GqArQzmSY/discussion">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-2" "id="#episode-2" href="#episode-2">2.</a> An unhosted editor</h2>

      <p>(<a href="http://unhosted.bencharp.com/page/2-editeur,2.html">en Fran&#231;ais</a>)</p>
      <p>Welcome to the second episode of Unhosted Adventures! If you log out of all websites, and close all desktop applications, putting
        your browser fullscreen, you will not be able to do many things. In order to get some work done, you will most likely need at least a
        text editor. So that is the first thing we will build. We will use <a href="http://codemirror.net/">CodeMirror</a> as the basis. This
        is a client-side text editor component, developed by Marijn Haverbeke, which can easily be embedded
        in web apps, whether hosted or unhosted. But since it requires no hosted code, it is especially useful for use in unhosted web apps.
        The following code allows you to edit javascript, html and markdown right inside your browser:</p><pre><code>
&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
  &lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;title&gt;codemirror&lt;/title&gt;
    &lt;script 
      src="http://codemirror.net/lib/codemirror.js"&gt;
    &lt;/script&gt;
    &lt;link rel="stylesheet"
      href="http://codemirror.net/lib/codemirror.css" /&gt;

    &lt;script
      src="http://codemirror.net/mode/xml/xml.js"&gt;
    &lt;/script&gt;
    &lt;script 
      src="http://codemirror.net/mode/javascript/javascript.js"&gt;
    &lt;/script&gt;
    &lt;script 
      src="http://codemirror.net/mode/css/css.js"&gt;
    &lt;/script&gt;
    &lt;script 
      src="http://codemirror.net/mode/htmlmixed/htmlmixed.js"&gt;
    &lt;/script&gt;
    &lt;script 
      src="http://codemirror.net/mode/markdown/markdown.js"&gt;
    &lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id="editor"&gt;&lt;/div&gt;
    &lt;div&gt;
      &lt;input type="submit" value="js" 
        onclick="myCodeMirror.setOption('mode', 'javascript');"&gt;
      &lt;input type="submit" value="html" 
        onclick="myCodeMirror.setOption('mode', 'htmlmixed');"&gt;
      &lt;input type="submit" value="markdown" 
        onclick="myCodeMirror.setOption('mode', 'markdown');"&gt;
    &lt;/div&gt;
  &lt;/body&gt;
  &lt;script&gt;
    var myCodeMirror = CodeMirror(
      document.getElementById('editor'),
      { lineNumbers: true }
    );
  &lt;/script&gt;
&lt;/html&gt;
</code></pre>  
      <p>Funny fact is, I wrote this example without having an editor. The way I did it was to visit example.com, and then open the web console
        and type</p><pre><code>
document.body.innerHTML = ''
</code></pre>
      <p>to clear the screen. That way I could use the console to add code to the page, and bootstrap myself
        into my first editor, which I could then save to a file with "Save Page As" from the "File" menu.
        Once I had it displaying a CodeMirror component, I could start using that to type in, and from there write more
        editor versions and then other things. But since I already went through that first bootstrap phase, you don't have to and can simply use this
        <a href="data:text/html;charset=utf-8,%3C!DOCTYPE%20html%3E%20%3Chtml%20lang%3D%22en%22%3E%20%3Chead%3E%20%3Cmeta%20charset%3D%22utf-8%22%3E%20%3Ctitle%3Ecodemirror%3C%2Ftitle%3E%20%3Cscript%20src%3D%22http%3A%2F%2Fcodemirror.net%2Flib%2Fcodemirror.js%22%3E%20%3C%2Fscript%3E%20%3Clink%20rel%3D%22stylesheet%22%20href%3D%22http%3A%2F%2Fcodemirror.net%2Flib%2Fcodemirror.css%22%20%2F%3E%20%3Cscript%20src%3D%22http%3A%2F%2Fcodemirror.net%2Fmode%2Fxml%2Fxml.js%22%3E%20%3C%2Fscript%3E%20%3Cscript%20src%3D%22http%3A%2F%2Fcodemirror.net%2Fmode%2Fjavascript%2Fjavascript.js%22%3E%20%3C%2Fscript%3E%20%3Cscript%20src%3D%22http%3A%2F%2Fcodemirror.net%2Fmode%2Fcss%2Fcss.js%22%3E%20%3C%2Fscript%3E%20%3Cscript%20src%3D%22http%3A%2F%2Fcodemirror.net%2Fmode%2Fhtmlmixed%2Fhtmlmixed.js%22%3E%20%3C%2Fscript%3E%20%3Cscript%20src%3D%22http%3A%2F%2Fcodemirror.net%2Fmode%2Fmarkdown%2Fmarkdown.js%22%3E%20%3C%2Fscript%3E%20%3C%2Fhead%3E%20%3Cbody%3E%20%3Cdiv%20id%3D%22editor%22%3E%3C%2Fdiv%3E%20%3Cdiv%3E%20%3Cinput%20type%3D%22submit%22%20value%3D%22js%22%20onclick%3D%22myCodeMirror.setOption('mode'%2C%20'javascript')%3B%22%3E%20%3Cinput%20type%3D%22submit%22%20value%3D%22html%22%20onclick%3D%22myCodeMirror.setOption('mode'%2C%20'htmlmixed')%3B%22%3E%20%3Cinput%20type%3D%22submit%22%20value%3D%22markdown%22%20onclick%3D%22myCodeMirror.setOption('mode'%2C%20'markdown')%3B%22%3E%20%3C%2Fdiv%3E%20%3C%2Fbody%3E%20%3Cscript%3E%20var%20myCodeMirror%20%3D%20CodeMirror(%20document.getElementById('editor')%2C%20%7B%20lineNumbers%3A%20true%20%7D)%3B%20%3C%2Fscript%3E%20%3C%2Fhtml%3E"
        target="_blank">data url</a> (in Firefox you may have to click the small "shield" icon to unblock the content). Type some markdown or javascript in there to try out what the different syntax
        highlightings look like. You can bookmark this data URL, or click 'Save Page As...' from the 'File' menu of your browser.
        Then you can browse to your device's file system by typing "file:///" into
        the address bar, and clicking through the directories until you find the file you saved. To view the source code, 
        an easy trick is to replace the first part of the data URL:</p><pre><code>
data:text/html;charset=utf-8,
</code></pre>  
      <p>with:</p><pre><code>
data:text/plain;charset=utf-8,
</code></pre>
      <p>Also fun is opening the web console while viewing the editor (Ctrl-Shift-K, Cmd-Alt-K, Ctrl-Shift-I, or Cmd-Alt-I
       depending on your OS and browser), and pasting the following line in there:</p><pre><code>
myCodeMirror.setValue(decodeURIComponent(location.href
  .substring('data:text/html;charset=utf-8,'.length)));
</code></pre>
      <p>This will decode the data URL and load the editor into itself. Now you can edit your editor. :) To update it, use the "opposite" line,
        which will take you to the new version you just created:</p><pre><code>
location.href = 'data:text/html;charset=utf-8,'
  + encodeURIComponent(myCodeMirror.getValue());
</code></pre>
      <p>Try it, by adding some text at the end of the document body and executing that second line. After that you can execute the first line again
        to load
        your modified version of the editor back into itself (use the up-arrow to see your command history in the web console).</p>
      <p>The next step is to add some buttons to make loading and saving the files you edit from and to the local filesystem easier. For that, we add
        the following code into the document body:</p><pre><code>
&lt;input type="file" onchange="localLoad(this.files);" />
&lt;input type="submit" value="save" 
      onclick="window.open(localSave());">
</code></pre>
      <p>And we add the following functions to the script tag at the end:</p><pre><code>
//LOCAL
function localSave() {
  return 'data:text/plain;charset=utf-8,'
    + encodeURIComponent(myCodeMirror.getValue());
}
    
function localLoad(files) {
  if (files.length === 1) {
    document.title = escape(files[0].name);
    var reader = new FileReader();
    reader.onload = function(e) {
      myCodeMirror.setValue(e.target.result);
    };
    reader.readAsText(files[0]);
  }
}
</code></pre>
      <p>The 'localLoad' code is copied from MDN; you should also check out the
        <a href="http://www.html5rocks.com/en/tutorials/file/dndfiles/">html5rocks tutorial</a>, which describes how you can add nice drag-and-drop.
        But since I use no desktop applications, I usually have Firefox fullscreen and have no other place to drag any items from, so that
        is useless in my case.</p>
      <p>The 'save' button is not ideal. It opens the editor contents in a new window so that you can save it with "Save Page As...", but that dialog then is
        not prefilled with
        the file path to which you saved the file the last time, and also it asks you to confirm if you really want to replace the file, and you
        need to close the
        extra window again, meaning saving the current file takes five clicks instead of one. But it is the best I could get working. The reason
        the window.open()
        call is in the button element and not in a function as it would normally be, is that popup blockers may block that if it is too deep in
        the call stack.</p>
      <p><strong>UPDATE:</strong> nowadays, you can use the <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/a">download attribute</a> to do this in a much nicer way. At the time of writing, that still only existed as a Chrome feature; it arrived in Firefox in spring 2013. Thanks to <a href="https://groups.google.com/d/msg/unhosted/ANz3ofSyfmc/BkeL6sL7Mf8J">Felix</a> for pointing this out!</p>
      <p>You may have noticed that these examples include some js and css files from http://codemirror.net/ which don't load if you have no network
        connection. So here is the full code of this tutorial, with all the CodeMirror files copied into it from version 2.34: 
        <a href="data:text/html;charset=utf-8,%3C!DOCTYPE%20html%20lang%3D%22en%22%3E%0A%3Chtml%3E%0A%20%20%3Chead%3E%0A%20%20%20%20%3Cmeta%20charset%3D%22utf-8%22%3E%0A%20%20%20%20%3Ctitle%3Ecodemirror%3C%2Ftitle%3E%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%3C!--%20http%3A%2F%2Fcodemirror.net%2Flib%2Fcodemirror.js%20--%3E%3Cscript%3E%0A%2F%2F%20CodeMirror%20version%202.34%0A%0A%2F%2F%20All%20functions%20that%20need%20access%20to%20the%20editor's%20state%20live%20inside%0A%2F%2F%20the%20CodeMirror%20function.%20Below%20that%2C%20at%20the%20bottom%20of%20the%20file%2C%0A%2F%2F%20some%20utilities%20are%20defined.%0A%0A%2F%2F%20CodeMirror%20is%20the%20only%20global%20var%20we%20claim%0Awindow.CodeMirror%20%3D%20(function()%20%7B%0A%20%20%22use%20strict%22%3B%0A%20%20%2F%2F%20This%20is%20the%20function%20that%20produces%20an%20editor%20instance.%20Its%0A%20%20%2F%2F%20closure%20is%20used%20to%20store%20the%20editor%20state.%0A%20%20function%20CodeMirror(place%2C%20givenOptions)%20%7B%0A%20%20%20%20%2F%2F%20Determine%20effective%20options%20based%20on%20given%20values%20and%20defaults.%0A%20%20%20%20var%20options%20%3D%20%7B%7D%2C%20defaults%20%3D%20CodeMirror.defaults%3B%0A%20%20%20%20for%20(var%20opt%20in%20defaults)%0A%20%20%20%20%20%20if%20(defaults.hasOwnProperty(opt))%0A%20%20%20%20%20%20%20%20options%5Bopt%5D%20%3D%20(givenOptions%20%26%26%20givenOptions.hasOwnProperty(opt)%20%3F%20givenOptions%20%3A%20defaults)%5Bopt%5D%3B%0A%0A%20%20%20%20var%20input%20%3D%20elt(%22textarea%22%2C%20null%2C%20null%2C%20%22position%3A%20absolute%3B%20padding%3A%200%3B%20width%3A%201px%3B%20height%3A%201em%22)%3B%0A%20%20%20%20input.setAttribute(%22wrap%22%2C%20%22off%22)%3B%20input.setAttribute(%22autocorrect%22%2C%20%22off%22)%3B%20input.setAttribute(%22autocapitalize%22%2C%20%22off%22)%3B%0A%20%20%20%20%2F%2F%20Wraps%20and%20hides%20input%20textarea%0A%20%20%20%20var%20inputDiv%20%3D%20elt(%22div%22%2C%20%5Binput%5D%2C%20null%2C%20%22overflow%3A%20hidden%3B%20position%3A%20relative%3B%20width%3A%203px%3B%20height%3A%200px%3B%22)%3B%0A%20%20%20%20%2F%2F%20The%20empty%20scrollbar%20content%2C%20used%20solely%20for%20managing%20the%20scrollbar%20thumb.%0A%20%20%20%20var%20scrollbarInner%20%3D%20elt(%22div%22%2C%20null%2C%20%22CodeMirror-scrollbar-inner%22)%3B%0A%20%20%20%20%2F%2F%20The%20vertical%20scrollbar.%20Horizontal%20scrolling%20is%20handled%20by%20the%20scroller%20itself.%0A%20%20%20%20var%20scrollbar%20%3D%20elt(%22div%22%2C%20%5BscrollbarInner%5D%2C%20%22CodeMirror-scrollbar%22)%3B%0A%20%20%20%20%2F%2F%20DIVs%20containing%20the%20selection%20and%20the%20actual%20code%0A%20%20%20%20var%20lineDiv%20%3D%20elt(%22div%22)%2C%20selectionDiv%20%3D%20elt(%22div%22%2C%20null%2C%20null%2C%20%22position%3A%20relative%3B%20z-index%3A%20-1%22)%3B%0A%20%20%20%20%2F%2F%20Blinky%20cursor%2C%20and%20element%20used%20to%20ensure%20cursor%20fits%20at%20the%20end%20of%20a%20line%0A%20%20%20%20var%20cursor%20%3D%20elt(%22pre%22%2C%20%22%5Cu00a0%22%2C%20%22CodeMirror-cursor%22)%2C%20widthForcer%20%3D%20elt(%22pre%22%2C%20%22%5Cu00a0%22%2C%20%22CodeMirror-cursor%22%2C%20%22visibility%3A%20hidden%22)%3B%0A%20%20%20%20%2F%2F%20Used%20to%20measure%20text%20size%0A%20%20%20%20var%20measure%20%3D%20elt(%22div%22%2C%20null%2C%20null%2C%20%22position%3A%20absolute%3B%20width%3A%20100%25%3B%20height%3A%200px%3B%20overflow%3A%20hidden%3B%20visibility%3A%20hidden%3B%22)%3B%0A%20%20%20%20var%20lineSpace%20%3D%20elt(%22div%22%2C%20%5Bmeasure%2C%20cursor%2C%20widthForcer%2C%20selectionDiv%2C%20lineDiv%5D%2C%20null%2C%20%22position%3A%20relative%3B%20z-index%3A%200%22)%3B%0A%20%20%20%20var%20gutterText%20%3D%20elt(%22div%22%2C%20null%2C%20%22CodeMirror-gutter-text%22)%2C%20gutter%20%3D%20elt(%22div%22%2C%20%5BgutterText%5D%2C%20%22CodeMirror-gutter%22)%3B%0A%20%20%20%20%2F%2F%20Moved%20around%20its%20parent%20to%20cover%20visible%20view%0A%20%20%20%20var%20mover%20%3D%20elt(%22div%22%2C%20%5Bgutter%2C%20elt(%22div%22%2C%20%5BlineSpace%5D%2C%20%22CodeMirror-lines%22)%5D%2C%20null%2C%20%22position%3A%20relative%22)%3B%0A%20%20%20%20%2F%2F%20Set%20to%20the%20height%20of%20the%20text%2C%20causes%20scrolling%0A%20%20%20%20var%20sizer%20%3D%20elt(%22div%22%2C%20%5Bmover%5D%2C%20null%2C%20%22position%3A%20relative%22)%3B%0A%20%20%20%20%2F%2F%20Provides%20scrolling%0A%20%20%20%20var%20scroller%20%3D%20elt(%22div%22%2C%20%5Bsizer%5D%2C%20%22CodeMirror-scroll%22)%3B%0A%20%20%20%20scroller.setAttribute(%22tabIndex%22%2C%20%22-1%22)%3B%0A%20%20%20%20%2F%2F%20The%20element%20in%20which%20the%20editor%20lives.%0A%20%20%20%20var%20wrapper%20%3D%20elt(%22div%22%2C%20%5BinputDiv%2C%20scrollbar%2C%20scroller%5D%2C%20%22CodeMirror%22%20%2B%20(options.lineWrapping%20%3F%20%22%20CodeMirror-wrap%22%20%3A%20%22%22))%3B%0A%20%20%20%20if%20(place.appendChild)%20place.appendChild(wrapper)%3B%20else%20place(wrapper)%3B%0A%0A%20%20%20%20themeChanged()%3B%20keyMapChanged()%3B%0A%20%20%20%20%2F%2F%20Needed%20to%20hide%20big%20blue%20blinking%20cursor%20on%20Mobile%20Safari%0A%20%20%20%20if%20(ios)%20input.style.width%20%3D%20%220px%22%3B%0A%20%20%20%20if%20(!webkit)%20scroller.draggable%20%3D%20true%3B%0A%20%20%20%20lineSpace.style.outline%20%3D%20%22none%22%3B%0A%20%20%20%20if%20(options.tabindex%20!%3D%20null)%20input.tabIndex%20%3D%20options.tabindex%3B%0A%20%20%20%20if%20(options.autofocus)%20focusInput()%3B%0A%20%20%20%20if%20(!options.gutter%20%26%26%20!options.lineNumbers)%20gutter.style.display%20%3D%20%22none%22%3B%0A%20%20%20%20%2F%2F%20Needed%20to%20handle%20Tab%20key%20in%20KHTML%0A%20%20%20%20if%20(khtml)%20inputDiv.style.height%20%3D%20%221px%22%2C%20inputDiv.style.position%20%3D%20%22absolute%22%3B%0A%0A%20%20%20%20%2F%2F%20Check%20for%20OS%20X%20%3E%3D%2010.7.%20This%20has%20transparent%20scrollbars%2C%20so%20the%0A%20%20%20%20%2F%2F%20overlaying%20of%20one%20scrollbar%20with%20another%20won't%20work.%20This%20is%20a%0A%20%20%20%20%2F%2F%20temporary%20hack%20to%20simply%20turn%20off%20the%20overlay%20scrollbar.%20See%0A%20%20%20%20%2F%2F%20issue%20%23727.%0A%20%20%20%20if%20(mac_geLion)%20%7B%20scrollbar.style.zIndex%20%3D%20-2%3B%20scrollbar.style.visibility%20%3D%20%22hidden%22%3B%20%7D%0A%20%20%20%20%2F%2F%20Need%20to%20set%20a%20minimum%20width%20to%20see%20the%20scrollbar%20on%20IE7%20(but%20must%20not%20set%20it%20on%20IE8).%0A%20%20%20%20else%20if%20(ie_lt8)%20scrollbar.style.minWidth%20%3D%20%2218px%22%3B%0A%0A%20%20%20%20%2F%2F%20Delayed%20object%20wrap%20timeouts%2C%20making%20sure%20only%20one%20is%20active.%20blinker%20holds%20an%20interval.%0A%20%20%20%20var%20poll%20%3D%20new%20Delayed()%2C%20highlight%20%3D%20new%20Delayed()%2C%20blinker%3B%0A%0A%20%20%20%20%2F%2F%20mode%20holds%20a%20mode%20API%20object.%20doc%20is%20the%20tree%20of%20Line%20objects%2C%0A%20%20%20%20%2F%2F%20frontier%20is%20the%20point%20up%20to%20which%20the%20content%20has%20been%20parsed%2C%0A%20%20%20%20%2F%2F%20and%20history%20the%20undo%20history%20(instance%20of%20History%20constructor).%0A%20%20%20%20var%20mode%2C%20doc%20%3D%20new%20BranchChunk(%5Bnew%20LeafChunk(%5Bnew%20Line(%22%22)%5D)%5D)%2C%20frontier%20%3D%200%2C%20focused%3B%0A%20%20%20%20loadMode()%3B%0A%20%20%20%20%2F%2F%20The%20selection.%20These%20are%20always%20maintained%20to%20point%20at%20valid%0A%20%20%20%20%2F%2F%20positions.%20Inverted%20is%20used%20to%20remember%20that%20the%20user%20is%0A%20%20%20%20%2F%2F%20selecting%20bottom-to-top.%0A%20%20%20%20var%20sel%20%3D%20%7Bfrom%3A%20%7Bline%3A%200%2C%20ch%3A%200%7D%2C%20to%3A%20%7Bline%3A%200%2C%20ch%3A%200%7D%2C%20inverted%3A%20false%7D%3B%0A%20%20%20%20%2F%2F%20Selection-related%20flags.%20shiftSelecting%20obviously%20tracks%0A%20%20%20%20%2F%2F%20whether%20the%20user%20is%20holding%20shift.%0A%20%20%20%20var%20shiftSelecting%2C%20lastClick%2C%20lastDoubleClick%2C%20lastScrollTop%20%3D%200%2C%20draggingText%2C%0A%20%20%20%20%20%20%20%20overwrite%20%3D%20false%2C%20suppressEdits%20%3D%20false%3B%0A%20%20%20%20%2F%2F%20Variables%20used%20by%20startOperation%2FendOperation%20to%20track%20what%0A%20%20%20%20%2F%2F%20happened%20during%20the%20operation.%0A%20%20%20%20var%20updateInput%2C%20userSelChange%2C%20changes%2C%20textChanged%2C%20selectionChanged%2C%0A%20%20%20%20%20%20%20%20gutterDirty%2C%20callbacks%3B%0A%20%20%20%20%2F%2F%20Current%20visible%20range%20(may%20be%20bigger%20than%20the%20view%20window).%0A%20%20%20%20var%20displayOffset%20%3D%200%2C%20showingFrom%20%3D%200%2C%20showingTo%20%3D%200%2C%20lastSizeC%20%3D%200%3B%0A%20%20%20%20%2F%2F%20bracketHighlighted%20is%20used%20to%20remember%20that%20a%20bracket%20has%20been%0A%20%20%20%20%2F%2F%20marked.%0A%20%20%20%20var%20bracketHighlighted%3B%0A%20%20%20%20%2F%2F%20Tracks%20the%20maximum%20line%20length%20so%20that%20the%20horizontal%20scrollbar%0A%20%20%20%20%2F%2F%20can%20be%20kept%20static%20when%20scrolling.%0A%20%20%20%20var%20maxLine%20%3D%20getLine(0)%2C%20updateMaxLine%20%3D%20false%2C%20maxLineChanged%20%3D%20true%3B%0A%20%20%20%20var%20pollingFast%20%3D%20false%3B%20%2F%2F%20Ensures%20slowPoll%20doesn't%20cancel%20fastPoll%0A%20%20%20%20var%20goalColumn%20%3D%20null%3B%0A%0A%20%20%20%20%2F%2F%20Initialize%20the%20content.%0A%20%20%20%20operation(function()%7BsetValue(options.value%20%7C%7C%20%22%22)%3B%20updateInput%20%3D%20false%3B%7D)()%3B%0A%20%20%20%20var%20history%20%3D%20new%20History()%3B%0A%0A%20%20%20%20%2F%2F%20Register%20our%20event%20handlers.%0A%20%20%20%20connect(scroller%2C%20%22mousedown%22%2C%20operation(onMouseDown))%3B%0A%20%20%20%20connect(scroller%2C%20%22dblclick%22%2C%20operation(onDoubleClick))%3B%0A%20%20%20%20connect(lineSpace%2C%20%22selectstart%22%2C%20e_preventDefault)%3B%0A%20%20%20%20%2F%2F%20Gecko%20browsers%20fire%20contextmenu%20*after*%20opening%20the%20menu%2C%20at%0A%20%20%20%20%2F%2F%20which%20point%20we%20can't%20mess%20with%20it%20anymore.%20Context%20menu%20is%0A%20%20%20%20%2F%2F%20handled%20in%20onMouseDown%20for%20Gecko.%0A%20%20%20%20if%20(!gecko)%20connect(scroller%2C%20%22contextmenu%22%2C%20onContextMenu)%3B%0A%20%20%20%20connect(scroller%2C%20%22scroll%22%2C%20onScrollMain)%3B%0A%20%20%20%20connect(scrollbar%2C%20%22scroll%22%2C%20onScrollBar)%3B%0A%20%20%20%20connect(scrollbar%2C%20%22mousedown%22%2C%20function()%20%7Bif%20(focused)%20setTimeout(focusInput%2C%200)%3B%7D)%3B%0A%20%20%20%20var%20resizeHandler%20%3D%20connect(window%2C%20%22resize%22%2C%20function()%20%7B%0A%20%20%20%20%20%20if%20(wrapper.parentNode)%20updateDisplay(true)%3B%0A%20%20%20%20%20%20else%20resizeHandler()%3B%0A%20%20%20%20%7D%2C%20true)%3B%0A%20%20%20%20connect(input%2C%20%22keyup%22%2C%20operation(onKeyUp))%3B%0A%20%20%20%20connect(input%2C%20%22input%22%2C%20fastPoll)%3B%0A%20%20%20%20connect(input%2C%20%22keydown%22%2C%20operation(onKeyDown))%3B%0A%20%20%20%20connect(input%2C%20%22keypress%22%2C%20operation(onKeyPress))%3B%0A%20%20%20%20connect(input%2C%20%22focus%22%2C%20onFocus)%3B%0A%20%20%20%20connect(input%2C%20%22blur%22%2C%20onBlur)%3B%0A%0A%20%20%20%20function%20drag_(e)%20%7B%0A%20%20%20%20%20%20if%20(options.onDragEvent%20%26%26%20options.onDragEvent(instance%2C%20addStop(e)))%20return%3B%0A%20%20%20%20%20%20e_stop(e)%3B%0A%20%20%20%20%7D%0A%20%20%20%20if%20(options.dragDrop)%20%7B%0A%20%20%20%20%20%20connect(scroller%2C%20%22dragstart%22%2C%20onDragStart)%3B%0A%20%20%20%20%20%20connect(scroller%2C%20%22dragenter%22%2C%20drag_)%3B%0A%20%20%20%20%20%20connect(scroller%2C%20%22dragover%22%2C%20drag_)%3B%0A%20%20%20%20%20%20connect(scroller%2C%20%22drop%22%2C%20operation(onDrop))%3B%0A%20%20%20%20%7D%0A%20%20%20%20connect(scroller%2C%20%22paste%22%2C%20function()%7BfocusInput()%3B%20fastPoll()%3B%7D)%3B%0A%20%20%20%20connect(input%2C%20%22paste%22%2C%20fastPoll)%3B%0A%20%20%20%20connect(input%2C%20%22cut%22%2C%20operation(function()%7B%0A%20%20%20%20%20%20if%20(!options.readOnly)%20replaceSelection(%22%22)%3B%0A%20%20%20%20%7D))%3B%0A%0A%20%20%20%20%2F%2F%20Needed%20to%20handle%20Tab%20key%20in%20KHTML%0A%20%20%20%20if%20(khtml)%20connect(sizer%2C%20%22mouseup%22%2C%20function()%20%7B%0A%20%20%20%20%20%20%20%20if%20(document.activeElement%20%3D%3D%20input)%20input.blur()%3B%0A%20%20%20%20%20%20%20%20focusInput()%3B%0A%20%20%20%20%7D)%3B%0A%0A%20%20%20%20%2F%2F%20IE%20throws%20unspecified%20error%20in%20certain%20cases%2C%20when%0A%20%20%20%20%2F%2F%20trying%20to%20access%20activeElement%20before%20onload%0A%20%20%20%20var%20hasFocus%3B%20try%20%7B%20hasFocus%20%3D%20(document.activeElement%20%3D%3D%20input)%3B%20%7D%20catch(e)%20%7B%20%7D%0A%20%20%20%20if%20(hasFocus%20%7C%7C%20options.autofocus)%20setTimeout(onFocus%2C%2020)%3B%0A%20%20%20%20else%20onBlur()%3B%0A%0A%20%20%20%20function%20isLine(l)%20%7Breturn%20l%20%3E%3D%200%20%26%26%20l%20%3C%20doc.size%3B%7D%0A%20%20%20%20%2F%2F%20The%20instance%20object%20that%20we'll%20return.%20Mostly%20calls%20out%20to%0A%20%20%20%20%2F%2F%20local%20functions%20in%20the%20CodeMirror%20function.%20Some%20do%20some%20extra%0A%20%20%20%20%2F%2F%20range%20checking%20and%2For%20clipping.%20operation%20is%20used%20to%20wrap%20the%0A%20%20%20%20%2F%2F%20call%20so%20that%20changes%20it%20makes%20are%20tracked%2C%20and%20the%20display%20is%0A%20%20%20%20%2F%2F%20updated%20afterwards.%0A%20%20%20%20var%20instance%20%3D%20wrapper.CodeMirror%20%3D%20%7B%0A%20%20%20%20%20%20getValue%3A%20getValue%2C%0A%20%20%20%20%20%20setValue%3A%20operation(setValue)%2C%0A%20%20%20%20%20%20getSelection%3A%20getSelection%2C%0A%20%20%20%20%20%20replaceSelection%3A%20operation(replaceSelection)%2C%0A%20%20%20%20%20%20focus%3A%20function()%7Bwindow.focus()%3B%20focusInput()%3B%20onFocus()%3B%20fastPoll()%3B%7D%2C%0A%20%20%20%20%20%20setOption%3A%20function(option%2C%20value)%20%7B%0A%20%20%20%20%20%20%20%20var%20oldVal%20%3D%20options%5Boption%5D%3B%0A%20%20%20%20%20%20%20%20options%5Boption%5D%20%3D%20value%3B%0A%20%20%20%20%20%20%20%20if%20(option%20%3D%3D%20%22mode%22%20%7C%7C%20option%20%3D%3D%20%22indentUnit%22)%20loadMode()%3B%0A%20%20%20%20%20%20%20%20else%20if%20(option%20%3D%3D%20%22readOnly%22%20%26%26%20value%20%3D%3D%20%22nocursor%22)%20%7BonBlur()%3B%20input.blur()%3B%7D%0A%20%20%20%20%20%20%20%20else%20if%20(option%20%3D%3D%20%22readOnly%22%20%26%26%20!value)%20%7BresetInput(true)%3B%7D%0A%20%20%20%20%20%20%20%20else%20if%20(option%20%3D%3D%20%22theme%22)%20themeChanged()%3B%0A%20%20%20%20%20%20%20%20else%20if%20(option%20%3D%3D%20%22lineWrapping%22%20%26%26%20oldVal%20!%3D%20value)%20operation(wrappingChanged)()%3B%0A%20%20%20%20%20%20%20%20else%20if%20(option%20%3D%3D%20%22tabSize%22)%20updateDisplay(true)%3B%0A%20%20%20%20%20%20%20%20else%20if%20(option%20%3D%3D%20%22keyMap%22)%20keyMapChanged()%3B%0A%20%20%20%20%20%20%20%20if%20(option%20%3D%3D%20%22lineNumbers%22%20%7C%7C%20option%20%3D%3D%20%22gutter%22%20%7C%7C%20option%20%3D%3D%20%22firstLineNumber%22%20%7C%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20option%20%3D%3D%20%22theme%22%20%7C%7C%20option%20%3D%3D%20%22lineNumberFormatter%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20gutterChanged()%3B%0A%20%20%20%20%20%20%20%20%20%20updateDisplay(true)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20getOption%3A%20function(option)%20%7Breturn%20options%5Boption%5D%3B%7D%2C%0A%20%20%20%20%20%20getMode%3A%20function()%20%7Breturn%20mode%3B%7D%2C%0A%20%20%20%20%20%20undo%3A%20operation(undo)%2C%0A%20%20%20%20%20%20redo%3A%20operation(redo)%2C%0A%20%20%20%20%20%20indentLine%3A%20operation(function(n%2C%20dir)%20%7B%0A%20%20%20%20%20%20%20%20if%20(typeof%20dir%20!%3D%20%22string%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(dir%20%3D%3D%20null)%20dir%20%3D%20options.smartIndent%20%3F%20%22smart%22%20%3A%20%22prev%22%3B%0A%20%20%20%20%20%20%20%20%20%20else%20dir%20%3D%20dir%20%3F%20%22add%22%20%3A%20%22subtract%22%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20if%20(isLine(n))%20indentLine(n%2C%20dir)%3B%0A%20%20%20%20%20%20%7D)%2C%0A%20%20%20%20%20%20indentSelection%3A%20operation(indentSelected)%2C%0A%20%20%20%20%20%20historySize%3A%20function()%20%7Breturn%20%7Bundo%3A%20history.done.length%2C%20redo%3A%20history.undone.length%7D%3B%7D%2C%0A%20%20%20%20%20%20clearHistory%3A%20function()%20%7Bhistory%20%3D%20new%20History()%3B%7D%2C%0A%20%20%20%20%20%20setHistory%3A%20function(histData)%20%7B%0A%20%20%20%20%20%20%20%20history%20%3D%20new%20History()%3B%0A%20%20%20%20%20%20%20%20history.done%20%3D%20histData.done%3B%0A%20%20%20%20%20%20%20%20history.undone%20%3D%20histData.undone%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20getHistory%3A%20function()%20%7B%0A%20%20%20%20%20%20%20%20function%20cp(arr)%20%7B%0A%20%20%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20nw%20%3D%20%5B%5D%2C%20nwelt%3B%20i%20%3C%20arr.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20nw.push(nwelt%20%3D%20%5B%5D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20(var%20j%20%3D%200%2C%20elt%20%3D%20arr%5Bi%5D%3B%20j%20%3C%20elt.length%3B%20%2B%2Bj)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20old%20%3D%20%5B%5D%2C%20cur%20%3D%20elt%5Bj%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20nwelt.push(%7Bstart%3A%20cur.start%2C%20added%3A%20cur.added%2C%20old%3A%20old%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20(var%20k%20%3D%200%3B%20k%20%3C%20cur.old.length%3B%20%2B%2Bk)%20old.push(hlText(cur.old%5Bk%5D))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20return%20nw%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20return%20%7Bdone%3A%20cp(history.done)%2C%20undone%3A%20cp(history.undone)%7D%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20matchBrackets%3A%20operation(function()%7BmatchBrackets(true)%3B%7D)%2C%0A%20%20%20%20%20%20getTokenAt%3A%20operation(function(pos)%20%7B%0A%20%20%20%20%20%20%20%20pos%20%3D%20clipPos(pos)%3B%0A%20%20%20%20%20%20%20%20return%20getLine(pos.line).getTokenAt(mode%2C%20getStateBefore(pos.line)%2C%20options.tabSize%2C%20pos.ch)%3B%0A%20%20%20%20%20%20%7D)%2C%0A%20%20%20%20%20%20getStateAfter%3A%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20line%20%3D%20clipLine(line%20%3D%3D%20null%20%3F%20doc.size%20-%201%3A%20line)%3B%0A%20%20%20%20%20%20%20%20return%20getStateBefore(line%20%2B%201)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20cursorCoords%3A%20function(start%2C%20mode)%20%7B%0A%20%20%20%20%20%20%20%20if%20(start%20%3D%3D%20null)%20start%20%3D%20sel.inverted%3B%0A%20%20%20%20%20%20%20%20return%20this.charCoords(start%20%3F%20sel.from%20%3A%20sel.to%2C%20mode)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20charCoords%3A%20function(pos%2C%20mode)%20%7B%0A%20%20%20%20%20%20%20%20pos%20%3D%20clipPos(pos)%3B%0A%20%20%20%20%20%20%20%20if%20(mode%20%3D%3D%20%22local%22)%20return%20localCoords(pos%2C%20false)%3B%0A%20%20%20%20%20%20%20%20if%20(mode%20%3D%3D%20%22div%22)%20return%20localCoords(pos%2C%20true)%3B%0A%20%20%20%20%20%20%20%20return%20pageCoords(pos)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20coordsChar%3A%20function(coords)%20%7B%0A%20%20%20%20%20%20%20%20var%20off%20%3D%20eltOffset(lineSpace)%3B%0A%20%20%20%20%20%20%20%20return%20coordsChar(coords.x%20-%20off.left%2C%20coords.y%20-%20off.top)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20markText%3A%20operation(markText)%2C%0A%20%20%20%20%20%20setBookmark%3A%20setBookmark%2C%0A%20%20%20%20%20%20findMarksAt%3A%20findMarksAt%2C%0A%20%20%20%20%20%20setMarker%3A%20operation(addGutterMarker)%2C%0A%20%20%20%20%20%20clearMarker%3A%20operation(removeGutterMarker)%2C%0A%20%20%20%20%20%20setLineClass%3A%20operation(setLineClass)%2C%0A%20%20%20%20%20%20hideLine%3A%20operation(function(h)%20%7Breturn%20setLineHidden(h%2C%20true)%3B%7D)%2C%0A%20%20%20%20%20%20showLine%3A%20operation(function(h)%20%7Breturn%20setLineHidden(h%2C%20false)%3B%7D)%2C%0A%20%20%20%20%20%20onDeleteLine%3A%20function(line%2C%20f)%20%7B%0A%20%20%20%20%20%20%20%20if%20(typeof%20line%20%3D%3D%20%22number%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(!isLine(line))%20return%20null%3B%0A%20%20%20%20%20%20%20%20%20%20line%20%3D%20getLine(line)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20(line.handlers%20%7C%7C%20(line.handlers%20%3D%20%5B%5D)).push(f)%3B%0A%20%20%20%20%20%20%20%20return%20line%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20lineInfo%3A%20lineInfo%2C%0A%20%20%20%20%20%20getViewport%3A%20function()%20%7B%20return%20%7Bfrom%3A%20showingFrom%2C%20to%3A%20showingTo%7D%3B%7D%2C%0A%20%20%20%20%20%20addWidget%3A%20function(pos%2C%20node%2C%20scroll%2C%20vert%2C%20horiz)%20%7B%0A%20%20%20%20%20%20%20%20pos%20%3D%20localCoords(clipPos(pos))%3B%0A%20%20%20%20%20%20%20%20var%20top%20%3D%20pos.yBot%2C%20left%20%3D%20pos.x%3B%0A%20%20%20%20%20%20%20%20node.style.position%20%3D%20%22absolute%22%3B%0A%20%20%20%20%20%20%20%20sizer.appendChild(node)%3B%0A%20%20%20%20%20%20%20%20if%20(vert%20%3D%3D%20%22over%22)%20top%20%3D%20pos.y%3B%0A%20%20%20%20%20%20%20%20else%20if%20(vert%20%3D%3D%20%22near%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20vspace%20%3D%20Math.max(scroller.offsetHeight%2C%20doc.height%20*%20textHeight())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20hspace%20%3D%20Math.max(sizer.clientWidth%2C%20lineSpace.clientWidth)%20-%20paddingLeft()%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(pos.yBot%20%2B%20node.offsetHeight%20%3E%20vspace%20%26%26%20pos.y%20%3E%20node.offsetHeight)%0A%20%20%20%20%20%20%20%20%20%20%20%20top%20%3D%20pos.y%20-%20node.offsetHeight%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(left%20%2B%20node.offsetWidth%20%3E%20hspace)%0A%20%20%20%20%20%20%20%20%20%20%20%20left%20%3D%20hspace%20-%20node.offsetWidth%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20node.style.top%20%3D%20(top%20%2B%20paddingTop())%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20node.style.left%20%3D%20node.style.right%20%3D%20%22%22%3B%0A%20%20%20%20%20%20%20%20if%20(horiz%20%3D%3D%20%22right%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20left%20%3D%20sizer.clientWidth%20-%20node.offsetWidth%3B%0A%20%20%20%20%20%20%20%20%20%20node.style.right%20%3D%20%220px%22%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(horiz%20%3D%3D%20%22left%22)%20left%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%20%20else%20if%20(horiz%20%3D%3D%20%22middle%22)%20left%20%3D%20(sizer.clientWidth%20-%20node.offsetWidth)%20%2F%202%3B%0A%20%20%20%20%20%20%20%20%20%20node.style.left%20%3D%20(left%20%2B%20paddingLeft())%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20if%20(scroll)%0A%20%20%20%20%20%20%20%20%20%20scrollIntoView(left%2C%20top%2C%20left%20%2B%20node.offsetWidth%2C%20top%20%2B%20node.offsetHeight)%3B%0A%20%20%20%20%20%20%7D%2C%0A%0A%20%20%20%20%20%20lineCount%3A%20function()%20%7Breturn%20doc.size%3B%7D%2C%0A%20%20%20%20%20%20clipPos%3A%20clipPos%2C%0A%20%20%20%20%20%20getCursor%3A%20function(start)%20%7B%0A%20%20%20%20%20%20%20%20if%20(start%20%3D%3D%20null)%20start%20%3D%20sel.inverted%3B%0A%20%20%20%20%20%20%20%20return%20copyPos(start%20%3F%20sel.from%20%3A%20sel.to)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20somethingSelected%3A%20function()%20%7Breturn%20!posEq(sel.from%2C%20sel.to)%3B%7D%2C%0A%20%20%20%20%20%20setCursor%3A%20operation(function(line%2C%20ch%2C%20user)%20%7B%0A%20%20%20%20%20%20%20%20if%20(ch%20%3D%3D%20null%20%26%26%20typeof%20line.line%20%3D%3D%20%22number%22)%20setCursor(line.line%2C%20line.ch%2C%20user)%3B%0A%20%20%20%20%20%20%20%20else%20setCursor(line%2C%20ch%2C%20user)%3B%0A%20%20%20%20%20%20%7D)%2C%0A%20%20%20%20%20%20setSelection%3A%20operation(function(from%2C%20to%2C%20user)%20%7B%0A%20%20%20%20%20%20%20%20(user%20%3F%20setSelectionUser%20%3A%20setSelection)(clipPos(from)%2C%20clipPos(to%20%7C%7C%20from))%3B%0A%20%20%20%20%20%20%7D)%2C%0A%20%20%20%20%20%20getLine%3A%20function(line)%20%7Bif%20(isLine(line))%20return%20getLine(line).text%3B%7D%2C%0A%20%20%20%20%20%20getLineHandle%3A%20function(line)%20%7Bif%20(isLine(line))%20return%20getLine(line)%3B%7D%2C%0A%20%20%20%20%20%20setLine%3A%20operation(function(line%2C%20text)%20%7B%0A%20%20%20%20%20%20%20%20if%20(isLine(line))%20replaceRange(text%2C%20%7Bline%3A%20line%2C%20ch%3A%200%7D%2C%20%7Bline%3A%20line%2C%20ch%3A%20getLine(line).text.length%7D)%3B%0A%20%20%20%20%20%20%7D)%2C%0A%20%20%20%20%20%20removeLine%3A%20operation(function(line)%20%7B%0A%20%20%20%20%20%20%20%20if%20(isLine(line))%20replaceRange(%22%22%2C%20%7Bline%3A%20line%2C%20ch%3A%200%7D%2C%20clipPos(%7Bline%3A%20line%2B1%2C%20ch%3A%200%7D))%3B%0A%20%20%20%20%20%20%7D)%2C%0A%20%20%20%20%20%20replaceRange%3A%20operation(replaceRange)%2C%0A%20%20%20%20%20%20getRange%3A%20function(from%2C%20to%2C%20lineSep)%20%7Breturn%20getRange(clipPos(from)%2C%20clipPos(to)%2C%20lineSep)%3B%7D%2C%0A%0A%20%20%20%20%20%20triggerOnKeyDown%3A%20operation(onKeyDown)%2C%0A%20%20%20%20%20%20execCommand%3A%20function(cmd)%20%7Breturn%20commands%5Bcmd%5D(instance)%3B%7D%2C%0A%20%20%20%20%20%20%2F%2F%20Stuff%20used%20by%20commands%2C%20probably%20not%20much%20use%20to%20outside%20code.%0A%20%20%20%20%20%20moveH%3A%20operation(moveH)%2C%0A%20%20%20%20%20%20deleteH%3A%20operation(deleteH)%2C%0A%20%20%20%20%20%20moveV%3A%20operation(moveV)%2C%0A%20%20%20%20%20%20toggleOverwrite%3A%20function()%20%7B%0A%20%20%20%20%20%20%20%20if(overwrite)%7B%0A%20%20%20%20%20%20%20%20%20%20overwrite%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20cursor.className%20%3D%20cursor.className.replace(%22%20CodeMirror-overwrite%22%2C%20%22%22)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20overwrite%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%20%20cursor.className%20%2B%3D%20%22%20CodeMirror-overwrite%22%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%2C%0A%0A%20%20%20%20%20%20posFromIndex%3A%20function(off)%20%7B%0A%20%20%20%20%20%20%20%20var%20lineNo%20%3D%200%2C%20ch%3B%0A%20%20%20%20%20%20%20%20doc.iter(0%2C%20doc.size%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20sz%20%3D%20line.text.length%20%2B%201%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(sz%20%3E%20off)%20%7B%20ch%20%3D%20off%3B%20return%20true%3B%20%7D%0A%20%20%20%20%20%20%20%20%20%20off%20-%3D%20sz%3B%0A%20%20%20%20%20%20%20%20%20%20%2B%2BlineNo%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20return%20clipPos(%7Bline%3A%20lineNo%2C%20ch%3A%20ch%7D)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20indexFromPos%3A%20function%20(coords)%20%7B%0A%20%20%20%20%20%20%20%20if%20(coords.line%20%3C%200%20%7C%7C%20coords.ch%20%3C%200)%20return%200%3B%0A%20%20%20%20%20%20%20%20var%20index%20%3D%20coords.ch%3B%0A%20%20%20%20%20%20%20%20doc.iter(0%2C%20coords.line%2C%20function%20(line)%20%7B%0A%20%20%20%20%20%20%20%20%20%20index%20%2B%3D%20line.text.length%20%2B%201%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20return%20index%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20scrollTo%3A%20function(x%2C%20y)%20%7B%0A%20%20%20%20%20%20%20%20if%20(x%20!%3D%20null)%20scroller.scrollLeft%20%3D%20x%3B%0A%20%20%20%20%20%20%20%20if%20(y%20!%3D%20null)%20scrollbar.scrollTop%20%3D%20scroller.scrollTop%20%3D%20y%3B%0A%20%20%20%20%20%20%20%20updateDisplay(%5B%5D)%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20getScrollInfo%3A%20function()%20%7B%0A%20%20%20%20%20%20%20%20return%20%7Bx%3A%20scroller.scrollLeft%2C%20y%3A%20scrollbar.scrollTop%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20height%3A%20scrollbar.scrollHeight%2C%20width%3A%20scroller.scrollWidth%7D%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20setSize%3A%20function(width%2C%20height)%20%7B%0A%20%20%20%20%20%20%20%20function%20interpret(val)%20%7B%0A%20%20%20%20%20%20%20%20%20%20val%20%3D%20String(val)%3B%0A%20%20%20%20%20%20%20%20%20%20return%20%2F%5E%5Cd%2B%24%2F.test(val)%20%3F%20val%20%2B%20%22px%22%20%3A%20val%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20if%20(width%20!%3D%20null)%20wrapper.style.width%20%3D%20interpret(width)%3B%0A%20%20%20%20%20%20%20%20if%20(height%20!%3D%20null)%20scroller.style.height%20%3D%20interpret(height)%3B%0A%20%20%20%20%20%20%20%20instance.refresh()%3B%0A%20%20%20%20%20%20%7D%2C%0A%0A%20%20%20%20%20%20operation%3A%20function(f)%7Breturn%20operation(f)()%3B%7D%2C%0A%20%20%20%20%20%20compoundChange%3A%20function(f)%7Breturn%20compoundChange(f)%3B%7D%2C%0A%20%20%20%20%20%20refresh%3A%20function()%7B%0A%20%20%20%20%20%20%20%20updateDisplay(true%2C%20null%2C%20lastScrollTop)%3B%0A%20%20%20%20%20%20%20%20if%20(scrollbar.scrollHeight%20%3E%20lastScrollTop)%0A%20%20%20%20%20%20%20%20%20%20scrollbar.scrollTop%20%3D%20lastScrollTop%3B%0A%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20getInputField%3A%20function()%7Breturn%20input%3B%7D%2C%0A%20%20%20%20%20%20getWrapperElement%3A%20function()%7Breturn%20wrapper%3B%7D%2C%0A%20%20%20%20%20%20getScrollerElement%3A%20function()%7Breturn%20scroller%3B%7D%2C%0A%20%20%20%20%20%20getGutterElement%3A%20function()%7Breturn%20gutter%3B%7D%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20function%20getLine(n)%20%7B%20return%20getLineAt(doc%2C%20n)%3B%20%7D%0A%20%20%20%20function%20updateLineHeight(line%2C%20height)%20%7B%0A%20%20%20%20%20%20gutterDirty%20%3D%20true%3B%0A%20%20%20%20%20%20var%20diff%20%3D%20height%20-%20line.height%3B%0A%20%20%20%20%20%20for%20(var%20n%20%3D%20line%3B%20n%3B%20n%20%3D%20n.parent)%20n.height%20%2B%3D%20diff%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20lineContent(line%2C%20wrapAt)%20%7B%0A%20%20%20%20%20%20if%20(!line.styles)%0A%20%20%20%20%20%20%20%20line.highlight(mode%2C%20line.stateAfter%20%3D%20getStateBefore(lineNo(line))%2C%20options.tabSize)%3B%0A%20%20%20%20%20%20return%20line.getContent(options.tabSize%2C%20wrapAt%2C%20options.lineWrapping)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20setValue(code)%20%7B%0A%20%20%20%20%20%20var%20top%20%3D%20%7Bline%3A%200%2C%20ch%3A%200%7D%3B%0A%20%20%20%20%20%20updateLines(top%2C%20%7Bline%3A%20doc.size%20-%201%2C%20ch%3A%20getLine(doc.size-1).text.length%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20splitLines(code)%2C%20top%2C%20top)%3B%0A%20%20%20%20%20%20updateInput%20%3D%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20getValue(lineSep)%20%7B%0A%20%20%20%20%20%20var%20text%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20doc.iter(0%2C%20doc.size%2C%20function(line)%20%7B%20text.push(line.text)%3B%20%7D)%3B%0A%20%20%20%20%20%20return%20text.join(lineSep%20%7C%7C%20%22%5Cn%22)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20onScrollBar(e)%20%7B%0A%20%20%20%20%20%20if%20(scrollbar.scrollTop%20!%3D%20lastScrollTop)%20%7B%0A%20%20%20%20%20%20%20%20lastScrollTop%20%3D%20scroller.scrollTop%20%3D%20scrollbar.scrollTop%3B%0A%20%20%20%20%20%20%20%20updateDisplay(%5B%5D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20onScrollMain(e)%20%7B%0A%20%20%20%20%20%20if%20(options.fixedGutter%20%26%26%20gutter.style.left%20!%3D%20scroller.scrollLeft%20%2B%20%22px%22)%0A%20%20%20%20%20%20%20%20gutter.style.left%20%3D%20scroller.scrollLeft%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20if%20(scroller.scrollTop%20!%3D%20lastScrollTop)%20%7B%0A%20%20%20%20%20%20%20%20lastScrollTop%20%3D%20scroller.scrollTop%3B%0A%20%20%20%20%20%20%20%20if%20(scrollbar.scrollTop%20!%3D%20lastScrollTop)%0A%20%20%20%20%20%20%20%20%20%20scrollbar.scrollTop%20%3D%20lastScrollTop%3B%0A%20%20%20%20%20%20%20%20updateDisplay(%5B%5D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(options.onScroll)%20options.onScroll(instance)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20onMouseDown(e)%20%7B%0A%20%20%20%20%20%20setShift(e_prop(e%2C%20%22shiftKey%22))%3B%0A%20%20%20%20%20%20%2F%2F%20Check%20whether%20this%20is%20a%20click%20in%20a%20widget%0A%20%20%20%20%20%20for%20(var%20n%20%3D%20e_target(e)%3B%20n%20!%3D%20wrapper%3B%20n%20%3D%20n.parentNode)%0A%20%20%20%20%20%20%20%20if%20(n.parentNode%20%3D%3D%20sizer%20%26%26%20n%20!%3D%20mover)%20return%3B%0A%0A%20%20%20%20%20%20%2F%2F%20See%20if%20this%20is%20a%20click%20in%20the%20gutter%0A%20%20%20%20%20%20for%20(var%20n%20%3D%20e_target(e)%3B%20n%20!%3D%20wrapper%3B%20n%20%3D%20n.parentNode)%0A%20%20%20%20%20%20%20%20if%20(n.parentNode%20%3D%3D%20gutterText)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(options.onGutterClick)%0A%20%20%20%20%20%20%20%20%20%20%20%20options.onGutterClick(instance%2C%20indexOf(gutterText.childNodes%2C%20n)%20%2B%20showingFrom%2C%20e)%3B%0A%20%20%20%20%20%20%20%20%20%20return%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20var%20start%20%3D%20posFromMouse(e)%3B%0A%0A%20%20%20%20%20%20switch%20(e_button(e))%20%7B%0A%20%20%20%20%20%20case%203%3A%0A%20%20%20%20%20%20%20%20if%20(gecko)%20onContextMenu(e)%3B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20case%202%3A%0A%20%20%20%20%20%20%20%20if%20(start)%20setCursor(start.line%2C%20start.ch%2C%20true)%3B%0A%20%20%20%20%20%20%20%20setTimeout(focusInput%2C%2020)%3B%0A%20%20%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%2F%2F%20For%20button%201%2C%20if%20it%20was%20clicked%20inside%20the%20editor%0A%20%20%20%20%20%20%2F%2F%20(posFromMouse%20returning%20non-null)%2C%20we%20have%20to%20adjust%20the%0A%20%20%20%20%20%20%2F%2F%20selection.%0A%20%20%20%20%20%20if%20(!start)%20%7Bif%20(e_target(e)%20%3D%3D%20scroller)%20e_preventDefault(e)%3B%20return%3B%7D%0A%0A%20%20%20%20%20%20if%20(!focused)%20onFocus()%3B%0A%0A%20%20%20%20%20%20var%20now%20%3D%20%2Bnew%20Date%2C%20type%20%3D%20%22single%22%3B%0A%20%20%20%20%20%20if%20(lastDoubleClick%20%26%26%20lastDoubleClick.time%20%3E%20now%20-%20400%20%26%26%20posEq(lastDoubleClick.pos%2C%20start))%20%7B%0A%20%20%20%20%20%20%20%20type%20%3D%20%22triple%22%3B%0A%20%20%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20%20%20setTimeout(focusInput%2C%2020)%3B%0A%20%20%20%20%20%20%20%20selectLine(start.line)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(lastClick%20%26%26%20lastClick.time%20%3E%20now%20-%20400%20%26%26%20posEq(lastClick.pos%2C%20start))%20%7B%0A%20%20%20%20%20%20%20%20type%20%3D%20%22double%22%3B%0A%20%20%20%20%20%20%20%20lastDoubleClick%20%3D%20%7Btime%3A%20now%2C%20pos%3A%20start%7D%3B%0A%20%20%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20%20%20var%20word%20%3D%20findWordAt(start)%3B%0A%20%20%20%20%20%20%20%20setSelectionUser(word.from%2C%20word.to)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%20lastClick%20%3D%20%7Btime%3A%20now%2C%20pos%3A%20start%7D%3B%20%7D%0A%0A%20%20%20%20%20%20function%20dragEnd(e2)%20%7B%0A%20%20%20%20%20%20%20%20if%20(webkit)%20scroller.draggable%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20draggingText%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20up()%3B%20drop()%3B%0A%20%20%20%20%20%20%20%20if%20(Math.abs(e.clientX%20-%20e2.clientX)%20%2B%20Math.abs(e.clientY%20-%20e2.clientY)%20%3C%2010)%20%7B%0A%20%20%20%20%20%20%20%20%20%20e_preventDefault(e2)%3B%0A%20%20%20%20%20%20%20%20%20%20setCursor(start.line%2C%20start.ch%2C%20true)%3B%0A%20%20%20%20%20%20%20%20%20%20focusInput()%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20last%20%3D%20start%2C%20going%3B%0A%20%20%20%20%20%20if%20(options.dragDrop%20%26%26%20dragAndDrop%20%26%26%20!options.readOnly%20%26%26%20!posEq(sel.from%2C%20sel.to)%20%26%26%0A%20%20%20%20%20%20%20%20%20%20!posLess(start%2C%20sel.from)%20%26%26%20!posLess(sel.to%2C%20start)%20%26%26%20type%20%3D%3D%20%22single%22)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20Let%20the%20drag%20handler%20handle%20this.%0A%20%20%20%20%20%20%20%20if%20(webkit)%20scroller.draggable%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20var%20up%20%3D%20connect(document%2C%20%22mouseup%22%2C%20operation(dragEnd)%2C%20true)%3B%0A%20%20%20%20%20%20%20%20var%20drop%20%3D%20connect(scroller%2C%20%22drop%22%2C%20operation(dragEnd)%2C%20true)%3B%0A%20%20%20%20%20%20%20%20draggingText%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%2F%2F%20IE's%20approach%20to%20draggable%0A%20%20%20%20%20%20%20%20if%20(scroller.dragDrop)%20scroller.dragDrop()%3B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20%22single%22)%20setCursor(start.line%2C%20start.ch%2C%20true)%3B%0A%0A%20%20%20%20%20%20var%20startstart%20%3D%20sel.from%2C%20startend%20%3D%20sel.to%3B%0A%0A%20%20%20%20%20%20function%20doSelect(cur)%20%7B%0A%20%20%20%20%20%20%20%20if%20(type%20%3D%3D%20%22single%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20setSelectionUser(start%2C%20cur)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%20%22double%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20word%20%3D%20findWordAt(cur)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(posLess(cur%2C%20startstart))%20setSelectionUser(word.from%2C%20startend)%3B%0A%20%20%20%20%20%20%20%20%20%20else%20setSelectionUser(startstart%2C%20word.to)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%20%22triple%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(posLess(cur%2C%20startstart))%20setSelectionUser(startend%2C%20clipPos(%7Bline%3A%20cur.line%2C%20ch%3A%200%7D))%3B%0A%20%20%20%20%20%20%20%20%20%20else%20setSelectionUser(startstart%2C%20clipPos(%7Bline%3A%20cur.line%20%2B%201%2C%20ch%3A%200%7D))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20function%20extend(e)%20%7B%0A%20%20%20%20%20%20%20%20var%20cur%20%3D%20posFromMouse(e%2C%20true)%3B%0A%20%20%20%20%20%20%20%20if%20(cur%20%26%26%20!posEq(cur%2C%20last))%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(!focused)%20onFocus()%3B%0A%20%20%20%20%20%20%20%20%20%20last%20%3D%20cur%3B%0A%20%20%20%20%20%20%20%20%20%20doSelect(cur)%3B%0A%20%20%20%20%20%20%20%20%20%20updateInput%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20var%20visible%20%3D%20visibleLines()%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(cur.line%20%3E%3D%20visible.to%20%7C%7C%20cur.line%20%3C%20visible.from)%0A%20%20%20%20%20%20%20%20%20%20%20%20going%20%3D%20setTimeout(operation(function()%7Bextend(e)%3B%7D)%2C%20150)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20function%20done(e)%20%7B%0A%20%20%20%20%20%20%20%20clearTimeout(going)%3B%0A%20%20%20%20%20%20%20%20var%20cur%20%3D%20posFromMouse(e)%3B%0A%20%20%20%20%20%20%20%20if%20(cur)%20doSelect(cur)%3B%0A%20%20%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20%20%20focusInput()%3B%0A%20%20%20%20%20%20%20%20updateInput%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20move()%3B%20up()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20move%20%3D%20connect(document%2C%20%22mousemove%22%2C%20operation(function(e)%20%7B%0A%20%20%20%20%20%20%20%20clearTimeout(going)%3B%0A%20%20%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20%20%20if%20(!ie%20%26%26%20!e_button(e))%20done(e)%3B%0A%20%20%20%20%20%20%20%20else%20extend(e)%3B%0A%20%20%20%20%20%20%7D)%2C%20true)%3B%0A%20%20%20%20%20%20var%20up%20%3D%20connect(document%2C%20%22mouseup%22%2C%20operation(done)%2C%20true)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20onDoubleClick(e)%20%7B%0A%20%20%20%20%20%20for%20(var%20n%20%3D%20e_target(e)%3B%20n%20!%3D%20wrapper%3B%20n%20%3D%20n.parentNode)%0A%20%20%20%20%20%20%20%20if%20(n.parentNode%20%3D%3D%20gutterText)%20return%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20onDrop(e)%20%7B%0A%20%20%20%20%20%20if%20(options.onDragEvent%20%26%26%20options.onDragEvent(instance%2C%20addStop(e)))%20return%3B%0A%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20var%20pos%20%3D%20posFromMouse(e%2C%20true)%2C%20files%20%3D%20e.dataTransfer.files%3B%0A%20%20%20%20%20%20if%20(!pos%20%7C%7C%20options.readOnly)%20return%3B%0A%20%20%20%20%20%20if%20(files%20%26%26%20files.length%20%26%26%20window.FileReader%20%26%26%20window.File)%20%7B%0A%20%20%20%20%20%20%20%20var%20n%20%3D%20files.length%2C%20text%20%3D%20Array(n)%2C%20read%20%3D%200%3B%0A%20%20%20%20%20%20%20%20var%20loadFile%20%3D%20function(file%2C%20i)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20reader%20%3D%20new%20FileReader%3B%0A%20%20%20%20%20%20%20%20%20%20reader.onload%20%3D%20function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20text%5Bi%5D%20%3D%20reader.result%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(%2B%2Bread%20%3D%3D%20n)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20pos%20%3D%20clipPos(pos)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20operation(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20end%20%3D%20replaceRange(text.join(%22%22)%2C%20pos%2C%20pos)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20setSelectionUser(pos%2C%20end)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%20%20%20%20reader.readAsText(file)%3B%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20n%3B%20%2B%2Bi)%20loadFile(files%5Bi%5D%2C%20i)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20Don't%20do%20a%20replace%20if%20the%20drop%20happened%20inside%20of%20the%20selected%20text.%0A%20%20%20%20%20%20%20%20if%20(draggingText%20%26%26%20!(posLess(pos%2C%20sel.from)%20%7C%7C%20posLess(sel.to%2C%20pos)))%20return%3B%0A%20%20%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20text%20%3D%20e.dataTransfer.getData(%22Text%22)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(text)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20compoundChange(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20curFrom%20%3D%20sel.from%2C%20curTo%20%3D%20sel.to%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20setSelectionUser(pos%2C%20pos)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(draggingText)%20replaceRange(%22%22%2C%20curFrom%2C%20curTo)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20replaceSelection(text)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20focusInput()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20catch(e)%7B%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20function%20onDragStart(e)%20%7B%0A%20%20%20%20%20%20var%20txt%20%3D%20getSelection()%3B%0A%20%20%20%20%20%20e.dataTransfer.setData(%22Text%22%2C%20txt)%3B%0A%0A%20%20%20%20%20%20%2F%2F%20Use%20dummy%20image%20instead%20of%20default%20browsers%20image.%0A%20%20%20%20%20%20if%20(e.dataTransfer.setDragImage)%0A%20%20%20%20%20%20%20%20e.dataTransfer.setDragImage(elt('img')%2C%200%2C%200)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20doHandleBinding(bound%2C%20dropShift)%20%7B%0A%20%20%20%20%20%20if%20(typeof%20bound%20%3D%3D%20%22string%22)%20%7B%0A%20%20%20%20%20%20%20%20bound%20%3D%20commands%5Bbound%5D%3B%0A%20%20%20%20%20%20%20%20if%20(!bound)%20return%20false%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20prevShift%20%3D%20shiftSelecting%3B%0A%20%20%20%20%20%20try%20%7B%0A%20%20%20%20%20%20%20%20if%20(options.readOnly)%20suppressEdits%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20if%20(dropShift)%20shiftSelecting%20%3D%20null%3B%0A%20%20%20%20%20%20%20%20bound(instance)%3B%0A%20%20%20%20%20%20%7D%20catch(e)%20%7B%0A%20%20%20%20%20%20%20%20if%20(e%20!%3D%20Pass)%20throw%20e%3B%0A%20%20%20%20%20%20%20%20return%20false%3B%0A%20%20%20%20%20%20%7D%20finally%20%7B%0A%20%20%20%20%20%20%20%20shiftSelecting%20%3D%20prevShift%3B%0A%20%20%20%20%20%20%20%20suppressEdits%20%3D%20false%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20var%20maybeTransition%3B%0A%20%20%20%20function%20handleKeyBinding(e)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Handle%20auto%20keymap%20transitions%0A%20%20%20%20%20%20var%20startMap%20%3D%20getKeyMap(options.keyMap)%2C%20next%20%3D%20startMap.auto%3B%0A%20%20%20%20%20%20clearTimeout(maybeTransition)%3B%0A%20%20%20%20%20%20if%20(next%20%26%26%20!isModifierKey(e))%20maybeTransition%20%3D%20setTimeout(function()%20%7B%0A%20%20%20%20%20%20%20%20if%20(getKeyMap(options.keyMap)%20%3D%3D%20startMap)%20%7B%0A%20%20%20%20%20%20%20%20%20%20options.keyMap%20%3D%20(next.call%20%3F%20next.call(null%2C%20instance)%20%3A%20next)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%2C%2050)%3B%0A%0A%20%20%20%20%20%20var%20name%20%3D%20keyNames%5Be_prop(e%2C%20%22keyCode%22)%5D%2C%20handled%20%3D%20false%3B%0A%20%20%20%20%20%20var%20flipCtrlCmd%20%3D%20opera%20%26%26%20mac%3B%0A%20%20%20%20%20%20if%20(name%20%3D%3D%20null%20%7C%7C%20e.altGraphKey)%20return%20false%3B%0A%20%20%20%20%20%20if%20(e_prop(e%2C%20%22altKey%22))%20name%20%3D%20%22Alt-%22%20%2B%20name%3B%0A%20%20%20%20%20%20if%20(e_prop(e%2C%20flipCtrlCmd%20%3F%20%22metaKey%22%20%3A%20%22ctrlKey%22))%20name%20%3D%20%22Ctrl-%22%20%2B%20name%3B%0A%20%20%20%20%20%20if%20(e_prop(e%2C%20flipCtrlCmd%20%3F%20%22ctrlKey%22%20%3A%20%22metaKey%22))%20name%20%3D%20%22Cmd-%22%20%2B%20name%3B%0A%0A%20%20%20%20%20%20var%20stopped%20%3D%20false%3B%0A%20%20%20%20%20%20function%20stop()%20%7B%20stopped%20%3D%20true%3B%20%7D%0A%0A%20%20%20%20%20%20if%20(e_prop(e%2C%20%22shiftKey%22))%20%7B%0A%20%20%20%20%20%20%20%20handled%20%3D%20lookupKey(%22Shift-%22%20%2B%20name%2C%20options.extraKeys%2C%20options.keyMap%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20function(b)%20%7Breturn%20doHandleBinding(b%2C%20true)%3B%7D%2C%20stop)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7C%7C%20lookupKey(name%2C%20options.extraKeys%2C%20options.keyMap%2C%20function(b)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(typeof%20b%20%3D%3D%20%22string%22%20%26%26%20%2F%5Ego%5BA-Z%5D%2F.test(b))%20return%20doHandleBinding(b)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%20stop)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20handled%20%3D%20lookupKey(name%2C%20options.extraKeys%2C%20options.keyMap%2C%20doHandleBinding%2C%20stop)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(stopped)%20handled%20%3D%20false%3B%0A%20%20%20%20%20%20if%20(handled)%20%7B%0A%20%20%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20%20%20restartBlink()%3B%0A%20%20%20%20%20%20%20%20if%20(ie)%20%7B%20e.oldKeyCode%20%3D%20e.keyCode%3B%20e.keyCode%20%3D%200%3B%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20handled%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20handleCharBinding(e%2C%20ch)%20%7B%0A%20%20%20%20%20%20var%20handled%20%3D%20lookupKey(%22'%22%20%2B%20ch%20%2B%20%22'%22%2C%20options.extraKeys%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20options.keyMap%2C%20function(b)%20%7B%20return%20doHandleBinding(b%2C%20true)%3B%20%7D)%3B%0A%20%20%20%20%20%20if%20(handled)%20%7B%0A%20%20%20%20%20%20%20%20e_preventDefault(e)%3B%0A%20%20%20%20%20%20%20%20restartBlink()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20handled%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20var%20lastStoppedKey%20%3D%20null%3B%0A%20%20%20%20function%20onKeyDown(e)%20%7B%0A%20%20%20%20%20%20if%20(!focused)%20onFocus()%3B%0A%20%20%20%20%20%20if%20(ie%20%26%26%20e.keyCode%20%3D%3D%2027)%20%7B%20e.returnValue%20%3D%20false%3B%20%7D%0A%20%20%20%20%20%20if%20(pollingFast)%20%7B%20if%20(readInput())%20pollingFast%20%3D%20false%3B%20%7D%0A%20%20%20%20%20%20if%20(options.onKeyEvent%20%26%26%20options.onKeyEvent(instance%2C%20addStop(e)))%20return%3B%0A%20%20%20%20%20%20var%20code%20%3D%20e_prop(e%2C%20%22keyCode%22)%3B%0A%20%20%20%20%20%20%2F%2F%20IE%20does%20strange%20things%20with%20escape.%0A%20%20%20%20%20%20setShift(code%20%3D%3D%2016%20%7C%7C%20e_prop(e%2C%20%22shiftKey%22))%3B%0A%20%20%20%20%20%20%2F%2F%20First%20give%20onKeyEvent%20option%20a%20chance%20to%20handle%20this.%0A%20%20%20%20%20%20var%20handled%20%3D%20handleKeyBinding(e)%3B%0A%20%20%20%20%20%20if%20(opera)%20%7B%0A%20%20%20%20%20%20%20%20lastStoppedKey%20%3D%20handled%20%3F%20code%20%3A%20null%3B%0A%20%20%20%20%20%20%20%20%2F%2F%20Opera%20has%20no%20cut%20event...%20we%20try%20to%20at%20least%20catch%20the%20key%20combo%0A%20%20%20%20%20%20%20%20if%20(!handled%20%26%26%20code%20%3D%3D%2088%20%26%26%20e_prop(e%2C%20mac%20%3F%20%22metaKey%22%20%3A%20%22ctrlKey%22))%0A%20%20%20%20%20%20%20%20%20%20replaceSelection(%22%22)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20function%20onKeyPress(e)%20%7B%0A%20%20%20%20%20%20if%20(pollingFast)%20readInput()%3B%0A%20%20%20%20%20%20if%20(options.onKeyEvent%20%26%26%20options.onKeyEvent(instance%2C%20addStop(e)))%20return%3B%0A%20%20%20%20%20%20var%20keyCode%20%3D%20e_prop(e%2C%20%22keyCode%22)%2C%20charCode%20%3D%20e_prop(e%2C%20%22charCode%22)%3B%0A%20%20%20%20%20%20if%20(opera%20%26%26%20keyCode%20%3D%3D%20lastStoppedKey)%20%7BlastStoppedKey%20%3D%20null%3B%20e_preventDefault(e)%3B%20return%3B%7D%0A%20%20%20%20%20%20if%20(((opera%20%26%26%20(!e.which%20%7C%7C%20e.which%20%3C%2010))%20%7C%7C%20khtml)%20%26%26%20handleKeyBinding(e))%20return%3B%0A%20%20%20%20%20%20var%20ch%20%3D%20String.fromCharCode(charCode%20%3D%3D%20null%20%3F%20keyCode%20%3A%20charCode)%3B%0A%20%20%20%20%20%20if%20(options.electricChars%20%26%26%20mode.electricChars%20%26%26%20options.smartIndent%20%26%26%20!options.readOnly)%20%7B%0A%20%20%20%20%20%20%20%20if%20(mode.electricChars.indexOf(ch)%20%3E%20-1)%0A%20%20%20%20%20%20%20%20%20%20setTimeout(operation(function()%20%7BindentLine(sel.to.line%2C%20%22smart%22)%3B%7D)%2C%2075)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(handleCharBinding(e%2C%20ch))%20return%3B%0A%20%20%20%20%20%20fastPoll()%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20onKeyUp(e)%20%7B%0A%20%20%20%20%20%20if%20(options.onKeyEvent%20%26%26%20options.onKeyEvent(instance%2C%20addStop(e)))%20return%3B%0A%20%20%20%20%20%20if%20(e_prop(e%2C%20%22keyCode%22)%20%3D%3D%2016)%20shiftSelecting%20%3D%20null%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20onFocus()%20%7B%0A%20%20%20%20%20%20if%20(options.readOnly%20%3D%3D%20%22nocursor%22)%20return%3B%0A%20%20%20%20%20%20if%20(!focused)%20%7B%0A%20%20%20%20%20%20%20%20if%20(options.onFocus)%20options.onFocus(instance)%3B%0A%20%20%20%20%20%20%20%20focused%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20if%20(scroller.className.search(%2F%5CbCodeMirror-focused%5Cb%2F)%20%3D%3D%20-1)%0A%20%20%20%20%20%20%20%20%20%20scroller.className%20%2B%3D%20%22%20CodeMirror-focused%22%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20slowPoll()%3B%0A%20%20%20%20%20%20restartBlink()%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20onBlur()%20%7B%0A%20%20%20%20%20%20if%20(focused)%20%7B%0A%20%20%20%20%20%20%20%20if%20(options.onBlur)%20options.onBlur(instance)%3B%0A%20%20%20%20%20%20%20%20focused%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20if%20(bracketHighlighted)%0A%20%20%20%20%20%20%20%20%20%20operation(function()%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(bracketHighlighted)%20%7B%20bracketHighlighted()%3B%20bracketHighlighted%20%3D%20null%3B%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D)()%3B%0A%20%20%20%20%20%20%20%20scroller.className%20%3D%20scroller.className.replace(%22%20CodeMirror-focused%22%2C%20%22%22)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20clearInterval(blinker)%3B%0A%20%20%20%20%20%20setTimeout(function()%20%7Bif%20(!focused)%20shiftSelecting%20%3D%20null%3B%7D%2C%20150)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20%2F%2F%20Replace%20the%20range%20from%20from%20to%20to%20by%20the%20strings%20in%20newText.%0A%20%20%20%20%2F%2F%20Afterwards%2C%20set%20the%20selection%20to%20selFrom%2C%20selTo.%0A%20%20%20%20function%20updateLines(from%2C%20to%2C%20newText%2C%20selFrom%2C%20selTo)%20%7B%0A%20%20%20%20%20%20if%20(suppressEdits)%20return%3B%0A%20%20%20%20%20%20var%20old%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20doc.iter(from.line%2C%20to.line%20%2B%201%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20old.push(newHL(line.text%2C%20line.markedSpans))%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20if%20(history)%20%7B%0A%20%20%20%20%20%20%20%20history.addChange(from.line%2C%20newText.length%2C%20old)%3B%0A%20%20%20%20%20%20%20%20while%20(history.done.length%20%3E%20options.undoDepth)%20history.done.shift()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20lines%20%3D%20updateMarkedSpans(hlSpans(old%5B0%5D)%2C%20hlSpans(lst(old))%2C%20from.ch%2C%20to.ch%2C%20newText)%3B%0A%20%20%20%20%20%20updateLinesNoUndo(from%2C%20to%2C%20lines%2C%20selFrom%2C%20selTo)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20unredoHelper(from%2C%20to)%20%7B%0A%20%20%20%20%20%20if%20(!from.length)%20return%3B%0A%20%20%20%20%20%20var%20set%20%3D%20from.pop()%2C%20out%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%20set.length%20-%201%3B%20i%20%3E%3D%200%3B%20i%20-%3D%201)%20%7B%0A%20%20%20%20%20%20%20%20var%20change%20%3D%20set%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20var%20replaced%20%3D%20%5B%5D%2C%20end%20%3D%20change.start%20%2B%20change.added%3B%0A%20%20%20%20%20%20%20%20doc.iter(change.start%2C%20end%2C%20function(line)%20%7B%20replaced.push(newHL(line.text%2C%20line.markedSpans))%3B%20%7D)%3B%0A%20%20%20%20%20%20%20%20out.push(%7Bstart%3A%20change.start%2C%20added%3A%20change.old.length%2C%20old%3A%20replaced%7D)%3B%0A%20%20%20%20%20%20%20%20var%20pos%20%3D%20%7Bline%3A%20change.start%20%2B%20change.old.length%20-%201%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ch%3A%20editEnd(hlText(lst(replaced))%2C%20hlText(lst(change.old)))%7D%3B%0A%20%20%20%20%20%20%20%20updateLinesNoUndo(%7Bline%3A%20change.start%2C%20ch%3A%200%7D%2C%20%7Bline%3A%20end%20-%201%2C%20ch%3A%20getLine(end-1).text.length%7D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20change.old%2C%20pos%2C%20pos)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20updateInput%20%3D%20true%3B%0A%20%20%20%20%20%20to.push(out)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20undo()%20%7BunredoHelper(history.done%2C%20history.undone)%3B%7D%0A%20%20%20%20function%20redo()%20%7BunredoHelper(history.undone%2C%20history.done)%3B%7D%0A%0A%20%20%20%20function%20updateLinesNoUndo(from%2C%20to%2C%20lines%2C%20selFrom%2C%20selTo)%20%7B%0A%20%20%20%20%20%20if%20(suppressEdits)%20return%3B%0A%20%20%20%20%20%20var%20recomputeMaxLength%20%3D%20false%2C%20maxLineLength%20%3D%20maxLine.text.length%3B%0A%20%20%20%20%20%20if%20(!options.lineWrapping)%0A%20%20%20%20%20%20%20%20doc.iter(from.line%2C%20to.line%20%2B%201%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(!line.hidden%20%26%26%20line.text.length%20%3D%3D%20maxLineLength)%20%7BrecomputeMaxLength%20%3D%20true%3B%20return%20true%3B%7D%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20if%20(from.line%20!%3D%20to.line%20%7C%7C%20lines.length%20%3E%201)%20gutterDirty%20%3D%20true%3B%0A%0A%20%20%20%20%20%20var%20nlines%20%3D%20to.line%20-%20from.line%2C%20firstLine%20%3D%20getLine(from.line)%2C%20lastLine%20%3D%20getLine(to.line)%3B%0A%20%20%20%20%20%20var%20lastHL%20%3D%20lst(lines)%3B%0A%0A%20%20%20%20%20%20%2F%2F%20First%20adjust%20the%20line%20structure%0A%20%20%20%20%20%20if%20(from.ch%20%3D%3D%200%20%26%26%20to.ch%20%3D%3D%200%20%26%26%20hlText(lastHL)%20%3D%3D%20%22%22)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20This%20is%20a%20whole-line%20replace.%20Treated%20specially%20to%20make%0A%20%20%20%20%20%20%20%20%2F%2F%20sure%20line%20objects%20move%20the%20way%20they%20are%20supposed%20to.%0A%20%20%20%20%20%20%20%20var%20added%20%3D%20%5B%5D%2C%20prevLine%20%3D%20null%3B%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20lines.length%20-%201%3B%20i%20%3C%20e%3B%20%2B%2Bi)%0A%20%20%20%20%20%20%20%20%20%20added.push(new%20Line(hlText(lines%5Bi%5D)%2C%20hlSpans(lines%5Bi%5D)))%3B%0A%20%20%20%20%20%20%20%20lastLine.update(lastLine.text%2C%20hlSpans(lastHL))%3B%0A%20%20%20%20%20%20%20%20if%20(nlines)%20doc.remove(from.line%2C%20nlines%2C%20callbacks)%3B%0A%20%20%20%20%20%20%20%20if%20(added.length)%20doc.insert(from.line%2C%20added)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(firstLine%20%3D%3D%20lastLine)%20%7B%0A%20%20%20%20%20%20%20%20if%20(lines.length%20%3D%3D%201)%20%7B%0A%20%20%20%20%20%20%20%20%20%20firstLine.update(firstLine.text.slice(0%2C%20from.ch)%20%2B%20hlText(lines%5B0%5D)%20%2B%20firstLine.text.slice(to.ch)%2C%20hlSpans(lines%5B0%5D))%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20for%20(var%20added%20%3D%20%5B%5D%2C%20i%20%3D%201%2C%20e%20%3D%20lines.length%20-%201%3B%20i%20%3C%20e%3B%20%2B%2Bi)%0A%20%20%20%20%20%20%20%20%20%20%20%20added.push(new%20Line(hlText(lines%5Bi%5D)%2C%20hlSpans(lines%5Bi%5D)))%3B%0A%20%20%20%20%20%20%20%20%20%20added.push(new%20Line(hlText(lastHL)%20%2B%20firstLine.text.slice(to.ch)%2C%20hlSpans(lastHL)))%3B%0A%20%20%20%20%20%20%20%20%20%20firstLine.update(firstLine.text.slice(0%2C%20from.ch)%20%2B%20hlText(lines%5B0%5D)%2C%20hlSpans(lines%5B0%5D))%3B%0A%20%20%20%20%20%20%20%20%20%20doc.insert(from.line%20%2B%201%2C%20added)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%20else%20if%20(lines.length%20%3D%3D%201)%20%7B%0A%20%20%20%20%20%20%20%20firstLine.update(firstLine.text.slice(0%2C%20from.ch)%20%2B%20hlText(lines%5B0%5D)%20%2B%20lastLine.text.slice(to.ch)%2C%20hlSpans(lines%5B0%5D))%3B%0A%20%20%20%20%20%20%20%20doc.remove(from.line%20%2B%201%2C%20nlines%2C%20callbacks)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20var%20added%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20%20%20firstLine.update(firstLine.text.slice(0%2C%20from.ch)%20%2B%20hlText(lines%5B0%5D)%2C%20hlSpans(lines%5B0%5D))%3B%0A%20%20%20%20%20%20%20%20lastLine.update(hlText(lastHL)%20%2B%20lastLine.text.slice(to.ch)%2C%20hlSpans(lastHL))%3B%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%201%2C%20e%20%3D%20lines.length%20-%201%3B%20i%20%3C%20e%3B%20%2B%2Bi)%0A%20%20%20%20%20%20%20%20%20%20added.push(new%20Line(hlText(lines%5Bi%5D)%2C%20hlSpans(lines%5Bi%5D)))%3B%0A%20%20%20%20%20%20%20%20if%20(nlines%20%3E%201)%20doc.remove(from.line%20%2B%201%2C%20nlines%20-%201%2C%20callbacks)%3B%0A%20%20%20%20%20%20%20%20doc.insert(from.line%20%2B%201%2C%20added)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(options.lineWrapping)%20%7B%0A%20%20%20%20%20%20%20%20var%20perLine%20%3D%20Math.max(5%2C%20scroller.clientWidth%20%2F%20charWidth()%20-%203)%3B%0A%20%20%20%20%20%20%20%20doc.iter(from.line%2C%20from.line%20%2B%20lines.length%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(line.hidden)%20return%3B%0A%20%20%20%20%20%20%20%20%20%20var%20guess%20%3D%20Math.ceil(line.text.length%20%2F%20perLine)%20%7C%7C%201%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(guess%20!%3D%20line.height)%20updateLineHeight(line%2C%20guess)%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20doc.iter(from.line%2C%20from.line%20%2B%20lines.length%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20l%20%3D%20line.text%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(!line.hidden%20%26%26%20l.length%20%3E%20maxLineLength)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20maxLine%20%3D%20line%3B%20maxLineLength%20%3D%20l.length%3B%20maxLineChanged%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20recomputeMaxLength%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20if%20(recomputeMaxLength)%20updateMaxLine%20%3D%20true%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%2F%2F%20Adjust%20frontier%2C%20schedule%20worker%0A%20%20%20%20%20%20frontier%20%3D%20Math.min(frontier%2C%20from.line)%3B%0A%20%20%20%20%20%20startWorker(400)%3B%0A%0A%20%20%20%20%20%20var%20lendiff%20%3D%20lines.length%20-%20nlines%20-%201%3B%0A%20%20%20%20%20%20%2F%2F%20Remember%20that%20these%20lines%20changed%2C%20for%20updating%20the%20display%0A%20%20%20%20%20%20changes.push(%7Bfrom%3A%20from.line%2C%20to%3A%20to.line%20%2B%201%2C%20diff%3A%20lendiff%7D)%3B%0A%20%20%20%20%20%20if%20(options.onChange)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20Normalize%20lines%20to%20contain%20only%20strings%2C%20since%20that's%20what%0A%20%20%20%20%20%20%20%20%2F%2F%20the%20change%20event%20handler%20expects%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20lines.length%3B%20%2B%2Bi)%0A%20%20%20%20%20%20%20%20%20%20if%20(typeof%20lines%5Bi%5D%20!%3D%20%22string%22)%20lines%5Bi%5D%20%3D%20lines%5Bi%5D.text%3B%0A%20%20%20%20%20%20%20%20var%20changeObj%20%3D%20%7Bfrom%3A%20from%2C%20to%3A%20to%2C%20text%3A%20lines%7D%3B%0A%20%20%20%20%20%20%20%20if%20(textChanged)%20%7B%0A%20%20%20%20%20%20%20%20%20%20for%20(var%20cur%20%3D%20textChanged%3B%20cur.next%3B%20cur%20%3D%20cur.next)%20%7B%7D%0A%20%20%20%20%20%20%20%20%20%20cur.next%20%3D%20changeObj%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20textChanged%20%3D%20changeObj%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%2F%2F%20Update%20the%20selection%0A%20%20%20%20%20%20function%20updateLine(n)%20%7Breturn%20n%20%3C%3D%20Math.min(to.line%2C%20to.line%20%2B%20lendiff)%20%3F%20n%20%3A%20n%20%2B%20lendiff%3B%7D%0A%20%20%20%20%20%20setSelection(clipPos(selFrom)%2C%20clipPos(selTo)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20updateLine(sel.from.line)%2C%20updateLine(sel.to.line))%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20needsScrollbar()%20%7B%0A%20%20%20%20%20%20var%20realHeight%20%3D%20doc.height%20*%20textHeight()%20%2B%202%20*%20paddingTop()%3B%0A%20%20%20%20%20%20return%20realHeight%20*%20.99%20%3E%20scroller.offsetHeight%20%3F%20realHeight%20%3A%20false%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20updateVerticalScroll(scrollTop)%20%7B%0A%20%20%20%20%20%20var%20scrollHeight%20%3D%20needsScrollbar()%3B%0A%20%20%20%20%20%20scrollbar.style.display%20%3D%20scrollHeight%20%3F%20%22block%22%20%3A%20%22none%22%3B%0A%20%20%20%20%20%20if%20(scrollHeight)%20%7B%0A%20%20%20%20%20%20%20%20scrollbarInner.style.height%20%3D%20sizer.style.minHeight%20%3D%20scrollHeight%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20scrollbar.style.height%20%3D%20scroller.clientHeight%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20if%20(scrollTop%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20scrollbar.scrollTop%20%3D%20scroller.scrollTop%20%3D%20scrollTop%3B%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20'Nudge'%20the%20scrollbar%20to%20work%20around%20a%20Webkit%20bug%20where%2C%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20in%20some%20situations%2C%20we'd%20end%20up%20with%20a%20scrollbar%20that%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20reported%20its%20scrollTop%20(and%20looked)%20as%20expected%2C%20but%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20*behaved*%20as%20if%20it%20was%20still%20in%20a%20previous%20state%20(i.e.%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20couldn't%20scroll%20up%2C%20even%20though%20it%20appeared%20to%20be%20at%20the%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20bottom).%0A%20%20%20%20%20%20%20%20%20%20if%20(webkit)%20setTimeout(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(scrollbar.scrollTop%20!%3D%20scrollTop)%20return%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20scrollbar.scrollTop%20%3D%20scrollTop%20%2B%20(scrollTop%20%3F%20-1%20%3A%201)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20scrollbar.scrollTop%20%3D%20scrollTop%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%2C%200)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20sizer.style.minHeight%20%3D%20%22%22%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%2F%2F%20Position%20the%20mover%20div%20to%20align%20with%20the%20current%20virtual%20scroll%20position%0A%20%20%20%20%20%20mover.style.top%20%3D%20displayOffset%20*%20textHeight()%20%2B%20%22px%22%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20computeMaxLength()%20%7B%0A%20%20%20%20%20%20maxLine%20%3D%20getLine(0)%3B%20maxLineChanged%20%3D%20true%3B%0A%20%20%20%20%20%20var%20maxLineLength%20%3D%20maxLine.text.length%3B%0A%20%20%20%20%20%20doc.iter(1%2C%20doc.size%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20var%20l%20%3D%20line.text%3B%0A%20%20%20%20%20%20%20%20if%20(!line.hidden%20%26%26%20l.length%20%3E%20maxLineLength)%20%7B%0A%20%20%20%20%20%20%20%20%20%20maxLineLength%20%3D%20l.length%3B%20maxLine%20%3D%20line%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20updateMaxLine%20%3D%20false%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20replaceRange(code%2C%20from%2C%20to)%20%7B%0A%20%20%20%20%20%20from%20%3D%20clipPos(from)%3B%0A%20%20%20%20%20%20if%20(!to)%20to%20%3D%20from%3B%20else%20to%20%3D%20clipPos(to)%3B%0A%20%20%20%20%20%20code%20%3D%20splitLines(code)%3B%0A%20%20%20%20%20%20function%20adjustPos(pos)%20%7B%0A%20%20%20%20%20%20%20%20if%20(posLess(pos%2C%20from))%20return%20pos%3B%0A%20%20%20%20%20%20%20%20if%20(!posLess(to%2C%20pos))%20return%20end%3B%0A%20%20%20%20%20%20%20%20var%20line%20%3D%20pos.line%20%2B%20code.length%20-%20(to.line%20-%20from.line)%20-%201%3B%0A%20%20%20%20%20%20%20%20var%20ch%20%3D%20pos.ch%3B%0A%20%20%20%20%20%20%20%20if%20(pos.line%20%3D%3D%20to.line)%0A%20%20%20%20%20%20%20%20%20%20ch%20%2B%3D%20lst(code).length%20-%20(to.ch%20-%20(to.line%20%3D%3D%20from.line%20%3F%20from.ch%20%3A%200))%3B%0A%20%20%20%20%20%20%20%20return%20%7Bline%3A%20line%2C%20ch%3A%20ch%7D%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20end%3B%0A%20%20%20%20%20%20replaceRange1(code%2C%20from%2C%20to%2C%20function(end1)%20%7B%0A%20%20%20%20%20%20%20%20end%20%3D%20end1%3B%0A%20%20%20%20%20%20%20%20return%20%7Bfrom%3A%20adjustPos(sel.from)%2C%20to%3A%20adjustPos(sel.to)%7D%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20return%20end%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20replaceSelection(code%2C%20collapse)%20%7B%0A%20%20%20%20%20%20replaceRange1(splitLines(code)%2C%20sel.from%2C%20sel.to%2C%20function(end)%20%7B%0A%20%20%20%20%20%20%20%20if%20(collapse%20%3D%3D%20%22end%22)%20return%20%7Bfrom%3A%20end%2C%20to%3A%20end%7D%3B%0A%20%20%20%20%20%20%20%20else%20if%20(collapse%20%3D%3D%20%22start%22)%20return%20%7Bfrom%3A%20sel.from%2C%20to%3A%20sel.from%7D%3B%0A%20%20%20%20%20%20%20%20else%20return%20%7Bfrom%3A%20sel.from%2C%20to%3A%20end%7D%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20replaceRange1(code%2C%20from%2C%20to%2C%20computeSel)%20%7B%0A%20%20%20%20%20%20var%20endch%20%3D%20code.length%20%3D%3D%201%20%3F%20code%5B0%5D.length%20%2B%20from.ch%20%3A%20lst(code).length%3B%0A%20%20%20%20%20%20var%20newSel%20%3D%20computeSel(%7Bline%3A%20from.line%20%2B%20code.length%20-%201%2C%20ch%3A%20endch%7D)%3B%0A%20%20%20%20%20%20updateLines(from%2C%20to%2C%20code%2C%20newSel.from%2C%20newSel.to)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20getRange(from%2C%20to%2C%20lineSep)%20%7B%0A%20%20%20%20%20%20var%20l1%20%3D%20from.line%2C%20l2%20%3D%20to.line%3B%0A%20%20%20%20%20%20if%20(l1%20%3D%3D%20l2)%20return%20getLine(l1).text.slice(from.ch%2C%20to.ch)%3B%0A%20%20%20%20%20%20var%20code%20%3D%20%5BgetLine(l1).text.slice(from.ch)%5D%3B%0A%20%20%20%20%20%20doc.iter(l1%20%2B%201%2C%20l2%2C%20function(line)%20%7B%20code.push(line.text)%3B%20%7D)%3B%0A%20%20%20%20%20%20code.push(getLine(l2).text.slice(0%2C%20to.ch))%3B%0A%20%20%20%20%20%20return%20code.join(lineSep%20%7C%7C%20%22%5Cn%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20getSelection(lineSep)%20%7B%0A%20%20%20%20%20%20return%20getRange(sel.from%2C%20sel.to%2C%20lineSep)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20slowPoll()%20%7B%0A%20%20%20%20%20%20if%20(pollingFast)%20return%3B%0A%20%20%20%20%20%20poll.set(options.pollInterval%2C%20function()%20%7B%0A%20%20%20%20%20%20%20%20readInput()%3B%0A%20%20%20%20%20%20%20%20if%20(focused)%20slowPoll()%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20fastPoll()%20%7B%0A%20%20%20%20%20%20var%20missed%20%3D%20false%3B%0A%20%20%20%20%20%20pollingFast%20%3D%20true%3B%0A%20%20%20%20%20%20function%20p()%20%7B%0A%20%20%20%20%20%20%20%20var%20changed%20%3D%20readInput()%3B%0A%20%20%20%20%20%20%20%20if%20(!changed%20%26%26%20!missed)%20%7Bmissed%20%3D%20true%3B%20poll.set(60%2C%20p)%3B%7D%0A%20%20%20%20%20%20%20%20else%20%7BpollingFast%20%3D%20false%3B%20slowPoll()%3B%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20poll.set(20%2C%20p)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20%2F%2F%20Previnput%20is%20a%20hack%20to%20work%20with%20IME.%20If%20we%20reset%20the%20textarea%0A%20%20%20%20%2F%2F%20on%20every%20change%2C%20that%20breaks%20IME.%20So%20we%20look%20for%20changes%0A%20%20%20%20%2F%2F%20compared%20to%20the%20previous%20content%20instead.%20(Modern%20browsers%20have%0A%20%20%20%20%2F%2F%20events%20that%20indicate%20IME%20taking%20place%2C%20but%20these%20are%20not%20widely%0A%20%20%20%20%2F%2F%20supported%20or%20compatible%20enough%20yet%20to%20rely%20on.)%0A%20%20%20%20var%20prevInput%20%3D%20%22%22%3B%0A%20%20%20%20function%20readInput()%20%7B%0A%20%20%20%20%20%20if%20(!focused%20%7C%7C%20hasSelection(input)%20%7C%7C%20options.readOnly)%20return%20false%3B%0A%20%20%20%20%20%20var%20text%20%3D%20input.value%3B%0A%20%20%20%20%20%20if%20(text%20%3D%3D%20prevInput)%20return%20false%3B%0A%20%20%20%20%20%20if%20(!nestedOperation)%20startOperation()%3B%0A%20%20%20%20%20%20shiftSelecting%20%3D%20null%3B%0A%20%20%20%20%20%20var%20same%20%3D%200%2C%20l%20%3D%20Math.min(prevInput.length%2C%20text.length)%3B%0A%20%20%20%20%20%20while%20(same%20%3C%20l%20%26%26%20prevInput%5Bsame%5D%20%3D%3D%20text%5Bsame%5D)%20%2B%2Bsame%3B%0A%20%20%20%20%20%20if%20(same%20%3C%20prevInput.length)%0A%20%20%20%20%20%20%20%20sel.from%20%3D%20%7Bline%3A%20sel.from.line%2C%20ch%3A%20sel.from.ch%20-%20(prevInput.length%20-%20same)%7D%3B%0A%20%20%20%20%20%20else%20if%20(overwrite%20%26%26%20posEq(sel.from%2C%20sel.to))%0A%20%20%20%20%20%20%20%20sel.to%20%3D%20%7Bline%3A%20sel.to.line%2C%20ch%3A%20Math.min(getLine(sel.to.line).text.length%2C%20sel.to.ch%20%2B%20(text.length%20-%20same))%7D%3B%0A%20%20%20%20%20%20replaceSelection(text.slice(same)%2C%20%22end%22)%3B%0A%20%20%20%20%20%20if%20(text.length%20%3E%201000)%20%7B%20input.value%20%3D%20prevInput%20%3D%20%22%22%3B%20%7D%0A%20%20%20%20%20%20else%20prevInput%20%3D%20text%3B%0A%20%20%20%20%20%20if%20(!nestedOperation)%20endOperation()%3B%0A%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20resetInput(user)%20%7B%0A%20%20%20%20%20%20if%20(!posEq(sel.from%2C%20sel.to))%20%7B%0A%20%20%20%20%20%20%20%20prevInput%20%3D%20%22%22%3B%0A%20%20%20%20%20%20%20%20input.value%20%3D%20getSelection()%3B%0A%20%20%20%20%20%20%20%20if%20(focused)%20selectInput(input)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(user)%20prevInput%20%3D%20input.value%20%3D%20%22%22%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20focusInput()%20%7B%0A%20%20%20%20%20%20if%20(options.readOnly%20!%3D%20%22nocursor%22)%20input.focus()%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20scrollCursorIntoView()%20%7B%0A%20%20%20%20%20%20var%20coords%20%3D%20calculateCursorCoords()%3B%0A%20%20%20%20%20%20scrollIntoView(coords.x%2C%20coords.y%2C%20coords.x%2C%20coords.yBot)%3B%0A%20%20%20%20%20%20if%20(!focused)%20return%3B%0A%20%20%20%20%20%20var%20box%20%3D%20sizer.getBoundingClientRect()%2C%20doScroll%20%3D%20null%3B%0A%20%20%20%20%20%20if%20(coords.y%20%2B%20box.top%20%3C%200)%20doScroll%20%3D%20true%3B%0A%20%20%20%20%20%20else%20if%20(coords.y%20%2B%20box.top%20%2B%20textHeight()%20%3E%20(window.innerHeight%20%7C%7C%20document.documentElement.clientHeight))%20doScroll%20%3D%20false%3B%0A%20%20%20%20%20%20if%20(doScroll%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20var%20hidden%20%3D%20cursor.style.display%20%3D%3D%20%22none%22%3B%0A%20%20%20%20%20%20%20%20if%20(hidden)%20%7B%0A%20%20%20%20%20%20%20%20%20%20cursor.style.display%20%3D%20%22%22%3B%0A%20%20%20%20%20%20%20%20%20%20cursor.style.left%20%3D%20coords.x%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20%20%20cursor.style.top%20%3D%20(coords.y%20-%20displayOffset)%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20cursor.scrollIntoView(doScroll)%3B%0A%20%20%20%20%20%20%20%20if%20(hidden)%20cursor.style.display%20%3D%20%22none%22%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20function%20calculateCursorCoords()%20%7B%0A%20%20%20%20%20%20var%20cursor%20%3D%20localCoords(sel.inverted%20%3F%20sel.from%20%3A%20sel.to)%3B%0A%20%20%20%20%20%20var%20x%20%3D%20options.lineWrapping%20%3F%20Math.min(cursor.x%2C%20lineSpace.offsetWidth)%20%3A%20cursor.x%3B%0A%20%20%20%20%20%20return%20%7Bx%3A%20x%2C%20y%3A%20cursor.y%2C%20yBot%3A%20cursor.yBot%7D%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20scrollIntoView(x1%2C%20y1%2C%20x2%2C%20y2)%20%7B%0A%20%20%20%20%20%20var%20scrollPos%20%3D%20calculateScrollPos(x1%2C%20y1%2C%20x2%2C%20y2)%3B%0A%20%20%20%20%20%20if%20(scrollPos.scrollLeft%20!%3D%20null)%20%7Bscroller.scrollLeft%20%3D%20scrollPos.scrollLeft%3B%7D%0A%20%20%20%20%20%20if%20(scrollPos.scrollTop%20!%3D%20null)%20%7Bscrollbar.scrollTop%20%3D%20scroller.scrollTop%20%3D%20scrollPos.scrollTop%3B%7D%0A%20%20%20%20%7D%0A%20%20%20%20function%20calculateScrollPos(x1%2C%20y1%2C%20x2%2C%20y2)%20%7B%0A%20%20%20%20%20%20var%20pl%20%3D%20paddingLeft()%2C%20pt%20%3D%20paddingTop()%3B%0A%20%20%20%20%20%20y1%20%2B%3D%20pt%3B%20y2%20%2B%3D%20pt%3B%20x1%20%2B%3D%20pl%3B%20x2%20%2B%3D%20pl%3B%0A%20%20%20%20%20%20var%20screen%20%3D%20scroller.clientHeight%2C%20screentop%20%3D%20scrollbar.scrollTop%2C%20result%20%3D%20%7B%7D%3B%0A%20%20%20%20%20%20var%20docBottom%20%3D%20needsScrollbar()%20%7C%7C%20Infinity%3B%0A%20%20%20%20%20%20var%20atTop%20%3D%20y1%20%3C%20pt%20%2B%2010%2C%20atBottom%20%3D%20y2%20%2B%20pt%20%3E%20docBottom%20-%2010%3B%0A%20%20%20%20%20%20if%20(y1%20%3C%20screentop)%20result.scrollTop%20%3D%20atTop%20%3F%200%20%3A%20Math.max(0%2C%20y1)%3B%0A%20%20%20%20%20%20else%20if%20(y2%20%3E%20screentop%20%2B%20screen)%20result.scrollTop%20%3D%20(atBottom%20%3F%20docBottom%20%3A%20y2)%20-%20screen%3B%0A%0A%20%20%20%20%20%20var%20screenw%20%3D%20scroller.clientWidth%2C%20screenleft%20%3D%20scroller.scrollLeft%3B%0A%20%20%20%20%20%20var%20gutterw%20%3D%20options.fixedGutter%20%3F%20gutter.clientWidth%20%3A%200%3B%0A%20%20%20%20%20%20var%20atLeft%20%3D%20x1%20%3C%20gutterw%20%2B%20pl%20%2B%2010%3B%0A%20%20%20%20%20%20if%20(x1%20%3C%20screenleft%20%2B%20gutterw%20%7C%7C%20atLeft)%20%7B%0A%20%20%20%20%20%20%20%20if%20(atLeft)%20x1%20%3D%200%3B%0A%20%20%20%20%20%20%20%20result.scrollLeft%20%3D%20Math.max(0%2C%20x1%20-%2010%20-%20gutterw)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(x2%20%3E%20screenw%20%2B%20screenleft%20-%203)%20%7B%0A%20%20%20%20%20%20%20%20result.scrollLeft%20%3D%20x2%20%2B%2010%20-%20screenw%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20result%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20visibleLines(scrollTop)%20%7B%0A%20%20%20%20%20%20var%20lh%20%3D%20textHeight()%2C%20top%20%3D%20(scrollTop%20!%3D%20null%20%3F%20scrollTop%20%3A%20scrollbar.scrollTop)%20-%20paddingTop()%3B%0A%20%20%20%20%20%20var%20fromHeight%20%3D%20Math.max(0%2C%20Math.floor(top%20%2F%20lh))%3B%0A%20%20%20%20%20%20var%20toHeight%20%3D%20Math.ceil((top%20%2B%20scroller.clientHeight)%20%2F%20lh)%3B%0A%20%20%20%20%20%20return%20%7Bfrom%3A%20lineAtHeight(doc%2C%20fromHeight)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20to%3A%20lineAtHeight(doc%2C%20toHeight)%7D%3B%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20Uses%20a%20set%20of%20changes%20plus%20the%20current%20scroll%20position%20to%0A%20%20%20%20%2F%2F%20determine%20which%20DOM%20updates%20have%20to%20be%20made%2C%20and%20makes%20the%0A%20%20%20%20%2F%2F%20updates.%0A%20%20%20%20function%20updateDisplay(changes%2C%20suppressCallback%2C%20scrollTop)%20%7B%0A%20%20%20%20%20%20if%20(!scroller.clientWidth)%20%7B%0A%20%20%20%20%20%20%20%20showingFrom%20%3D%20showingTo%20%3D%20displayOffset%20%3D%200%3B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%2F%2F%20Compute%20the%20new%20visible%20window%0A%20%20%20%20%20%20%2F%2F%20If%20scrollTop%20is%20specified%2C%20use%20that%20to%20determine%20which%20lines%0A%20%20%20%20%20%20%2F%2F%20to%20render%20instead%20of%20the%20current%20scrollbar%20position.%0A%20%20%20%20%20%20var%20visible%20%3D%20visibleLines(scrollTop)%3B%0A%20%20%20%20%20%20%2F%2F%20Bail%20out%20if%20the%20visible%20area%20is%20already%20rendered%20and%20nothing%20changed.%0A%20%20%20%20%20%20if%20(changes%20!%3D%3D%20true%20%26%26%20changes.length%20%3D%3D%200%20%26%26%20visible.from%20%3E%20showingFrom%20%26%26%20visible.to%20%3C%20showingTo)%20%7B%0A%20%20%20%20%20%20%20%20updateVerticalScroll(scrollTop)%3B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20from%20%3D%20Math.max(visible.from%20-%20100%2C%200)%2C%20to%20%3D%20Math.min(doc.size%2C%20visible.to%20%2B%20100)%3B%0A%20%20%20%20%20%20if%20(showingFrom%20%3C%20from%20%26%26%20from%20-%20showingFrom%20%3C%2020)%20from%20%3D%20showingFrom%3B%0A%20%20%20%20%20%20if%20(showingTo%20%3E%20to%20%26%26%20showingTo%20-%20to%20%3C%2020)%20to%20%3D%20Math.min(doc.size%2C%20showingTo)%3B%0A%0A%20%20%20%20%20%20%2F%2F%20Create%20a%20range%20of%20theoretically%20intact%20lines%2C%20and%20punch%20holes%0A%20%20%20%20%20%20%2F%2F%20in%20that%20using%20the%20change%20info.%0A%20%20%20%20%20%20var%20intact%20%3D%20changes%20%3D%3D%3D%20true%20%3F%20%5B%5D%20%3A%0A%20%20%20%20%20%20%20%20computeIntact(%5B%7Bfrom%3A%20showingFrom%2C%20to%3A%20showingTo%2C%20domStart%3A%200%7D%5D%2C%20changes)%3B%0A%20%20%20%20%20%20%2F%2F%20Clip%20off%20the%20parts%20that%20won't%20be%20visible%0A%20%20%20%20%20%20var%20intactLines%20%3D%200%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20intact.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20range%20%3D%20intact%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20if%20(range.from%20%3C%20from)%20%7Brange.domStart%20%2B%3D%20(from%20-%20range.from)%3B%20range.from%20%3D%20from%3B%7D%0A%20%20%20%20%20%20%20%20if%20(range.to%20%3E%20to)%20range.to%20%3D%20to%3B%0A%20%20%20%20%20%20%20%20if%20(range.from%20%3E%3D%20range.to)%20intact.splice(i--%2C%201)%3B%0A%20%20%20%20%20%20%20%20else%20intactLines%20%2B%3D%20range.to%20-%20range.from%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(intactLines%20%3D%3D%20to%20-%20from%20%26%26%20from%20%3D%3D%20showingFrom%20%26%26%20to%20%3D%3D%20showingTo)%20%7B%0A%20%20%20%20%20%20%20%20updateVerticalScroll(scrollTop)%3B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20intact.sort(function(a%2C%20b)%20%7Breturn%20a.domStart%20-%20b.domStart%3B%7D)%3B%0A%0A%20%20%20%20%20%20var%20th%20%3D%20textHeight()%2C%20gutterDisplay%20%3D%20gutter.style.display%3B%0A%20%20%20%20%20%20lineDiv.style.display%20%3D%20%22none%22%3B%0A%20%20%20%20%20%20patchDisplay(from%2C%20to%2C%20intact)%3B%0A%20%20%20%20%20%20lineDiv.style.display%20%3D%20gutter.style.display%20%3D%20%22%22%3B%0A%0A%20%20%20%20%20%20var%20different%20%3D%20from%20!%3D%20showingFrom%20%7C%7C%20to%20!%3D%20showingTo%20%7C%7C%20lastSizeC%20!%3D%20scroller.clientHeight%20%2B%20th%3B%0A%20%20%20%20%20%20%2F%2F%20This%20is%20just%20a%20bogus%20formula%20that%20detects%20when%20the%20editor%20is%0A%20%20%20%20%20%20%2F%2F%20resized%20or%20the%20font%20size%20changes.%0A%20%20%20%20%20%20if%20(different)%20lastSizeC%20%3D%20scroller.clientHeight%20%2B%20th%3B%0A%20%20%20%20%20%20if%20(from%20!%3D%20showingFrom%20%7C%7C%20to%20!%3D%20showingTo%20%26%26%20options.onViewportChange)%0A%20%20%20%20%20%20%20%20setTimeout(function()%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(options.onViewportChange)%20options.onViewportChange(instance%2C%20from%2C%20to)%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20showingFrom%20%3D%20from%3B%20showingTo%20%3D%20to%3B%0A%20%20%20%20%20%20displayOffset%20%3D%20heightAtLine(doc%2C%20from)%3B%0A%20%20%20%20%20%20startWorker(100)%3B%0A%0A%20%20%20%20%20%20%2F%2F%20Since%20this%20is%20all%20rather%20error%20prone%2C%20it%20is%20honoured%20with%20the%0A%20%20%20%20%20%20%2F%2F%20only%20assertion%20in%20the%20whole%20file.%0A%20%20%20%20%20%20if%20(lineDiv.childNodes.length%20!%3D%20showingTo%20-%20showingFrom)%0A%20%20%20%20%20%20%20%20throw%20new%20Error(%22BAD%20PATCH!%20%22%20%2B%20JSON.stringify(intact)%20%2B%20%22%20size%3D%22%20%2B%20(showingTo%20-%20showingFrom)%20%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%20nodes%3D%22%20%2B%20lineDiv.childNodes.length)%3B%0A%0A%20%20%20%20%20%20function%20checkHeights()%20%7B%0A%20%20%20%20%20%20%20%20var%20curNode%20%3D%20lineDiv.firstChild%2C%20heightChanged%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20doc.iter(showingFrom%2C%20showingTo%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20Work%20around%20bizarro%20IE7%20bug%20where%2C%20sometimes%2C%20our%20curNode%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20is%20magically%20replaced%20with%20a%20new%20node%20in%20the%20DOM%2C%20leaving%0A%20%20%20%20%20%20%20%20%20%20%2F%2F%20us%20with%20a%20reference%20to%20an%20orphan%20(nextSibling-less)%20node.%0A%20%20%20%20%20%20%20%20%20%20if%20(!curNode)%20return%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(!line.hidden)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20height%20%3D%20Math.round(curNode.offsetHeight%20%2F%20th)%20%7C%7C%201%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(line.height%20!%3D%20height)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20updateLineHeight(line%2C%20height)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20gutterDirty%20%3D%20heightChanged%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20curNode%20%3D%20curNode.nextSibling%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20return%20heightChanged%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20if%20(options.lineWrapping)%20checkHeights()%3B%0A%0A%20%20%20%20%20%20gutter.style.display%20%3D%20gutterDisplay%3B%0A%20%20%20%20%20%20if%20(different%20%7C%7C%20gutterDirty)%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20If%20the%20gutter%20grew%20in%20size%2C%20re-check%20heights.%20If%20those%20changed%2C%20re-draw%20gutter.%0A%20%20%20%20%20%20%20%20updateGutter()%20%26%26%20options.lineWrapping%20%26%26%20checkHeights()%20%26%26%20updateGutter()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20updateVerticalScroll(scrollTop)%3B%0A%20%20%20%20%20%20updateSelection()%3B%0A%20%20%20%20%20%20if%20(!suppressCallback%20%26%26%20options.onUpdate)%20options.onUpdate(instance)%3B%0A%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20computeIntact(intact%2C%20changes)%20%7B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20l%20%3D%20changes.length%20%7C%7C%200%3B%20i%20%3C%20l%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20change%20%3D%20changes%5Bi%5D%2C%20intact2%20%3D%20%5B%5D%2C%20diff%20%3D%20change.diff%20%7C%7C%200%3B%0A%20%20%20%20%20%20%20%20for%20(var%20j%20%3D%200%2C%20l2%20%3D%20intact.length%3B%20j%20%3C%20l2%3B%20%2B%2Bj)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20range%20%3D%20intact%5Bj%5D%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(change.to%20%3C%3D%20range.from%20%26%26%20change.diff)%0A%20%20%20%20%20%20%20%20%20%20%20%20intact2.push(%7Bfrom%3A%20range.from%20%2B%20diff%2C%20to%3A%20range.to%20%2B%20diff%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20domStart%3A%20range.domStart%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20else%20if%20(change.to%20%3C%3D%20range.from%20%7C%7C%20change.from%20%3E%3D%20range.to)%0A%20%20%20%20%20%20%20%20%20%20%20%20intact2.push(range)%3B%0A%20%20%20%20%20%20%20%20%20%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(change.from%20%3E%20range.from)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20intact2.push(%7Bfrom%3A%20range.from%2C%20to%3A%20change.from%2C%20domStart%3A%20range.domStart%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(change.to%20%3C%20range.to)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20intact2.push(%7Bfrom%3A%20change.to%20%2B%20diff%2C%20to%3A%20range.to%20%2B%20diff%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20domStart%3A%20range.domStart%20%2B%20(change.to%20-%20range.from)%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20intact%20%3D%20intact2%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20intact%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20patchDisplay(from%2C%20to%2C%20intact)%20%7B%0A%20%20%20%20%20%20function%20killNode(node)%20%7B%0A%20%20%20%20%20%20%20%20var%20tmp%20%3D%20node.nextSibling%3B%0A%20%20%20%20%20%20%20%20node.parentNode.removeChild(node)%3B%0A%20%20%20%20%20%20%20%20return%20tmp%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%2F%2F%20The%20first%20pass%20removes%20the%20DOM%20nodes%20that%20aren't%20intact.%0A%20%20%20%20%20%20if%20(!intact.length)%20removeChildren(lineDiv)%3B%0A%20%20%20%20%20%20else%20%7B%0A%20%20%20%20%20%20%20%20var%20domPos%20%3D%200%2C%20curNode%20%3D%20lineDiv.firstChild%2C%20n%3B%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20intact.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20cur%20%3D%20intact%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%20%20while%20(cur.domStart%20%3E%20domPos)%20%7BcurNode%20%3D%20killNode(curNode)%3B%20domPos%2B%2B%3B%7D%0A%20%20%20%20%20%20%20%20%20%20for%20(var%20j%20%3D%200%2C%20e%20%3D%20cur.to%20-%20cur.from%3B%20j%20%3C%20e%3B%20%2B%2Bj)%20%7BcurNode%20%3D%20curNode.nextSibling%3B%20domPos%2B%2B%3B%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20while%20(curNode)%20curNode%20%3D%20killNode(curNode)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%2F%2F%20This%20pass%20fills%20in%20the%20lines%20that%20actually%20changed.%0A%20%20%20%20%20%20var%20nextIntact%20%3D%20intact.shift()%2C%20curNode%20%3D%20lineDiv.firstChild%2C%20j%20%3D%20from%3B%0A%20%20%20%20%20%20doc.iter(from%2C%20to%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20if%20(nextIntact%20%26%26%20nextIntact.to%20%3D%3D%20j)%20nextIntact%20%3D%20intact.shift()%3B%0A%20%20%20%20%20%20%20%20if%20(!nextIntact%20%7C%7C%20nextIntact.from%20%3E%20j)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(line.hidden)%20var%20lineElement%20%3D%20elt(%22pre%22)%3B%0A%20%20%20%20%20%20%20%20%20%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20lineElement%20%3D%20lineContent(line)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(line.className)%20lineElement.className%20%3D%20line.className%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20Kludge%20to%20make%20sure%20the%20styled%20element%20lies%20behind%20the%20selection%20(by%20z-index)%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(line.bgClassName)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20pre%20%3D%20elt(%22pre%22%2C%20%22%5Cu00a0%22%2C%20line.bgClassName%2C%20%22position%3A%20absolute%3B%20left%3A%200%3B%20right%3A%200%3B%20top%3A%200%3B%20bottom%3A%200%3B%20z-index%3A%20-2%22)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20lineElement%20%3D%20elt(%22div%22%2C%20%5Bpre%2C%20lineElement%5D%2C%20null%2C%20%22position%3A%20relative%22)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20lineDiv.insertBefore(lineElement%2C%20curNode)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20curNode%20%3D%20curNode.nextSibling%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2B%2Bj%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20updateGutter()%20%7B%0A%20%20%20%20%20%20if%20(!options.gutter%20%26%26%20!options.lineNumbers)%20return%3B%0A%20%20%20%20%20%20var%20hText%20%3D%20mover.offsetHeight%2C%20hEditor%20%3D%20scroller.clientHeight%3B%0A%20%20%20%20%20%20gutter.style.height%20%3D%20(hText%20-%20hEditor%20%3C%202%20%3F%20hEditor%20%3A%20hText)%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20var%20fragment%20%3D%20document.createDocumentFragment()%2C%20i%20%3D%20showingFrom%2C%20normalNode%3B%0A%20%20%20%20%20%20doc.iter(showingFrom%2C%20Math.max(showingTo%2C%20showingFrom%20%2B%201)%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20if%20(line.hidden)%20%7B%0A%20%20%20%20%20%20%20%20%20%20fragment.appendChild(elt(%22pre%22))%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20marker%20%3D%20line.gutterMarker%3B%0A%20%20%20%20%20%20%20%20%20%20var%20text%20%3D%20options.lineNumbers%20%3F%20options.lineNumberFormatter(i%20%2B%20options.firstLineNumber)%20%3A%20null%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(marker%20%26%26%20marker.text)%0A%20%20%20%20%20%20%20%20%20%20%20%20text%20%3D%20marker.text.replace(%22%25N%25%22%2C%20text%20!%3D%20null%20%3F%20text%20%3A%20%22%22)%3B%0A%20%20%20%20%20%20%20%20%20%20else%20if%20(text%20%3D%3D%20null)%0A%20%20%20%20%20%20%20%20%20%20%20%20text%20%3D%20%22%5Cu00a0%22%3B%0A%20%20%20%20%20%20%20%20%20%20var%20markerElement%20%3D%20fragment.appendChild(elt(%22pre%22%2C%20null%2C%20marker%20%26%26%20marker.style))%3B%0A%20%20%20%20%20%20%20%20%20%20markerElement.innerHTML%20%3D%20text%3B%0A%20%20%20%20%20%20%20%20%20%20for%20(var%20j%20%3D%201%3B%20j%20%3C%20line.height%3B%20%2B%2Bj)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20markerElement.appendChild(elt(%22br%22))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20markerElement.appendChild(document.createTextNode(%22%5Cu00a0%22))%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20if%20(!marker)%20normalNode%20%3D%20i%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2B%2Bi%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20gutter.style.display%20%3D%20%22none%22%3B%0A%20%20%20%20%20%20removeChildrenAndAdd(gutterText%2C%20fragment)%3B%0A%20%20%20%20%20%20%2F%2F%20Make%20sure%20scrolling%20doesn't%20cause%20number%20gutter%20size%20to%20pop%0A%20%20%20%20%20%20if%20(normalNode%20!%3D%20null%20%26%26%20options.lineNumbers)%20%7B%0A%20%20%20%20%20%20%20%20var%20node%20%3D%20gutterText.childNodes%5BnormalNode%20-%20showingFrom%5D%3B%0A%20%20%20%20%20%20%20%20var%20minwidth%20%3D%20String(doc.size).length%2C%20val%20%3D%20eltText(node.firstChild)%2C%20pad%20%3D%20%22%22%3B%0A%20%20%20%20%20%20%20%20while%20(val.length%20%2B%20pad.length%20%3C%20minwidth)%20pad%20%2B%3D%20%22%5Cu00a0%22%3B%0A%20%20%20%20%20%20%20%20if%20(pad)%20node.insertBefore(document.createTextNode(pad)%2C%20node.firstChild)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20gutter.style.display%20%3D%20%22%22%3B%0A%20%20%20%20%20%20var%20resized%20%3D%20Math.abs((parseInt(lineSpace.style.marginLeft)%20%7C%7C%200)%20-%20gutter.offsetWidth)%20%3E%202%3B%0A%20%20%20%20%20%20lineSpace.style.marginLeft%20%3D%20gutter.offsetWidth%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20gutterDirty%20%3D%20false%3B%0A%20%20%20%20%20%20return%20resized%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20updateSelection()%20%7B%0A%20%20%20%20%20%20var%20collapsed%20%3D%20posEq(sel.from%2C%20sel.to)%3B%0A%20%20%20%20%20%20var%20fromPos%20%3D%20localCoords(sel.from%2C%20true)%3B%0A%20%20%20%20%20%20var%20toPos%20%3D%20collapsed%20%3F%20fromPos%20%3A%20localCoords(sel.to%2C%20true)%3B%0A%20%20%20%20%20%20var%20headPos%20%3D%20sel.inverted%20%3F%20fromPos%20%3A%20toPos%2C%20th%20%3D%20textHeight()%3B%0A%20%20%20%20%20%20var%20wrapOff%20%3D%20eltOffset(wrapper)%2C%20lineOff%20%3D%20eltOffset(lineDiv)%3B%0A%20%20%20%20%20%20inputDiv.style.top%20%3D%20Math.max(0%2C%20Math.min(scroller.offsetHeight%2C%20headPos.y%20%2B%20lineOff.top%20-%20wrapOff.top))%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20inputDiv.style.left%20%3D%20Math.max(0%2C%20Math.min(scroller.offsetWidth%2C%20headPos.x%20%2B%20lineOff.left%20-%20wrapOff.left))%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20if%20(collapsed)%20%7B%0A%20%20%20%20%20%20%20%20cursor.style.top%20%3D%20headPos.y%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20cursor.style.left%20%3D%20(options.lineWrapping%20%3F%20Math.min(headPos.x%2C%20lineSpace.offsetWidth)%20%3A%20headPos.x)%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20cursor.style.display%20%3D%20%22%22%3B%0A%20%20%20%20%20%20%20%20selectionDiv.style.display%20%3D%20%22none%22%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20var%20sameLine%20%3D%20fromPos.y%20%3D%3D%20toPos.y%2C%20fragment%20%3D%20document.createDocumentFragment()%3B%0A%20%20%20%20%20%20%20%20var%20clientWidth%20%3D%20lineSpace.clientWidth%20%7C%7C%20lineSpace.offsetWidth%3B%0A%20%20%20%20%20%20%20%20var%20clientHeight%20%3D%20lineSpace.clientHeight%20%7C%7C%20lineSpace.offsetHeight%3B%0A%20%20%20%20%20%20%20%20var%20add%20%3D%20function(left%2C%20top%2C%20right%2C%20height)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20rstyle%20%3D%20quirksMode%20%3F%20%22width%3A%20%22%20%2B%20(!right%20%3F%20clientWidth%20%3A%20clientWidth%20-%20right%20-%20left)%20%2B%20%22px%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%20%22right%3A%20%22%20%2B%20right%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20%20%20fragment.appendChild(elt(%22div%22%2C%20null%2C%20%22CodeMirror-selected%22%2C%20%22position%3A%20absolute%3B%20left%3A%20%22%20%2B%20left%20%2B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22px%3B%20top%3A%20%22%20%2B%20top%20%2B%20%22px%3B%20%22%20%2B%20rstyle%20%2B%20%22%3B%20height%3A%20%22%20%2B%20height%20%2B%20%22px%22))%3B%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%20%20if%20(sel.from.ch%20%26%26%20fromPos.y%20%3E%3D%200)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20right%20%3D%20sameLine%20%3F%20clientWidth%20-%20toPos.x%20%3A%200%3B%0A%20%20%20%20%20%20%20%20%20%20add(fromPos.x%2C%20fromPos.y%2C%20right%2C%20th)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20var%20middleStart%20%3D%20Math.max(0%2C%20fromPos.y%20%2B%20(sel.from.ch%20%3F%20th%20%3A%200))%3B%0A%20%20%20%20%20%20%20%20var%20middleHeight%20%3D%20Math.min(toPos.y%2C%20clientHeight)%20-%20middleStart%3B%0A%20%20%20%20%20%20%20%20if%20(middleHeight%20%3E%200.2%20*%20th)%0A%20%20%20%20%20%20%20%20%20%20add(0%2C%20middleStart%2C%200%2C%20middleHeight)%3B%0A%20%20%20%20%20%20%20%20if%20((!sameLine%20%7C%7C%20!sel.from.ch)%20%26%26%20toPos.y%20%3C%20clientHeight%20-%20.5%20*%20th)%0A%20%20%20%20%20%20%20%20%20%20add(0%2C%20toPos.y%2C%20clientWidth%20-%20toPos.x%2C%20th)%3B%0A%20%20%20%20%20%20%20%20removeChildrenAndAdd(selectionDiv%2C%20fragment)%3B%0A%20%20%20%20%20%20%20%20cursor.style.display%20%3D%20%22none%22%3B%0A%20%20%20%20%20%20%20%20selectionDiv.style.display%20%3D%20%22%22%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20setShift(val)%20%7B%0A%20%20%20%20%20%20if%20(val)%20shiftSelecting%20%3D%20shiftSelecting%20%7C%7C%20(sel.inverted%20%3F%20sel.to%20%3A%20sel.from)%3B%0A%20%20%20%20%20%20else%20shiftSelecting%20%3D%20null%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20setSelectionUser(from%2C%20to)%20%7B%0A%20%20%20%20%20%20var%20sh%20%3D%20shiftSelecting%20%26%26%20clipPos(shiftSelecting)%3B%0A%20%20%20%20%20%20if%20(sh)%20%7B%0A%20%20%20%20%20%20%20%20if%20(posLess(sh%2C%20from))%20from%20%3D%20sh%3B%0A%20%20%20%20%20%20%20%20else%20if%20(posLess(to%2C%20sh))%20to%20%3D%20sh%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20setSelection(from%2C%20to)%3B%0A%20%20%20%20%20%20userSelChange%20%3D%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20Update%20the%20selection.%20Last%20two%20args%20are%20only%20used%20by%0A%20%20%20%20%2F%2F%20updateLines%2C%20since%20they%20have%20to%20be%20expressed%20in%20the%20line%0A%20%20%20%20%2F%2F%20numbers%20before%20the%20update.%0A%20%20%20%20function%20setSelection(from%2C%20to%2C%20oldFrom%2C%20oldTo)%20%7B%0A%20%20%20%20%20%20goalColumn%20%3D%20null%3B%0A%20%20%20%20%20%20if%20(oldFrom%20%3D%3D%20null)%20%7BoldFrom%20%3D%20sel.from.line%3B%20oldTo%20%3D%20sel.to.line%3B%7D%0A%20%20%20%20%20%20if%20(posEq(sel.from%2C%20from)%20%26%26%20posEq(sel.to%2C%20to))%20return%3B%0A%20%20%20%20%20%20if%20(posLess(to%2C%20from))%20%7Bvar%20tmp%20%3D%20to%3B%20to%20%3D%20from%3B%20from%20%3D%20tmp%3B%7D%0A%0A%20%20%20%20%20%20%2F%2F%20Skip%20over%20hidden%20lines.%0A%20%20%20%20%20%20if%20(from.line%20!%3D%20oldFrom)%20%7B%0A%20%20%20%20%20%20%20%20var%20from1%20%3D%20skipHidden(from%2C%20oldFrom%2C%20sel.from.ch)%3B%0A%20%20%20%20%20%20%20%20%2F%2F%20If%20there%20is%20no%20non-hidden%20line%20left%2C%20force%20visibility%20on%20current%20line%0A%20%20%20%20%20%20%20%20if%20(!from1)%20setLineHidden(from.line%2C%20false)%3B%0A%20%20%20%20%20%20%20%20else%20from%20%3D%20from1%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(to.line%20!%3D%20oldTo)%20to%20%3D%20skipHidden(to%2C%20oldTo%2C%20sel.to.ch)%3B%0A%0A%20%20%20%20%20%20if%20(posEq(from%2C%20to))%20sel.inverted%20%3D%20false%3B%0A%20%20%20%20%20%20else%20if%20(posEq(from%2C%20sel.to))%20sel.inverted%20%3D%20false%3B%0A%20%20%20%20%20%20else%20if%20(posEq(to%2C%20sel.from))%20sel.inverted%20%3D%20true%3B%0A%0A%20%20%20%20%20%20if%20(options.autoClearEmptyLines%20%26%26%20posEq(sel.from%2C%20sel.to))%20%7B%0A%20%20%20%20%20%20%20%20var%20head%20%3D%20sel.inverted%20%3F%20from%20%3A%20to%3B%0A%20%20%20%20%20%20%20%20if%20(head.line%20!%3D%20sel.from.line%20%26%26%20sel.from.line%20%3C%20doc.size)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20oldLine%20%3D%20getLine(sel.from.line)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(%2F%5E%5Cs%2B%24%2F.test(oldLine.text))%0A%20%20%20%20%20%20%20%20%20%20%20%20setTimeout(operation(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(oldLine.parent%20%26%26%20%2F%5E%5Cs%2B%24%2F.test(oldLine.text))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20no%20%3D%20lineNo(oldLine)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20replaceRange(%22%22%2C%20%7Bline%3A%20no%2C%20ch%3A%200%7D%2C%20%7Bline%3A%20no%2C%20ch%3A%20oldLine.text.length%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%2C%2010))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20sel.from%20%3D%20from%3B%20sel.to%20%3D%20to%3B%0A%20%20%20%20%20%20selectionChanged%20%3D%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20skipHidden(pos%2C%20oldLine%2C%20oldCh)%20%7B%0A%20%20%20%20%20%20function%20getNonHidden(dir)%20%7B%0A%20%20%20%20%20%20%20%20var%20lNo%20%3D%20pos.line%20%2B%20dir%2C%20end%20%3D%20dir%20%3D%3D%201%20%3F%20doc.size%20%3A%20-1%3B%0A%20%20%20%20%20%20%20%20while%20(lNo%20!%3D%20end)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20line%20%3D%20getLine(lNo)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(!line.hidden)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20ch%20%3D%20pos.ch%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(toEnd%20%7C%7C%20ch%20%3E%20oldCh%20%7C%7C%20ch%20%3E%20line.text.length)%20ch%20%3D%20line.text.length%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20%7Bline%3A%20lNo%2C%20ch%3A%20ch%7D%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20lNo%20%2B%3D%20dir%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20line%20%3D%20getLine(pos.line)%3B%0A%20%20%20%20%20%20var%20toEnd%20%3D%20pos.ch%20%3D%3D%20line.text.length%20%26%26%20pos.ch%20!%3D%20oldCh%3B%0A%20%20%20%20%20%20if%20(!line.hidden)%20return%20pos%3B%0A%20%20%20%20%20%20if%20(pos.line%20%3E%3D%20oldLine)%20return%20getNonHidden(1)%20%7C%7C%20getNonHidden(-1)%3B%0A%20%20%20%20%20%20else%20return%20getNonHidden(-1)%20%7C%7C%20getNonHidden(1)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20setCursor(line%2C%20ch%2C%20user)%20%7B%0A%20%20%20%20%20%20var%20pos%20%3D%20clipPos(%7Bline%3A%20line%2C%20ch%3A%20ch%20%7C%7C%200%7D)%3B%0A%20%20%20%20%20%20(user%20%3F%20setSelectionUser%20%3A%20setSelection)(pos%2C%20pos)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20clipLine(n)%20%7Breturn%20Math.max(0%2C%20Math.min(n%2C%20doc.size-1))%3B%7D%0A%20%20%20%20function%20clipPos(pos)%20%7B%0A%20%20%20%20%20%20if%20(pos.line%20%3C%200)%20return%20%7Bline%3A%200%2C%20ch%3A%200%7D%3B%0A%20%20%20%20%20%20if%20(pos.line%20%3E%3D%20doc.size)%20return%20%7Bline%3A%20doc.size-1%2C%20ch%3A%20getLine(doc.size-1).text.length%7D%3B%0A%20%20%20%20%20%20var%20ch%20%3D%20pos.ch%2C%20linelen%20%3D%20getLine(pos.line).text.length%3B%0A%20%20%20%20%20%20if%20(ch%20%3D%3D%20null%20%7C%7C%20ch%20%3E%20linelen)%20return%20%7Bline%3A%20pos.line%2C%20ch%3A%20linelen%7D%3B%0A%20%20%20%20%20%20else%20if%20(ch%20%3C%200)%20return%20%7Bline%3A%20pos.line%2C%20ch%3A%200%7D%3B%0A%20%20%20%20%20%20else%20return%20pos%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20findPosH(dir%2C%20unit)%20%7B%0A%20%20%20%20%20%20var%20end%20%3D%20sel.inverted%20%3F%20sel.from%20%3A%20sel.to%2C%20line%20%3D%20end.line%2C%20ch%20%3D%20end.ch%3B%0A%20%20%20%20%20%20var%20lineObj%20%3D%20getLine(line)%3B%0A%20%20%20%20%20%20function%20findNextLine()%20%7B%0A%20%20%20%20%20%20%20%20for%20(var%20l%20%3D%20line%20%2B%20dir%2C%20e%20%3D%20dir%20%3C%200%20%3F%20-1%20%3A%20doc.size%3B%20l%20!%3D%20e%3B%20l%20%2B%3D%20dir)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20lo%20%3D%20getLine(l)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(!lo.hidden)%20%7B%20line%20%3D%20l%3B%20lineObj%20%3D%20lo%3B%20return%20true%3B%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20function%20moveOnce(boundToLine)%20%7B%0A%20%20%20%20%20%20%20%20if%20(ch%20%3D%3D%20(dir%20%3C%200%20%3F%200%20%3A%20lineObj.text.length))%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(!boundToLine%20%26%26%20findNextLine())%20ch%20%3D%20dir%20%3C%200%20%3F%20lineObj.text.length%20%3A%200%3B%0A%20%20%20%20%20%20%20%20%20%20else%20return%20false%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20ch%20%2B%3D%20dir%3B%0A%20%20%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(unit%20%3D%3D%20%22char%22)%20moveOnce()%3B%0A%20%20%20%20%20%20else%20if%20(unit%20%3D%3D%20%22column%22)%20moveOnce(true)%3B%0A%20%20%20%20%20%20else%20if%20(unit%20%3D%3D%20%22word%22)%20%7B%0A%20%20%20%20%20%20%20%20var%20sawWord%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20for%20(%3B%3B)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(dir%20%3C%200)%20if%20(!moveOnce())%20break%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(isWordChar(lineObj.text.charAt(ch)))%20sawWord%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%20%20else%20if%20(sawWord)%20%7Bif%20(dir%20%3C%200)%20%7Bdir%20%3D%201%3B%20moveOnce()%3B%7D%20break%3B%7D%0A%20%20%20%20%20%20%20%20%20%20if%20(dir%20%3E%200)%20if%20(!moveOnce())%20break%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20%7Bline%3A%20line%2C%20ch%3A%20ch%7D%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20moveH(dir%2C%20unit)%20%7B%0A%20%20%20%20%20%20var%20pos%20%3D%20dir%20%3C%200%20%3F%20sel.from%20%3A%20sel.to%3B%0A%20%20%20%20%20%20if%20(shiftSelecting%20%7C%7C%20posEq(sel.from%2C%20sel.to))%20pos%20%3D%20findPosH(dir%2C%20unit)%3B%0A%20%20%20%20%20%20setCursor(pos.line%2C%20pos.ch%2C%20true)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20deleteH(dir%2C%20unit)%20%7B%0A%20%20%20%20%20%20if%20(!posEq(sel.from%2C%20sel.to))%20replaceRange(%22%22%2C%20sel.from%2C%20sel.to)%3B%0A%20%20%20%20%20%20else%20if%20(dir%20%3C%200)%20replaceRange(%22%22%2C%20findPosH(dir%2C%20unit)%2C%20sel.to)%3B%0A%20%20%20%20%20%20else%20replaceRange(%22%22%2C%20sel.from%2C%20findPosH(dir%2C%20unit))%3B%0A%20%20%20%20%20%20userSelChange%20%3D%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20moveV(dir%2C%20unit)%20%7B%0A%20%20%20%20%20%20var%20dist%20%3D%200%2C%20pos%20%3D%20localCoords(sel.inverted%20%3F%20sel.from%20%3A%20sel.to%2C%20true)%3B%0A%20%20%20%20%20%20if%20(goalColumn%20!%3D%20null)%20pos.x%20%3D%20goalColumn%3B%0A%20%20%20%20%20%20if%20(unit%20%3D%3D%20%22page%22)%20%7B%0A%20%20%20%20%20%20%20%20var%20screen%20%3D%20Math.min(scroller.clientHeight%2C%20window.innerHeight%20%7C%7C%20document.documentElement.clientHeight)%3B%0A%20%20%20%20%20%20%20%20var%20target%20%3D%20coordsChar(pos.x%2C%20pos.y%20%2B%20screen%20*%20dir)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(unit%20%3D%3D%20%22line%22)%20%7B%0A%20%20%20%20%20%20%20%20var%20th%20%3D%20textHeight()%3B%0A%20%20%20%20%20%20%20%20var%20target%20%3D%20coordsChar(pos.x%2C%20pos.y%20%2B%20.5%20*%20th%20%2B%20dir%20*%20th)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(unit%20%3D%3D%20%22page%22)%20scrollbar.scrollTop%20%2B%3D%20localCoords(target%2C%20true).y%20-%20pos.y%3B%0A%20%20%20%20%20%20setCursor(target.line%2C%20target.ch%2C%20true)%3B%0A%20%20%20%20%20%20goalColumn%20%3D%20pos.x%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20findWordAt(pos)%20%7B%0A%20%20%20%20%20%20var%20line%20%3D%20getLine(pos.line).text%3B%0A%20%20%20%20%20%20var%20start%20%3D%20pos.ch%2C%20end%20%3D%20pos.ch%3B%0A%20%20%20%20%20%20if%20(line)%20%7B%0A%20%20%20%20%20%20%20%20if%20(pos.after%20%3D%3D%3D%20false%20%7C%7C%20end%20%3D%3D%20line.length)%20--start%3B%20else%20%2B%2Bend%3B%0A%20%20%20%20%20%20%20%20var%20startChar%20%3D%20line.charAt(start)%3B%0A%20%20%20%20%20%20%20%20var%20check%20%3D%20isWordChar(startChar)%20%3F%20isWordChar%20%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%5Cs%2F.test(startChar)%20%3F%20function(ch)%20%7Breturn%20%2F%5Cs%2F.test(ch)%3B%7D%20%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20function(ch)%20%7Breturn%20!%2F%5Cs%2F.test(ch)%20%26%26%20!isWordChar(ch)%3B%7D%3B%0A%20%20%20%20%20%20%20%20while%20(start%20%3E%200%20%26%26%20check(line.charAt(start%20-%201)))%20--start%3B%0A%20%20%20%20%20%20%20%20while%20(end%20%3C%20line.length%20%26%26%20check(line.charAt(end)))%20%2B%2Bend%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20%7Bfrom%3A%20%7Bline%3A%20pos.line%2C%20ch%3A%20start%7D%2C%20to%3A%20%7Bline%3A%20pos.line%2C%20ch%3A%20end%7D%7D%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20selectLine(line)%20%7B%0A%20%20%20%20%20%20setSelectionUser(%7Bline%3A%20line%2C%20ch%3A%200%7D%2C%20clipPos(%7Bline%3A%20line%20%2B%201%2C%20ch%3A%200%7D))%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20indentSelected(mode)%20%7B%0A%20%20%20%20%20%20if%20(posEq(sel.from%2C%20sel.to))%20return%20indentLine(sel.from.line%2C%20mode)%3B%0A%20%20%20%20%20%20var%20e%20%3D%20sel.to.line%20-%20(sel.to.ch%20%3F%200%20%3A%201)%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%20sel.from.line%3B%20i%20%3C%3D%20e%3B%20%2B%2Bi)%20indentLine(i%2C%20mode)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20indentLine(n%2C%20how)%20%7B%0A%20%20%20%20%20%20if%20(!how)%20how%20%3D%20%22add%22%3B%0A%20%20%20%20%20%20if%20(how%20%3D%3D%20%22smart%22)%20%7B%0A%20%20%20%20%20%20%20%20if%20(!mode.indent)%20how%20%3D%20%22prev%22%3B%0A%20%20%20%20%20%20%20%20else%20var%20state%20%3D%20getStateBefore(n)%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20var%20line%20%3D%20getLine(n)%2C%20curSpace%20%3D%20line.indentation(options.tabSize)%2C%0A%20%20%20%20%20%20%20%20%20%20curSpaceString%20%3D%20line.text.match(%2F%5E%5Cs*%2F)%5B0%5D%2C%20indentation%3B%0A%20%20%20%20%20%20if%20(how%20%3D%3D%20%22smart%22)%20%7B%0A%20%20%20%20%20%20%20%20indentation%20%3D%20mode.indent(state%2C%20line.text.slice(curSpaceString.length)%2C%20line.text)%3B%0A%20%20%20%20%20%20%20%20if%20(indentation%20%3D%3D%20Pass)%20how%20%3D%20%22prev%22%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(how%20%3D%3D%20%22prev%22)%20%7B%0A%20%20%20%20%20%20%20%20if%20(n)%20indentation%20%3D%20getLine(n-1).indentation(options.tabSize)%3B%0A%20%20%20%20%20%20%20%20else%20indentation%20%3D%200%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20else%20if%20(how%20%3D%3D%20%22add%22)%20indentation%20%3D%20curSpace%20%2B%20options.indentUnit%3B%0A%20%20%20%20%20%20else%20if%20(how%20%3D%3D%20%22subtract%22)%20indentation%20%3D%20curSpace%20-%20options.indentUnit%3B%0A%20%20%20%20%20%20indentation%20%3D%20Math.max(0%2C%20indentation)%3B%0A%20%20%20%20%20%20var%20diff%20%3D%20indentation%20-%20curSpace%3B%0A%0A%20%20%20%20%20%20var%20indentString%20%3D%20%22%22%2C%20pos%20%3D%200%3B%0A%20%20%20%20%20%20if%20(options.indentWithTabs)%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%20Math.floor(indentation%20%2F%20options.tabSize)%3B%20i%3B%20--i)%20%7Bpos%20%2B%3D%20options.tabSize%3B%20indentString%20%2B%3D%20%22%5Ct%22%3B%7D%0A%20%20%20%20%20%20if%20(pos%20%3C%20indentation)%20indentString%20%2B%3D%20spaceStr(indentation%20-%20pos)%3B%0A%0A%20%20%20%20%20%20if%20(indentString%20!%3D%20curSpaceString)%0A%20%20%20%20%20%20%20%20replaceRange(indentString%2C%20%7Bline%3A%20n%2C%20ch%3A%200%7D%2C%20%7Bline%3A%20n%2C%20ch%3A%20curSpaceString.length%7D)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20loadMode()%20%7B%0A%20%20%20%20%20%20mode%20%3D%20CodeMirror.getMode(options%2C%20options.mode)%3B%0A%20%20%20%20%20%20doc.iter(0%2C%20doc.size%2C%20function(line)%20%7B%20line.stateAfter%20%3D%20null%3B%20%7D)%3B%0A%20%20%20%20%20%20frontier%20%3D%200%3B%0A%20%20%20%20%20%20startWorker(100)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20gutterChanged()%20%7B%0A%20%20%20%20%20%20var%20visible%20%3D%20options.gutter%20%7C%7C%20options.lineNumbers%3B%0A%20%20%20%20%20%20gutter.style.display%20%3D%20visible%20%3F%20%22%22%20%3A%20%22none%22%3B%0A%20%20%20%20%20%20if%20(visible)%20gutterDirty%20%3D%20true%3B%0A%20%20%20%20%20%20else%20lineDiv.parentNode.style.marginLeft%20%3D%200%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20wrappingChanged(from%2C%20to)%20%7B%0A%20%20%20%20%20%20if%20(options.lineWrapping)%20%7B%0A%20%20%20%20%20%20%20%20wrapper.className%20%2B%3D%20%22%20CodeMirror-wrap%22%3B%0A%20%20%20%20%20%20%20%20var%20perLine%20%3D%20scroller.clientWidth%20%2F%20charWidth()%20-%203%3B%0A%20%20%20%20%20%20%20%20doc.iter(0%2C%20doc.size%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(line.hidden)%20return%3B%0A%20%20%20%20%20%20%20%20%20%20var%20guess%20%3D%20Math.ceil(line.text.length%20%2F%20perLine)%20%7C%7C%201%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(guess%20!%3D%201)%20updateLineHeight(line%2C%20guess)%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20lineSpace.style.minWidth%20%3D%20widthForcer.style.left%20%3D%20%22%22%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20wrapper.className%20%3D%20wrapper.className.replace(%22%20CodeMirror-wrap%22%2C%20%22%22)%3B%0A%20%20%20%20%20%20%20%20computeMaxLength()%3B%0A%20%20%20%20%20%20%20%20doc.iter(0%2C%20doc.size%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(line.height%20!%3D%201%20%26%26%20!line.hidden)%20updateLineHeight(line%2C%201)%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20changes.push(%7Bfrom%3A%200%2C%20to%3A%20doc.size%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20themeChanged()%20%7B%0A%20%20%20%20%20%20scroller.className%20%3D%20scroller.className.replace(%2F%5Cs*cm-s-%5CS%2B%2Fg%2C%20%22%22)%20%2B%0A%20%20%20%20%20%20%20%20options.theme.replace(%2F(%5E%7C%5Cs)%5Cs*%2Fg%2C%20%22%20cm-s-%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20keyMapChanged()%20%7B%0A%20%20%20%20%20%20var%20style%20%3D%20keyMap%5Boptions.keyMap%5D.style%3B%0A%20%20%20%20%20%20wrapper.className%20%3D%20wrapper.className.replace(%2F%5Cs*cm-keymap-%5CS%2B%2Fg%2C%20%22%22)%20%2B%0A%20%20%20%20%20%20%20%20(style%20%3F%20%22%20cm-keymap-%22%20%2B%20style%20%3A%20%22%22)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20TextMarker(type%2C%20style)%20%7B%20this.lines%20%3D%20%5B%5D%3B%20this.type%20%3D%20type%3B%20if%20(style)%20this.style%20%3D%20style%3B%20%7D%0A%20%20%20%20TextMarker.prototype.clear%20%3D%20operation(function()%20%7B%0A%20%20%20%20%20%20var%20min%20%3D%20Infinity%2C%20max%20%3D%20-Infinity%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20this.lines.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20line%20%3D%20this.lines%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20var%20span%20%3D%20getMarkedSpanFor(line.markedSpans%2C%20this%2C%20true)%3B%0A%20%20%20%20%20%20%20%20if%20(span.from%20!%3D%20null%20%7C%7C%20span.to%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20lineN%20%3D%20lineNo(line)%3B%0A%20%20%20%20%20%20%20%20%20%20min%20%3D%20Math.min(min%2C%20lineN)%3B%20max%20%3D%20Math.max(max%2C%20lineN)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(min%20!%3D%20Infinity)%0A%20%20%20%20%20%20%20%20changes.push(%7Bfrom%3A%20min%2C%20to%3A%20max%20%2B%201%7D)%3B%0A%20%20%20%20%20%20this.lines.length%20%3D%200%3B%0A%20%20%20%20%7D)%3B%0A%20%20%20%20TextMarker.prototype.find%20%3D%20function()%20%7B%0A%20%20%20%20%20%20var%20from%2C%20to%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20this.lines.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20line%20%3D%20this.lines%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20var%20span%20%3D%20getMarkedSpanFor(line.markedSpans%2C%20this)%3B%0A%20%20%20%20%20%20%20%20if%20(span.from%20!%3D%20null%20%7C%7C%20span.to%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20found%20%3D%20lineNo(line)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(span.from%20!%3D%20null)%20from%20%3D%20%7Bline%3A%20found%2C%20ch%3A%20span.from%7D%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(span.to%20!%3D%20null)%20to%20%3D%20%7Bline%3A%20found%2C%20ch%3A%20span.to%7D%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(this.type%20%3D%3D%20%22bookmark%22)%20return%20from%3B%0A%20%20%20%20%20%20return%20from%20%26%26%20%7Bfrom%3A%20from%2C%20to%3A%20to%7D%3B%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20function%20markText(from%2C%20to%2C%20className%2C%20options)%20%7B%0A%20%20%20%20%20%20from%20%3D%20clipPos(from)%3B%20to%20%3D%20clipPos(to)%3B%0A%20%20%20%20%20%20var%20marker%20%3D%20new%20TextMarker(%22range%22%2C%20className)%3B%0A%20%20%20%20%20%20if%20(options)%20for%20(var%20opt%20in%20options)%20if%20(options.hasOwnProperty(opt))%0A%20%20%20%20%20%20%20%20marker%5Bopt%5D%20%3D%20options%5Bopt%5D%3B%0A%20%20%20%20%20%20var%20curLine%20%3D%20from.line%3B%0A%20%20%20%20%20%20doc.iter(curLine%2C%20to.line%20%2B%201%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20var%20span%20%3D%20%7Bfrom%3A%20curLine%20%3D%3D%20from.line%20%3F%20from.ch%20%3A%20null%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20to%3A%20curLine%20%3D%3D%20to.line%20%3F%20to.ch%20%3A%20null%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20marker%3A%20marker%7D%3B%0A%20%20%20%20%20%20%20%20(line.markedSpans%20%7C%7C%20(line.markedSpans%20%3D%20%5B%5D)).push(span)%3B%0A%20%20%20%20%20%20%20%20marker.lines.push(line)%3B%0A%20%20%20%20%20%20%20%20%2B%2BcurLine%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20changes.push(%7Bfrom%3A%20from.line%2C%20to%3A%20to.line%20%2B%201%7D)%3B%0A%20%20%20%20%20%20return%20marker%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20setBookmark(pos)%20%7B%0A%20%20%20%20%20%20pos%20%3D%20clipPos(pos)%3B%0A%20%20%20%20%20%20var%20marker%20%3D%20new%20TextMarker(%22bookmark%22)%2C%20line%20%3D%20getLine(pos.line)%3B%0A%20%20%20%20%20%20var%20span%20%3D%20%7Bfrom%3A%20pos.ch%2C%20to%3A%20pos.ch%2C%20marker%3A%20marker%7D%3B%0A%20%20%20%20%20%20(line.markedSpans%20%7C%7C%20(line.markedSpans%20%3D%20%5B%5D)).push(span)%3B%0A%20%20%20%20%20%20marker.lines.push(line)%3B%0A%20%20%20%20%20%20return%20marker%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20findMarksAt(pos)%20%7B%0A%20%20%20%20%20%20pos%20%3D%20clipPos(pos)%3B%0A%20%20%20%20%20%20var%20markers%20%3D%20%5B%5D%2C%20spans%20%3D%20getLine(pos.line).markedSpans%3B%0A%20%20%20%20%20%20if%20(spans)%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20spans.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20span%20%3D%20spans%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20if%20((span.from%20%3D%3D%20null%20%7C%7C%20span.from%20%3C%3D%20pos.ch)%20%26%26%0A%20%20%20%20%20%20%20%20%20%20%20%20(span.to%20%3D%3D%20null%20%7C%7C%20span.to%20%3E%3D%20pos.ch))%0A%20%20%20%20%20%20%20%20%20%20markers.push(span.marker)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20markers%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20addGutterMarker(line%2C%20text%2C%20className)%20%7B%0A%20%20%20%20%20%20if%20(typeof%20line%20%3D%3D%20%22number%22)%20line%20%3D%20getLine(clipLine(line))%3B%0A%20%20%20%20%20%20line.gutterMarker%20%3D%20%7Btext%3A%20text%2C%20style%3A%20className%7D%3B%0A%20%20%20%20%20%20gutterDirty%20%3D%20true%3B%0A%20%20%20%20%20%20return%20line%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20removeGutterMarker(line)%20%7B%0A%20%20%20%20%20%20if%20(typeof%20line%20%3D%3D%20%22number%22)%20line%20%3D%20getLine(clipLine(line))%3B%0A%20%20%20%20%20%20line.gutterMarker%20%3D%20null%3B%0A%20%20%20%20%20%20gutterDirty%20%3D%20true%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20changeLine(handle%2C%20op)%20%7B%0A%20%20%20%20%20%20var%20no%20%3D%20handle%2C%20line%20%3D%20handle%3B%0A%20%20%20%20%20%20if%20(typeof%20handle%20%3D%3D%20%22number%22)%20line%20%3D%20getLine(clipLine(handle))%3B%0A%20%20%20%20%20%20else%20no%20%3D%20lineNo(handle)%3B%0A%20%20%20%20%20%20if%20(no%20%3D%3D%20null)%20return%20null%3B%0A%20%20%20%20%20%20if%20(op(line%2C%20no))%20changes.push(%7Bfrom%3A%20no%2C%20to%3A%20no%20%2B%201%7D)%3B%0A%20%20%20%20%20%20else%20return%20null%3B%0A%20%20%20%20%20%20return%20line%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20setLineClass(handle%2C%20className%2C%20bgClassName)%20%7B%0A%20%20%20%20%20%20return%20changeLine(handle%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20if%20(line.className%20!%3D%20className%20%7C%7C%20line.bgClassName%20!%3D%20bgClassName)%20%7B%0A%20%20%20%20%20%20%20%20%20%20line.className%20%3D%20className%3B%0A%20%20%20%20%20%20%20%20%20%20line.bgClassName%20%3D%20bgClassName%3B%0A%20%20%20%20%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20setLineHidden(handle%2C%20hidden)%20%7B%0A%20%20%20%20%20%20return%20changeLine(handle%2C%20function(line%2C%20no)%20%7B%0A%20%20%20%20%20%20%20%20if%20(line.hidden%20!%3D%20hidden)%20%7B%0A%20%20%20%20%20%20%20%20%20%20line.hidden%20%3D%20hidden%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(!options.lineWrapping)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(hidden%20%26%26%20line.text.length%20%3D%3D%20maxLine.text.length)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20updateMaxLine%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(!hidden%20%26%26%20line.text.length%20%3E%20maxLine.text.length)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20maxLine%20%3D%20line%3B%20updateMaxLine%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20updateLineHeight(line%2C%20hidden%20%3F%200%20%3A%201)%3B%0A%20%20%20%20%20%20%20%20%20%20var%20fline%20%3D%20sel.from.line%2C%20tline%20%3D%20sel.to.line%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(hidden%20%26%26%20(fline%20%3D%3D%20no%20%7C%7C%20tline%20%3D%3D%20no))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20from%20%3D%20fline%20%3D%3D%20no%20%3F%20skipHidden(%7Bline%3A%20fline%2C%20ch%3A%200%7D%2C%20fline%2C%200)%20%3A%20sel.from%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20to%20%3D%20tline%20%3D%3D%20no%20%3F%20skipHidden(%7Bline%3A%20tline%2C%20ch%3A%200%7D%2C%20tline%2C%200)%20%3A%20sel.to%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20Can't%20hide%20the%20last%20visible%20line%2C%20we'd%20have%20no%20place%20to%20put%20the%20cursor%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(!to)%20return%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20setSelection(from%2C%20to)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20return%20(gutterDirty%20%3D%20true)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20lineInfo(line)%20%7B%0A%20%20%20%20%20%20if%20(typeof%20line%20%3D%3D%20%22number%22)%20%7B%0A%20%20%20%20%20%20%20%20if%20(!isLine(line))%20return%20null%3B%0A%20%20%20%20%20%20%20%20var%20n%20%3D%20line%3B%0A%20%20%20%20%20%20%20%20line%20%3D%20getLine(line)%3B%0A%20%20%20%20%20%20%20%20if%20(!line)%20return%20null%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20var%20n%20%3D%20lineNo(line)%3B%0A%20%20%20%20%20%20%20%20if%20(n%20%3D%3D%20null)%20return%20null%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20marker%20%3D%20line.gutterMarker%3B%0A%20%20%20%20%20%20return%20%7Bline%3A%20n%2C%20handle%3A%20line%2C%20text%3A%20line.text%2C%20markerText%3A%20marker%20%26%26%20marker.text%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20markerClass%3A%20marker%20%26%26%20marker.style%2C%20lineClass%3A%20line.className%2C%20bgClass%3A%20line.bgClassName%7D%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20measureLine(line%2C%20ch)%20%7B%0A%20%20%20%20%20%20if%20(ch%20%3D%3D%200)%20return%20%7Btop%3A%200%2C%20left%3A%200%7D%3B%0A%20%20%20%20%20%20var%20wbr%20%3D%20options.lineWrapping%20%26%26%20ch%20%3C%20line.text.length%20%26%26%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20spanAffectsWrapping.test(line.text.slice(ch%20-%201%2C%20ch%20%2B%201))%3B%0A%20%20%20%20%20%20var%20pre%20%3D%20lineContent(line%2C%20ch)%3B%0A%20%20%20%20%20%20removeChildrenAndAdd(measure%2C%20pre)%3B%0A%20%20%20%20%20%20var%20anchor%20%3D%20pre.anchor%3B%0A%20%20%20%20%20%20var%20top%20%3D%20anchor.offsetTop%2C%20left%20%3D%20anchor.offsetLeft%3B%0A%20%20%20%20%20%20%2F%2F%20Older%20IEs%20report%20zero%20offsets%20for%20spans%20directly%20after%20a%20wrap%0A%20%20%20%20%20%20if%20(ie%20%26%26%20top%20%3D%3D%200%20%26%26%20left%20%3D%3D%200)%20%7B%0A%20%20%20%20%20%20%20%20var%20backup%20%3D%20elt(%22span%22%2C%20%22x%22)%3B%0A%20%20%20%20%20%20%20%20anchor.parentNode.insertBefore(backup%2C%20anchor.nextSibling)%3B%0A%20%20%20%20%20%20%20%20top%20%3D%20backup.offsetTop%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20%7Btop%3A%20top%2C%20left%3A%20left%7D%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20localCoords(pos%2C%20inLineWrap)%20%7B%0A%20%20%20%20%20%20var%20x%2C%20lh%20%3D%20textHeight()%2C%20y%20%3D%20lh%20*%20(heightAtLine(doc%2C%20pos.line)%20-%20(inLineWrap%20%3F%20displayOffset%20%3A%200))%3B%0A%20%20%20%20%20%20if%20(pos.ch%20%3D%3D%200)%20x%20%3D%200%3B%0A%20%20%20%20%20%20else%20%7B%0A%20%20%20%20%20%20%20%20var%20sp%20%3D%20measureLine(getLine(pos.line)%2C%20pos.ch)%3B%0A%20%20%20%20%20%20%20%20x%20%3D%20sp.left%3B%0A%20%20%20%20%20%20%20%20if%20(options.lineWrapping)%20y%20%2B%3D%20Math.max(0%2C%20sp.top)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20%7Bx%3A%20x%2C%20y%3A%20y%2C%20yBot%3A%20y%20%2B%20lh%7D%3B%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20Coords%20must%20be%20lineSpace-local%0A%20%20%20%20function%20coordsChar(x%2C%20y)%20%7B%0A%20%20%20%20%20%20var%20th%20%3D%20textHeight()%2C%20cw%20%3D%20charWidth()%2C%20heightPos%20%3D%20displayOffset%20%2B%20Math.floor(y%20%2F%20th)%3B%0A%20%20%20%20%20%20if%20(heightPos%20%3C%200)%20return%20%7Bline%3A%200%2C%20ch%3A%200%7D%3B%0A%20%20%20%20%20%20var%20lineNo%20%3D%20lineAtHeight(doc%2C%20heightPos)%3B%0A%20%20%20%20%20%20if%20(lineNo%20%3E%3D%20doc.size)%20return%20%7Bline%3A%20doc.size%20-%201%2C%20ch%3A%20getLine(doc.size%20-%201).text.length%7D%3B%0A%20%20%20%20%20%20var%20lineObj%20%3D%20getLine(lineNo)%2C%20text%20%3D%20lineObj.text%3B%0A%20%20%20%20%20%20var%20tw%20%3D%20options.lineWrapping%2C%20innerOff%20%3D%20tw%20%3F%20heightPos%20-%20heightAtLine(doc%2C%20lineNo)%20%3A%200%3B%0A%20%20%20%20%20%20if%20(x%20%3C%3D%200%20%26%26%20innerOff%20%3D%3D%200)%20return%20%7Bline%3A%20lineNo%2C%20ch%3A%200%7D%3B%0A%20%20%20%20%20%20var%20wrongLine%20%3D%20false%3B%0A%20%20%20%20%20%20function%20getX(len)%20%7B%0A%20%20%20%20%20%20%20%20var%20sp%20%3D%20measureLine(lineObj%2C%20len)%3B%0A%20%20%20%20%20%20%20%20if%20(tw)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20off%20%3D%20Math.round(sp.top%20%2F%20th)%3B%0A%20%20%20%20%20%20%20%20%20%20wrongLine%20%3D%20off%20!%3D%20innerOff%3B%0A%20%20%20%20%20%20%20%20%20%20return%20Math.max(0%2C%20sp.left%20%2B%20(off%20-%20innerOff)%20*%20scroller.clientWidth)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20return%20sp.left%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20from%20%3D%200%2C%20fromX%20%3D%200%2C%20to%20%3D%20text.length%2C%20toX%3B%0A%20%20%20%20%20%20%2F%2F%20Guess%20a%20suitable%20upper%20bound%20for%20our%20search.%0A%20%20%20%20%20%20var%20estimated%20%3D%20Math.min(to%2C%20Math.ceil((x%20%2B%20innerOff%20*%20scroller.clientWidth%20*%20.9)%20%2F%20cw))%3B%0A%20%20%20%20%20%20for%20(%3B%3B)%20%7B%0A%20%20%20%20%20%20%20%20var%20estX%20%3D%20getX(estimated)%3B%0A%20%20%20%20%20%20%20%20if%20(estX%20%3C%3D%20x%20%26%26%20estimated%20%3C%20to)%20estimated%20%3D%20Math.min(to%2C%20Math.ceil(estimated%20*%201.2))%3B%0A%20%20%20%20%20%20%20%20else%20%7BtoX%20%3D%20estX%3B%20to%20%3D%20estimated%3B%20break%3B%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(x%20%3E%20toX)%20return%20%7Bline%3A%20lineNo%2C%20ch%3A%20to%7D%3B%0A%20%20%20%20%20%20%2F%2F%20Try%20to%20guess%20a%20suitable%20lower%20bound%20as%20well.%0A%20%20%20%20%20%20estimated%20%3D%20Math.floor(to%20*%200.8)%3B%20estX%20%3D%20getX(estimated)%3B%0A%20%20%20%20%20%20if%20(estX%20%3C%20x)%20%7Bfrom%20%3D%20estimated%3B%20fromX%20%3D%20estX%3B%7D%0A%20%20%20%20%20%20%2F%2F%20Do%20a%20binary%20search%20between%20these%20bounds.%0A%20%20%20%20%20%20for%20(%3B%3B)%20%7B%0A%20%20%20%20%20%20%20%20if%20(to%20-%20from%20%3C%3D%201)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20after%20%3D%20x%20-%20fromX%20%3C%20toX%20-%20x%3B%0A%20%20%20%20%20%20%20%20%20%20return%20%7Bline%3A%20lineNo%2C%20ch%3A%20after%20%3F%20from%20%3A%20to%2C%20after%3A%20after%7D%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20var%20middle%20%3D%20Math.ceil((from%20%2B%20to)%20%2F%202)%2C%20middleX%20%3D%20getX(middle)%3B%0A%20%20%20%20%20%20%20%20if%20(middleX%20%3E%20x)%20%7Bto%20%3D%20middle%3B%20toX%20%3D%20middleX%3B%20if%20(wrongLine)%20toX%20%2B%3D%201000%3B%20%7D%0A%20%20%20%20%20%20%20%20else%20%7Bfrom%20%3D%20middle%3B%20fromX%20%3D%20middleX%3B%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20function%20pageCoords(pos)%20%7B%0A%20%20%20%20%20%20var%20local%20%3D%20localCoords(pos%2C%20true)%2C%20off%20%3D%20eltOffset(lineSpace)%3B%0A%20%20%20%20%20%20return%20%7Bx%3A%20off.left%20%2B%20local.x%2C%20y%3A%20off.top%20%2B%20local.y%2C%20yBot%3A%20off.top%20%2B%20local.yBot%7D%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20var%20cachedHeight%2C%20cachedHeightFor%2C%20measurePre%3B%0A%20%20%20%20function%20textHeight()%20%7B%0A%20%20%20%20%20%20if%20(measurePre%20%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20measurePre%20%3D%20elt(%22pre%22)%3B%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%2049%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20%20%20measurePre.appendChild(document.createTextNode(%22x%22))%3B%0A%20%20%20%20%20%20%20%20%20%20measurePre.appendChild(elt(%22br%22))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20measurePre.appendChild(document.createTextNode(%22x%22))%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20offsetHeight%20%3D%20lineDiv.clientHeight%3B%0A%20%20%20%20%20%20if%20(offsetHeight%20%3D%3D%20cachedHeightFor)%20return%20cachedHeight%3B%0A%20%20%20%20%20%20cachedHeightFor%20%3D%20offsetHeight%3B%0A%20%20%20%20%20%20removeChildrenAndAdd(measure%2C%20measurePre.cloneNode(true))%3B%0A%20%20%20%20%20%20cachedHeight%20%3D%20measure.firstChild.offsetHeight%20%2F%2050%20%7C%7C%201%3B%0A%20%20%20%20%20%20removeChildren(measure)%3B%0A%20%20%20%20%20%20return%20cachedHeight%3B%0A%20%20%20%20%7D%0A%20%20%20%20var%20cachedWidth%2C%20cachedWidthFor%20%3D%200%3B%0A%20%20%20%20function%20charWidth()%20%7B%0A%20%20%20%20%20%20if%20(scroller.clientWidth%20%3D%3D%20cachedWidthFor)%20return%20cachedWidth%3B%0A%20%20%20%20%20%20cachedWidthFor%20%3D%20scroller.clientWidth%3B%0A%20%20%20%20%20%20var%20anchor%20%3D%20elt(%22span%22%2C%20%22x%22)%3B%0A%20%20%20%20%20%20var%20pre%20%3D%20elt(%22pre%22%2C%20%5Banchor%5D)%3B%0A%20%20%20%20%20%20removeChildrenAndAdd(measure%2C%20pre)%3B%0A%20%20%20%20%20%20return%20(cachedWidth%20%3D%20anchor.offsetWidth%20%7C%7C%2010)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20paddingTop()%20%7Breturn%20lineSpace.offsetTop%3B%7D%0A%20%20%20%20function%20paddingLeft()%20%7Breturn%20lineSpace.offsetLeft%3B%7D%0A%0A%20%20%20%20function%20posFromMouse(e%2C%20liberal)%20%7B%0A%20%20%20%20%20%20var%20offW%20%3D%20eltOffset(scroller%2C%20true)%2C%20x%2C%20y%3B%0A%20%20%20%20%20%20%2F%2F%20Fails%20unpredictably%20on%20IE%5B67%5D%20when%20mouse%20is%20dragged%20around%20quickly.%0A%20%20%20%20%20%20try%20%7B%20x%20%3D%20e.clientX%3B%20y%20%3D%20e.clientY%3B%20%7D%20catch%20(e)%20%7B%20return%20null%3B%20%7D%0A%20%20%20%20%20%20%2F%2F%20This%20is%20a%20mess%20of%20a%20heuristic%20to%20try%20and%20determine%20whether%20a%0A%20%20%20%20%20%20%2F%2F%20scroll-bar%20was%20clicked%20or%20not%2C%20and%20to%20return%20null%20if%20one%20was%0A%20%20%20%20%20%20%2F%2F%20(and%20!liberal).%0A%20%20%20%20%20%20if%20(!liberal%20%26%26%20(x%20-%20offW.left%20%3E%20scroller.clientWidth%20%7C%7C%20y%20-%20offW.top%20%3E%20scroller.clientHeight))%0A%20%20%20%20%20%20%20%20return%20null%3B%0A%20%20%20%20%20%20var%20offL%20%3D%20eltOffset(lineSpace%2C%20true)%3B%0A%20%20%20%20%20%20return%20coordsChar(x%20-%20offL.left%2C%20y%20-%20offL.top)%3B%0A%20%20%20%20%7D%0A%20%20%20%20var%20detectingSelectAll%3B%0A%20%20%20%20function%20onContextMenu(e)%20%7B%0A%20%20%20%20%20%20var%20pos%20%3D%20posFromMouse(e)%2C%20scrollPos%20%3D%20scrollbar.scrollTop%3B%0A%20%20%20%20%20%20if%20(!pos%20%7C%7C%20opera)%20return%3B%20%2F%2F%20Opera%20is%20difficult.%0A%20%20%20%20%20%20if%20(posEq(sel.from%2C%20sel.to)%20%7C%7C%20posLess(pos%2C%20sel.from)%20%7C%7C%20!posLess(pos%2C%20sel.to))%0A%20%20%20%20%20%20%20%20operation(setCursor)(pos.line%2C%20pos.ch)%3B%0A%0A%20%20%20%20%20%20var%20oldCSS%20%3D%20input.style.cssText%3B%0A%20%20%20%20%20%20inputDiv.style.position%20%3D%20%22absolute%22%3B%0A%20%20%20%20%20%20input.style.cssText%20%3D%20%22position%3A%20fixed%3B%20width%3A%2030px%3B%20height%3A%2030px%3B%20top%3A%20%22%20%2B%20(e.clientY%20-%205)%20%2B%0A%20%20%20%20%20%20%20%20%22px%3B%20left%3A%20%22%20%2B%20(e.clientX%20-%205)%20%2B%20%22px%3B%20z-index%3A%201000%3B%20background%3A%20white%3B%20%22%20%2B%0A%20%20%20%20%20%20%20%20%22border-width%3A%200%3B%20outline%3A%20none%3B%20overflow%3A%20hidden%3B%20opacity%3A%20.05%3B%20filter%3A%20alpha(opacity%3D5)%3B%22%3B%0A%20%20%20%20%20%20focusInput()%3B%0A%20%20%20%20%20%20resetInput(true)%3B%0A%20%20%20%20%20%20%2F%2F%20Adds%20%22Select%20all%22%20to%20context%20menu%20in%20FF%0A%20%20%20%20%20%20if%20(posEq(sel.from%2C%20sel.to))%20input.value%20%3D%20prevInput%20%3D%20%22%20%22%3B%0A%0A%20%20%20%20%20%20function%20rehide()%20%7B%0A%20%20%20%20%20%20%20%20inputDiv.style.position%20%3D%20%22relative%22%3B%0A%20%20%20%20%20%20%20%20input.style.cssText%20%3D%20oldCSS%3B%0A%20%20%20%20%20%20%20%20if%20(ie_lt9)%20scrollbar.scrollTop%20%3D%20scrollPos%3B%0A%20%20%20%20%20%20%20%20slowPoll()%3B%0A%0A%20%20%20%20%20%20%20%20%2F%2F%20Try%20to%20detect%20the%20user%20choosing%20select-all%20%0A%20%20%20%20%20%20%20%20if%20(input.selectionStart%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20clearTimeout(detectingSelectAll)%3B%0A%20%20%20%20%20%20%20%20%20%20var%20extval%20%3D%20input.value%20%3D%20%22%20%22%20%2B%20(posEq(sel.from%2C%20sel.to)%20%3F%20%22%22%20%3A%20input.value)%2C%20i%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%20%20prevInput%20%3D%20%22%20%22%3B%0A%20%20%20%20%20%20%20%20%20%20input.selectionStart%20%3D%201%3B%20input.selectionEnd%20%3D%20extval.length%3B%0A%20%20%20%20%20%20%20%20%20%20detectingSelectAll%20%3D%20setTimeout(function%20poll()%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(prevInput%20%3D%3D%20%22%20%22%20%26%26%20input.selectionStart%20%3D%3D%200)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20operation(commands.selectAll)(instance)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20else%20if%20(i%2B%2B%20%3C%2010)%20detectingSelectAll%20%3D%20setTimeout(poll%2C%20500)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20else%20resetInput()%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%2C%20200)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20if%20(gecko)%20%7B%0A%20%20%20%20%20%20%20%20e_stop(e)%3B%0A%20%20%20%20%20%20%20%20var%20mouseup%20%3D%20connect(window%2C%20%22mouseup%22%2C%20function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20mouseup()%3B%0A%20%20%20%20%20%20%20%20%20%20setTimeout(rehide%2C%2020)%3B%0A%20%20%20%20%20%20%20%20%7D%2C%20true)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20setTimeout(rehide%2C%2050)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20%2F%2F%20Cursor-blinking%0A%20%20%20%20function%20restartBlink()%20%7B%0A%20%20%20%20%20%20clearInterval(blinker)%3B%0A%20%20%20%20%20%20var%20on%20%3D%20true%3B%0A%20%20%20%20%20%20cursor.style.visibility%20%3D%20%22%22%3B%0A%20%20%20%20%20%20blinker%20%3D%20setInterval(function()%20%7B%0A%20%20%20%20%20%20%20%20cursor.style.visibility%20%3D%20(on%20%3D%20!on)%20%3F%20%22%22%20%3A%20%22hidden%22%3B%0A%20%20%20%20%20%20%7D%2C%20options.cursorBlinkRate)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20var%20matching%20%3D%20%7B%22(%22%3A%20%22)%3E%22%2C%20%22)%22%3A%20%22(%3C%22%2C%20%22%5B%22%3A%20%22%5D%3E%22%2C%20%22%5D%22%3A%20%22%5B%3C%22%2C%20%22%7B%22%3A%20%22%7D%3E%22%2C%20%22%7D%22%3A%20%22%7B%3C%22%7D%3B%0A%20%20%20%20function%20matchBrackets(autoclear)%20%7B%0A%20%20%20%20%20%20var%20head%20%3D%20sel.inverted%20%3F%20sel.from%20%3A%20sel.to%2C%20line%20%3D%20getLine(head.line)%2C%20pos%20%3D%20head.ch%20-%201%3B%0A%20%20%20%20%20%20var%20match%20%3D%20(pos%20%3E%3D%200%20%26%26%20matching%5Bline.text.charAt(pos)%5D)%20%7C%7C%20matching%5Bline.text.charAt(%2B%2Bpos)%5D%3B%0A%20%20%20%20%20%20if%20(!match)%20return%3B%0A%20%20%20%20%20%20var%20ch%20%3D%20match.charAt(0)%2C%20forward%20%3D%20match.charAt(1)%20%3D%3D%20%22%3E%22%2C%20d%20%3D%20forward%20%3F%201%20%3A%20-1%2C%20st%20%3D%20line.styles%3B%0A%20%20%20%20%20%20for%20(var%20off%20%3D%20pos%20%2B%201%2C%20i%20%3D%200%2C%20e%20%3D%20st.length%3B%20i%20%3C%20e%3B%20i%2B%3D2)%0A%20%20%20%20%20%20%20%20if%20((off%20-%3D%20st%5Bi%5D.length)%20%3C%3D%200)%20%7Bvar%20style%20%3D%20st%5Bi%2B1%5D%3B%20break%3B%7D%0A%0A%20%20%20%20%20%20var%20stack%20%3D%20%5Bline.text.charAt(pos)%5D%2C%20re%20%3D%20%2F%5B()%7B%7D%5B%5C%5D%5D%2F%3B%0A%20%20%20%20%20%20function%20scan(line%2C%20from%2C%20to)%20%7B%0A%20%20%20%20%20%20%20%20if%20(!line.text)%20return%3B%0A%20%20%20%20%20%20%20%20var%20st%20%3D%20line.styles%2C%20pos%20%3D%20forward%20%3F%200%20%3A%20line.text.length%20-%201%2C%20cur%3B%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%20forward%20%3F%200%20%3A%20st.length%20-%202%2C%20e%20%3D%20forward%20%3F%20st.length%20%3A%20-2%3B%20i%20!%3D%20e%3B%20i%20%2B%3D%202*d)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20text%20%3D%20st%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(st%5Bi%2B1%5D%20!%3D%20style)%20%7Bpos%20%2B%3D%20d%20*%20text.length%3B%20continue%3B%7D%0A%20%20%20%20%20%20%20%20%20%20for%20(var%20j%20%3D%20forward%20%3F%200%20%3A%20text.length%20-%201%2C%20te%20%3D%20forward%20%3F%20text.length%20%3A%20-1%3B%20j%20!%3D%20te%3B%20j%20%2B%3D%20d%2C%20pos%2B%3Dd)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(pos%20%3E%3D%20from%20%26%26%20pos%20%3C%20to%20%26%26%20re.test(cur%20%3D%20text.charAt(j)))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20match%20%3D%20matching%5Bcur%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(match.charAt(1)%20%3D%3D%20%22%3E%22%20%3D%3D%20forward)%20stack.push(cur)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20if%20(stack.pop()%20!%3D%20match.charAt(0))%20return%20%7Bpos%3A%20pos%2C%20match%3A%20false%7D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20else%20if%20(!stack.length)%20return%20%7Bpos%3A%20pos%2C%20match%3A%20true%7D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20for%20(var%20i%20%3D%20head.line%2C%20e%20%3D%20forward%20%3F%20Math.min(i%20%2B%20100%2C%20doc.size)%20%3A%20Math.max(-1%2C%20i%20-%20100)%3B%20i%20!%3D%20e%3B%20i%2B%3Dd)%20%7B%0A%20%20%20%20%20%20%20%20var%20line%20%3D%20getLine(i)%2C%20first%20%3D%20i%20%3D%3D%20head.line%3B%0A%20%20%20%20%20%20%20%20var%20found%20%3D%20scan(line%2C%20first%20%26%26%20forward%20%3F%20pos%20%2B%201%20%3A%200%2C%20first%20%26%26%20!forward%20%3F%20pos%20%3A%20line.text.length)%3B%0A%20%20%20%20%20%20%20%20if%20(found)%20break%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(!found)%20found%20%3D%20%7Bpos%3A%20null%2C%20match%3A%20false%7D%3B%0A%20%20%20%20%20%20var%20style%20%3D%20found.match%20%3F%20%22CodeMirror-matchingbracket%22%20%3A%20%22CodeMirror-nonmatchingbracket%22%3B%0A%20%20%20%20%20%20var%20one%20%3D%20markText(%7Bline%3A%20head.line%2C%20ch%3A%20pos%7D%2C%20%7Bline%3A%20head.line%2C%20ch%3A%20pos%2B1%7D%2C%20style)%2C%0A%20%20%20%20%20%20%20%20%20%20two%20%3D%20found.pos%20!%3D%20null%20%26%26%20markText(%7Bline%3A%20i%2C%20ch%3A%20found.pos%7D%2C%20%7Bline%3A%20i%2C%20ch%3A%20found.pos%20%2B%201%7D%2C%20style)%3B%0A%20%20%20%20%20%20var%20clear%20%3D%20operation(function()%7Bone.clear()%3B%20two%20%26%26%20two.clear()%3B%7D)%3B%0A%20%20%20%20%20%20if%20(autoclear)%20setTimeout(clear%2C%20800)%3B%0A%20%20%20%20%20%20else%20bracketHighlighted%20%3D%20clear%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20%2F%2F%20Finds%20the%20line%20to%20start%20with%20when%20starting%20a%20parse.%20Tries%20to%0A%20%20%20%20%2F%2F%20find%20a%20line%20with%20a%20stateAfter%2C%20so%20that%20it%20can%20start%20with%20a%0A%20%20%20%20%2F%2F%20valid%20state.%20If%20that%20fails%2C%20it%20returns%20the%20line%20with%20the%0A%20%20%20%20%2F%2F%20smallest%20indentation%2C%20which%20tends%20to%20need%20the%20least%20context%20to%0A%20%20%20%20%2F%2F%20parse%20correctly.%0A%20%20%20%20function%20findStartLine(n)%20%7B%0A%20%20%20%20%20%20var%20minindent%2C%20minline%3B%0A%20%20%20%20%20%20for%20(var%20search%20%3D%20n%2C%20lim%20%3D%20n%20-%2040%3B%20search%20%3E%20lim%3B%20--search)%20%7B%0A%20%20%20%20%20%20%20%20if%20(search%20%3D%3D%200)%20return%200%3B%0A%20%20%20%20%20%20%20%20var%20line%20%3D%20getLine(search-1)%3B%0A%20%20%20%20%20%20%20%20if%20(line.stateAfter)%20return%20search%3B%0A%20%20%20%20%20%20%20%20var%20indented%20%3D%20line.indentation(options.tabSize)%3B%0A%20%20%20%20%20%20%20%20if%20(minline%20%3D%3D%20null%20%7C%7C%20minindent%20%3E%20indented)%20%7B%0A%20%20%20%20%20%20%20%20%20%20minline%20%3D%20search%20-%201%3B%0A%20%20%20%20%20%20%20%20%20%20minindent%20%3D%20indented%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20minline%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20getStateBefore(n)%20%7B%0A%20%20%20%20%20%20var%20pos%20%3D%20findStartLine(n)%2C%20state%20%3D%20pos%20%26%26%20getLine(pos-1).stateAfter%3B%0A%20%20%20%20%20%20if%20(!state)%20state%20%3D%20startState(mode)%3B%0A%20%20%20%20%20%20else%20state%20%3D%20copyState(mode%2C%20state)%3B%0A%20%20%20%20%20%20doc.iter(pos%2C%20n%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20line.process(mode%2C%20state%2C%20options.tabSize)%3B%0A%20%20%20%20%20%20%20%20line.stateAfter%20%3D%20(pos%20%3D%3D%20n%20-%201%20%7C%7C%20pos%20%25%205%20%3D%3D%200)%20%3F%20copyState(mode%2C%20state)%20%3A%20null%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20return%20state%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20highlightWorker()%20%7B%0A%20%20%20%20%20%20if%20(frontier%20%3E%3D%20showingTo)%20return%3B%0A%20%20%20%20%20%20var%20end%20%3D%20%2Bnew%20Date%20%2B%20options.workTime%2C%20state%20%3D%20copyState(mode%2C%20getStateBefore(frontier))%3B%0A%20%20%20%20%20%20var%20startFrontier%20%3D%20frontier%3B%0A%20%20%20%20%20%20doc.iter(frontier%2C%20showingTo%2C%20function(line)%20%7B%0A%20%20%20%20%20%20%20%20if%20(frontier%20%3E%3D%20showingFrom)%20%7B%20%2F%2F%20Visible%0A%20%20%20%20%20%20%20%20%20%20line.highlight(mode%2C%20state%2C%20options.tabSize)%3B%0A%20%20%20%20%20%20%20%20%20%20line.stateAfter%20%3D%20copyState(mode%2C%20state)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20line.process(mode%2C%20state%2C%20options.tabSize)%3B%0A%20%20%20%20%20%20%20%20%20%20line.stateAfter%20%3D%20frontier%20%25%205%20%3D%3D%200%20%3F%20copyState(mode%2C%20state)%20%3A%20null%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2B%2Bfrontier%3B%0A%20%20%20%20%20%20%20%20if%20(%2Bnew%20Date%20%3E%20end)%20%7B%0A%20%20%20%20%20%20%20%20%20%20startWorker(options.workDelay)%3B%0A%20%20%20%20%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20if%20(showingTo%20%3E%20startFrontier%20%26%26%20frontier%20%3E%3D%20showingFrom)%0A%20%20%20%20%20%20%20%20operation(function()%20%7Bchanges.push(%7Bfrom%3A%20startFrontier%2C%20to%3A%20frontier%7D)%3B%7D)()%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20startWorker(time)%20%7B%0A%20%20%20%20%20%20if%20(frontier%20%3C%20showingTo)%0A%20%20%20%20%20%20%20%20highlight.set(time%2C%20highlightWorker)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20%2F%2F%20Operations%20are%20used%20to%20wrap%20changes%20in%20such%20a%20way%20that%20each%0A%20%20%20%20%2F%2F%20change%20won't%20have%20to%20update%20the%20cursor%20and%20display%20(which%20would%0A%20%20%20%20%2F%2F%20be%20awkward%2C%20slow%2C%20and%20error-prone)%2C%20but%20instead%20updates%20are%0A%20%20%20%20%2F%2F%20batched%20and%20then%20all%20combined%20and%20executed%20at%20once.%0A%20%20%20%20function%20startOperation()%20%7B%0A%20%20%20%20%20%20updateInput%20%3D%20userSelChange%20%3D%20textChanged%20%3D%20null%3B%0A%20%20%20%20%20%20changes%20%3D%20%5B%5D%3B%20selectionChanged%20%3D%20false%3B%20callbacks%20%3D%20%5B%5D%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20endOperation()%20%7B%0A%20%20%20%20%20%20if%20(updateMaxLine)%20computeMaxLength()%3B%0A%20%20%20%20%20%20if%20(maxLineChanged%20%26%26%20!options.lineWrapping)%20%7B%0A%20%20%20%20%20%20%20%20var%20cursorWidth%20%3D%20widthForcer.offsetWidth%2C%20left%20%3D%20measureLine(maxLine%2C%20maxLine.text.length).left%3B%0A%20%20%20%20%20%20%20%20if%20(!ie_lt8)%20%7B%0A%20%20%20%20%20%20%20%20%20%20widthForcer.style.left%20%3D%20left%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20%20%20lineSpace.style.minWidth%20%3D%20(left%20%2B%20cursorWidth)%20%2B%20%22px%22%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20maxLineChanged%20%3D%20false%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20newScrollPos%2C%20updated%3B%0A%20%20%20%20%20%20if%20(selectionChanged)%20%7B%0A%20%20%20%20%20%20%20%20var%20coords%20%3D%20calculateCursorCoords()%3B%0A%20%20%20%20%20%20%20%20newScrollPos%20%3D%20calculateScrollPos(coords.x%2C%20coords.y%2C%20coords.x%2C%20coords.yBot)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(changes.length%20%7C%7C%20newScrollPos%20%26%26%20newScrollPos.scrollTop%20!%3D%20null)%0A%20%20%20%20%20%20%20%20updated%20%3D%20updateDisplay(changes%2C%20true%2C%20newScrollPos%20%26%26%20newScrollPos.scrollTop)%3B%0A%20%20%20%20%20%20if%20(!updated)%20%7B%0A%20%20%20%20%20%20%20%20if%20(selectionChanged)%20updateSelection()%3B%0A%20%20%20%20%20%20%20%20if%20(gutterDirty)%20updateGutter()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(newScrollPos)%20scrollCursorIntoView()%3B%0A%20%20%20%20%20%20if%20(selectionChanged)%20restartBlink()%3B%0A%0A%20%20%20%20%20%20if%20(focused%20%26%26%20(updateInput%20%3D%3D%3D%20true%20%7C%7C%20(updateInput%20!%3D%3D%20false%20%26%26%20selectionChanged)))%0A%20%20%20%20%20%20%20%20resetInput(userSelChange)%3B%0A%0A%20%20%20%20%20%20if%20(selectionChanged%20%26%26%20options.matchBrackets)%0A%20%20%20%20%20%20%20%20setTimeout(operation(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(bracketHighlighted)%20%7BbracketHighlighted()%3B%20bracketHighlighted%20%3D%20null%3B%7D%0A%20%20%20%20%20%20%20%20%20%20if%20(posEq(sel.from%2C%20sel.to))%20matchBrackets(false)%3B%0A%20%20%20%20%20%20%20%20%7D)%2C%2020)%3B%0A%20%20%20%20%20%20var%20sc%20%3D%20selectionChanged%2C%20cbs%20%3D%20callbacks%3B%20%2F%2F%20these%20can%20be%20reset%20by%20callbacks%0A%20%20%20%20%20%20if%20(textChanged%20%26%26%20options.onChange%20%26%26%20instance)%0A%20%20%20%20%20%20%20%20options.onChange(instance%2C%20textChanged)%3B%0A%20%20%20%20%20%20if%20(sc%20%26%26%20options.onCursorActivity)%0A%20%20%20%20%20%20%20%20options.onCursorActivity(instance)%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20cbs.length%3B%20%2B%2Bi)%20cbs%5Bi%5D(instance)%3B%0A%20%20%20%20%20%20if%20(updated%20%26%26%20options.onUpdate)%20options.onUpdate(instance)%3B%0A%20%20%20%20%7D%0A%20%20%20%20var%20nestedOperation%20%3D%200%3B%0A%20%20%20%20function%20operation(f)%20%7B%0A%20%20%20%20%20%20return%20function()%20%7B%0A%20%20%20%20%20%20%20%20if%20(!nestedOperation%2B%2B)%20startOperation()%3B%0A%20%20%20%20%20%20%20%20try%20%7Bvar%20result%20%3D%20f.apply(this%2C%20arguments)%3B%7D%0A%20%20%20%20%20%20%20%20finally%20%7Bif%20(!--nestedOperation)%20endOperation()%3B%7D%0A%20%20%20%20%20%20%20%20return%20result%3B%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20compoundChange(f)%20%7B%0A%20%20%20%20%20%20history.startCompound()%3B%0A%20%20%20%20%20%20try%20%7B%20return%20f()%3B%20%7D%20finally%20%7B%20history.endCompound()%3B%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20for%20(var%20ext%20in%20extensions)%0A%20%20%20%20%20%20if%20(extensions.propertyIsEnumerable(ext)%20%26%26%0A%20%20%20%20%20%20%20%20%20%20!instance.propertyIsEnumerable(ext))%0A%20%20%20%20%20%20%20%20instance%5Bext%5D%20%3D%20extensions%5Bext%5D%3B%0A%20%20%20%20return%20instance%3B%0A%20%20%7D%20%2F%2F%20(end%20of%20function%20CodeMirror)%0A%0A%20%20%2F%2F%20The%20default%20configuration%20options.%0A%20%20CodeMirror.defaults%20%3D%20%7B%0A%20%20%20%20value%3A%20%22%22%2C%0A%20%20%20%20mode%3A%20null%2C%0A%20%20%20%20theme%3A%20%22default%22%2C%0A%20%20%20%20indentUnit%3A%202%2C%0A%20%20%20%20indentWithTabs%3A%20false%2C%0A%20%20%20%20smartIndent%3A%20true%2C%0A%20%20%20%20tabSize%3A%204%2C%0A%20%20%20%20keyMap%3A%20%22default%22%2C%0A%20%20%20%20extraKeys%3A%20null%2C%0A%20%20%20%20electricChars%3A%20true%2C%0A%20%20%20%20autoClearEmptyLines%3A%20false%2C%0A%20%20%20%20onKeyEvent%3A%20null%2C%0A%20%20%20%20onDragEvent%3A%20null%2C%0A%20%20%20%20lineWrapping%3A%20false%2C%0A%20%20%20%20lineNumbers%3A%20false%2C%0A%20%20%20%20gutter%3A%20false%2C%0A%20%20%20%20fixedGutter%3A%20false%2C%0A%20%20%20%20firstLineNumber%3A%201%2C%0A%20%20%20%20readOnly%3A%20false%2C%0A%20%20%20%20dragDrop%3A%20true%2C%0A%20%20%20%20onChange%3A%20null%2C%0A%20%20%20%20onCursorActivity%3A%20null%2C%0A%20%20%20%20onViewportChange%3A%20null%2C%0A%20%20%20%20onGutterClick%3A%20null%2C%0A%20%20%20%20onUpdate%3A%20null%2C%0A%20%20%20%20onFocus%3A%20null%2C%20onBlur%3A%20null%2C%20onScroll%3A%20null%2C%0A%20%20%20%20matchBrackets%3A%20false%2C%0A%20%20%20%20cursorBlinkRate%3A%20530%2C%0A%20%20%20%20workTime%3A%20100%2C%0A%20%20%20%20workDelay%3A%20200%2C%0A%20%20%20%20pollInterval%3A%20100%2C%0A%20%20%20%20undoDepth%3A%2040%2C%0A%20%20%20%20tabindex%3A%20null%2C%0A%20%20%20%20autofocus%3A%20null%2C%0A%20%20%20%20lineNumberFormatter%3A%20function(integer)%20%7B%20return%20integer%3B%20%7D%0A%20%20%7D%3B%0A%0A%20%20var%20ios%20%3D%20%2FAppleWebKit%2F.test(navigator.userAgent)%20%26%26%20%2FMobile%5C%2F%5Cw%2B%2F.test(navigator.userAgent)%3B%0A%20%20var%20mac%20%3D%20ios%20%7C%7C%20%2FMac%2F.test(navigator.platform)%3B%0A%20%20var%20win%20%3D%20%2FWin%2F.test(navigator.platform)%3B%0A%0A%20%20%2F%2F%20Known%20modes%2C%20by%20name%20and%20by%20MIME%0A%20%20var%20modes%20%3D%20CodeMirror.modes%20%3D%20%7B%7D%2C%20mimeModes%20%3D%20CodeMirror.mimeModes%20%3D%20%7B%7D%3B%0A%20%20CodeMirror.defineMode%20%3D%20function(name%2C%20mode)%20%7B%0A%20%20%20%20if%20(!CodeMirror.defaults.mode%20%26%26%20name%20!%3D%20%22null%22)%20CodeMirror.defaults.mode%20%3D%20name%3B%0A%20%20%20%20if%20(arguments.length%20%3E%202)%20%7B%0A%20%20%20%20%20%20mode.dependencies%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%202%3B%20i%20%3C%20arguments.length%3B%20%2B%2Bi)%20mode.dependencies.push(arguments%5Bi%5D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20modes%5Bname%5D%20%3D%20mode%3B%0A%20%20%7D%3B%0A%20%20CodeMirror.defineMIME%20%3D%20function(mime%2C%20spec)%20%7B%0A%20%20%20%20mimeModes%5Bmime%5D%20%3D%20spec%3B%0A%20%20%7D%3B%0A%20%20CodeMirror.resolveMode%20%3D%20function(spec)%20%7B%0A%20%20%20%20if%20(typeof%20spec%20%3D%3D%20%22string%22%20%26%26%20mimeModes.hasOwnProperty(spec))%0A%20%20%20%20%20%20spec%20%3D%20mimeModes%5Bspec%5D%3B%0A%20%20%20%20else%20if%20(typeof%20spec%20%3D%3D%20%22string%22%20%26%26%20%2F%5E%5B%5Cw%5C-%5D%2B%5C%2F%5B%5Cw%5C-%5D%2B%5C%2Bxml%24%2F.test(spec))%0A%20%20%20%20%20%20return%20CodeMirror.resolveMode(%22application%2Fxml%22)%3B%0A%20%20%20%20if%20(typeof%20spec%20%3D%3D%20%22string%22)%20return%20%7Bname%3A%20spec%7D%3B%0A%20%20%20%20else%20return%20spec%20%7C%7C%20%7Bname%3A%20%22null%22%7D%3B%0A%20%20%7D%3B%0A%20%20CodeMirror.getMode%20%3D%20function(options%2C%20spec)%20%7B%0A%20%20%20%20var%20spec%20%3D%20CodeMirror.resolveMode(spec)%3B%0A%20%20%20%20var%20mfactory%20%3D%20modes%5Bspec.name%5D%3B%0A%20%20%20%20if%20(!mfactory)%20return%20CodeMirror.getMode(options%2C%20%22text%2Fplain%22)%3B%0A%20%20%20%20var%20modeObj%20%3D%20mfactory(options%2C%20spec)%3B%0A%20%20%20%20if%20(modeExtensions.hasOwnProperty(spec.name))%20%7B%0A%20%20%20%20%20%20var%20exts%20%3D%20modeExtensions%5Bspec.name%5D%3B%0A%20%20%20%20%20%20for%20(var%20prop%20in%20exts)%20if%20(exts.hasOwnProperty(prop))%20modeObj%5Bprop%5D%20%3D%20exts%5Bprop%5D%3B%0A%20%20%20%20%7D%0A%20%20%20%20modeObj.name%20%3D%20spec.name%3B%0A%20%20%20%20return%20modeObj%3B%0A%20%20%7D%3B%0A%20%20CodeMirror.listModes%20%3D%20function()%20%7B%0A%20%20%20%20var%20list%20%3D%20%5B%5D%3B%0A%20%20%20%20for%20(var%20m%20in%20modes)%0A%20%20%20%20%20%20if%20(modes.propertyIsEnumerable(m))%20list.push(m)%3B%0A%20%20%20%20return%20list%3B%0A%20%20%7D%3B%0A%20%20CodeMirror.listMIMEs%20%3D%20function()%20%7B%0A%20%20%20%20var%20list%20%3D%20%5B%5D%3B%0A%20%20%20%20for%20(var%20m%20in%20mimeModes)%0A%20%20%20%20%20%20if%20(mimeModes.propertyIsEnumerable(m))%20list.push(%7Bmime%3A%20m%2C%20mode%3A%20mimeModes%5Bm%5D%7D)%3B%0A%20%20%20%20return%20list%3B%0A%20%20%7D%3B%0A%0A%20%20var%20extensions%20%3D%20CodeMirror.extensions%20%3D%20%7B%7D%3B%0A%20%20CodeMirror.defineExtension%20%3D%20function(name%2C%20func)%20%7B%0A%20%20%20%20extensions%5Bname%5D%20%3D%20func%3B%0A%20%20%7D%3B%0A%0A%20%20var%20modeExtensions%20%3D%20CodeMirror.modeExtensions%20%3D%20%7B%7D%3B%0A%20%20CodeMirror.extendMode%20%3D%20function(mode%2C%20properties)%20%7B%0A%20%20%20%20var%20exts%20%3D%20modeExtensions.hasOwnProperty(mode)%20%3F%20modeExtensions%5Bmode%5D%20%3A%20(modeExtensions%5Bmode%5D%20%3D%20%7B%7D)%3B%0A%20%20%20%20for%20(var%20prop%20in%20properties)%20if%20(properties.hasOwnProperty(prop))%0A%20%20%20%20%20%20exts%5Bprop%5D%20%3D%20properties%5Bprop%5D%3B%0A%20%20%7D%3B%0A%0A%20%20var%20commands%20%3D%20CodeMirror.commands%20%3D%20%7B%0A%20%20%20%20selectAll%3A%20function(cm)%20%7Bcm.setSelection(%7Bline%3A%200%2C%20ch%3A%200%7D%2C%20%7Bline%3A%20cm.lineCount()%20-%201%7D)%3B%7D%2C%0A%20%20%20%20killLine%3A%20function(cm)%20%7B%0A%20%20%20%20%20%20var%20from%20%3D%20cm.getCursor(true)%2C%20to%20%3D%20cm.getCursor(false)%2C%20sel%20%3D%20!posEq(from%2C%20to)%3B%0A%20%20%20%20%20%20if%20(!sel%20%26%26%20cm.getLine(from.line).length%20%3D%3D%20from.ch)%20cm.replaceRange(%22%22%2C%20from%2C%20%7Bline%3A%20from.line%20%2B%201%2C%20ch%3A%200%7D)%3B%0A%20%20%20%20%20%20else%20cm.replaceRange(%22%22%2C%20from%2C%20sel%20%3F%20to%20%3A%20%7Bline%3A%20from.line%7D)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20deleteLine%3A%20function(cm)%20%7Bvar%20l%20%3D%20cm.getCursor().line%3B%20cm.replaceRange(%22%22%2C%20%7Bline%3A%20l%2C%20ch%3A%200%7D%2C%20%7Bline%3A%20l%7D)%3B%7D%2C%0A%20%20%20%20undo%3A%20function(cm)%20%7Bcm.undo()%3B%7D%2C%0A%20%20%20%20redo%3A%20function(cm)%20%7Bcm.redo()%3B%7D%2C%0A%20%20%20%20goDocStart%3A%20function(cm)%20%7Bcm.setCursor(0%2C%200%2C%20true)%3B%7D%2C%0A%20%20%20%20goDocEnd%3A%20function(cm)%20%7Bcm.setSelection(%7Bline%3A%20cm.lineCount()%20-%201%7D%2C%20null%2C%20true)%3B%7D%2C%0A%20%20%20%20goLineStart%3A%20function(cm)%20%7Bcm.setCursor(cm.getCursor().line%2C%200%2C%20true)%3B%7D%2C%0A%20%20%20%20goLineStartSmart%3A%20function(cm)%20%7B%0A%20%20%20%20%20%20var%20cur%20%3D%20cm.getCursor()%3B%0A%20%20%20%20%20%20var%20text%20%3D%20cm.getLine(cur.line)%2C%20firstNonWS%20%3D%20Math.max(0%2C%20text.search(%2F%5CS%2F))%3B%0A%20%20%20%20%20%20cm.setCursor(cur.line%2C%20cur.ch%20%3C%3D%20firstNonWS%20%26%26%20cur.ch%20%3F%200%20%3A%20firstNonWS%2C%20true)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20goLineEnd%3A%20function(cm)%20%7Bcm.setSelection(%7Bline%3A%20cm.getCursor().line%7D%2C%20null%2C%20true)%3B%7D%2C%0A%20%20%20%20goLineUp%3A%20function(cm)%20%7Bcm.moveV(-1%2C%20%22line%22)%3B%7D%2C%0A%20%20%20%20goLineDown%3A%20function(cm)%20%7Bcm.moveV(1%2C%20%22line%22)%3B%7D%2C%0A%20%20%20%20goPageUp%3A%20function(cm)%20%7Bcm.moveV(-1%2C%20%22page%22)%3B%7D%2C%0A%20%20%20%20goPageDown%3A%20function(cm)%20%7Bcm.moveV(1%2C%20%22page%22)%3B%7D%2C%0A%20%20%20%20goCharLeft%3A%20function(cm)%20%7Bcm.moveH(-1%2C%20%22char%22)%3B%7D%2C%0A%20%20%20%20goCharRight%3A%20function(cm)%20%7Bcm.moveH(1%2C%20%22char%22)%3B%7D%2C%0A%20%20%20%20goColumnLeft%3A%20function(cm)%20%7Bcm.moveH(-1%2C%20%22column%22)%3B%7D%2C%0A%20%20%20%20goColumnRight%3A%20function(cm)%20%7Bcm.moveH(1%2C%20%22column%22)%3B%7D%2C%0A%20%20%20%20goWordLeft%3A%20function(cm)%20%7Bcm.moveH(-1%2C%20%22word%22)%3B%7D%2C%0A%20%20%20%20goWordRight%3A%20function(cm)%20%7Bcm.moveH(1%2C%20%22word%22)%3B%7D%2C%0A%20%20%20%20delCharLeft%3A%20function(cm)%20%7Bcm.deleteH(-1%2C%20%22char%22)%3B%7D%2C%0A%20%20%20%20delCharRight%3A%20function(cm)%20%7Bcm.deleteH(1%2C%20%22char%22)%3B%7D%2C%0A%20%20%20%20delWordLeft%3A%20function(cm)%20%7Bcm.deleteH(-1%2C%20%22word%22)%3B%7D%2C%0A%20%20%20%20delWordRight%3A%20function(cm)%20%7Bcm.deleteH(1%2C%20%22word%22)%3B%7D%2C%0A%20%20%20%20indentAuto%3A%20function(cm)%20%7Bcm.indentSelection(%22smart%22)%3B%7D%2C%0A%20%20%20%20indentMore%3A%20function(cm)%20%7Bcm.indentSelection(%22add%22)%3B%7D%2C%0A%20%20%20%20indentLess%3A%20function(cm)%20%7Bcm.indentSelection(%22subtract%22)%3B%7D%2C%0A%20%20%20%20insertTab%3A%20function(cm)%20%7Bcm.replaceSelection(%22%5Ct%22%2C%20%22end%22)%3B%7D%2C%0A%20%20%20%20defaultTab%3A%20function(cm)%20%7B%0A%20%20%20%20%20%20if%20(cm.somethingSelected())%20cm.indentSelection(%22add%22)%3B%0A%20%20%20%20%20%20else%20cm.replaceSelection(%22%5Ct%22%2C%20%22end%22)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20transposeChars%3A%20function(cm)%20%7B%0A%20%20%20%20%20%20var%20cur%20%3D%20cm.getCursor()%2C%20line%20%3D%20cm.getLine(cur.line)%3B%0A%20%20%20%20%20%20if%20(cur.ch%20%3E%200%20%26%26%20cur.ch%20%3C%20line.length%20-%201)%0A%20%20%20%20%20%20%20%20cm.replaceRange(line.charAt(cur.ch)%20%2B%20line.charAt(cur.ch%20-%201)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7Bline%3A%20cur.line%2C%20ch%3A%20cur.ch%20-%201%7D%2C%20%7Bline%3A%20cur.line%2C%20ch%3A%20cur.ch%20%2B%201%7D)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20newlineAndIndent%3A%20function(cm)%20%7B%0A%20%20%20%20%20%20cm.replaceSelection(%22%5Cn%22%2C%20%22end%22)%3B%0A%20%20%20%20%20%20cm.indentLine(cm.getCursor().line)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20toggleOverwrite%3A%20function(cm)%20%7Bcm.toggleOverwrite()%3B%7D%0A%20%20%7D%3B%0A%0A%20%20var%20keyMap%20%3D%20CodeMirror.keyMap%20%3D%20%7B%7D%3B%0A%20%20keyMap.basic%20%3D%20%7B%0A%20%20%20%20%22Left%22%3A%20%22goCharLeft%22%2C%20%22Right%22%3A%20%22goCharRight%22%2C%20%22Up%22%3A%20%22goLineUp%22%2C%20%22Down%22%3A%20%22goLineDown%22%2C%0A%20%20%20%20%22End%22%3A%20%22goLineEnd%22%2C%20%22Home%22%3A%20%22goLineStartSmart%22%2C%20%22PageUp%22%3A%20%22goPageUp%22%2C%20%22PageDown%22%3A%20%22goPageDown%22%2C%0A%20%20%20%20%22Delete%22%3A%20%22delCharRight%22%2C%20%22Backspace%22%3A%20%22delCharLeft%22%2C%20%22Tab%22%3A%20%22defaultTab%22%2C%20%22Shift-Tab%22%3A%20%22indentAuto%22%2C%0A%20%20%20%20%22Enter%22%3A%20%22newlineAndIndent%22%2C%20%22Insert%22%3A%20%22toggleOverwrite%22%0A%20%20%7D%3B%0A%20%20%2F%2F%20Note%20that%20the%20save%20and%20find-related%20commands%20aren't%20defined%20by%0A%20%20%2F%2F%20default.%20Unknown%20commands%20are%20simply%20ignored.%0A%20%20keyMap.pcDefault%20%3D%20%7B%0A%20%20%20%20%22Ctrl-A%22%3A%20%22selectAll%22%2C%20%22Ctrl-D%22%3A%20%22deleteLine%22%2C%20%22Ctrl-Z%22%3A%20%22undo%22%2C%20%22Shift-Ctrl-Z%22%3A%20%22redo%22%2C%20%22Ctrl-Y%22%3A%20%22redo%22%2C%0A%20%20%20%20%22Ctrl-Home%22%3A%20%22goDocStart%22%2C%20%22Alt-Up%22%3A%20%22goDocStart%22%2C%20%22Ctrl-End%22%3A%20%22goDocEnd%22%2C%20%22Ctrl-Down%22%3A%20%22goDocEnd%22%2C%0A%20%20%20%20%22Ctrl-Left%22%3A%20%22goWordLeft%22%2C%20%22Ctrl-Right%22%3A%20%22goWordRight%22%2C%20%22Alt-Left%22%3A%20%22goLineStart%22%2C%20%22Alt-Right%22%3A%20%22goLineEnd%22%2C%0A%20%20%20%20%22Ctrl-Backspace%22%3A%20%22delWordLeft%22%2C%20%22Ctrl-Delete%22%3A%20%22delWordRight%22%2C%20%22Ctrl-S%22%3A%20%22save%22%2C%20%22Ctrl-F%22%3A%20%22find%22%2C%0A%20%20%20%20%22Ctrl-G%22%3A%20%22findNext%22%2C%20%22Shift-Ctrl-G%22%3A%20%22findPrev%22%2C%20%22Shift-Ctrl-F%22%3A%20%22replace%22%2C%20%22Shift-Ctrl-R%22%3A%20%22replaceAll%22%2C%0A%20%20%20%20%22Ctrl-%5B%22%3A%20%22indentLess%22%2C%20%22Ctrl-%5D%22%3A%20%22indentMore%22%2C%0A%20%20%20%20fallthrough%3A%20%22basic%22%0A%20%20%7D%3B%0A%20%20keyMap.macDefault%20%3D%20%7B%0A%20%20%20%20%22Cmd-A%22%3A%20%22selectAll%22%2C%20%22Cmd-D%22%3A%20%22deleteLine%22%2C%20%22Cmd-Z%22%3A%20%22undo%22%2C%20%22Shift-Cmd-Z%22%3A%20%22redo%22%2C%20%22Cmd-Y%22%3A%20%22redo%22%2C%0A%20%20%20%20%22Cmd-Up%22%3A%20%22goDocStart%22%2C%20%22Cmd-End%22%3A%20%22goDocEnd%22%2C%20%22Cmd-Down%22%3A%20%22goDocEnd%22%2C%20%22Alt-Left%22%3A%20%22goWordLeft%22%2C%0A%20%20%20%20%22Alt-Right%22%3A%20%22goWordRight%22%2C%20%22Cmd-Left%22%3A%20%22goLineStart%22%2C%20%22Cmd-Right%22%3A%20%22goLineEnd%22%2C%20%22Alt-Backspace%22%3A%20%22delWordLeft%22%2C%0A%20%20%20%20%22Ctrl-Alt-Backspace%22%3A%20%22delWordRight%22%2C%20%22Alt-Delete%22%3A%20%22delWordRight%22%2C%20%22Cmd-S%22%3A%20%22save%22%2C%20%22Cmd-F%22%3A%20%22find%22%2C%0A%20%20%20%20%22Cmd-G%22%3A%20%22findNext%22%2C%20%22Shift-Cmd-G%22%3A%20%22findPrev%22%2C%20%22
F%22%3A%20%22replace%22%2C%20%22Shift-Cmd-Alt-F%22%3A%20%22replaceAll%22%2C%0A%20%20%20%20%22Cmd-%5B%22%3A%20%22indentLess%22%2C%20%22Cmd-%5D%22%3A%20%22indentMore%22%2C%0A%20%20%20%20fallthrough%3A%20%5B%22basic%22%2C%20%22emacsy%22%5D%0A%20%20%7D%3B%0A%20%20keyMap%5B%22default%22%5D%20%3D%20mac%20%3F%20keyMap.macDefault%20%3A%20keyMap.pcDefault%3B%0A%20%20keyMap.emacsy%20%3D%20%7B%0A%20%20%20%20%22Ctrl-F%22%3A%20%22goCharRight%22%2C%20%22Ctrl-B%22%3A%20%22goCharLeft%22%2C%20%22Ctrl-P%22%3A%20%22goLineUp%22%2C%20%22Ctrl-N%22%3A%20%22goLineDown%22%2C%0A%20%20%20%20%22Alt-F%22%3A%20%22goWordRight%22%2C%20%22Alt-B%22%3A%20%22goWordLeft%22%2C%20%22Ctrl-A%22%3A%20%22goLineStart%22%2C%20%22Ctrl-E%22%3A%20%22goLineEnd%22%2C%0A%20%20%20%20%22Ctrl-V%22%3A%20%22goPageUp%22%2C%20%22Shift-Ctrl-V%22%3A%20%22goPageDown%22%2C%20%22Ctrl-D%22%3A%20%22delCharRight%22%2C%20%22Ctrl-H%22%3A%20%22delCharLeft%22%2C%0A%20%20%20%20%22Alt-D%22%3A%20%22delWordRight%22%2C%20%22Alt-Backspace%22%3A%20%22delWordLeft%22%2C%20%22Ctrl-K%22%3A%20%22killLine%22%2C%20%22Ctrl-T%22%3A%20%22transposeChars%22%0A%20%20%7D%3B%0A%0A%20%20function%20getKeyMap(val)%20%7B%0A%20%20%20%20if%20(typeof%20val%20%3D%3D%20%22string%22)%20return%20keyMap%5Bval%5D%3B%0A%20%20%20%20else%20return%20val%3B%0A%20%20%7D%0A%20%20function%20lookupKey(name%2C%20extraMap%2C%20map%2C%20handle%2C%20stop)%20%7B%0A%20%20%20%20function%20lookup(map)%20%7B%0A%20%20%20%20%20%20map%20%3D%20getKeyMap(map)%3B%0A%20%20%20%20%20%20var%20found%20%3D%20map%5Bname%5D%3B%0A%20%20%20%20%20%20if%20(found%20%3D%3D%3D%20false)%20%7B%0A%20%20%20%20%20%20%20%20if%20(stop)%20stop()%3B%0A%20%20%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(found%20!%3D%20null%20%26%26%20handle(found))%20return%20true%3B%0A%20%20%20%20%20%20if%20(map.nofallthrough)%20%7B%0A%20%20%20%20%20%20%20%20if%20(stop)%20stop()%3B%0A%20%20%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20fallthrough%20%3D%20map.fallthrough%3B%0A%20%20%20%20%20%20if%20(fallthrough%20%3D%3D%20null)%20return%20false%3B%0A%20%20%20%20%20%20if%20(Object.prototype.toString.call(fallthrough)%20!%3D%20%22%5Bobject%20Array%5D%22)%0A%20%20%20%20%20%20%20%20return%20lookup(fallthrough)%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20fallthrough.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20if%20(lookup(fallthrough%5Bi%5D))%20return%20true%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20false%3B%0A%20%20%20%20%7D%0A%20%20%20%20if%20(extraMap%20%26%26%20lookup(extraMap))%20return%20true%3B%0A%20%20%20%20return%20lookup(map)%3B%0A%20%20%7D%0A%20%20function%20isModifierKey(event)%20%7B%0A%20%20%20%20var%20name%20%3D%20keyNames%5Be_prop(event%2C%20%22keyCode%22)%5D%3B%0A%20%20%20%20return%20name%20%3D%3D%20%22Ctrl%22%20%7C%7C%20name%20%3D%3D%20%22Alt%22%20%7C%7C%20name%20%3D%3D%20%22Shift%22%20%7C%7C%20name%20%3D%3D%20%22Mod%22%3B%0A%20%20%7D%0A%0A%20%20CodeMirror.fromTextArea%20%3D%20function(textarea%2C%20options)%20%7B%0A%20%20%20%20if%20(!options)%20options%20%3D%20%7B%7D%3B%0A%20%20%20%20options.value%20%3D%20textarea.value%3B%0A%20%20%20%20if%20(!options.tabindex%20%26%26%20textarea.tabindex)%0A%20%20%20%20%20%20options.tabindex%20%3D%20textarea.tabindex%3B%0A%20%20%20%20%2F%2F%20Set%20autofocus%20to%20true%20if%20this%20textarea%20is%20focused%2C%20or%20if%20it%20has%0A%20%20%20%20%2F%2F%20autofocus%20and%20no%20other%20element%20is%20focused.%0A%20%20%20%20if%20(options.autofocus%20%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20var%20hasFocus%20%3D%20document.body%3B%0A%20%20%20%20%20%20%2F%2F%20doc.activeElement%20occasionally%20throws%20on%20IE%0A%20%20%20%20%20%20try%20%7B%20hasFocus%20%3D%20document.activeElement%3B%20%7D%20catch(e)%20%7B%7D%0A%20%20%20%20%20%20options.autofocus%20%3D%20hasFocus%20%3D%3D%20textarea%20%7C%7C%0A%20%20%20%20%20%20%20%20textarea.getAttribute(%22autofocus%22)%20!%3D%20null%20%26%26%20hasFocus%20%3D%3D%20document.body%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20function%20save()%20%7Btextarea.value%20%3D%20instance.getValue()%3B%7D%0A%20%20%20%20if%20(textarea.form)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Deplorable%20hack%20to%20make%20the%20submit%20method%20do%20the%20right%20thing.%0A%20%20%20%20%20%20var%20rmSubmit%20%3D%20connect(textarea.form%2C%20%22submit%22%2C%20save%2C%20true)%3B%0A%20%20%20%20%20%20if%20(typeof%20textarea.form.submit%20%3D%3D%20%22function%22)%20%7B%0A%20%20%20%20%20%20%20%20var%20realSubmit%20%3D%20textarea.form.submit%3B%0A%20%20%20%20%20%20%20%20textarea.form.submit%20%3D%20function%20wrappedSubmit()%20%7B%0A%20%20%20%20%20%20%20%20%20%20save()%3B%0A%20%20%20%20%20%20%20%20%20%20textarea.form.submit%20%3D%20realSubmit%3B%0A%20%20%20%20%20%20%20%20%20%20textarea.form.submit()%3B%0A%20%20%20%20%20%20%20%20%20%20textarea.form.submit%20%3D%20wrappedSubmit%3B%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20textarea.style.display%20%3D%20%22none%22%3B%0A%20%20%20%20var%20instance%20%3D%20CodeMirror(function(node)%20%7B%0A%20%20%20%20%20%20textarea.parentNode.insertBefore(node%2C%20textarea.nextSibling)%3B%0A%20%20%20%20%7D%2C%20options)%3B%0A%20%20%20%20instance.save%20%3D%20save%3B%0A%20%20%20%20instance.getTextArea%20%3D%20function()%20%7B%20return%20textarea%3B%20%7D%3B%0A%20%20%20%20instance.toTextArea%20%3D%20function()%20%7B%0A%20%20%20%20%20%20save()%3B%0A%20%20%20%20%20%20textarea.parentNode.removeChild(instance.getWrapperElement())%3B%0A%20%20%20%20%20%20textarea.style.display%20%3D%20%22%22%3B%0A%20%20%20%20%20%20if%20(textarea.form)%20%7B%0A%20%20%20%20%20%20%20%20rmSubmit()%3B%0A%20%20%20%20%20%20%20%20if%20(typeof%20textarea.form.submit%20%3D%3D%20%22function%22)%0A%20%20%20%20%20%20%20%20%20%20textarea.form.submit%20%3D%20realSubmit%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%3B%0A%20%20%20%20return%20instance%3B%0A%20%20%7D%3B%0A%0A%20%20var%20gecko%20%3D%20%2Fgecko%5C%2F%5Cd%7B7%7D%2Fi.test(navigator.userAgent)%3B%0A%20%20var%20ie%20%3D%20%2FMSIE%20%5Cd%2F.test(navigator.userAgent)%3B%0A%20%20var%20ie_lt8%20%3D%20%2FMSIE%20%5B1-7%5D%5Cb%2F.test(navigator.userAgent)%3B%0A%20%20var%20ie_lt9%20%3D%20%2FMSIE%20%5B1-8%5D%5Cb%2F.test(navigator.userAgent)%3B%0A%20%20var%20quirksMode%20%3D%20ie%20%26%26%20document.documentMode%20%3D%3D%205%3B%0A%20%20var%20webkit%20%3D%20%2FWebKit%5C%2F%2F.test(navigator.userAgent)%3B%0A%20%20var%20chrome%20%3D%20%2FChrome%5C%2F%2F.test(navigator.userAgent)%3B%0A%20%20var%20opera%20%3D%20%2FOpera%5C%2F%2F.test(navigator.userAgent)%3B%0A%20%20var%20safari%20%3D%20%2FApple%20Computer%2F.test(navigator.vendor)%3B%0A%20%20var%20khtml%20%3D%20%2FKHTML%5C%2F%2F.test(navigator.userAgent)%3B%0A%20%20var%20mac_geLion%20%3D%20%2FMac%20OS%20X%2010%5CD(%5B7-9%5D%7C%5Cd%5Cd)%5CD%2F.test(navigator.userAgent)%3B%0A%0A%20%20%2F%2F%20Utility%20functions%20for%20working%20with%20state.%20Exported%20because%20modes%0A%20%20%2F%2F%20sometimes%20need%20to%20do%20this.%0A%20%20function%20copyState(mode%2C%20state)%20%7B%0A%20%20%20%20if%20(state%20%3D%3D%3D%20true)%20return%20state%3B%0A%20%20%20%20if%20(mode.copyState)%20return%20mode.copyState(state)%3B%0A%20%20%20%20var%20nstate%20%3D%20%7B%7D%3B%0A%20%20%20%20for%20(var%20n%20in%20state)%20%7B%0A%20%20%20%20%20%20var%20val%20%3D%20state%5Bn%5D%3B%0A%20%20%20%20%20%20if%20(val%20instanceof%20Array)%20val%20%3D%20val.concat(%5B%5D)%3B%0A%20%20%20%20%20%20nstate%5Bn%5D%20%3D%20val%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20nstate%3B%0A%20%20%7D%0A%20%20CodeMirror.copyState%20%3D%20copyState%3B%0A%20%20function%20startState(mode%2C%20a1%2C%20a2)%20%7B%0A%20%20%20%20return%20mode.startState%20%3F%20mode.startState(a1%2C%20a2)%20%3A%20true%3B%0A%20%20%7D%0A%20%20CodeMirror.startState%20%3D%20startState%3B%0A%20%20CodeMirror.innerMode%20%3D%20function(mode%2C%20state)%20%7B%0A%20%20%20%20while%20(mode.innerMode)%20%7B%0A%20%20%20%20%20%20var%20info%20%3D%20mode.innerMode(state)%3B%0A%20%20%20%20%20%20state%20%3D%20info.state%3B%0A%20%20%20%20%20%20mode%20%3D%20info.mode%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20info%20%7C%7C%20%7Bmode%3A%20mode%2C%20state%3A%20state%7D%3B%0A%20%20%7D%3B%0A%0A%20%20%2F%2F%20The%20character%20stream%20used%20by%20a%20mode's%20parser.%0A%20%20function%20StringStream(string%2C%20tabSize)%20%7B%0A%20%20%20%20this.pos%20%3D%20this.start%20%3D%200%3B%0A%20%20%20%20this.string%20%3D%20string%3B%0A%20%20%20%20this.tabSize%20%3D%20tabSize%20%7C%7C%208%3B%0A%20%20%7D%0A%20%20StringStream.prototype%20%3D%20%7B%0A%20%20%20%20eol%3A%20function()%20%7Breturn%20this.pos%20%3E%3D%20this.string.length%3B%7D%2C%0A%20%20%20%20sol%3A%20function()%20%7Breturn%20this.pos%20%3D%3D%200%3B%7D%2C%0A%20%20%20%20peek%3A%20function()%20%7Breturn%20this.string.charAt(this.pos)%20%7C%7C%20undefined%3B%7D%2C%0A%20%20%20%20next%3A%20function()%20%7B%0A%20%20%20%20%20%20if%20(this.pos%20%3C%20this.string.length)%0A%20%20%20%20%20%20%20%20return%20this.string.charAt(this.pos%2B%2B)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20eat%3A%20function(match)%20%7B%0A%20%20%20%20%20%20var%20ch%20%3D%20this.string.charAt(this.pos)%3B%0A%20%20%20%20%20%20if%20(typeof%20match%20%3D%3D%20%22string%22)%20var%20ok%20%3D%20ch%20%3D%3D%20match%3B%0A%20%20%20%20%20%20else%20var%20ok%20%3D%20ch%20%26%26%20(match.test%20%3F%20match.test(ch)%20%3A%20match(ch))%3B%0A%20%20%20%20%20%20if%20(ok)%20%7B%2B%2Bthis.pos%3B%20return%20ch%3B%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20eatWhile%3A%20function(match)%20%7B%0A%20%20%20%20%20%20var%20start%20%3D%20this.pos%3B%0A%20%20%20%20%20%20while%20(this.eat(match))%7B%7D%0A%20%20%20%20%20%20return%20this.pos%20%3E%20start%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20eatSpace%3A%20function()%20%7B%0A%20%20%20%20%20%20var%20start%20%3D%20this.pos%3B%0A%20%20%20%20%20%20while%20(%2F%5B%5Cs%5Cu00a0%5D%2F.test(this.string.charAt(this.pos)))%20%2B%2Bthis.pos%3B%0A%20%20%20%20%20%20return%20this.pos%20%3E%20start%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20skipToEnd%3A%20function()%20%7Bthis.pos%20%3D%20this.string.length%3B%7D%2C%0A%20%20%20%20skipTo%3A%20function(ch)%20%7B%0A%20%20%20%20%20%20var%20found%20%3D%20this.string.indexOf(ch%2C%20this.pos)%3B%0A%20%20%20%20%20%20if%20(found%20%3E%20-1)%20%7Bthis.pos%20%3D%20found%3B%20return%20true%3B%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20backUp%3A%20function(n)%20%7Bthis.pos%20-%3D%20n%3B%7D%2C%0A%20%20%20%20column%3A%20function()%20%7Breturn%20countColumn(this.string%2C%20this.start%2C%20this.tabSize)%3B%7D%2C%0A%20%20%20%20indentation%3A%20function()%20%7Breturn%20countColumn(this.string%2C%20null%2C%20this.tabSize)%3B%7D%2C%0A%20%20%20%20match%3A%20function(pattern%2C%20consume%2C%20caseInsensitive)%20%7B%0A%20%20%20%20%20%20if%20(typeof%20pattern%20%3D%3D%20%22string%22)%20%7B%0A%20%20%20%20%20%20%20%20var%20cased%20%3D%20function(str)%20%7Breturn%20caseInsensitive%20%3F%20str.toLowerCase()%20%3A%20str%3B%7D%3B%0A%20%20%20%20%20%20%20%20if%20(cased(this.string).indexOf(cased(pattern)%2C%20this.pos)%20%3D%3D%20this.pos)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(consume%20!%3D%3D%20false)%20this.pos%20%2B%3D%20pattern.length%3B%0A%20%20%20%20%20%20%20%20%20%20return%20true%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20var%20match%20%3D%20this.string.slice(this.pos).match(pattern)%3B%0A%20%20%20%20%20%20%20%20if%20(match%20%26%26%20match.index%20%3E%200)%20return%20null%3B%0A%20%20%20%20%20%20%20%20if%20(match%20%26%26%20consume%20!%3D%3D%20false)%20this.pos%20%2B%3D%20match%5B0%5D.length%3B%0A%20%20%20%20%20%20%20%20return%20match%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20current%3A%20function()%7Breturn%20this.string.slice(this.start%2C%20this.pos)%3B%7D%0A%20%20%7D%3B%0A%20%20CodeMirror.StringStream%20%3D%20StringStream%3B%0A%0A%20%20function%20MarkedSpan(from%2C%20to%2C%20marker)%20%7B%0A%20%20%20%20this.from%20%3D%20from%3B%20this.to%20%3D%20to%3B%20this.marker%20%3D%20marker%3B%0A%20%20%7D%0A%0A%20%20function%20getMarkedSpanFor(spans%2C%20marker%2C%20del)%20%7B%0A%20%20%20%20if%20(spans)%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20spans.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20var%20span%20%3D%20spans%5Bi%5D%3B%0A%20%20%20%20%20%20if%20(span.marker%20%3D%3D%20marker)%20%7B%0A%20%20%20%20%20%20%20%20if%20(del)%20spans.splice(i%2C%201)%3B%0A%20%20%20%20%20%20%20%20return%20span%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20function%20markedSpansBefore(old%2C%20startCh%2C%20endCh)%20%7B%0A%20%20%20%20if%20(old)%20for%20(var%20i%20%3D%200%2C%20nw%3B%20i%20%3C%20old.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20var%20span%20%3D%20old%5Bi%5D%2C%20marker%20%3D%20span.marker%3B%0A%20%20%20%20%20%20var%20startsBefore%20%3D%20span.from%20%3D%3D%20null%20%7C%7C%20(marker.inclusiveLeft%20%3F%20span.from%20%3C%3D%20startCh%20%3A%20span.from%20%3C%20startCh)%3B%0A%20%20%20%20%20%20if%20(startsBefore%20%7C%7C%20marker.type%20%3D%3D%20%22bookmark%22%20%26%26%20span.from%20%3D%3D%20startCh%20%26%26%20span.from%20!%3D%20endCh)%20%7B%0A%20%20%20%20%20%20%20%20var%20endsAfter%20%3D%20span.to%20%3D%3D%20null%20%7C%7C%20(marker.inclusiveRight%20%3F%20span.to%20%3E%3D%20startCh%20%3A%20span.to%20%3E%20startCh)%3B%0A%20%20%20%20%20%20%20%20(nw%20%7C%7C%20(nw%20%3D%20%5B%5D)).push(%7Bfrom%3A%20span.from%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20to%3A%20endsAfter%20%3F%20null%20%3A%20span.to%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20marker%3A%20marker%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20nw%3B%0A%20%20%7D%0A%0A%20%20function%20markedSpansAfter(old%2C%20endCh)%20%7B%0A%20%20%20%20if%20(old)%20for%20(var%20i%20%3D%200%2C%20nw%3B%20i%20%3C%20old.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20var%20span%20%3D%20old%5Bi%5D%2C%20marker%20%3D%20span.marker%3B%0A%20%20%20%20%20%20var%20endsAfter%20%3D%20span.to%20%3D%3D%20null%20%7C%7C%20(marker.inclusiveRight%20%3F%20span.to%20%3E%3D%20endCh%20%3A%20span.to%20%3E%20endCh)%3B%0A%20%20%20%20%20%20if%20(endsAfter%20%7C%7C%20marker.type%20%3D%3D%20%22bookmark%22%20%26%26%20span.from%20%3D%3D%20endCh)%20%7B%0A%20%20%20%20%20%20%20%20var%20startsBefore%20%3D%20span.from%20%3D%3D%20null%20%7C%7C%20(marker.inclusiveLeft%20%3F%20span.from%20%3C%3D%20endCh%20%3A%20span.from%20%3C%20endCh)%3B%0A%20%20%20%20%20%20%20%20(nw%20%7C%7C%20(nw%20%3D%20%5B%5D)).push(%7Bfrom%3A%20startsBefore%20%3F%20null%20%3A%20span.from%20-%20endCh%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20to%3A%20span.to%20%3D%3D%20null%20%3F%20null%20%3A%20span.to%20-%20endCh%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20marker%3A%20marker%7D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20nw%3B%0A%20%20%7D%0A%0A%20%20function%20updateMarkedSpans(oldFirst%2C%20oldLast%2C%20startCh%2C%20endCh%2C%20newText)%20%7B%0A%20%20%20%20if%20(!oldFirst%20%26%26%20!oldLast)%20return%20newText%3B%0A%20%20%20%20%2F%2F%20Get%20the%20spans%20that%20'stick%20out'%20on%20both%20sides%0A%20%20%20%20var%20first%20%3D%20markedSpansBefore(oldFirst%2C%20startCh)%3B%0A%20%20%20%20var%20last%20%3D%20markedSpansAfter(oldLast%2C%20endCh)%3B%0A%0A%20%20%20%20%2F%2F%20Next%2C%20merge%20those%20two%20ends%0A%20%20%20%20var%20sameLine%20%3D%20newText.length%20%3D%3D%201%2C%20offset%20%3D%20lst(newText).length%20%2B%20(sameLine%20%3F%20startCh%20%3A%200)%3B%0A%20%20%20%20if%20(first)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Fix%20up%20.to%20properties%20of%20first%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20first.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20span%20%3D%20first%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20if%20(span.to%20%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20found%20%3D%20getMarkedSpanFor(last%2C%20span.marker)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(!found)%20span.to%20%3D%20startCh%3B%0A%20%20%20%20%20%20%20%20%20%20else%20if%20(sameLine)%20span.to%20%3D%20found.to%20%3D%3D%20null%20%3F%20null%20%3A%20found.to%20%2B%20offset%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20if%20(last)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Fix%20up%20.from%20in%20last%20(or%20move%20them%20into%20first%20in%20case%20of%20sameLine)%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20last.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20span%20%3D%20last%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20if%20(span.to%20!%3D%20null)%20span.to%20%2B%3D%20offset%3B%0A%20%20%20%20%20%20%20%20if%20(span.from%20%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20found%20%3D%20getMarkedSpanFor(first%2C%20span.marker)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(!found)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20span.from%20%3D%20offset%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(sameLine)%20(first%20%7C%7C%20(first%20%3D%20%5B%5D)).push(span)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20span.from%20%2B%3D%20offset%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(sameLine)%20(first%20%7C%7C%20(first%20%3D%20%5B%5D)).push(span)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%0A%20%20%20%20var%20newMarkers%20%3D%20%5BnewHL(newText%5B0%5D%2C%20first)%5D%3B%0A%20%20%20%20if%20(!sameLine)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Fill%20gap%20with%20whole-line-spans%0A%20%20%20%20%20%20var%20gap%20%3D%20newText.length%20-%202%2C%20gapMarkers%3B%0A%20%20%20%20%20%20if%20(gap%20%3E%200%20%26%26%20first)%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20first.length%3B%20%2B%2Bi)%0A%20%20%20%20%20%20%20%20%20%20if%20(first%5Bi%5D.to%20%3D%3D%20null)%0A%20%20%20%20%20%20%20%20%20%20%20%20(gapMarkers%20%7C%7C%20(gapMarkers%20%3D%20%5B%5D)).push(%7Bfrom%3A%20null%2C%20to%3A%20null%2C%20marker%3A%20first%5Bi%5D.marker%7D)%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20gap%3B%20%2B%2Bi)%0A%20%20%20%20%20%20%20%20newMarkers.push(newHL(newText%5Bi%2B1%5D%2C%20gapMarkers))%3B%0A%20%20%20%20%20%20newMarkers.push(newHL(lst(newText)%2C%20last))%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20newMarkers%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20hl%20stands%20for%20history-line%2C%20a%20data%20structure%20that%20can%20be%20either%20a%0A%20%20%2F%2F%20string%20(line%20without%20markers)%20or%20a%20%7Btext%2C%20markedSpans%7D%20object.%0A%20%20function%20hlText(val)%20%7B%20return%20typeof%20val%20%3D%3D%20%22string%22%20%3F%20val%20%3A%20val.text%3B%20%7D%0A%20%20function%20hlSpans(val)%20%7B%20return%20typeof%20val%20%3D%3D%20%22string%22%20%3F%20null%20%3A%20val.markedSpans%3B%20%7D%0A%20%20function%20newHL(text%2C%20spans)%20%7B%20return%20spans%20%3F%20%7Btext%3A%20text%2C%20markedSpans%3A%20spans%7D%20%3A%20text%3B%20%7D%0A%0A%20%20function%20detachMarkedSpans(line)%20%7B%0A%20%20%20%20var%20spans%20%3D%20line.markedSpans%3B%0A%20%20%20%20if%20(!spans)%20return%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20spans.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20var%20lines%20%3D%20spans%5Bi%5D.marker.lines%3B%0A%20%20%20%20%20%20var%20ix%20%3D%20indexOf(lines%2C%20line)%3B%0A%20%20%20%20%20%20lines.splice(ix%2C%201)%3B%0A%20%20%20%20%7D%0A%20%20%20%20line.markedSpans%20%3D%20null%3B%0A%20%20%7D%0A%0A%20%20function%20attachMarkedSpans(line%2C%20spans)%20%7B%0A%20%20%20%20if%20(!spans)%20return%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20spans.length%3B%20%2B%2Bi)%0A%20%20%20%20%20%20var%20marker%20%3D%20spans%5Bi%5D.marker.lines.push(line)%3B%0A%20%20%20%20line.markedSpans%20%3D%20spans%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20When%20measuring%20the%20position%20of%20the%20end%20of%20a%20line%2C%20different%0A%20%20%2F%2F%20browsers%20require%20different%20approaches.%20If%20an%20empty%20span%20is%20added%2C%0A%20%20%2F%2F%20many%20browsers%20report%20bogus%20offsets.%20Of%20those%2C%20some%20(Webkit%2C%0A%20%20%2F%2F%20recent%20IE)%20will%20accept%20a%20space%20without%20moving%20the%20whole%20span%20to%0A%20%20%2F%2F%20the%20next%20line%20when%20wrapping%20it%2C%20others%20work%20with%20a%20zero-width%0A%20%20%2F%2F%20space.%0A%20%20var%20eolSpanContent%20%3D%20%22%20%22%3B%0A%20%20if%20(gecko%20%7C%7C%20(ie%20%26%26%20!ie_lt8))%20eolSpanContent%20%3D%20%22%5Cu200b%22%3B%0A%20%20else%20if%20(opera)%20eolSpanContent%20%3D%20%22%22%3B%0A%0A%20%20%2F%2F%20Line%20objects.%20These%20hold%20state%20related%20to%20a%20line%2C%20including%0A%20%20%2F%2F%20highlighting%20info%20(the%20styles%20array).%0A%20%20function%20Line(text%2C%20markedSpans)%20%7B%0A%20%20%20%20this.text%20%3D%20text%3B%0A%20%20%20%20this.height%20%3D%201%3B%0A%20%20%20%20attachMarkedSpans(this%2C%20markedSpans)%3B%0A%20%20%7D%0A%20%20Line.prototype%20%3D%20%7B%0A%20%20%20%20update%3A%20function(text%2C%20markedSpans)%20%7B%0A%20%20%20%20%20%20this.text%20%3D%20text%3B%0A%20%20%20%20%20%20this.stateAfter%20%3D%20this.styles%20%3D%20null%3B%0A%20%20%20%20%20%20detachMarkedSpans(this)%3B%0A%20%20%20%20%20%20attachMarkedSpans(this%2C%20markedSpans)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20%2F%2F%20Run%20the%20given%20mode's%20parser%20over%20a%20line%2C%20update%20the%20styles%0A%20%20%20%20%2F%2F%20array%2C%20which%20contains%20alternating%20fragments%20of%20text%20and%20CSS%0A%20%20%20%20%2F%2F%20classes.%0A%20%20%20%20highlight%3A%20function(mode%2C%20state%2C%20tabSize)%20%7B%0A%20%20%20%20%20%20var%20stream%20%3D%20new%20StringStream(this.text%2C%20tabSize)%2C%20st%20%3D%20this.styles%20%7C%7C%20(this.styles%20%3D%20%5B%5D)%3B%0A%20%20%20%20%20%20var%20pos%20%3D%20st.length%20%3D%200%3B%0A%20%20%20%20%20%20if%20(this.text%20%3D%3D%20%22%22%20%26%26%20mode.blankLine)%20mode.blankLine(state)%3B%0A%20%20%20%20%20%20while%20(!stream.eol())%20%7B%0A%20%20%20%20%20%20%20%20var%20style%20%3D%20mode.token(stream%2C%20state)%2C%20substr%20%3D%20stream.current()%3B%0A%20%20%20%20%20%20%20%20stream.start%20%3D%20stream.pos%3B%0A%20%20%20%20%20%20%20%20if%20(pos%20%26%26%20st%5Bpos-1%5D%20%3D%3D%20style)%20%7B%0A%20%20%20%20%20%20%20%20%20%20st%5Bpos-2%5D%20%2B%3D%20substr%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(substr)%20%7B%0A%20%20%20%20%20%20%20%20%20%20st%5Bpos%2B%2B%5D%20%3D%20substr%3B%20st%5Bpos%2B%2B%5D%20%3D%20style%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%2F%2F%20Give%20up%20when%20line%20is%20ridiculously%20long%0A%20%20%20%20%20%20%20%20if%20(stream.pos%20%3E%205000)%20%7B%0A%20%20%20%20%20%20%20%20%20%20st%5Bpos%2B%2B%5D%20%3D%20this.text.slice(stream.pos)%3B%20st%5Bpos%2B%2B%5D%20%3D%20null%3B%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20process%3A%20function(mode%2C%20state%2C%20tabSize)%20%7B%0A%20%20%20%20%20%20var%20stream%20%3D%20new%20StringStream(this.text%2C%20tabSize)%3B%0A%20%20%20%20%20%20if%20(this.text%20%3D%3D%20%22%22%20%26%26%20mode.blankLine)%20mode.blankLine(state)%3B%0A%20%20%20%20%20%20while%20(!stream.eol()%20%26%26%20stream.pos%20%3C%3D%205000)%20%7B%0A%20%20%20%20%20%20%20%20mode.token(stream%2C%20state)%3B%0A%20%20%20%20%20%20%20%20stream.start%20%3D%20stream.pos%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20%2F%2F%20Fetch%20the%20parser%20token%20for%20a%20given%20character.%20Useful%20for%20hacks%0A%20%20%20%20%2F%2F%20that%20want%20to%20inspect%20the%20mode%20state%20(say%2C%20for%20completion).%0A%20%20%20%20getTokenAt%3A%20function(mode%2C%20state%2C%20tabSize%2C%20ch)%20%7B%0A%20%20%20%20%20%20var%20txt%20%3D%20this.text%2C%20stream%20%3D%20new%20StringStream(txt%2C%20tabSize)%3B%0A%20%20%20%20%20%20while%20(stream.pos%20%3C%20ch%20%26%26%20!stream.eol())%20%7B%0A%20%20%20%20%20%20%20%20stream.start%20%3D%20stream.pos%3B%0A%20%20%20%20%20%20%20%20var%20style%20%3D%20mode.token(stream%2C%20state)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20%7Bstart%3A%20stream.start%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20end%3A%20stream.pos%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20string%3A%20stream.current()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20className%3A%20style%20%7C%7C%20null%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20state%3A%20state%7D%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20indentation%3A%20function(tabSize)%20%7Breturn%20countColumn(this.text%2C%20null%2C%20tabSize)%3B%7D%2C%0A%20%20%20%20%2F%2F%20Produces%20an%20HTML%20fragment%20for%20the%20line%2C%20taking%20selection%2C%0A%20%20%20%20%2F%2F%20marking%2C%20and%20highlighting%20into%20account.%0A%20%20%20%20getContent%3A%20function(tabSize%2C%20wrapAt%2C%20compensateForWrapping)%20%7B%0A%20%20%20%20%20%20var%20first%20%3D%20true%2C%20col%20%3D%200%2C%20specials%20%3D%20%2F%5B%5Ct%5Cu0000-%5Cu0019%5Cu200b%5Cu2028%5Cu2029%5CuFEFF%5D%2Fg%3B%0A%20%20%20%20%20%20var%20pre%20%3D%20elt(%22pre%22)%3B%0A%20%20%20%20%20%20function%20span_(html%2C%20text%2C%20style)%20%7B%0A%20%20%20%20%20%20%20%20if%20(!text)%20return%3B%0A%20%20%20%20%20%20%20%20%2F%2F%20Work%20around%20a%20bug%20where%2C%20in%20some%20compat%20modes%2C%20IE%20ignores%20leading%20spaces%0A%20%20%20%20%20%20%20%20if%20(first%20%26%26%20ie%20%26%26%20text.charAt(0)%20%3D%3D%20%22%20%22)%20text%20%3D%20%22%5Cu00a0%22%20%2B%20text.slice(1)%3B%0A%20%20%20%20%20%20%20%20first%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20if%20(!specials.test(text))%20%7B%0A%20%20%20%20%20%20%20%20%20%20col%20%2B%3D%20text.length%3B%0A%20%20%20%20%20%20%20%20%20%20var%20content%20%3D%20document.createTextNode(text)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20content%20%3D%20document.createDocumentFragment()%2C%20pos%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%20%20while%20(true)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20specials.lastIndex%20%3D%20pos%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20m%20%3D%20specials.exec(text)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20skipped%20%3D%20m%20%3F%20m.index%20-%20pos%20%3A%20text.length%20-%20pos%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(skipped)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20content.appendChild(document.createTextNode(text.slice(pos%2C%20pos%20%2B%20skipped)))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20col%20%2B%3D%20skipped%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(!m)%20break%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20pos%20%2B%3D%20skipped%20%2B%201%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(m%5B0%5D%20%3D%3D%20%22%5Ct%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20tabWidth%20%3D%20tabSize%20-%20col%20%25%20tabSize%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20content.appendChild(elt(%22span%22%2C%20spaceStr(tabWidth)%2C%20%22cm-tab%22))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20col%20%2B%3D%20tabWidth%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20token%20%3D%20elt(%22span%22%2C%20%22%5Cu2022%22%2C%20%22cm-invalidchar%22)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20token.title%20%3D%20%22%5C%5Cu%22%20%2B%20m%5B0%5D.charCodeAt(0).toString(16)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20content.appendChild(token)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20col%20%2B%3D%201%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20if%20(style)%20html.appendChild(elt(%22span%22%2C%20%5Bcontent%5D%2C%20style))%3B%0A%20%20%20%20%20%20%20%20else%20html.appendChild(content)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20var%20span%20%3D%20span_%3B%0A%20%20%20%20%20%20if%20(wrapAt%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20var%20outPos%20%3D%200%2C%20anchor%20%3D%20pre.anchor%20%3D%20elt(%22span%22)%3B%0A%20%20%20%20%20%20%20%20span%20%3D%20function(html%2C%20text%2C%20style)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20l%20%3D%20text.length%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(wrapAt%20%3E%3D%20outPos%20%26%26%20wrapAt%20%3C%20outPos%20%2B%20l)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(wrapAt%20%3E%20outPos)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20span_(html%2C%20text.slice(0%2C%20wrapAt%20-%20outPos)%2C%20style)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20See%20comment%20at%20the%20definition%20of%20spanAffectsWrapping%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(compensateForWrapping)%20html.appendChild(elt(%22wbr%22))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20html.appendChild(anchor)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20cut%20%3D%20wrapAt%20-%20outPos%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20span_(anchor%2C%20opera%20%3F%20text.slice(cut%2C%20cut%20%2B%201)%20%3A%20text.slice(cut)%2C%20style)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(opera)%20span_(html%2C%20text.slice(cut%20%2B%201)%2C%20style)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20wrapAt--%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20outPos%20%2B%3D%20l%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20outPos%20%2B%3D%20l%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20span_(html%2C%20text%2C%20style)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(outPos%20%3D%3D%20wrapAt%20%26%26%20outPos%20%3D%3D%20len)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20setTextContent(anchor%2C%20eolSpanContent)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20html.appendChild(anchor)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20Stop%20outputting%20HTML%20when%20gone%20sufficiently%20far%20beyond%20measure%0A%20%20%20%20%20%20%20%20%20%20%20%20else%20if%20(outPos%20%3E%20wrapAt%20%2B%2010%20%26%26%20%2F%5Cs%2F.test(text))%20span%20%3D%20function()%7B%7D%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20var%20st%20%3D%20this.styles%2C%20allText%20%3D%20this.text%2C%20marked%20%3D%20this.markedSpans%3B%0A%20%20%20%20%20%20var%20len%20%3D%20allText.length%3B%0A%20%20%20%20%20%20function%20styleToClass(style)%20%7B%0A%20%20%20%20%20%20%20%20if%20(!style)%20return%20null%3B%0A%20%20%20%20%20%20%20%20return%20%22cm-%22%20%2B%20style.replace(%2F%20%2B%2Fg%2C%20%22%20cm-%22)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(!allText%20%26%26%20wrapAt%20%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20span(pre%2C%20%22%20%22)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(!marked%20%7C%7C%20!marked.length)%20%7B%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20ch%20%3D%200%3B%20ch%20%3C%20len%3B%20i%2B%3D2)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20str%20%3D%20st%5Bi%5D%2C%20style%20%3D%20st%5Bi%2B1%5D%2C%20l%20%3D%20str.length%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(ch%20%2B%20l%20%3E%20len)%20str%20%3D%20str.slice(0%2C%20len%20-%20ch)%3B%0A%20%20%20%20%20%20%20%20%20%20ch%20%2B%3D%20l%3B%0A%20%20%20%20%20%20%20%20%20%20span(pre%2C%20str%2C%20styleToClass(style))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20marked.sort(function(a%2C%20b)%20%7B%20return%20a.from%20-%20b.from%3B%20%7D)%3B%0A%20%20%20%20%20%20%20%20var%20pos%20%3D%200%2C%20i%20%3D%200%2C%20text%20%3D%20%22%22%2C%20style%2C%20sg%20%3D%200%3B%0A%20%20%20%20%20%20%20%20var%20nextChange%20%3D%20marked%5B0%5D.from%20%7C%7C%200%2C%20marks%20%3D%20%5B%5D%2C%20markpos%20%3D%200%3B%0A%20%20%20%20%20%20%20%20var%20advanceMarks%20%3D%20function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20m%3B%0A%20%20%20%20%20%20%20%20%20%20while%20(markpos%20%3C%20marked.length%20%26%26%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20((m%20%3D%20marked%5Bmarkpos%5D).from%20%3D%3D%20pos%20%7C%7C%20m.from%20%3D%3D%20null))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(m.marker.type%20%3D%3D%20%22range%22)%20marks.push(m)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2B%2Bmarkpos%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20nextChange%20%3D%20markpos%20%3C%20marked.length%20%3F%20marked%5Bmarkpos%5D.from%20%3A%20Infinity%3B%0A%20%20%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20marks.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20to%20%3D%20marks%5Bi%5D.to%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(to%20%3D%3D%20null)%20to%20%3D%20Infinity%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(to%20%3D%3D%20pos)%20marks.splice(i--%2C%201)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20else%20nextChange%20%3D%20Math.min(to%2C%20nextChange)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%20%20var%20m%20%3D%200%3B%0A%20%20%20%20%20%20%20%20while%20(pos%20%3C%20len)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(nextChange%20%3D%3D%20pos)%20advanceMarks()%3B%0A%20%20%20%20%20%20%20%20%20%20var%20upto%20%3D%20Math.min(len%2C%20nextChange)%3B%0A%20%20%20%20%20%20%20%20%20%20while%20(true)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20(text)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20end%20%3D%20pos%20%2B%20text.length%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20appliedStyle%20%3D%20style%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20(var%20j%20%3D%200%3B%20j%20%3C%20marks.length%3B%20%2B%2Bj)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20mark%20%3D%20marks%5Bj%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20appliedStyle%20%3D%20(appliedStyle%20%3F%20appliedStyle%20%2B%20%22%20%22%20%3A%20%22%22)%20%2B%20mark.marker.style%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(mark.marker.endStyle%20%26%26%20mark.to%20%3D%3D%3D%20Math.min(end%2C%20upto))%20appliedStyle%20%2B%3D%20%22%20%22%20%2B%20mark.marker.endStyle%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(mark.marker.startStyle%20%26%26%20mark.from%20%3D%3D%3D%20pos)%20appliedStyle%20%2B%3D%20%22%20%22%20%2B%20mark.marker.startStyle%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20span(pre%2C%20end%20%3E%20upto%20%3F%20text.slice(0%2C%20upto%20-%20pos)%20%3A%20text%2C%20appliedStyle)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20(end%20%3E%3D%20upto)%20%7Btext%20%3D%20text.slice(upto%20-%20pos)%3B%20pos%20%3D%20upto%3B%20break%3B%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20pos%20%3D%20end%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20text%20%3D%20st%5Bi%2B%2B%5D%3B%20style%20%3D%20styleToClass(st%5Bi%2B%2B%5D)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20pre%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20cleanUp%3A%20function()%20%7B%0A%20%20%20%20%20%20this.parent%20%3D%20null%3B%0A%20%20%20%20%20%20detachMarkedSpans(this)%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%0A%20%20%2F%2F%20Data%20structure%20that%20holds%20the%20sequence%20of%20lines.%0A%20%20function%20LeafChunk(lines)%20%7B%0A%20%20%20%20this.lines%20%3D%20lines%3B%0A%20%20%20%20this.parent%20%3D%20null%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20lines.length%2C%20height%20%3D%200%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20lines%5Bi%5D.parent%20%3D%20this%3B%0A%20%20%20%20%20%20height%20%2B%3D%20lines%5Bi%5D.height%3B%0A%20%20%20%20%7D%0A%20%20%20%20this.height%20%3D%20height%3B%0A%20%20%7D%0A%20%20LeafChunk.prototype%20%3D%20%7B%0A%20%20%20%20chunkSize%3A%20function()%20%7B%20return%20this.lines.length%3B%20%7D%2C%0A%20%20%20%20remove%3A%20function(at%2C%20n%2C%20callbacks)%20%7B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%20at%2C%20e%20%3D%20at%20%2B%20n%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20line%20%3D%20this.lines%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20this.height%20-%3D%20line.height%3B%0A%20%20%20%20%20%20%20%20line.cleanUp()%3B%0A%20%20%20%20%20%20%20%20if%20(line.handlers)%0A%20%20%20%20%20%20%20%20%20%20for%20(var%20j%20%3D%200%3B%20j%20%3C%20line.handlers.length%3B%20%2B%2Bj)%20callbacks.push(line.handlers%5Bj%5D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20this.lines.splice(at%2C%20n)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20collapse%3A%20function(lines)%20%7B%0A%20%20%20%20%20%20lines.splice.apply(lines%2C%20%5Blines.length%2C%200%5D.concat(this.lines))%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20insertHeight%3A%20function(at%2C%20lines%2C%20height)%20%7B%0A%20%20%20%20%20%20this.height%20%2B%3D%20height%3B%0A%20%20%20%20%20%20this.lines%20%3D%20this.lines.slice(0%2C%20at).concat(lines).concat(this.lines.slice(at))%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20lines.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20lines%5Bi%5D.parent%20%3D%20this%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20iterN%3A%20function(at%2C%20n%2C%20op)%20%7B%0A%20%20%20%20%20%20for%20(var%20e%20%3D%20at%20%2B%20n%3B%20at%20%3C%20e%3B%20%2B%2Bat)%0A%20%20%20%20%20%20%20%20if%20(op(this.lines%5Bat%5D))%20return%20true%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%20%20function%20BranchChunk(children)%20%7B%0A%20%20%20%20this.children%20%3D%20children%3B%0A%20%20%20%20var%20size%20%3D%200%2C%20height%20%3D%200%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20children.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20var%20ch%20%3D%20children%5Bi%5D%3B%0A%20%20%20%20%20%20size%20%2B%3D%20ch.chunkSize()%3B%20height%20%2B%3D%20ch.height%3B%0A%20%20%20%20%20%20ch.parent%20%3D%20this%3B%0A%20%20%20%20%7D%0A%20%20%20%20this.size%20%3D%20size%3B%0A%20%20%20%20this.height%20%3D%20height%3B%0A%20%20%20%20this.parent%20%3D%20null%3B%0A%20%20%7D%0A%20%20BranchChunk.prototype%20%3D%20%7B%0A%20%20%20%20chunkSize%3A%20function()%20%7B%20return%20this.size%3B%20%7D%2C%0A%20%20%20%20remove%3A%20function(at%2C%20n%2C%20callbacks)%20%7B%0A%20%20%20%20%20%20this.size%20-%3D%20n%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20this.children.length%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20child%20%3D%20this.children%5Bi%5D%2C%20sz%20%3D%20child.chunkSize()%3B%0A%20%20%20%20%20%20%20%20if%20(at%20%3C%20sz)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20rm%20%3D%20Math.min(n%2C%20sz%20-%20at)%2C%20oldHeight%20%3D%20child.height%3B%0A%20%20%20%20%20%20%20%20%20%20child.remove(at%2C%20rm%2C%20callbacks)%3B%0A%20%20%20%20%20%20%20%20%20%20this.height%20-%3D%20oldHeight%20-%20child.height%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(sz%20%3D%3D%20rm)%20%7B%20this.children.splice(i--%2C%201)%3B%20child.parent%20%3D%20null%3B%20%7D%0A%20%20%20%20%20%20%20%20%20%20if%20((n%20-%3D%20rm)%20%3D%3D%200)%20break%3B%0A%20%20%20%20%20%20%20%20%20%20at%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20at%20-%3D%20sz%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(this.size%20-%20n%20%3C%2025)%20%7B%0A%20%20%20%20%20%20%20%20var%20lines%20%3D%20%5B%5D%3B%0A%20%20%20%20%20%20%20%20this.collapse(lines)%3B%0A%20%20%20%20%20%20%20%20this.children%20%3D%20%5Bnew%20LeafChunk(lines)%5D%3B%0A%20%20%20%20%20%20%20%20this.children%5B0%5D.parent%20%3D%20this%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20collapse%3A%20function(lines)%20%7B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20this.children.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20this.children%5Bi%5D.collapse(lines)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20insert%3A%20function(at%2C%20lines)%20%7B%0A%20%20%20%20%20%20var%20height%20%3D%200%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20lines.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20height%20%2B%3D%20lines%5Bi%5D.height%3B%0A%20%20%20%20%20%20this.insertHeight(at%2C%20lines%2C%20height)%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20insertHeight%3A%20function(at%2C%20lines%2C%20height)%20%7B%0A%20%20%20%20%20%20this.size%20%2B%3D%20lines.length%3B%0A%20%20%20%20%20%20this.height%20%2B%3D%20height%3B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20this.children.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20child%20%3D%20this.children%5Bi%5D%2C%20sz%20%3D%20child.chunkSize()%3B%0A%20%20%20%20%20%20%20%20if%20(at%20%3C%3D%20sz)%20%7B%0A%20%20%20%20%20%20%20%20%20%20child.insertHeight(at%2C%20lines%2C%20height)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(child.lines%20%26%26%20child.lines.length%20%3E%2050)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20while%20(child.lines.length%20%3E%2050)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20spilled%20%3D%20child.lines.splice(child.lines.length%20-%2025%2C%2025)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20newleaf%20%3D%20new%20LeafChunk(spilled)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20child.height%20-%3D%20newleaf.height%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20this.children.splice(i%20%2B%201%2C%200%2C%20newleaf)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20newleaf.parent%20%3D%20this%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20this.maybeSpill()%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20at%20-%3D%20sz%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20maybeSpill%3A%20function()%20%7B%0A%20%20%20%20%20%20if%20(this.children.length%20%3C%3D%2010)%20return%3B%0A%20%20%20%20%20%20var%20me%20%3D%20this%3B%0A%20%20%20%20%20%20do%20%7B%0A%20%20%20%20%20%20%20%20var%20spilled%20%3D%20me.children.splice(me.children.length%20-%205%2C%205)%3B%0A%20%20%20%20%20%20%20%20var%20sibling%20%3D%20new%20BranchChunk(spilled)%3B%0A%20%20%20%20%20%20%20%20if%20(!me.parent)%20%7B%20%2F%2F%20Become%20the%20parent%20node%0A%20%20%20%20%20%20%20%20%20%20var%20copy%20%3D%20new%20BranchChunk(me.children)%3B%0A%20%20%20%20%20%20%20%20%20%20copy.parent%20%3D%20me%3B%0A%20%20%20%20%20%20%20%20%20%20me.children%20%3D%20%5Bcopy%2C%20sibling%5D%3B%0A%20%20%20%20%20%20%20%20%20%20me%20%3D%20copy%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20me.size%20-%3D%20sibling.size%3B%0A%20%20%20%20%20%20%20%20%20%20me.height%20-%3D%20sibling.height%3B%0A%20%20%20%20%20%20%20%20%20%20var%20myIndex%20%3D%20indexOf(me.parent.children%2C%20me)%3B%0A%20%20%20%20%20%20%20%20%20%20me.parent.children.splice(myIndex%20%2B%201%2C%200%2C%20sibling)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20sibling.parent%20%3D%20me.parent%3B%0A%20%20%20%20%20%20%7D%20while%20(me.children.length%20%3E%2010)%3B%0A%20%20%20%20%20%20me.parent.maybeSpill()%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20iter%3A%20function(from%2C%20to%2C%20op)%20%7B%20this.iterN(from%2C%20to%20-%20from%2C%20op)%3B%20%7D%2C%0A%20%20%20%20iterN%3A%20function(at%2C%20n%2C%20op)%20%7B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20this.children.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20child%20%3D%20this.children%5Bi%5D%2C%20sz%20%3D%20child.chunkSize()%3B%0A%20%20%20%20%20%20%20%20if%20(at%20%3C%20sz)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20used%20%3D%20Math.min(n%2C%20sz%20-%20at)%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(child.iterN(at%2C%20used%2C%20op))%20return%20true%3B%0A%20%20%20%20%20%20%20%20%20%20if%20((n%20-%3D%20used)%20%3D%3D%200)%20break%3B%0A%20%20%20%20%20%20%20%20%20%20at%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20at%20-%3D%20sz%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%0A%20%20function%20getLineAt(chunk%2C%20n)%20%7B%0A%20%20%20%20while%20(!chunk.lines)%20%7B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%3B%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20child%20%3D%20chunk.children%5Bi%5D%2C%20sz%20%3D%20child.chunkSize()%3B%0A%20%20%20%20%20%20%20%20if%20(n%20%3C%20sz)%20%7B%20chunk%20%3D%20child%3B%20break%3B%20%7D%0A%20%20%20%20%20%20%20%20n%20-%3D%20sz%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20chunk.lines%5Bn%5D%3B%0A%20%20%7D%0A%20%20function%20lineNo(line)%20%7B%0A%20%20%20%20if%20(line.parent%20%3D%3D%20null)%20return%20null%3B%0A%20%20%20%20var%20cur%20%3D%20line.parent%2C%20no%20%3D%20indexOf(cur.lines%2C%20line)%3B%0A%20%20%20%20for%20(var%20chunk%20%3D%20cur.parent%3B%20chunk%3B%20cur%20%3D%20chunk%2C%20chunk%20%3D%20chunk.parent)%20%7B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20chunk.children.length%3B%20%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20if%20(chunk.children%5Bi%5D%20%3D%3D%20cur)%20break%3B%0A%20%20%20%20%20%20%20%20no%20%2B%3D%20chunk.children%5Bi%5D.chunkSize()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20no%3B%0A%20%20%7D%0A%20%20function%20lineAtHeight(chunk%2C%20h)%20%7B%0A%20%20%20%20var%20n%20%3D%200%3B%0A%20%20%20%20outer%3A%20do%20%7B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20chunk.children.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20child%20%3D%20chunk.children%5Bi%5D%2C%20ch%20%3D%20child.height%3B%0A%20%20%20%20%20%20%20%20if%20(h%20%3C%20ch)%20%7B%20chunk%20%3D%20child%3B%20continue%20outer%3B%20%7D%0A%20%20%20%20%20%20%20%20h%20-%3D%20ch%3B%0A%20%20%20%20%20%20%20%20n%20%2B%3D%20child.chunkSize()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20n%3B%0A%20%20%20%20%7D%20while%20(!chunk.lines)%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20chunk.lines.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20var%20line%20%3D%20chunk.lines%5Bi%5D%2C%20lh%20%3D%20line.height%3B%0A%20%20%20%20%20%20if%20(h%20%3C%20lh)%20break%3B%0A%20%20%20%20%20%20h%20-%3D%20lh%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20n%20%2B%20i%3B%0A%20%20%7D%0A%20%20function%20heightAtLine(chunk%2C%20n)%20%7B%0A%20%20%20%20var%20h%20%3D%200%3B%0A%20%20%20%20outer%3A%20do%20%7B%0A%20%20%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20chunk.children.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20%20%20var%20child%20%3D%20chunk.children%5Bi%5D%2C%20sz%20%3D%20child.chunkSize()%3B%0A%20%20%20%20%20%20%20%20if%20(n%20%3C%20sz)%20%7B%20chunk%20%3D%20child%3B%20continue%20outer%3B%20%7D%0A%20%20%20%20%20%20%20%20n%20-%3D%20sz%3B%0A%20%20%20%20%20%20%20%20h%20%2B%3D%20child.height%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20h%3B%0A%20%20%20%20%7D%20while%20(!chunk.lines)%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20n%3B%20%2B%2Bi)%20h%20%2B%3D%20chunk.lines%5Bi%5D.height%3B%0A%20%20%20%20return%20h%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20The%20history%20object%20'chunks'%20changes%20that%20are%20made%20close%20together%0A%20%20%2F%2F%20and%20at%20almost%20the%20same%20time%20into%20bigger%20undoable%20units.%0A%20%20function%20History()%20%7B%0A%20%20%20%20this.time%20%3D%200%3B%0A%20%20%20%20this.done%20%3D%20%5B%5D%3B%20this.undone%20%3D%20%5B%5D%3B%0A%20%20%20%20this.compound%20%3D%200%3B%0A%20%20%20%20this.closed%20%3D%20false%3B%0A%20%20%7D%0A%20%20History.prototype%20%3D%20%7B%0A%20%20%20%20addChange%3A%20function(start%2C%20added%2C%20old)%20%7B%0A%20%20%20%20%20%20this.undone.length%20%3D%200%3B%0A%20%20%20%20%20%20var%20time%20%3D%20%2Bnew%20Date%2C%20cur%20%3D%20lst(this.done)%2C%20last%20%3D%20cur%20%26%26%20lst(cur)%3B%0A%20%20%20%20%20%20var%20dtime%20%3D%20time%20-%20this.time%3B%0A%0A%20%20%20%20%20%20if%20(this.compound%20%26%26%20cur%20%26%26%20!this.closed)%20%7B%0A%20%20%20%20%20%20%20%20cur.push(%7Bstart%3A%20start%2C%20added%3A%20added%2C%20old%3A%20old%7D)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(dtime%20%3E%20400%20%7C%7C%20!last%20%7C%7C%20this.closed%20%7C%7C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20last.start%20%3E%20start%20%2B%20old.length%20%7C%7C%20last.start%20%2B%20last.added%20%3C%20start)%20%7B%0A%20%20%20%20%20%20%20%20this.done.push(%5B%7Bstart%3A%20start%2C%20added%3A%20added%2C%20old%3A%20old%7D%5D)%3B%0A%20%20%20%20%20%20%20%20this.closed%20%3D%20false%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20var%20startBefore%20%3D%20Math.max(0%2C%20last.start%20-%20start)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20endAfter%20%3D%20Math.max(0%2C%20(start%20%2B%20old.length)%20-%20(last.start%20%2B%20last.added))%3B%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%20startBefore%3B%20i%20%3E%200%3B%20--i)%20last.old.unshift(old%5Bi%20-%201%5D)%3B%0A%20%20%20%20%20%20%20%20for%20(var%20i%20%3D%20endAfter%3B%20i%20%3E%200%3B%20--i)%20last.old.push(old%5Bold.length%20-%20i%5D)%3B%0A%20%20%20%20%20%20%20%20if%20(startBefore)%20last.start%20%3D%20start%3B%0A%20%20%20%20%20%20%20%20last.added%20%2B%3D%20added%20-%20(old.length%20-%20startBefore%20-%20endAfter)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20this.time%20%3D%20time%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20startCompound%3A%20function()%20%7B%0A%20%20%20%20%20%20if%20(!this.compound%2B%2B)%20this.closed%20%3D%20true%3B%0A%20%20%20%20%7D%2C%0A%20%20%20%20endCompound%3A%20function()%20%7B%0A%20%20%20%20%20%20if%20(!--this.compound)%20this.closed%20%3D%20true%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%0A%20%20function%20stopMethod()%20%7Be_stop(this)%3B%7D%0A%20%20%2F%2F%20Ensure%20an%20event%20has%20a%20stop%20method.%0A%20%20function%20addStop(event)%20%7B%0A%20%20%20%20if%20(!event.stop)%20event.stop%20%3D%20stopMethod%3B%0A%20%20%20%20return%20event%3B%0A%20%20%7D%0A%0A%20%20function%20e_preventDefault(e)%20%7B%0A%20%20%20%20if%20(e.preventDefault)%20e.preventDefault()%3B%0A%20%20%20%20else%20e.returnValue%20%3D%20false%3B%0A%20%20%7D%0A%20%20function%20e_stopPropagation(e)%20%7B%0A%20%20%20%20if%20(e.stopPropagation)%20e.stopPropagation()%3B%0A%20%20%20%20else%20e.cancelBubble%20%3D%20true%3B%0A%20%20%7D%0A%20%20function%20e_stop(e)%20%7Be_preventDefault(e)%3B%20e_stopPropagation(e)%3B%7D%0A%20%20CodeMirror.e_stop%20%3D%20e_stop%3B%0A%20%20CodeMirror.e_preventDefault%20%3D%20e_preventDefault%3B%0A%20%20CodeMirror.e_stopPropagation%20%3D%20e_stopPropagation%3B%0A%0A%20%20function%20e_target(e)%20%7Breturn%20e.target%20%7C%7C%20e.srcElement%3B%7D%0A%20%20function%20e_button(e)%20%7B%0A%20%20%20%20var%20b%20%3D%20e.which%3B%0A%20%20%20%20if%20(b%20%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20if%20(e.button%20%26%201)%20b%20%3D%201%3B%0A%20%20%20%20%20%20else%20if%20(e.button%20%26%202)%20b%20%3D%203%3B%0A%20%20%20%20%20%20else%20if%20(e.button%20%26%204)%20b%20%3D%202%3B%0A%20%20%20%20%7D%0A%20%20%20%20if%20(mac%20%26%26%20e.ctrlKey%20%26%26%20b%20%3D%3D%201)%20b%20%3D%203%3B%0A%20%20%20%20return%20b%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20Allow%203rd-party%20code%20to%20override%20event%20properties%20by%20adding%20an%20override%0A%20%20%2F%2F%20object%20to%20an%20event%20object.%0A%20%20function%20e_prop(e%2C%20prop)%20%7B%0A%20%20%20%20var%20overridden%20%3D%20e.override%20%26%26%20e.override.hasOwnProperty(prop)%3B%0A%20%20%20%20return%20overridden%20%3F%20e.override%5Bprop%5D%20%3A%20e%5Bprop%5D%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20Event%20handler%20registration.%20If%20disconnect%20is%20true%2C%20it'll%20return%20a%0A%20%20%2F%2F%20function%20that%20unregisters%20the%20handler.%0A%20%20function%20connect(node%2C%20type%2C%20handler%2C%20disconnect)%20%7B%0A%20%20%20%20if%20(typeof%20node.addEventListener%20%3D%3D%20%22function%22)%20%7B%0A%20%20%20%20%20%20node.addEventListener(type%2C%20handler%2C%20false)%3B%0A%20%20%20%20%20%20if%20(disconnect)%20return%20function()%20%7Bnode.removeEventListener(type%2C%20handler%2C%20false)%3B%7D%3B%0A%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20var%20wrapHandler%20%3D%20function(event)%20%7Bhandler(event%20%7C%7C%20window.event)%3B%7D%3B%0A%20%20%20%20%20%20node.attachEvent(%22on%22%20%2B%20type%2C%20wrapHandler)%3B%0A%20%20%20%20%20%20if%20(disconnect)%20return%20function()%20%7Bnode.detachEvent(%22on%22%20%2B%20type%2C%20wrapHandler)%3B%7D%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20CodeMirror.connect%20%3D%20connect%3B%0A%0A%20%20function%20Delayed()%20%7Bthis.id%20%3D%20null%3B%7D%0A%20%20Delayed.prototype%20%3D%20%7Bset%3A%20function(ms%2C%20f)%20%7BclearTimeout(this.id)%3B%20this.id%20%3D%20setTimeout(f%2C%20ms)%3B%7D%7D%3B%0A%0A%20%20var%20Pass%20%3D%20CodeMirror.Pass%20%3D%20%7BtoString%3A%20function()%7Breturn%20%22CodeMirror.Pass%22%3B%7D%7D%3B%0A%0A%20%20%2F%2F%20Detect%20drag-and-drop%0A%20%20var%20dragAndDrop%20%3D%20function()%20%7B%0A%20%20%20%20%2F%2F%20There%20is%20*some*%20kind%20of%20drag-and-drop%20support%20in%20IE6-8%2C%20but%20I%0A%20%20%20%20%2F%2F%20couldn't%20get%20it%20to%20work%20yet.%0A%20%20%20%20if%20(ie_lt9)%20return%20false%3B%0A%20%20%20%20var%20div%20%3D%20elt('div')%3B%0A%20%20%20%20return%20%22draggable%22%20in%20div%20%7C%7C%20%22dragDrop%22%20in%20div%3B%0A%20%20%7D()%3B%0A%0A%20%20%2F%2F%20Feature-detect%20whether%20newlines%20in%20textareas%20are%20converted%20to%20%5Cr%5Cn%0A%20%20var%20lineSep%20%3D%20function%20()%20%7B%0A%20%20%20%20var%20te%20%3D%20elt(%22textarea%22)%3B%0A%20%20%20%20te.value%20%3D%20%22foo%5Cnbar%22%3B%0A%20%20%20%20if%20(te.value.indexOf(%22%5Cr%22)%20%3E%20-1)%20return%20%22%5Cr%5Cn%22%3B%0A%20%20%20%20return%20%22%5Cn%22%3B%0A%20%20%7D()%3B%0A%0A%20%20%2F%2F%20For%20a%20reason%20I%20have%20yet%20to%20figure%20out%2C%20some%20browsers%20disallow%0A%20%20%2F%2F%20word%20wrapping%20between%20certain%20characters%20*only*%20if%20a%20new%20inline%0A%20%20%2F%2F%20element%20is%20started%20between%20them.%20This%20makes%20it%20hard%20to%20reliably%0A%20%20%2F%2F%20measure%20the%20position%20of%20things%2C%20since%20that%20requires%20inserting%20an%0A%20%20%2F%2F%20extra%20span.%20This%20terribly%20fragile%20set%20of%20regexps%20matches%20the%0A%20%20%2F%2F%20character%20combinations%20that%20suffer%20from%20this%20phenomenon%20on%20the%0A%20%20%2F%2F%20various%20browsers.%0A%20%20var%20spanAffectsWrapping%20%3D%20%2F%5E%24%2F%3B%20%2F%2F%20Won't%20match%20any%20two-character%20string%0A%20%20if%20(gecko)%20spanAffectsWrapping%20%3D%20%2F%24'%2F%3B%0A%20%20else%20if%20(safari)%20spanAffectsWrapping%20%3D%20%2F%5C-%5B%5E%20%5C-%3F%5D%7C%5C%3F%5B%5E%20!'%5C%22%5C)%2C.%5C-%5C%2F%3A%3B%5C%3F%5C%5D%5C%7D%5D%2F%3B%0A%20%20else%20if%20(chrome)%20spanAffectsWrapping%20%3D%20%2F%5C-%5B%5E%20%5C-%5C.%3F%5D%7C%5C%3F%5B%5E%20%5C-%5C.%3F%5C%5D%5C%7D%3A%3B!'%5C%22%5C)%2C%5C%2F%5D%7C%5B%5C.!%5C%22%23%26%25%5C)*%2B%2C%3A%3B%3D%3E%5C%5D%7C%5C%7D~%5D%5B%5C(%5C%7B%5C%5B%3C%5D%7C%5C%24'%2F%3B%0A%0A%20%20%2F%2F%20Counts%20the%20column%20offset%20in%20a%20string%2C%20taking%20tabs%20into%20account.%0A%20%20%2F%2F%20Used%20mostly%20to%20find%20indentation.%0A%20%20function%20countColumn(string%2C%20end%2C%20tabSize)%20%7B%0A%20%20%20%20if%20(end%20%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20end%20%3D%20string.search(%2F%5B%5E%5Cs%5Cu00a0%5D%2F)%3B%0A%20%20%20%20%20%20if%20(end%20%3D%3D%20-1)%20end%20%3D%20string.length%3B%0A%20%20%20%20%7D%0A%20%20%20%20for%20(var%20i%20%3D%200%2C%20n%20%3D%200%3B%20i%20%3C%20end%3B%20%2B%2Bi)%20%7B%0A%20%20%20%20%20%20if%20(string.charAt(i)%20%3D%3D%20%22%5Ct%22)%20n%20%2B%3D%20tabSize%20-%20(n%20%25%20tabSize)%3B%0A%20%20%20%20%20%20else%20%2B%2Bn%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20n%3B%0A%20%20%7D%0A%0A%20%20function%20eltOffset(node%2C%20screen)%20%7B%0A%20%20%20%20%2F%2F%20Take%20the%20parts%20of%20bounding%20client%20rect%20that%20we%20are%20interested%20in%20so%20we%20are%20able%20to%20edit%20if%20need%20be%2C%0A%20%20%20%20%2F%2F%20since%20the%20returned%20value%20cannot%20be%20changed%20externally%20(they%20are%20kept%20in%20sync%20as%20the%20element%20moves%20within%20the%20page)%0A%20%20%20%20try%20%7B%20var%20box%20%3D%20node.getBoundingClientRect()%3B%20box%20%3D%20%7B%20top%3A%20box.top%2C%20left%3A%20box.left%20%7D%3B%20%7D%0A%20%20%20%20catch(e)%20%7B%20box%20%3D%20%7Btop%3A%200%2C%20left%3A%200%7D%3B%20%7D%0A%20%20%20%20if%20(!screen)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Get%20the%20toplevel%20scroll%2C%20working%20around%20browser%20differences.%0A%20%20%20%20%20%20if%20(window.pageYOffset%20%3D%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20var%20t%20%3D%20document.documentElement%20%7C%7C%20document.body.parentNode%3B%0A%20%20%20%20%20%20%20%20if%20(t.scrollTop%20%3D%3D%20null)%20t%20%3D%20document.body%3B%0A%20%20%20%20%20%20%20%20box.top%20%2B%3D%20t.scrollTop%3B%20box.left%20%2B%3D%20t.scrollLeft%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20box.top%20%2B%3D%20window.pageYOffset%3B%20box.left%20%2B%3D%20window.pageXOffset%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20box%3B%0A%20%20%7D%0A%0A%20%20function%20eltText(node)%20%7B%0A%20%20%20%20return%20node.textContent%20%7C%7C%20node.innerText%20%7C%7C%20node.nodeValue%20%7C%7C%20%22%22%3B%0A%20%20%7D%0A%0A%20%20var%20spaceStrs%20%3D%20%5B%22%22%5D%3B%0A%20%20function%20spaceStr(n)%20%7B%0A%20%20%20%20while%20(spaceStrs.length%20%3C%3D%20n)%0A%20%20%20%20%20%20spaceStrs.push(lst(spaceStrs)%20%2B%20%22%20%22)%3B%0A%20%20%20%20return%20spaceStrs%5Bn%5D%3B%0A%20%20%7D%0A%0A%20%20function%20lst(arr)%20%7B%20return%20arr%5Barr.length-1%5D%3B%20%7D%0A%0A%20%20function%20selectInput(node)%20%7B%0A%20%20%20%20if%20(ios)%20%7B%20%2F%2F%20Mobile%20Safari%20apparently%20has%20a%20bug%20where%20select()%20is%20broken.%0A%20%20%20%20%20%20node.selectionStart%20%3D%200%3B%0A%20%20%20%20%20%20node.selectionEnd%20%3D%20node.value.length%3B%0A%20%20%20%20%7D%20else%20node.select()%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20Operations%20on%20%7Bline%2C%20ch%7D%20objects.%0A%20%20function%20posEq(a%2C%20b)%20%7Breturn%20a.line%20%3D%3D%20b.line%20%26%26%20a.ch%20%3D%3D%20b.ch%3B%7D%0A%20%20function%20posLess(a%2C%20b)%20%7Breturn%20a.line%20%3C%20b.line%20%7C%7C%20(a.line%20%3D%3D%20b.line%20%26%26%20a.ch%20%3C%20b.ch)%3B%7D%0A%20%20function%20copyPos(x)%20%7Breturn%20%7Bline%3A%20x.line%2C%20ch%3A%20x.ch%7D%3B%7D%0A%0A%20%20function%20elt(tag%2C%20content%2C%20className%2C%20style)%20%7B%0A%20%20%20%20var%20e%20%3D%20document.createElement(tag)%3B%0A%20%20%20%20if%20(className)%20e.className%20%3D%20className%3B%0A%20%20%20%20if%20(style)%20e.style.cssText%20%3D%20style%3B%0A%20%20%20%20if%20(typeof%20content%20%3D%3D%20%22string%22)%20setTextContent(e%2C%20content)%3B%0A%20%20%20%20else%20if%20(content)%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20content.length%3B%20%2B%2Bi)%20e.appendChild(content%5Bi%5D)%3B%0A%20%20%20%20return%20e%3B%0A%20%20%7D%0A%20%20function%20removeChildren(e)%20%7B%0A%20%20%20%20e.innerHTML%20%3D%20%22%22%3B%0A%20%20%20%20return%20e%3B%0A%20%20%7D%0A%20%20function%20removeChildrenAndAdd(parent%2C%20e)%20%7B%0A%20%20%20%20removeChildren(parent).appendChild(e)%3B%0A%20%20%7D%0A%20%20function%20setTextContent(e%2C%20str)%20%7B%0A%20%20%20%20if%20(ie_lt9)%20%7B%0A%20%20%20%20%20%20e.innerHTML%20%3D%20%22%22%3B%0A%20%20%20%20%20%20e.appendChild(document.createTextNode(str))%3B%0A%20%20%20%20%7D%20else%20e.textContent%20%3D%20str%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20Used%20to%20position%20the%20cursor%20after%20an%20undo%2Fredo%20by%20finding%20the%0A%20%20%2F%2F%20last%20edited%20character.%0A%20%20function%20editEnd(from%2C%20to)%20%7B%0A%20%20%20%20if%20(!to)%20return%200%3B%0A%20%20%20%20if%20(!from)%20return%20to.length%3B%0A%20%20%20%20for%20(var%20i%20%3D%20from.length%2C%20j%20%3D%20to.length%3B%20i%20%3E%3D%200%20%26%26%20j%20%3E%3D%200%3B%20--i%2C%20--j)%0A%20%20%20%20%20%20if%20(from.charAt(i)%20!%3D%20to.charAt(j))%20break%3B%0A%20%20%20%20return%20j%20%2B%201%3B%0A%20%20%7D%0A%0A%20%20function%20indexOf(collection%2C%20elt)%20%7B%0A%20%20%20%20if%20(collection.indexOf)%20return%20collection.indexOf(elt)%3B%0A%20%20%20%20for%20(var%20i%20%3D%200%2C%20e%20%3D%20collection.length%3B%20i%20%3C%20e%3B%20%2B%2Bi)%0A%20%20%20%20%20%20if%20(collection%5Bi%5D%20%3D%3D%20elt)%20return%20i%3B%0A%20%20%20%20return%20-1%3B%0A%20%20%7D%0A%20%20function%20isWordChar(ch)%20%7B%0A%20%20%20%20return%20%2F%5Cw%2F.test(ch)%20%7C%7C%20ch.toUpperCase()%20!%3D%20ch.toLowerCase()%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20See%20if%20%22%22.split%20is%20the%20broken%20IE%20version%2C%20if%20so%2C%20provide%20an%0A%20%20%2F%2F%20alternative%20way%20to%20split%20lines.%0A%20%20var%20splitLines%20%3D%20%22%5Cn%5Cnb%22.split(%2F%5Cn%2F).length%20!%3D%203%20%3F%20function(string)%20%7B%0A%20%20%20%20var%20pos%20%3D%200%2C%20result%20%3D%20%5B%5D%2C%20l%20%3D%20string.length%3B%0A%20%20%20%20while%20(pos%20%3C%3D%20l)%20%7B%0A%20%20%20%20%20%20var%20nl%20%3D%20string.indexOf(%22%5Cn%22%2C%20pos)%3B%0A%20%20%20%20%20%20if%20(nl%20%3D%3D%20-1)%20nl%20%3D%20string.length%3B%0A%20%20%20%20%20%20var%20line%20%3D%20string.slice(pos%2C%20string.charAt(nl%20-%201)%20%3D%3D%20%22%5Cr%22%20%3F%20nl%20-%201%20%3A%20nl)%3B%0A%20%20%20%20%20%20var%20rt%20%3D%20line.indexOf(%22%5Cr%22)%3B%0A%20%20%20%20%20%20if%20(rt%20!%3D%20-1)%20%7B%0A%20%20%20%20%20%20%20%20result.push(line.slice(0%2C%20rt))%3B%0A%20%20%20%20%20%20%20%20pos%20%2B%3D%20rt%20%2B%201%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20result.push(line)%3B%0A%20%20%20%20%20%20%20%20pos%20%3D%20nl%20%2B%201%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20result%3B%0A%20%20%7D%20%3A%20function(string)%7Breturn%20string.split(%2F%5Cr%5Cn%3F%7C%5Cn%2F)%3B%7D%3B%0A%20%20CodeMirror.splitLines%20%3D%20splitLines%3B%0A%0A%20%20var%20hasSelection%20%3D%20window.getSelection%20%3F%20function(te)%20%7B%0A%20%20%20%20try%20%7B%20return%20te.selectionStart%20!%3D%20te.selectionEnd%3B%20%7D%0A%20%20%20%20catch(e)%20%7B%20return%20false%3B%20%7D%0A%20%20%7D%20%3A%20function(te)%20%7B%0A%20%20%20%20try%20%7Bvar%20range%20%3D%20te.ownerDocument.selection.createRange()%3B%7D%0A%20%20%20%20catch(e)%20%7B%7D%0A%20%20%20%20if%20(!range%20%7C%7C%20range.parentElement()%20!%3D%20te)%20return%20false%3B%0A%20%20%20%20return%20range.compareEndPoints(%22StartToEnd%22%2C%20range)%20!%3D%200%3B%0A%20%20%7D%3B%0A%0A%20%20CodeMirror.defineMode(%22null%22%2C%20function()%20%7B%0A%20%20%20%20return%20%7Btoken%3A%20function(stream)%20%7Bstream.skipToEnd()%3B%7D%7D%3B%0A%20%20%7D)%3B%0A%20%20CodeMirror.defineMIME(%22text%2Fplain%22%2C%20%22null%22)%3B%0A%0A%20%20var%20keyNames%20%3D%20%7B3%3A%20%22Enter%22%2C%208%3A%20%22Backspace%22%2C%209%3A%20%22Tab%22%2C%2013%3A%20%22Enter%22%2C%2016%3A%20%22Shift%22%2C%2017%3A%20%22Ctrl%22%2C%2018%3A%20%22Alt%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2019%3A%20%22Pause%22%2C%2020%3A%20%22CapsLock%22%2C%2027%3A%20%22Esc%22%2C%2032%3A%20%22Space%22%2C%2033%3A%20%22PageUp%22%2C%2034%3A%20%22PageDown%22%2C%2035%3A%20%22End%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2036%3A%20%22Home%22%2C%2037%3A%20%22Left%22%2C%2038%3A%20%22Up%22%2C%2039%3A%20%22Right%22%2C%2040%3A%20%22Down%22%2C%2044%3A%20%22PrintScrn%22%2C%2045%3A%20%22Insert%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2046%3A%20%22Delete%22%2C%2059%3A%20%22%3B%22%2C%2091%3A%20%22Mod%22%2C%2092%3A%20%22Mod%22%2C%2093%3A%20%22Mod%22%2C%20109%3A%20%22-%22%2C%20107%3A%20%22%3D%22%2C%20127%3A%20%22Delete%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20186%3A%20%22%3B%22%2C%20187%3A%20%22%3D%22%2C%20188%3A%20%22%2C%22%2C%20189%3A%20%22-%22%2C%20190%3A%20%22.%22%2C%20191%3A%20%22%2F%22%2C%20192%3A%20%22%60%22%2C%20219%3A%20%22%5B%22%2C%20220%3A%20%22%5C%5C%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20221%3A%20%22%5D%22%2C%20222%3A%20%22'%22%2C%2063276%3A%20%22PageUp%22%2C%2063277%3A%20%22PageDown%22%2C%2063275%3A%20%22End%22%2C%2063273%3A%20%22Home%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2063234%3A%20%22Left%22%2C%2063232%3A%20%22Up%22%2C%2063235%3A%20%22Right%22%2C%2063233%3A%20%22Down%22%2C%2063302%3A%20%22Insert%22%2C%2063272%3A%20%22Delete%22%7D%3B%0A%20%20CodeMirror.keyNames%20%3D%20keyNames%3B%0A%20%20(function()%20%7B%0A%20%20%20%20%2F%2F%20Number%20keys%0A%20%20%20%20for%20(var%20i%20%3D%200%3B%20i%20%3C%2010%3B%20i%2B%2B)%20keyNames%5Bi%20%2B%2048%5D%20%3D%20String(i)%3B%0A%20%20%20%20%2F%2F%20Alphabetic%20keys%0A%20%20%20%20for%20(var%20i%20%3D%2065%3B%20i%20%3C%3D%2090%3B%20i%2B%2B)%20keyNames%5Bi%5D%20%3D%20String.fromCharCode(i)%3B%0A%20%20%20%20%2F%2F%20Function%20keys%0A%20%20%20%20for%20(var%20i%20%3D%201%3B%20i%20%3C%3D%2012%3B%20i%2B%2B)%20keyNames%5Bi%20%2B%20111%5D%20%3D%20keyNames%5Bi%20%2B%2063235%5D%20%3D%20%22F%22%20%2B%20i%3B%0A%20%20%7D)()%3B%0A%0A%20%20CodeMirror.version%20%3D%20%222.34%22%3B%0A%0A%20%20return%20CodeMirror%3B%0A%7D)()%3B%0A%0A%20%20%20%20%3C%2Fscript%3E%0A%20%20%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%3C!--%20http%3A%2F%2Fcodemirror.net%2Flib%2Fcodemirror.css%20--%3E%3Cstyle%3E%0A.CodeMirror%20%7B%0A%20%20line-height%3A%201em%3B%0A%20%20font-family%3A%20monospace%3B%0A%0A%20%20%2F*%20Necessary%20so%20the%20scrollbar%20can%20be%20absolutely%20positioned%20within%20the%20wrapper%20on%20Lion.%20*%2F%0A%20%20position%3A%20relative%3B%0A%20%20%2F*%20This%20prevents%20unwanted%20scrollbars%20from%20showing%20up%20on%20the%20body%20and%20wrapper%20in%20IE.%20*%2F%0A%20%20overflow%3A%20hidden%3B%0A%7D%0A%0A.CodeMirror-scroll%20%7B%0A%20%20overflow%3A%20auto%3B%0A%20%20height%3A%20300px%3B%0A%20%20%2F*%20This%20is%20needed%20to%20prevent%20an%20IE%5B67%5D%20bug%20where%20the%20scrolled%20content%0A%20%20%20%20%20is%20visible%20outside%20of%20the%20scrolling%20box.%20*%2F%0A%20%20position%3A%20relative%3B%0A%20%20outline%3A%20none%3B%0A%7D%0A%0A%2F*%20Vertical%20scrollbar%20*%2F%0A.CodeMirror-scrollbar%20%7B%0A%20%20position%3A%20absolute%3B%0A%20%20right%3A%200%3B%20top%3A%200%3B%0A%20%20overflow-x%3A%20hidden%3B%0A%20%20overflow-y%3A%20scroll%3B%0A%20%20z-index%3A%205%3B%0A%7D%0A.CodeMirror-scrollbar-inner%20%7B%0A%20%20%2F*%20This%20needs%20to%20have%20a%20nonzero%20width%20in%20order%20for%20the%20scrollbar%20to%20appear%0A%20%20%20%20%20in%20Firefox%20and%20IE9.%20*%2F%0A%20%20width%3A%201px%3B%0A%7D%0A.CodeMirror-scrollbar.cm-sb-overlap%20%7B%0A%20%20%2F*%20Ensure%20that%20the%20scrollbar%20appears%20in%20Lion%2C%20and%20that%20it%20overlaps%20the%20content%0A%20%20%20%20%20rather%20than%20sitting%20to%20the%20right%20of%20it.%20*%2F%0A%20%20position%3A%20absolute%3B%0A%20%20z-index%3A%201%3B%0A%20%20float%3A%20none%3B%0A%20%20right%3A%200%3B%0A%20%20min-width%3A%2012px%3B%0A%7D%0A.CodeMirror-scrollbar.cm-sb-nonoverlap%20%7B%0A%20%20min-width%3A%2012px%3B%0A%7D%0A.CodeMirror-scrollbar.cm-sb-ie7%20%7B%0A%20%20min-width%3A%2018px%3B%0A%7D%0A%0A.CodeMirror-gutter%20%7B%0A%20%20position%3A%20absolute%3B%20left%3A%200%3B%20top%3A%200%3B%0A%20%20z-index%3A%2010%3B%0A%20%20background-color%3A%20%23f7f7f7%3B%0A%20%20border-right%3A%201px%20solid%20%23eee%3B%0A%20%20min-width%3A%202em%3B%0A%20%20height%3A%20100%25%3B%0A%7D%0A.CodeMirror-gutter-text%20%7B%0A%20%20color%3A%20%23aaa%3B%0A%20%20text-align%3A%20right%3B%0A%20%20padding%3A%20.4em%20.2em%20.4em%20.4em%3B%0A%20%20white-space%3A%20pre%20!important%3B%0A%20%20cursor%3A%20default%3B%0A%7D%0A.CodeMirror-lines%20%7B%0A%20%20padding%3A%20.4em%3B%0A%20%20white-space%3A%20pre%3B%0A%20%20cursor%3A%20text%3B%0A%7D%0A%0A.CodeMirror%20pre%20%7B%0A%20%20-moz-border-radius%3A%200%3B%0A%20%20-webkit-border-radius%3A%200%3B%0A%20%20-o-border-radius%3A%200%3B%0A%20%20border-radius%3A%200%3B%0A%20%20border-width%3A%200%3B%20margin%3A%200%3B%20padding%3A%200%3B%20background%3A%20transparent%3B%0A%20%20font-family%3A%20inherit%3B%0A%20%20font-size%3A%20inherit%3B%0A%20%20padding%3A%200%3B%20margin%3A%200%3B%0A%20%20white-space%3A%20pre%3B%0A%20%20word-wrap%3A%20normal%3B%0A%20%20line-height%3A%20inherit%3B%0A%20%20color%3A%20inherit%3B%0A%7D%0A%0A.CodeMirror-wrap%20pre%20%7B%0A%20%20word-wrap%3A%20break-word%3B%0A%20%20white-space%3A%20pre-wrap%3B%0A%20%20word-break%3A%20normal%3B%0A%7D%0A.CodeMirror-wrap%20.CodeMirror-scroll%20%7B%0A%20%20overflow-x%3A%20hidden%3B%0A%7D%0A%0A.CodeMirror%20textarea%20%7B%0A%20%20outline%3A%20none%20!important%3B%0A%7D%0A%0A.CodeMirror%20pre.CodeMirror-cursor%20%7B%0A%20%20z-index%3A%2010%3B%0A%20%20position%3A%20absolute%3B%0A%20%20visibility%3A%20hidden%3B%0A%20%20border-left%3A%201px%20solid%20black%3B%0A%20%20border-right%3A%20none%3B%0A%20%20width%3A%200%3B%0A%7D%0A.cm-keymap-fat-cursor%20pre.CodeMirror-cursor%20%7B%0A%20%20width%3A%20auto%3B%0A%20%20border%3A%200%3B%0A%20%20background%3A%20transparent%3B%0A%20%20background%3A%20rgba(0%2C%20200%2C%200%2C%20.4)%3B%0A%20%20filter%3A%20progid%3ADXImageTransform.Microsoft.gradient(startColorstr%3D%236600c800%2C%20endColorstr%3D%234c00c800)%3B%0A%7D%0A%2F*%20Kludge%20to%20turn%20off%20filter%20in%20ie9%2B%2C%20which%20also%20accepts%20rgba%20*%2F%0A.cm-keymap-fat-cursor%20pre.CodeMirror-cursor%3Anot(%23nonsense_id)%20%7B%0A%20%20filter%3A%20progid%3ADXImageTransform.Microsoft.gradient(enabled%3Dfalse)%3B%0A%7D%0A.CodeMirror%20pre.CodeMirror-cursor.CodeMirror-overwrite%20%7B%7D%0A.CodeMirror-focused%20pre.CodeMirror-cursor%20%7B%0A%20%20visibility%3A%20visible%3B%0A%7D%0A%0Adiv.CodeMirror-selected%20%7B%20background%3A%20%23d9d9d9%3B%20%7D%0A.CodeMirror-focused%20div.CodeMirror-selected%20%7B%20background%3A%20%23d7d4f0%3B%20%7D%0A%0A.CodeMirror-searching%20%7B%0A%20%20background%3A%20%23ffa%3B%0A%20%20background%3A%20rgba(255%2C%20255%2C%200%2C%20.4)%3B%0A%7D%0A%0A%2F*%20Default%20theme%20*%2F%0A%0A.cm-s-default%20span.cm-keyword%20%7Bcolor%3A%20%23708%3B%7D%0A.cm-s-default%20span.cm-atom%20%7Bcolor%3A%20%23219%3B%7D%0A.cm-s-default%20span.cm-number%20%7Bcolor%3A%20%23164%3B%7D%0A.cm-s-default%20span.cm-def%20%7Bcolor%3A%20%2300f%3B%7D%0A.cm-s-default%20span.cm-variable%20%7Bcolor%3A%20black%3B%7D%0A.cm-s-default%20span.cm-variable-2%20%7Bcolor%3A%20%2305a%3B%7D%0A.cm-s-default%20span.cm-variable-3%20%7Bcolor%3A%20%23085%3B%7D%0A.cm-s-default%20span.cm-property%20%7Bcolor%3A%20black%3B%7D%0A.cm-s-default%20span.cm-operator%20%7Bcolor%3A%20black%3B%7D%0A.cm-s-default%20span.cm-comment%20%7Bcolor%3A%20%23a50%3B%7D%0A.cm-s-default%20span.cm-string%20%7Bcolor%3A%20%23a11%3B%7D%0A.cm-s-default%20span.cm-string-2%20%7Bcolor%3A%20%23f50%3B%7D%0A.cm-s-default%20span.cm-meta%20%7Bcolor%3A%20%23555%3B%7D%0A.cm-s-default%20span.cm-error%20%7Bcolor%3A%20%23f00%3B%7D%0A.cm-s-default%20span.cm-qualifier%20%7Bcolor%3A%20%23555%3B%7D%0A.cm-s-default%20span.cm-builtin%20%7Bcolor%3A%20%2330a%3B%7D%0A.cm-s-default%20span.cm-bracket%20%7Bcolor%3A%20%23997%3B%7D%0A.cm-s-default%20span.cm-tag%20%7Bcolor%3A%20%23170%3B%7D%0A.cm-s-default%20span.cm-attribute%20%7Bcolor%3A%20%2300c%3B%7D%0A.cm-s-default%20span.cm-header%20%7Bcolor%3A%20blue%3B%7D%0A.cm-s-default%20span.cm-quote%20%7Bcolor%3A%20%23090%3B%7D%0A.cm-s-default%20span.cm-hr%20%7Bcolor%3A%20%23999%3B%7D%0A.cm-s-default%20span.cm-link%20%7Bcolor%3A%20%2300c%3B%7D%0A%0Aspan.cm-header%2C%20span.cm-strong%20%7Bfont-weight%3A%20bold%3B%7D%0Aspan.cm-em%20%7Bfont-style%3A%20italic%3B%7D%0Aspan.cm-emstrong%20%7Bfont-style%3A%20italic%3B%20font-weight%3A%20bold%3B%7D%0Aspan.cm-link%20%7Btext-decoration%3A%20underline%3B%7D%0A%0Aspan.cm-invalidchar%20%7Bcolor%3A%20%23f00%3B%7D%0A%0Adiv.CodeMirror%20span.CodeMirror-matchingbracket%20%7Bcolor%3A%20%230f0%3B%7D%0Adiv.CodeMirror%20span.CodeMirror-nonmatchingbracket%20%7Bcolor%3A%20%23f22%3B%7D%0A%0A%40media%20print%20%7B%0A%0A%20%20%2F*%20Hide%20the%20cursor%20when%20printing%20*%2F%0A%20%20.CodeMirror%20pre.CodeMirror-cursor%20%7B%0A%20%20%20%20visibility%3A%20hidden%3B%0A%20%20%7D%0A%0A%7D%0A%20%20%20%20%20%3C%2Fstyle%3E%20%0A%20%20%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%3C!--%20%20http%3A%2F%2Fcodemirror.net%2Fmode%2Fxml%2Fxml.js%20--%3E%3Cscript%3E%0ACodeMirror.defineMode(%22xml%22%2C%20function(config%2C%20parserConfig)%20%7B%0A%20%20var%20indentUnit%20%3D%20config.indentUnit%3B%0A%20%20var%20Kludges%20%3D%20parserConfig.htmlMode%20%3F%20%7B%0A%20%20%20%20autoSelfClosers%3A%20%7B'area'%3A%20true%2C%20'base'%3A%20true%2C%20'br'%3A%20true%2C%20'col'%3A%20true%2C%20'command'%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'embed'%3A%20true%2C%20'frame'%3A%20true%2C%20'hr'%3A%20true%2C%20'img'%3A%20true%2C%20'input'%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'keygen'%3A%20true%2C%20'link'%3A%20true%2C%20'meta'%3A%20true%2C%20'param'%3A%20true%2C%20'source'%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'track'%3A%20true%2C%20'wbr'%3A%20true%7D%2C%0A%20%20%20%20implicitlyClosed%3A%20%7B'dd'%3A%20true%2C%20'li'%3A%20true%2C%20'optgroup'%3A%20true%2C%20'option'%3A%20true%2C%20'p'%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'rp'%3A%20true%2C%20'rt'%3A%20true%2C%20'tbody'%3A%20true%2C%20'td'%3A%20true%2C%20'tfoot'%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20'th'%3A%20true%2C%20'tr'%3A%20true%7D%2C%0A%20%20%20%20contextGrabbers%3A%20%7B%0A%20%20%20%20%20%20'dd'%3A%20%7B'dd'%3A%20true%2C%20'dt'%3A%20true%7D%2C%0A%20%20%20%20%20%20'dt'%3A%20%7B'dd'%3A%20true%2C%20'dt'%3A%20true%7D%2C%0A%20%20%20%20%20%20'li'%3A%20%7B'li'%3A%20true%7D%2C%0A%20%20%20%20%20%20'option'%3A%20%7B'option'%3A%20true%2C%20'optgroup'%3A%20true%7D%2C%0A%20%20%20%20%20%20'optgroup'%3A%20%7B'optgroup'%3A%20true%7D%2C%0A%20%20%20%20%20%20'p'%3A%20%7B'address'%3A%20true%2C%20'article'%3A%20true%2C%20'aside'%3A%20true%2C%20'blockquote'%3A%20true%2C%20'dir'%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'div'%3A%20true%2C%20'dl'%3A%20true%2C%20'fieldset'%3A%20true%2C%20'footer'%3A%20true%2C%20'form'%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'h1'%3A%20true%2C%20'h2'%3A%20true%2C%20'h3'%3A%20true%2C%20'h4'%3A%20true%2C%20'h5'%3A%20true%2C%20'h6'%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'header'%3A%20true%2C%20'hgroup'%3A%20true%2C%20'hr'%3A%20true%2C%20'menu'%3A%20true%2C%20'nav'%3A%20true%2C%20'ol'%3A%20true%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20'p'%3A%20true%2C%20'pre'%3A%20true%2C%20'section'%3A%20true%2C%20'table'%3A%20true%2C%20'ul'%3A%20true%7D%2C%0A%20%20%20%20%20%20'rp'%3A%20%7B'rp'%3A%20true%2C%20'rt'%3A%20true%7D%2C%0A%20%20%20%20%20%20'rt'%3A%20%7B'rp'%3A%20true%2C%20'rt'%3A%20true%7D%2C%0A%20%20%20%20%20%20'tbody'%3A%20%7B'tbody'%3A%20true%2C%20'tfoot'%3A%20true%7D%2C%0A%20%20%20%20%20%20'td'%3A%20%7B'td'%3A%20true%2C%20'th'%3A%20true%7D%2C%0A%20%20%20%20%20%20'tfoot'%3A%20%7B'tbody'%3A%20true%7D%2C%0A%20%20%20%20%20%20'th'%3A%20%7B'td'%3A%20true%2C%20'th'%3A%20true%7D%2C%0A%20%20%20%20%20%20'thead'%3A%20%7B'tbody'%3A%20true%2C%20'tfoot'%3A%20true%7D%2C%0A%20%20%20%20%20%20'tr'%3A%20%7B'tr'%3A%20true%7D%0A%20%20%20%20%7D%2C%0A%20%20%20%20doNotIndent%3A%20%7B%22pre%22%3A%20true%7D%2C%0A%20%20%20%20allowUnquoted%3A%20true%2C%0A%20%20%20%20allowMissing%3A%20true%0A%20%20%7D%20%3A%20%7B%0A%20%20%20%20autoSelfClosers%3A%20%7B%7D%2C%0A%20%20%20%20implicitlyClosed%3A%20%7B%7D%2C%0A%20%20%20%20contextGrabbers%3A%20%7B%7D%2C%0A%20%20%20%20doNotIndent%3A%20%7B%7D%2C%0A%20%20%20%20allowUnquoted%3A%20false%2C%0A%20%20%20%20allowMissing%3A%20false%0A%20%20%7D%3B%0A%20%20var%20alignCDATA%20%3D%20parserConfig.alignCDATA%3B%0A%0A%20%20%2F%2F%20Return%20variables%20for%20tokenizers%0A%20%20var%20tagName%2C%20type%3B%0A%0A%20%20function%20inText(stream%2C%20state)%20%7B%0A%20%20%20%20function%20chain(parser)%20%7B%0A%20%20%20%20%20%20state.tokenize%20%3D%20parser%3B%0A%20%20%20%20%20%20return%20parser(stream%2C%20state)%3B%0A%20%20%20%20%7D%0A%0A%20%20%20%20var%20ch%20%3D%20stream.next()%3B%0A%20%20%20%20if%20(ch%20%3D%3D%20%22%3C%22)%20%7B%0A%20%20%20%20%20%20if%20(stream.eat(%22!%22))%20%7B%0A%20%20%20%20%20%20%20%20if%20(stream.eat(%22%5B%22))%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(stream.match(%22CDATA%5B%22))%20return%20chain(inBlock(%22atom%22%2C%20%22%5D%5D%3E%22))%3B%0A%20%20%20%20%20%20%20%20%20%20else%20return%20null%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20else%20if%20(stream.match(%22--%22))%20return%20chain(inBlock(%22comment%22%2C%20%22--%3E%22))%3B%0A%20%20%20%20%20%20%20%20else%20if%20(stream.match(%22DOCTYPE%22%2C%20true%2C%20true))%20%7B%0A%20%20%20%20%20%20%20%20%20%20stream.eatWhile(%2F%5B%5Cw%5C._%5C-%5D%2F)%3B%0A%20%20%20%20%20%20%20%20%20%20return%20chain(doctype(1))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20else%20return%20null%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20else%20if%20(stream.eat(%22%3F%22))%20%7B%0A%20%20%20%20%20%20%20%20stream.eatWhile(%2F%5B%5Cw%5C._%5C-%5D%2F)%3B%0A%20%20%20%20%20%20%20%20state.tokenize%20%3D%20inBlock(%22meta%22%2C%20%22%3F%3E%22)%3B%0A%20%20%20%20%20%20%20%20return%20%22meta%22%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20else%20%7B%0A%20%20%20%20%20%20%20%20type%20%3D%20stream.eat(%22%2F%22)%20%3F%20%22closeTag%22%20%3A%20%22openTag%22%3B%0A%20%20%20%20%20%20%20%20stream.eatSpace()%3B%0A%20%20%20%20%20%20%20%20tagName%20%3D%20%22%22%3B%0A%20%20%20%20%20%20%20%20var%20c%3B%0A%20%20%20%20%20%20%20%20while%20((c%20%3D%20stream.eat(%2F%5B%5E%5Cs%5Cu00a0%3D%3C%3E%5C%22%5C'%5C%2F%3F%5D%2F)))%20tagName%20%2B%3D%20c%3B%0A%20%20%20%20%20%20%20%20state.tokenize%20%3D%20inTag%3B%0A%20%20%20%20%20%20%20%20return%20%22tag%22%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%26%22)%20%7B%0A%20%20%20%20%20%20var%20ok%3B%0A%20%20%20%20%20%20if%20(stream.eat(%22%23%22))%20%7B%0A%20%20%20%20%20%20%20%20if%20(stream.eat(%22x%22))%20%7B%0A%20%20%20%20%20%20%20%20%20%20ok%20%3D%20stream.eatWhile(%2F%5Ba-fA-F%5Cd%5D%2F)%20%26%26%20stream.eat(%22%3B%22)%3B%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20ok%20%3D%20stream.eatWhile(%2F%5B%5Cd%5D%2F)%20%26%26%20stream.eat(%22%3B%22)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20ok%20%3D%20stream.eatWhile(%2F%5B%5Cw%5C.%5C-%3A%5D%2F)%20%26%26%20stream.eat(%22%3B%22)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20ok%20%3F%20%22atom%22%20%3A%20%22error%22%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20%7B%0A%20%20%20%20%20%20stream.eatWhile(%2F%5B%5E%26%3C%5D%2F)%3B%0A%20%20%20%20%20%20return%20null%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20function%20inTag(stream%2C%20state)%20%7B%0A%20%20%20%20var%20ch%20%3D%20stream.next()%3B%0A%20%20%20%20if%20(ch%20%3D%3D%20%22%3E%22%20%7C%7C%20(ch%20%3D%3D%20%22%2F%22%20%26%26%20stream.eat(%22%3E%22)))%20%7B%0A%20%20%20%20%20%20state.tokenize%20%3D%20inText%3B%0A%20%20%20%20%20%20type%20%3D%20ch%20%3D%3D%20%22%3E%22%20%3F%20%22endTag%22%20%3A%20%22selfcloseTag%22%3B%0A%20%20%20%20%20%20return%20%22tag%22%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%3D%22)%20%7B%0A%20%20%20%20%20%20type%20%3D%20%22equals%22%3B%0A%20%20%20%20%20%20return%20null%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(%2F%5B%5C'%5C%22%5D%2F.test(ch))%20%7B%0A%20%20%20%20%20%20state.tokenize%20%3D%20inAttribute(ch)%3B%0A%20%20%20%20%20%20return%20state.tokenize(stream%2C%20state)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20%7B%0A%20%20%20%20%20%20stream.eatWhile(%2F%5B%5E%5Cs%5Cu00a0%3D%3C%3E%5C%22%5C'%5C%2F%3F%5D%2F)%3B%0A%20%20%20%20%20%20return%20%22word%22%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20function%20inAttribute(quote)%20%7B%0A%20%20%20%20return%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20while%20(!stream.eol())%20%7B%0A%20%20%20%20%20%20%20%20if%20(stream.next()%20%3D%3D%20quote)%20%7B%0A%20%20%20%20%20%20%20%20%20%20state.tokenize%20%3D%20inTag%3B%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20%22string%22%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20function%20inBlock(style%2C%20terminator)%20%7B%0A%20%20%20%20return%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20while%20(!stream.eol())%20%7B%0A%20%20%20%20%20%20%20%20if%20(stream.match(terminator))%20%7B%0A%20%20%20%20%20%20%20%20%20%20state.tokenize%20%3D%20inText%3B%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20stream.next()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20style%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%20%20function%20doctype(depth)%20%7B%0A%20%20%20%20return%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20var%20ch%3B%0A%20%20%20%20%20%20while%20((ch%20%3D%20stream.next())%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20if%20(ch%20%3D%3D%20%22%3C%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20state.tokenize%20%3D%20doctype(depth%20%2B%201)%3B%0A%20%20%20%20%20%20%20%20%20%20return%20state.tokenize(stream%2C%20state)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(ch%20%3D%3D%20%22%3E%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(depth%20%3D%3D%201)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20state.tokenize%20%3D%20inText%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20state.tokenize%20%3D%20doctype(depth%20-%201)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20state.tokenize(stream%2C%20state)%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20%22meta%22%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20var%20curState%2C%20setStyle%3B%0A%20%20function%20pass()%20%7B%0A%20%20%20%20for%20(var%20i%20%3D%20arguments.length%20-%201%3B%20i%20%3E%3D%200%3B%20i--)%20curState.cc.push(arguments%5Bi%5D)%3B%0A%20%20%7D%0A%20%20function%20cont()%20%7B%0A%20%20%20%20pass.apply(null%2C%20arguments)%3B%0A%20%20%20%20return%20true%3B%0A%20%20%7D%0A%0A%20%20function%20pushContext(tagName%2C%20startOfLine)%20%7B%0A%20%20%20%20var%20noIndent%20%3D%20Kludges.doNotIndent.hasOwnProperty(tagName)%20%7C%7C%20(curState.context%20%26%26%20curState.context.noIndent)%3B%0A%20%20%20%20curState.context%20%3D%20%7B%0A%20%20%20%20%20%20prev%3A%20curState.context%2C%0A%20%20%20%20%20%20tagName%3A%20tagName%2C%0A%20%20%20%20%20%20indent%3A%20curState.indented%2C%0A%20%20%20%20%20%20startOfLine%3A%20startOfLine%2C%0A%20%20%20%20%20%20noIndent%3A%20noIndent%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%20%20function%20popContext()%20%7B%0A%20%20%20%20if%20(curState.context)%20curState.context%20%3D%20curState.context.prev%3B%0A%20%20%7D%0A%0A%20%20function%20element(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22openTag%22)%20%7B%0A%20%20%20%20%20%20curState.tagName%20%3D%20tagName%3B%0A%20%20%20%20%20%20return%20cont(attributes%2C%20endtag(curState.startOfLine))%3B%0A%20%20%20%20%7D%20else%20if%20(type%20%3D%3D%20%22closeTag%22)%20%7B%0A%20%20%20%20%20%20var%20err%20%3D%20false%3B%0A%20%20%20%20%20%20if%20(curState.context)%20%7B%0A%20%20%20%20%20%20%20%20if%20(curState.context.tagName%20!%3D%20tagName)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(Kludges.implicitlyClosed.hasOwnProperty(curState.context.tagName.toLowerCase()))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20popContext()%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20err%20%3D%20!curState.context%20%7C%7C%20curState.context.tagName%20!%3D%20tagName%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20err%20%3D%20true%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(err)%20setStyle%20%3D%20%22error%22%3B%0A%20%20%20%20%20%20return%20cont(endclosetag(err))%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20cont()%3B%0A%20%20%7D%0A%20%20function%20endtag(startOfLine)%20%7B%0A%20%20%20%20return%20function(type)%20%7B%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20%22selfcloseTag%22%20%7C%7C%0A%20%20%20%20%20%20%20%20%20%20(type%20%3D%3D%20%22endTag%22%20%26%26%20Kludges.autoSelfClosers.hasOwnProperty(curState.tagName.toLowerCase())))%20%7B%0A%20%20%20%20%20%20%20%20maybePopContext(curState.tagName.toLowerCase())%3B%0A%20%20%20%20%20%20%20%20return%20cont()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20%22endTag%22)%20%7B%0A%20%20%20%20%20%20%20%20maybePopContext(curState.tagName.toLowerCase())%3B%0A%20%20%20%20%20%20%20%20pushContext(curState.tagName%2C%20startOfLine)%3B%0A%20%20%20%20%20%20%20%20return%20cont()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20cont()%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%20%20function%20endclosetag(err)%20%7B%0A%20%20%20%20return%20function(type)%20%7B%0A%20%20%20%20%20%20if%20(err)%20setStyle%20%3D%20%22error%22%3B%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20%22endTag%22)%20%7B%20popContext()%3B%20return%20cont()%3B%20%7D%0A%20%20%20%20%20%20setStyle%20%3D%20%22error%22%3B%0A%20%20%20%20%20%20return%20cont(arguments.callee)%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%20%20function%20maybePopContext(nextTagName)%20%7B%0A%20%20%20%20var%20parentTagName%3B%0A%20%20%20%20while%20(true)%20%7B%0A%20%20%20%20%20%20if%20(!curState.context)%20%7B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20parentTagName%20%3D%20curState.context.tagName.toLowerCase()%3B%0A%20%20%20%20%20%20if%20(!Kludges.contextGrabbers.hasOwnProperty(parentTagName)%20%7C%7C%0A%20%20%20%20%20%20%20%20%20%20!Kludges.contextGrabbers%5BparentTagName%5D.hasOwnProperty(nextTagName))%20%7B%0A%20%20%20%20%20%20%20%20return%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20popContext()%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20function%20attributes(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22word%22)%20%7BsetStyle%20%3D%20%22attribute%22%3B%20return%20cont(attribute%2C%20attributes)%3B%7D%0A%20%20%20%20if%20(type%20%3D%3D%20%22endTag%22%20%7C%7C%20type%20%3D%3D%20%22selfcloseTag%22)%20return%20pass()%3B%0A%20%20%20%20setStyle%20%3D%20%22error%22%3B%0A%20%20%20%20return%20cont(attributes)%3B%0A%20%20%7D%0A%20%20function%20attribute(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22equals%22)%20return%20cont(attvalue%2C%20attributes)%3B%0A%20%20%20%20if%20(!Kludges.allowMissing)%20setStyle%20%3D%20%22error%22%3B%0A%20%20%20%20return%20(type%20%3D%3D%20%22endTag%22%20%7C%7C%20type%20%3D%3D%20%22selfcloseTag%22)%20%3F%20pass()%20%3A%20cont()%3B%0A%20%20%7D%0A%20%20function%20attvalue(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22string%22)%20return%20cont(attvaluemaybe)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22word%22%20%26%26%20Kludges.allowUnquoted)%20%7BsetStyle%20%3D%20%22string%22%3B%20return%20cont()%3B%7D%0A%20%20%20%20setStyle%20%3D%20%22error%22%3B%0A%20%20%20%20return%20(type%20%3D%3D%20%22endTag%22%20%7C%7C%20type%20%3D%3D%20%22selfCloseTag%22)%20%3F%20pass()%20%3A%20cont()%3B%0A%20%20%7D%0A%20%20function%20attvaluemaybe(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22string%22)%20return%20cont(attvaluemaybe)%3B%0A%20%20%20%20else%20return%20pass()%3B%0A%20%20%7D%0A%0A%20%20return%20%7B%0A%20%20%20%20startState%3A%20function()%20%7B%0A%20%20%20%20%20%20return%20%7Btokenize%3A%20inText%2C%20cc%3A%20%5B%5D%2C%20indented%3A%200%2C%20startOfLine%3A%20true%2C%20tagName%3A%20null%2C%20context%3A%20null%7D%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20token%3A%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20if%20(stream.sol())%20%7B%0A%20%20%20%20%20%20%20%20state.startOfLine%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20state.indented%20%3D%20stream.indentation()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(stream.eatSpace())%20return%20null%3B%0A%0A%20%20%20%20%20%20setStyle%20%3D%20type%20%3D%20tagName%20%3D%20null%3B%0A%20%20%20%20%20%20var%20style%20%3D%20state.tokenize(stream%2C%20state)%3B%0A%20%20%20%20%20%20state.type%20%3D%20type%3B%0A%20%20%20%20%20%20if%20((style%20%7C%7C%20type)%20%26%26%20style%20!%3D%20%22comment%22)%20%7B%0A%20%20%20%20%20%20%20%20curState%20%3D%20state%3B%0A%20%20%20%20%20%20%20%20while%20(true)%20%7B%0A%20%20%20%20%20%20%20%20%20%20var%20comb%20%3D%20state.cc.pop()%20%7C%7C%20element%3B%0A%20%20%20%20%20%20%20%20%20%20if%20(comb(type%20%7C%7C%20style))%20break%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20state.startOfLine%20%3D%20false%3B%0A%20%20%20%20%20%20return%20setStyle%20%7C%7C%20style%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20indent%3A%20function(state%2C%20textAfter%2C%20fullLine)%20%7B%0A%20%20%20%20%20%20var%20context%20%3D%20state.context%3B%0A%20%20%20%20%20%20if%20((state.tokenize%20!%3D%20inTag%20%26%26%20state.tokenize%20!%3D%20inText)%20%7C%7C%0A%20%20%20%20%20%20%20%20%20%20context%20%26%26%20context.noIndent)%0A%20%20%20%20%20%20%20%20return%20fullLine%20%3F%20fullLine.match(%2F%5E(%5Cs*)%2F)%5B0%5D.length%20%3A%200%3B%0A%20%20%20%20%20%20if%20(alignCDATA%20%26%26%20%2F%3C!%5C%5BCDATA%5C%5B%2F.test(textAfter))%20return%200%3B%0A%20%20%20%20%20%20if%20(context%20%26%26%20%2F%5E%3C%5C%2F%2F.test(textAfter))%0A%20%20%20%20%20%20%20%20context%20%3D%20context.prev%3B%0A%20%20%20%20%20%20while%20(context%20%26%26%20!context.startOfLine)%0A%20%20%20%20%20%20%20%20context%20%3D%20context.prev%3B%0A%20%20%20%20%20%20if%20(context)%20return%20context.indent%20%2B%20indentUnit%3B%0A%20%20%20%20%20%20else%20return%200%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20electricChars%3A%20%22%2F%22%0A%20%20%7D%3B%0A%7D)%3B%0A%0ACodeMirror.defineMIME(%22text%2Fxml%22%2C%20%22xml%22)%3B%0ACodeMirror.defineMIME(%22application%2Fxml%22%2C%20%22xml%22)%3B%0Aif%20(!CodeMirror.mimeModes.hasOwnProperty(%22text%2Fhtml%22))%0A%20%20CodeMirror.defineMIME(%22text%2Fhtml%22%2C%20%7Bname%3A%20%22xml%22%2C%20htmlMode%3A%20true%7D)%3B%0A%20%20%20%20%3C%2Fscript%3E%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%3C!--%20%20http%3A%2F%2Fcodemirror.net%2Fmode%2Fjavascript%2Fjavascript.js%20--%3E%3Cscript%3E%0ACodeMirror.defineMode(%22javascript%22%2C%20function(config%2C%20parserConfig)%20%7B%0A%20%20var%20indentUnit%20%3D%20config.indentUnit%3B%0A%20%20var%20jsonMode%20%3D%20parserConfig.json%3B%0A%0A%20%20%2F%2F%20Tokenizer%0A%0A%20%20var%20keywords%20%3D%20function()%7B%0A%20%20%20%20function%20kw(type)%20%7Breturn%20%7Btype%3A%20type%2C%20style%3A%20%22keyword%22%7D%3B%7D%0A%20%20%20%20var%20A%20%3D%20kw(%22keyword%20a%22)%2C%20B%20%3D%20kw(%22keyword%20b%22)%2C%20C%20%3D%20kw(%22keyword%20c%22)%3B%0A%20%20%20%20var%20operator%20%3D%20kw(%22operator%22)%2C%20atom%20%3D%20%7Btype%3A%20%22atom%22%2C%20style%3A%20%22atom%22%7D%3B%0A%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%22if%22%3A%20A%2C%20%22while%22%3A%20A%2C%20%22with%22%3A%20A%2C%20%22else%22%3A%20B%2C%20%22do%22%3A%20B%2C%20%22try%22%3A%20B%2C%20%22finally%22%3A%20B%2C%0A%20%20%20%20%20%20%22return%22%3A%20C%2C%20%22break%22%3A%20C%2C%20%22continue%22%3A%20C%2C%20%22new%22%3A%20C%2C%20%22delete%22%3A%20C%2C%20%22throw%22%3A%20C%2C%0A%20%20%20%20%20%20%22var%22%3A%20kw(%22var%22)%2C%20%22const%22%3A%20kw(%22var%22)%2C%20%22let%22%3A%20kw(%22var%22)%2C%0A%20%20%20%20%20%20%22function%22%3A%20kw(%22function%22)%2C%20%22catch%22%3A%20kw(%22catch%22)%2C%0A%20%20%20%20%20%20%22for%22%3A%20kw(%22for%22)%2C%20%22switch%22%3A%20kw(%22switch%22)%2C%20%22case%22%3A%20kw(%22case%22)%2C%20%22default%22%3A%20kw(%22default%22)%2C%0A%20%20%20%20%20%20%22in%22%3A%20operator%2C%20%22typeof%22%3A%20operator%2C%20%22instanceof%22%3A%20operator%2C%0A%20%20%20%20%20%20%22true%22%3A%20atom%2C%20%22false%22%3A%20atom%2C%20%22null%22%3A%20atom%2C%20%22undefined%22%3A%20atom%2C%20%22NaN%22%3A%20atom%2C%20%22Infinity%22%3A%20atom%0A%20%20%20%20%7D%3B%0A%20%20%7D()%3B%0A%0A%20%20var%20isOperatorChar%20%3D%20%2F%5B%2B%5C-*%26%25%3D%3C%3E!%3F%7C%5D%2F%3B%0A%0A%20%20function%20chain(stream%2C%20state%2C%20f)%20%7B%0A%20%20%20%20state.tokenize%20%3D%20f%3B%0A%20%20%20%20return%20f(stream%2C%20state)%3B%0A%20%20%7D%0A%0A%20%20function%20nextUntilUnescaped(stream%2C%20end)%20%7B%0A%20%20%20%20var%20escaped%20%3D%20false%2C%20next%3B%0A%20%20%20%20while%20((next%20%3D%20stream.next())%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20if%20(next%20%3D%3D%20end%20%26%26%20!escaped)%0A%20%20%20%20%20%20%20%20return%20false%3B%0A%20%20%20%20%20%20escaped%20%3D%20!escaped%20%26%26%20next%20%3D%3D%20%22%5C%5C%22%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20escaped%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20Used%20as%20scratch%20variables%20to%20communicate%20multiple%20values%20without%0A%20%20%2F%2F%20consing%20up%20tons%20of%20objects.%0A%20%20var%20type%2C%20content%3B%0A%20%20function%20ret(tp%2C%20style%2C%20cont)%20%7B%0A%20%20%20%20type%20%3D%20tp%3B%20content%20%3D%20cont%3B%0A%20%20%20%20return%20style%3B%0A%20%20%7D%0A%0A%20%20function%20jsTokenBase(stream%2C%20state)%20%7B%0A%20%20%20%20var%20ch%20%3D%20stream.next()%3B%0A%20%20%20%20if%20(ch%20%3D%3D%20'%22'%20%7C%7C%20ch%20%3D%3D%20%22'%22)%0A%20%20%20%20%20%20return%20chain(stream%2C%20state%2C%20jsTokenString(ch))%3B%0A%20%20%20%20else%20if%20(%2F%5B%5C%5B%5C%5D%7B%7D%5C(%5C)%2C%3B%5C%3A%5C.%5D%2F.test(ch))%0A%20%20%20%20%20%20return%20ret(ch)%3B%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%220%22%20%26%26%20stream.eat(%2Fx%2Fi))%20%7B%0A%20%20%20%20%20%20stream.eatWhile(%2F%5B%5Cda-f%5D%2Fi)%3B%0A%20%20%20%20%20%20return%20ret(%22number%22%2C%20%22number%22)%3B%0A%20%20%20%20%7D%20%20%20%20%20%20%0A%20%20%20%20else%20if%20(%2F%5Cd%2F.test(ch)%20%7C%7C%20ch%20%3D%3D%20%22-%22%20%26%26%20stream.eat(%2F%5Cd%2F))%20%7B%0A%20%20%20%20%20%20stream.match(%2F%5E%5Cd*(%3F%3A%5C.%5Cd*)%3F(%3F%3A%5BeE%5D%5B%2B%5C-%5D%3F%5Cd%2B)%3F%2F)%3B%0A%20%20%20%20%20%20return%20ret(%22number%22%2C%20%22number%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%2F%22)%20%7B%0A%20%20%20%20%20%20if%20(stream.eat(%22*%22))%20%7B%0A%20%20%20%20%20%20%20%20return%20chain(stream%2C%20state%2C%20jsTokenComment)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20else%20if%20(stream.eat(%22%2F%22))%20%7B%0A%20%20%20%20%20%20%20%20stream.skipToEnd()%3B%0A%20%20%20%20%20%20%20%20return%20ret(%22comment%22%2C%20%22comment%22)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20else%20if%20(state.reAllowed)%20%7B%0A%20%20%20%20%20%20%20%20nextUntilUnescaped(stream%2C%20%22%2F%22)%3B%0A%20%20%20%20%20%20%20%20stream.eatWhile(%2F%5Bgimy%5D%2F)%3B%20%2F%2F%20'y'%20is%20%22sticky%22%20option%20in%20Mozilla%0A%20%20%20%20%20%20%20%20return%20ret(%22regexp%22%2C%20%22string-2%22)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20else%20%7B%0A%20%20%20%20%20%20%20%20stream.eatWhile(isOperatorChar)%3B%0A%20%20%20%20%20%20%20%20return%20ret(%22operator%22%2C%20null%2C%20stream.current())%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%23%22)%20%7B%0A%20%20%20%20%20%20%20%20stream.skipToEnd()%3B%0A%20%20%20%20%20%20%20%20return%20ret(%22error%22%2C%20%22error%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(isOperatorChar.test(ch))%20%7B%0A%20%20%20%20%20%20stream.eatWhile(isOperatorChar)%3B%0A%20%20%20%20%20%20return%20ret(%22operator%22%2C%20null%2C%20stream.current())%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20%7B%0A%20%20%20%20%20%20stream.eatWhile(%2F%5B%5Cw%5C%24_%5D%2F)%3B%0A%20%20%20%20%20%20var%20word%20%3D%20stream.current()%2C%20known%20%3D%20keywords.propertyIsEnumerable(word)%20%26%26%20keywords%5Bword%5D%3B%0A%20%20%20%20%20%20return%20(known%20%26%26%20state.kwAllowed)%20%3F%20ret(known.type%2C%20known.style%2C%20word)%20%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ret(%22variable%22%2C%20%22variable%22%2C%20word)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20function%20jsTokenString(quote)%20%7B%0A%20%20%20%20return%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20if%20(!nextUntilUnescaped(stream%2C%20quote))%0A%20%20%20%20%20%20%20%20state.tokenize%20%3D%20jsTokenBase%3B%0A%20%20%20%20%20%20return%20ret(%22string%22%2C%20%22string%22)%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20function%20jsTokenComment(stream%2C%20state)%20%7B%0A%20%20%20%20var%20maybeEnd%20%3D%20false%2C%20ch%3B%0A%20%20%20%20while%20(ch%20%3D%20stream.next())%20%7B%0A%20%20%20%20%20%20if%20(ch%20%3D%3D%20%22%2F%22%20%26%26%20maybeEnd)%20%7B%0A%20%20%20%20%20%20%20%20state.tokenize%20%3D%20jsTokenBase%3B%0A%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20maybeEnd%20%3D%20(ch%20%3D%3D%20%22*%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20ret(%22comment%22%2C%20%22comment%22)%3B%0A%20%20%7D%0A%0A%20%20%2F%2F%20Parser%0A%0A%20%20var%20atomicTypes%20%3D%20%7B%22atom%22%3A%20true%2C%20%22number%22%3A%20true%2C%20%22variable%22%3A%20true%2C%20%22string%22%3A%20true%2C%20%22regexp%22%3A%20true%7D%3B%0A%0A%20%20function%20JSLexical(indented%2C%20column%2C%20type%2C%20align%2C%20prev%2C%20info)%20%7B%0A%20%20%20%20this.indented%20%3D%20indented%3B%0A%20%20%20%20this.column%20%3D%20column%3B%0A%20%20%20%20this.type%20%3D%20type%3B%0A%20%20%20%20this.prev%20%3D%20prev%3B%0A%20%20%20%20this.info%20%3D%20info%3B%0A%20%20%20%20if%20(align%20!%3D%20null)%20this.align%20%3D%20align%3B%0A%20%20%7D%0A%0A%20%20function%20inScope(state%2C%20varname)%20%7B%0A%20%20%20%20for%20(var%20v%20%3D%20state.localVars%3B%20v%3B%20v%20%3D%20v.next)%0A%20%20%20%20%20%20if%20(v.name%20%3D%3D%20varname)%20return%20true%3B%0A%20%20%7D%0A%0A%20%20function%20parseJS(state%2C%20style%2C%20type%2C%20content%2C%20stream)%20%7B%0A%20%20%20%20var%20cc%20%3D%20state.cc%3B%0A%20%20%20%20%2F%2F%20Communicate%20our%20context%20to%20the%20combinators.%0A%20%20%20%20%2F%2F%20(Less%20wasteful%20than%20consing%20up%20a%20hundred%20closures%20on%20every%20call.)%0A%20%20%20%20cx.state%20%3D%20state%3B%20cx.stream%20%3D%20stream%3B%20cx.marked%20%3D%20null%2C%20cx.cc%20%3D%20cc%3B%0A%20%20%0A%20%20%20%20if%20(!state.lexical.hasOwnProperty(%22align%22))%0A%20%20%20%20%20%20state.lexical.align%20%3D%20true%3B%0A%0A%20%20%20%20while(true)%20%7B%0A%20%20%20%20%20%20var%20combinator%20%3D%20cc.length%20%3F%20cc.pop()%20%3A%20jsonMode%20%3F%20expression%20%3A%20statement%3B%0A%20%20%20%20%20%20if%20(combinator(type%2C%20content))%20%7B%0A%20%20%20%20%20%20%20%20while(cc.length%20%26%26%20cc%5Bcc.length%20-%201%5D.lex)%0A%20%20%20%20%20%20%20%20%20%20cc.pop()()%3B%0A%20%20%20%20%20%20%20%20if%20(cx.marked)%20return%20cx.marked%3B%0A%20%20%20%20%20%20%20%20if%20(type%20%3D%3D%20%22variable%22%20%26%26%20inScope(state%2C%20content))%20return%20%22variable-2%22%3B%0A%20%20%20%20%20%20%20%20return%20style%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20%2F%2F%20Combinator%20utils%0A%0A%20%20var%20cx%20%3D%20%7Bstate%3A%20null%2C%20column%3A%20null%2C%20marked%3A%20null%2C%20cc%3A%20null%7D%3B%0A%20%20function%20pass()%20%7B%0A%20%20%20%20for%20(var%20i%20%3D%20arguments.length%20-%201%3B%20i%20%3E%3D%200%3B%20i--)%20cx.cc.push(arguments%5Bi%5D)%3B%0A%20%20%7D%0A%20%20function%20cont()%20%7B%0A%20%20%20%20pass.apply(null%2C%20arguments)%3B%0A%20%20%20%20return%20true%3B%0A%20%20%7D%0A%20%20function%20register(varname)%20%7B%0A%20%20%20%20var%20state%20%3D%20cx.state%3B%0A%20%20%20%20if%20(state.context)%20%7B%0A%20%20%20%20%20%20cx.marked%20%3D%20%22def%22%3B%0A%20%20%20%20%20%20for%20(var%20v%20%3D%20state.localVars%3B%20v%3B%20v%20%3D%20v.next)%0A%20%20%20%20%20%20%20%20if%20(v.name%20%3D%3D%20varname)%20return%3B%0A%20%20%20%20%20%20state.localVars%20%3D%20%7Bname%3A%20varname%2C%20next%3A%20state.localVars%7D%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20%2F%2F%20Combinators%0A%0A%20%20var%20defaultVars%20%3D%20%7Bname%3A%20%22this%22%2C%20next%3A%20%7Bname%3A%20%22arguments%22%7D%7D%3B%0A%20%20function%20pushcontext()%20%7B%0A%20%20%20%20cx.state.context%20%3D%20%7Bprev%3A%20cx.state.context%2C%20vars%3A%20cx.state.localVars%7D%3B%0A%20%20%20%20cx.state.localVars%20%3D%20defaultVars%3B%0A%20%20%7D%0A%20%20function%20popcontext()%20%7B%0A%20%20%20%20cx.state.localVars%20%3D%20cx.state.context.vars%3B%0A%20%20%20%20cx.state.context%20%3D%20cx.state.context.prev%3B%0A%20%20%7D%0A%20%20function%20pushlex(type%2C%20info)%20%7B%0A%20%20%20%20var%20result%20%3D%20function()%20%7B%0A%20%20%20%20%20%20var%20state%20%3D%20cx.state%3B%0A%20%20%20%20%20%20state.lexical%20%3D%20new%20JSLexical(state.indented%2C%20cx.stream.column()%2C%20type%2C%20null%2C%20state.lexical%2C%20info)%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20result.lex%20%3D%20true%3B%0A%20%20%20%20return%20result%3B%0A%20%20%7D%0A%20%20function%20poplex()%20%7B%0A%20%20%20%20var%20state%20%3D%20cx.state%3B%0A%20%20%20%20if%20(state.lexical.prev)%20%7B%0A%20%20%20%20%20%20if%20(state.lexical.type%20%3D%3D%20%22)%22)%0A%20%20%20%20%20%20%20%20state.indented%20%3D%20state.lexical.indented%3B%0A%20%20%20%20%20%20state.lexical%20%3D%20state.lexical.prev%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20poplex.lex%20%3D%20true%3B%0A%0A%20%20function%20expect(wanted)%20%7B%0A%20%20%20%20return%20function%20expecting(type)%20%7B%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20wanted)%20return%20cont()%3B%0A%20%20%20%20%20%20else%20if%20(wanted%20%3D%3D%20%22%3B%22)%20return%20pass()%3B%0A%20%20%20%20%20%20else%20return%20cont(arguments.callee)%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20function%20statement(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22var%22)%20return%20cont(pushlex(%22vardef%22)%2C%20vardef1%2C%20expect(%22%3B%22)%2C%20poplex)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22keyword%20a%22)%20return%20cont(pushlex(%22form%22)%2C%20expression%2C%20statement%2C%20poplex)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22keyword%20b%22)%20return%20cont(pushlex(%22form%22)%2C%20statement%2C%20poplex)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%7B%22)%20return%20cont(pushlex(%22%7D%22)%2C%20block%2C%20poplex)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%3B%22)%20return%20cont()%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22function%22)%20return%20cont(functiondef)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22for%22)%20return%20cont(pushlex(%22form%22)%2C%20expect(%22(%22)%2C%20pushlex(%22)%22)%2C%20forspec1%2C%20expect(%22)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20poplex%2C%20statement%2C%20poplex)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22variable%22)%20return%20cont(pushlex(%22stat%22)%2C%20maybelabel)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22switch%22)%20return%20cont(pushlex(%22form%22)%2C%20expression%2C%20pushlex(%22%7D%22%2C%20%22switch%22)%2C%20expect(%22%7B%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20block%2C%20poplex%2C%20poplex)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22case%22)%20return%20cont(expression%2C%20expect(%22%3A%22))%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22default%22)%20return%20cont(expect(%22%3A%22))%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22catch%22)%20return%20cont(pushlex(%22form%22)%2C%20pushcontext%2C%20expect(%22(%22)%2C%20funarg%2C%20expect(%22)%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20statement%2C%20poplex%2C%20popcontext)%3B%0A%20%20%20%20return%20pass(pushlex(%22stat%22)%2C%20expression%2C%20expect(%22%3B%22)%2C%20poplex)%3B%0A%20%20%7D%0A%20%20function%20expression(type)%20%7B%0A%20%20%20%20if%20(atomicTypes.hasOwnProperty(type))%20return%20cont(maybeoperator)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22function%22)%20return%20cont(functiondef)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22keyword%20c%22)%20return%20cont(maybeexpression)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22(%22)%20return%20cont(pushlex(%22)%22)%2C%20maybeexpression%2C%20expect(%22)%22)%2C%20poplex%2C%20maybeoperator)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22operator%22)%20return%20cont(expression)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%5B%22)%20return%20cont(pushlex(%22%5D%22)%2C%20commasep(expression%2C%20%22%5D%22)%2C%20poplex%2C%20maybeoperator)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%7B%22)%20return%20cont(pushlex(%22%7D%22)%2C%20commasep(objprop%2C%20%22%7D%22)%2C%20poplex%2C%20maybeoperator)%3B%0A%20%20%20%20return%20cont()%3B%0A%20%20%7D%0A%20%20function%20maybeexpression(type)%20%7B%0A%20%20%20%20if%20(type.match(%2F%5B%3B%5C%7D%5C)%5C%5D%2C%5D%2F))%20return%20pass()%3B%0A%20%20%20%20return%20pass(expression)%3B%0A%20%20%7D%0A%20%20%20%20%0A%20%20function%20maybeoperator(type%2C%20value)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22operator%22%20%26%26%20%2F%5C%2B%5C%2B%7C--%2F.test(value))%20return%20cont(maybeoperator)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22operator%22%20%26%26%20value%20%3D%3D%20%22%3F%22)%20return%20cont(expression%2C%20expect(%22%3A%22)%2C%20expression)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%3B%22)%20return%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22(%22)%20return%20cont(pushlex(%22)%22)%2C%20commasep(expression%2C%20%22)%22)%2C%20poplex%2C%20maybeoperator)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22.%22)%20return%20cont(property%2C%20maybeoperator)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%5B%22)%20return%20cont(pushlex(%22%5D%22)%2C%20expression%2C%20expect(%22%5D%22)%2C%20poplex%2C%20maybeoperator)%3B%0A%20%20%7D%0A%20%20function%20maybelabel(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%3A%22)%20return%20cont(poplex%2C%20statement)%3B%0A%20%20%20%20return%20pass(maybeoperator%2C%20expect(%22%3B%22)%2C%20poplex)%3B%0A%20%20%7D%0A%20%20function%20property(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22variable%22)%20%7Bcx.marked%20%3D%20%22property%22%3B%20return%20cont()%3B%7D%0A%20%20%7D%0A%20%20function%20objprop(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22variable%22)%20cx.marked%20%3D%20%22property%22%3B%0A%20%20%20%20if%20(atomicTypes.hasOwnProperty(type))%20return%20cont(expect(%22%3A%22)%2C%20expression)%3B%0A%20%20%7D%0A%20%20function%20commasep(what%2C%20end)%20%7B%0A%20%20%20%20function%20proceed(type)%20%7B%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20%22%2C%22)%20return%20cont(what%2C%20proceed)%3B%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20end)%20return%20cont()%3B%0A%20%20%20%20%20%20return%20cont(expect(end))%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20function%20commaSeparated(type)%20%7B%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20end)%20return%20cont()%3B%0A%20%20%20%20%20%20else%20return%20pass(what%2C%20proceed)%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%20%20function%20block(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%7D%22)%20return%20cont()%3B%0A%20%20%20%20return%20pass(statement%2C%20block)%3B%0A%20%20%7D%0A%20%20function%20vardef1(type%2C%20value)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22variable%22)%7Bregister(value)%3B%20return%20cont(vardef2)%3B%7D%0A%20%20%20%20return%20cont()%3B%0A%20%20%7D%0A%20%20function%20vardef2(type%2C%20value)%20%7B%0A%20%20%20%20if%20(value%20%3D%3D%20%22%3D%22)%20return%20cont(expression%2C%20vardef2)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%2C%22)%20return%20cont(vardef1)%3B%0A%20%20%7D%0A%20%20function%20forspec1(type)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22var%22)%20return%20cont(vardef1%2C%20forspec2)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%3B%22)%20return%20pass(forspec2)%3B%0A%20%20%20%20if%20(type%20%3D%3D%20%22variable%22)%20return%20cont(formaybein)%3B%0A%20%20%20%20return%20pass(forspec2)%3B%0A%20%20%7D%0A%20%20function%20formaybein(type%2C%20value)%20%7B%0A%20%20%20%20if%20(value%20%3D%3D%20%22in%22)%20return%20cont(expression)%3B%0A%20%20%20%20return%20cont(maybeoperator%2C%20forspec2)%3B%0A%20%20%7D%0A%20%20function%20forspec2(type%2C%20value)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22%3B%22)%20return%20cont(forspec3)%3B%0A%20%20%20%20if%20(value%20%3D%3D%20%22in%22)%20return%20cont(expression)%3B%0A%20%20%20%20return%20cont(expression%2C%20expect(%22%3B%22)%2C%20forspec3)%3B%0A%20%20%7D%0A%20%20function%20forspec3(type)%20%7B%0A%20%20%20%20if%20(type%20!%3D%20%22)%22)%20cont(expression)%3B%0A%20%20%7D%0A%20%20function%20functiondef(type%2C%20value)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22variable%22)%20%7Bregister(value)%3B%20return%20cont(functiondef)%3B%7D%0A%20%20%20%20if%20(type%20%3D%3D%20%22(%22)%20return%20cont(pushlex(%22)%22)%2C%20pushcontext%2C%20commasep(funarg%2C%20%22)%22)%2C%20poplex%2C%20statement%2C%20popcontext)%3B%0A%20%20%7D%0A%20%20function%20funarg(type%2C%20value)%20%7B%0A%20%20%20%20if%20(type%20%3D%3D%20%22variable%22)%20%7Bregister(value)%3B%20return%20cont()%3B%7D%0A%20%20%7D%0A%0A%20%20%2F%2F%20Interface%0A%0A%20%20return%20%7B%0A%20%20%20%20startState%3A%20function(basecolumn)%20%7B%0A%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20tokenize%3A%20jsTokenBase%2C%0A%20%20%20%20%20%20%20%20reAllowed%3A%20true%2C%0A%20%20%20%20%20%20%20%20kwAllowed%3A%20true%2C%0A%20%20%20%20%20%20%20%20cc%3A%20%5B%5D%2C%0A%20%20%20%20%20%20%20%20lexical%3A%20new%20JSLexical((basecolumn%20%7C%7C%200)%20-%20indentUnit%2C%200%2C%20%22block%22%2C%20false)%2C%0A%20%20%20%20%20%20%20%20localVars%3A%20parserConfig.localVars%2C%0A%20%20%20%20%20%20%20%20context%3A%20parserConfig.localVars%20%26%26%20%7Bvars%3A%20parserConfig.localVars%7D%2C%0A%20%20%20%20%20%20%20%20indented%3A%200%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20token%3A%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20if%20(stream.sol())%20%7B%0A%20%20%20%20%20%20%20%20if%20(!state.lexical.hasOwnProperty(%22align%22))%0A%20%20%20%20%20%20%20%20%20%20state.lexical.align%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20state.indented%20%3D%20stream.indentation()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(stream.eatSpace())%20return%20null%3B%0A%20%20%20%20%20%20var%20style%20%3D%20state.tokenize(stream%2C%20state)%3B%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20%22comment%22)%20return%20style%3B%0A%20%20%20%20%20%20state.reAllowed%20%3D%20!!(type%20%3D%3D%20%22operator%22%20%7C%7C%20type%20%3D%3D%20%22keyword%20c%22%20%7C%7C%20type.match(%2F%5E%5B%5C%5B%7B%7D%5C(%2C%3B%3A%5D%24%2F))%3B%0A%20%20%20%20%20%20state.kwAllowed%20%3D%20type%20!%3D%20'.'%3B%0A%20%20%20%20%20%20return%20parseJS(state%2C%20style%2C%20type%2C%20content%2C%20stream)%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20indent%3A%20function(state%2C%20textAfter)%20%7B%0A%20%20%20%20%20%20if%20(state.tokenize%20!%3D%20jsTokenBase)%20return%200%3B%0A%20%20%20%20%20%20var%20firstChar%20%3D%20textAfter%20%26%26%20textAfter.charAt(0)%2C%20lexical%20%3D%20state.lexical%3B%0A%20%20%20%20%20%20if%20(lexical.type%20%3D%3D%20%22stat%22%20%26%26%20firstChar%20%3D%3D%20%22%7D%22)%20lexical%20%3D%20lexical.prev%3B%0A%20%20%20%20%20%20var%20type%20%3D%20lexical.type%2C%20closing%20%3D%20firstChar%20%3D%3D%20type%3B%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20%22vardef%22)%20return%20lexical.indented%20%2B%204%3B%0A%20%20%20%20%20%20else%20if%20(type%20%3D%3D%20%22form%22%20%26%26%20firstChar%20%3D%3D%20%22%7B%22)%20return%20lexical.indented%3B%0A%20%20%20%20%20%20else%20if%20(type%20%3D%3D%20%22stat%22%20%7C%7C%20type%20%3D%3D%20%22form%22)%20return%20lexical.indented%20%2B%20indentUnit%3B%0A%20%20%20%20%20%20else%20if%20(lexical.info%20%3D%3D%20%22switch%22%20%26%26%20!closing)%0A%20%20%20%20%20%20%20%20return%20lexical.indented%20%2B%20(%2F%5E(%3F%3Acase%7Cdefault)%5Cb%2F.test(textAfter)%20%3F%20indentUnit%20%3A%202%20*%20indentUnit)%3B%0A%20%20%20%20%20%20else%20if%20(lexical.align)%20return%20lexical.column%20%2B%20(closing%20%3F%200%20%3A%201)%3B%0A%20%20%20%20%20%20else%20return%20lexical.indented%20%2B%20(closing%20%3F%200%20%3A%20indentUnit)%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20electricChars%3A%20%22%3A%7B%7D%22%0A%20%20%7D%3B%0A%7D)%3B%0A%0ACodeMirror.defineMIME(%22text%2Fjavascript%22%2C%20%22javascript%22)%3B%0ACodeMirror.defineMIME(%22application%2Fjson%22%2C%20%7Bname%3A%20%22javascript%22%2C%20json%3A%20true%7D)%3B%0A%20%20%20%20%3C%2Fscript%3E%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%3C!--%20http%3A%2F%2Fcodemirror.net%2Fmode%2Fcss%2Fcss.js%20--%3E%3Cscript%3E%0ACodeMirror.defineMode(%22css%22%2C%20function(config)%20%7B%0A%20%20var%20indentUnit%20%3D%20config.indentUnit%2C%20type%3B%0A%20%20%0A%20%20var%20atMediaTypes%20%3D%20keySet(%5B%0A%20%20%20%20%22all%22%2C%20%22aural%22%2C%20%22braille%22%2C%20%22handheld%22%2C%20%22print%22%2C%20%22projection%22%2C%20%22screen%22%2C%0A%20%20%20%20%22tty%22%2C%20%22tv%22%2C%20%22embossed%22%0A%20%20%5D)%3B%0A%20%20%0A%20%20var%20atMediaFeatures%20%3D%20keySet(%5B%0A%20%20%20%20%22width%22%2C%20%22min-width%22%2C%20%22max-width%22%2C%20%22height%22%2C%20%22min-height%22%2C%20%22max-height%22%2C%0A%20%20%20%20%22device-width%22%2C%20%22min-device-width%22%2C%20%22max-device-width%22%2C%20%22device-height%22%2C%0A%20%20%20%20%22min-device-height%22%2C%20%22max-device-height%22%2C%20%22aspect-ratio%22%2C%0A%20%20%20%20%22min-aspect-ratio%22%2C%20%22max-aspect-ratio%22%2C%20%22device-aspect-ratio%22%2C%0A%20%20%20%20%22min-device-aspect-ratio%22%2C%20%22max-device-aspect-ratio%22%2C%20%22color%22%2C%20%22min-color%22%2C%0A%20%20%20%20%22max-color%22%2C%20%22color-index%22%2C%20%22min-color-index%22%2C%20%22max-color-index%22%2C%0A%20%20%20%20%22monochrome%22%2C%20%22min-monochrome%22%2C%20%22max-monochrome%22%2C%20%22resolution%22%2C%0A%20%20%20%20%22min-resolution%22%2C%20%22max-resolution%22%2C%20%22scan%22%2C%20%22grid%22%0A%20%20%5D)%3B%0A%0A%20%20var%20propertyKeywords%20%3D%20keySet(%5B%0A%20%20%20%20%22align-content%22%2C%20%22align-items%22%2C%20%22align-self%22%2C%20%22alignment-adjust%22%2C%0A%20%20%20%20%22alignment-baseline%22%2C%20%22anchor-point%22%2C%20%22animation%22%2C%20%22animation-delay%22%2C%0A%20%20%20%20%22animation-direction%22%2C%20%22animation-duration%22%2C%20%22animation-iteration-count%22%2C%0A%20%20%20%20%22animation-name%22%2C%20%22animation-play-state%22%2C%20%22animation-timing-function%22%2C%0A%20%20%20%20%22appearance%22%2C%20%22azimuth%22%2C%20%22backface-visibility%22%2C%20%22background%22%2C%0A%20%20%20%20%22background-attachment%22%2C%20%22background-clip%22%2C%20%22background-color%22%2C%0A%20%20%20%20%22background-image%22%2C%20%22background-origin%22%2C%20%22background-position%22%2C%0A%20%20%20%20%22background-repeat%22%2C%20%22background-size%22%2C%20%22baseline-shift%22%2C%20%22binding%22%2C%0A%20%20%20%20%22bleed%22%2C%20%22bookmark-label%22%2C%20%22bookmark-level%22%2C%20%22bookmark-state%22%2C%0A%20%20%20%20%22bookmark-target%22%2C%20%22border%22%2C%20%22border-bottom%22%2C%20%22border-bottom-color%22%2C%0A%20%20%20%20%22border-bottom-left-radius%22%2C%20%22border-bottom-right-radius%22%2C%0A%20%20%20%20%22border-bottom-style%22%2C%20%22border-bottom-width%22%2C%20%22border-collapse%22%2C%0A%20%20%20%20%22border-color%22%2C%20%22border-image%22%2C%20%22border-image-outset%22%2C%0A%20%20%20%20%22border-image-repeat%22%2C%20%22border-image-slice%22%2C%20%22border-image-source%22%2C%0A%20%20%20%20%22border-image-width%22%2C%20%22border-left%22%2C%20%22border-left-color%22%2C%0A%20%20%20%20%22border-left-style%22%2C%20%22border-left-width%22%2C%20%22border-radius%22%2C%20%22border-right%22%2C%0A%20%20%20%20%22border-right-color%22%2C%20%22border-right-style%22%2C%20%22border-right-width%22%2C%0A%20%20%20%20%22border-spacing%22%2C%20%22border-style%22%2C%20%22border-top%22%2C%20%22border-top-color%22%2C%0A%20%20%20%20%22border-top-left-radius%22%2C%20%22border-top-right-radius%22%2C%20%22border-top-style%22%2C%0A%20%20%20%20%22border-top-width%22%2C%20%22border-width%22%2C%20%22bottom%22%2C%20%22box-decoration-break%22%2C%0A%20%20%20%20%22box-shadow%22%2C%20%22box-sizing%22%2C%20%22break-after%22%2C%20%22break-before%22%2C%20%22break-inside%22%2C%0A%20%20%20%20%22caption-side%22%2C%20%22clear%22%2C%20%22clip%22%2C%20%22color%22%2C%20%22color-profile%22%2C%20%22column-count%22%2C%0A%20%20%20%20%22column-fill%22%2C%20%22column-gap%22%2C%20%22column-rule%22%2C%20%22column-rule-color%22%2C%0A%20%20%20%20%22column-rule-style%22%2C%20%22column-rule-width%22%2C%20%22column-span%22%2C%20%22column-width%22%2C%0A%20%20%20%20%22columns%22%2C%20%22content%22%2C%20%22counter-increment%22%2C%20%22counter-reset%22%2C%20%22crop%22%2C%20%22cue%22%2C%0A%20%20%20%20%22cue-after%22%2C%20%22cue-before%22%2C%20%22cursor%22%2C%20%22direction%22%2C%20%22display%22%2C%0A%20%20%20%20%22dominant-baseline%22%2C%20%22drop-initial-after-adjust%22%2C%0A%20%20%20%20%22drop-initial-after-align%22%2C%20%22drop-initial-before-adjust%22%2C%0A%20%20%20%20%22drop-initial-before-align%22%2C%20%22drop-initial-size%22%2C%20%22drop-initial-value%22%2C%0A%20%20%20%20%22elevation%22%2C%20%22empty-cells%22%2C%20%22fit%22%2C%20%22fit-position%22%2C%20%22flex%22%2C%20%22flex-basis%22%2C%0A%20%20%20%20%22flex-direction%22%2C%20%22flex-flow%22%2C%20%22flex-grow%22%2C%20%22flex-shrink%22%2C%20%22flex-wrap%22%2C%0A%20%20%20%20%22float%22%2C%20%22float-offset%22%2C%20%22font%22%2C%20%22font-feature-settings%22%2C%20%22font-family%22%2C%0A%20%20%20%20%22font-kerning%22%2C%20%22font-language-override%22%2C%20%22font-size%22%2C%20%22font-size-adjust%22%2C%0A%20%20%20%20%22font-stretch%22%2C%20%22font-style%22%2C%20%22font-synthesis%22%2C%20%22font-variant%22%2C%0A%20%20%20%20%22font-variant-alternates%22%2C%20%22font-variant-caps%22%2C%20%22font-variant-east-asian%22%2C%0A%20%20%20%20%22font-variant-ligatures%22%2C%20%22font-variant-numeric%22%2C%20%22font-variant-position%22%2C%0A%20%20%20%20%22font-weight%22%2C%20%22grid-cell%22%2C%20%22grid-column%22%2C%20%22grid-column-align%22%2C%0A%20%20%20%20%22grid-column-sizing%22%2C%20%22grid-column-span%22%2C%20%22grid-columns%22%2C%20%22grid-flow%22%2C%0A%20%20%20%20%22grid-row%22%2C%20%22grid-row-align%22%2C%20%22grid-row-sizing%22%2C%20%22grid-row-span%22%2C%0A%20%20%20%20%22grid-rows%22%2C%20%22grid-template%22%2C%20%22hanging-punctuation%22%2C%20%22height%22%2C%20%22hyphens%22%2C%0A%20%20%20%20%22icon%22%2C%20%22image-orientation%22%2C%20%22image-rendering%22%2C%20%22image-resolution%22%2C%0A%20%20%20%20%22inline-box-align%22%2C%20%22justify-content%22%2C%20%22left%22%2C%20%22letter-spacing%22%2C%0A%20%20%20%20%22line-break%22%2C%20%22line-height%22%2C%20%22line-stacking%22%2C%20%22line-stacking-ruby%22%2C%0A%20%20%20%20%22line-stacking-shift%22%2C%20%22line-stacking-strategy%22%2C%20%22list-style%22%2C%0A%20%20%20%20%22list-style-image%22%2C%20%22list-style-position%22%2C%20%22list-style-type%22%2C%20%22margin%22%2C%0A%20%20%20%20%22margin-bottom%22%2C%20%22margin-left%22%2C%20%22margin-right%22%2C%20%22margin-top%22%2C%0A%20%20%20%20%22marker-offset%22%2C%20%22marks%22%2C%20%22marquee-direction%22%2C%20%22marquee-loop%22%2C%0A%20%20%20%20%22marquee-play-count%22%2C%20%22marquee-speed%22%2C%20%22marquee-style%22%2C%20%22max-height%22%2C%0A%20%20%20%20%22max-width%22%2C%20%22min-height%22%2C%20%22min-width%22%2C%20%22move-to%22%2C%20%22nav-down%22%2C%20%22nav-index%22%2C%0A%20%20%20%20%22nav-left%22%2C%20%22nav-right%22%2C%20%22nav-up%22%2C%20%22opacity%22%2C%20%22order%22%2C%20%22orphans%22%2C%20%22outline%22%2C%0A%20%20%20%20%22outline-color%22%2C%20%22outline-offset%22%2C%20%22outline-style%22%2C%20%22outline-width%22%2C%0A%20%20%20%20%22overflow%22%2C%20%22overflow-style%22%2C%20%22overflow-wrap%22%2C%20%22overflow-x%22%2C%20%22overflow-y%22%2C%0A%20%20%20%20%22padding%22%2C%20%22padding-bottom%22%2C%20%22padding-left%22%2C%20%22padding-right%22%2C%20%22padding-top%22%2C%0A%20%20%20%20%22page%22%2C%20%22page-break-after%22%2C%20%22page-break-before%22%2C%20%22page-break-inside%22%2C%0A%20%20%20%20%22page-policy%22%2C%20%22pause%22%2C%20%22pause-after%22%2C%20%22pause-before%22%2C%20%22perspective%22%2C%0A%20%20%20%20%22perspective-origin%22%2C%20%22pitch%22%2C%20%22pitch-range%22%2C%20%22play-during%22%2C%20%22position%22%2C%0A%20%20%20%20%22presentation-level%22%2C%20%22punctuation-trim%22%2C%20%22quotes%22%2C%20%22rendering-intent%22%2C%0A%20%20%20%20%22resize%22%2C%20%22rest%22%2C%20%22rest-after%22%2C%20%22rest-before%22%2C%20%22richness%22%2C%20%22right%22%2C%0A%20%20%20%20%22rotation%22%2C%20%22rotation-point%22%2C%20%22ruby-align%22%2C%20%22ruby-overhang%22%2C%0A%20%20%20%20%22ruby-position%22%2C%20%22ruby-span%22%2C%20%22size%22%2C%20%22speak%22%2C%20%22speak-as%22%2C%20%22speak-header%22%2C%0A%20%20%20%20%22speak-numeral%22%2C%20%22speak-punctuation%22%2C%20%22speech-rate%22%2C%20%22stress%22%2C%20%22string-set%22%2C%0A%20%20%20%20%22tab-size%22%2C%20%22table-layout%22%2C%20%22target%22%2C%20%22target-name%22%2C%20%22target-new%22%2C%0A%20%20%20%20%22target-position%22%2C%20%22text-align%22%2C%20%22text-align-last%22%2C%20%22text-decoration%22%2C%0A%20%20%20%20%22text-decoration-color%22%2C%20%22text-decoration-line%22%2C%20%22text-decoration-skip%22%2C%0A%20%20%20%20%22text-decoration-style%22%2C%20%22text-emphasis%22%2C%20%22text-emphasis-color%22%2C%0A%20%20%20%20%22text-emphasis-position%22%2C%20%22text-emphasis-style%22%2C%20%22text-height%22%2C%0A%20%20%20%20%22text-indent%22%2C%20%22text-justify%22%2C%20%22text-outline%22%2C%20%22text-shadow%22%2C%0A%20%20%20%20%22text-space-collapse%22%2C%20%22text-transform%22%2C%20%22text-underline-position%22%2C%0A%20%20%20%20%22text-wrap%22%2C%20%22top%22%2C%20%22transform%22%2C%20%22transform-origin%22%2C%20%22transform-style%22%2C%0A%20%20%20%20%22transition%22%2C%20%22transition-delay%22%2C%20%22transition-duration%22%2C%0A%20%20%20%20%22transition-property%22%2C%20%22transition-timing-function%22%2C%20%22unicode-bidi%22%2C%0A%20%20%20%20%22vertical-align%22%2C%20%22visibility%22%2C%20%22voice-balance%22%2C%20%22voice-duration%22%2C%0A%20%20%20%20%22voice-family%22%2C%20%22voice-pitch%22%2C%20%22voice-range%22%2C%20%22voice-rate%22%2C%20%22voice-stress%22%2C%0A%20%20%20%20%22voice-volume%22%2C%20%22volume%22%2C%20%22white-space%22%2C%20%22widows%22%2C%20%22width%22%2C%20%22word-break%22%2C%0A%20%20%20%20%22word-spacing%22%2C%20%22word-wrap%22%2C%20%22z-index%22%0A%20%20%5D)%3B%0A%0A%20%20var%20colorKeywords%20%3D%20keySet(%5B%0A%20%20%20%20%22black%22%2C%20%22silver%22%2C%20%22gray%22%2C%20%22white%22%2C%20%22maroon%22%2C%20%22red%22%2C%20%22purple%22%2C%20%22fuchsia%22%2C%0A%20%20%20%20%22green%22%2C%20%22lime%22%2C%20%22olive%22%2C%20%22yellow%22%2C%20%22navy%22%2C%20%22blue%22%2C%20%22teal%22%2C%20%22aqua%22%0A%20%20%5D)%3B%0A%20%20%0A%20%20var%20valueKeywords%20%3D%20keySet(%5B%0A%20%20%20%20%22above%22%2C%20%22absolute%22%2C%20%22activeborder%22%2C%20%22activecaption%22%2C%20%22afar%22%2C%0A%20%20%20%20%22after-white-space%22%2C%20%22ahead%22%2C%20%22alias%22%2C%20%22all%22%2C%20%22all-scroll%22%2C%20%22alternate%22%2C%0A%20%20%20%20%22always%22%2C%20%22amharic%22%2C%20%22amharic-abegede%22%2C%20%22antialiased%22%2C%20%22appworkspace%22%2C%0A%20%20%20%20%22arabic-indic%22%2C%20%22armenian%22%2C%20%22asterisks%22%2C%20%22auto%22%2C%20%22avoid%22%2C%20%22background%22%2C%0A%20%20%20%20%22backwards%22%2C%20%22baseline%22%2C%20%22below%22%2C%20%22bidi-override%22%2C%20%22binary%22%2C%20%22bengali%22%2C%0A%20%20%20%20%22blink%22%2C%20%22block%22%2C%20%22block-axis%22%2C%20%22bold%22%2C%20%22bolder%22%2C%20%22border%22%2C%20%22border-box%22%2C%0A%20%20%20%20%22both%22%2C%20%22bottom%22%2C%20%22break-all%22%2C%20%22break-word%22%2C%20%22button%22%2C%20%22button-bevel%22%2C%0A%20%20%20%20%22buttonface%22%2C%20%22buttonhighlight%22%2C%20%22buttonshadow%22%2C%20%22buttontext%22%2C%20%22cambodian%22%2C%0A%20%20%20%20%22capitalize%22%2C%20%22caps-lock-indicator%22%2C%20%22caption%22%2C%20%22captiontext%22%2C%20%22caret%22%2C%0A%20%20%20%20%22cell%22%2C%20%22center%22%2C%20%22checkbox%22%2C%20%22circle%22%2C%20%22cjk-earthly-branch%22%2C%0A%20%20%20%20%22cjk-heavenly-stem%22%2C%20%22cjk-ideographic%22%2C%20%22clear%22%2C%20%22clip%22%2C%20%22close-quote%22%2C%0A%20%20%20%20%22col-resize%22%2C%20%22collapse%22%2C%20%22compact%22%2C%20%22condensed%22%2C%20%22contain%22%2C%20%22content%22%2C%0A%20%20%20%20%22content-box%22%2C%20%22context-menu%22%2C%20%22continuous%22%2C%20%22copy%22%2C%20%22cover%22%2C%20%22crop%22%2C%0A%20%20%20%20%22cross%22%2C%20%22crosshair%22%2C%20%22currentcolor%22%2C%20%22cursive%22%2C%20%22dashed%22%2C%20%22decimal%22%2C%0A%20%20%20%20%22decimal-leading-zero%22%2C%20%22default%22%2C%20%22default-button%22%2C%20%22destination-atop%22%2C%0A%20%20%20%20%22destination-in%22%2C%20%22destination-out%22%2C%20%22destination-over%22%2C%20%22devanagari%22%2C%0A%20%20%20%20%22disc%22%2C%20%22discard%22%2C%20%22document%22%2C%20%22dot-dash%22%2C%20%22dot-dot-dash%22%2C%20%22dotted%22%2C%0A%20%20%20%20%22double%22%2C%20%22down%22%2C%20%22e-resize%22%2C%20%22ease%22%2C%20%22ease-in%22%2C%20%22ease-in-out%22%2C%20%22ease-out%22%2C%0A%20%20%20%20%22element%22%2C%20%22ellipsis%22%2C%20%22embed%22%2C%20%22end%22%2C%20%22ethiopic%22%2C%20%22ethiopic-abegede%22%2C%0A%20%20%20%20%22ethiopic-abegede-am-et%22%2C%20%22ethiopic-abegede-gez%22%2C%20%22ethiopic-abegede-ti-er%22%2C%0A%20%20%20%20%22ethiopic-abegede-ti-et%22%2C%20%22ethiopic-halehame-aa-er%22%2C%0A%20%20%20%20%22ethiopic-halehame-aa-et%22%2C%20%22ethiopic-halehame-am-et%22%2C%0A%20%20%20%20%22ethiopic-halehame-gez%22%2C%20%22ethiopic-halehame-om-et%22%2C%0A%20%20%20%20%22ethiopic-halehame-sid-et%22%2C%20%22ethiopic-halehame-so-et%22%2C%0A%20%20%20%20%22ethiopic-halehame-ti-er%22%2C%20%22ethiopic-halehame-ti-et%22%2C%0A%20%20%20%20%22ethiopic-halehame-tig%22%2C%20%22ew-resize%22%2C%20%22expanded%22%2C%20%22extra-condensed%22%2C%0A%20%20%20%20%22extra-expanded%22%2C%20%22fantasy%22%2C%20%22fast%22%2C%20%22fill%22%2C%20%22fixed%22%2C%20%22flat%22%2C%20%22footnotes%22%2C%0A%20%20%20%20%22forwards%22%2C%20%22from%22%2C%20%22geometricPrecision%22%2C%20%22georgian%22%2C%20%22graytext%22%2C%20%22groove%22%2C%0A%20%20%20%20%22gujarati%22%2C%20%22gurmukhi%22%2C%20%22hand%22%2C%20%22hangul%22%2C%20%22hangul-consonant%22%2C%20%22hebrew%22%2C%0A%20%20%20%20%22help%22%2C%20%22hidden%22%2C%20%22hide%22%2C%20%22higher%22%2C%20%22highlight%22%2C%20%22highlighttext%22%2C%0A%20%20%20%20%22hiragana%22%2C%20%22hiragana-iroha%22%2C%20%22horizontal%22%2C%20%22hsl%22%2C%20%22hsla%22%2C%20%22icon%22%2C%20%22ignore%22%2C%0A%20%20%20%20%22inactiveborder%22%2C%20%22inactivecaption%22%2C%20%22inactivecaptiontext%22%2C%20%22infinite%22%2C%0A%20%20%20%20%22infobackground%22%2C%20%22infotext%22%2C%20%22inherit%22%2C%20%22initial%22%2C%20%22inline%22%2C%20%22inline-axis%22%2C%0A%20%20%20%20%22inline-block%22%2C%20%22inline-table%22%2C%20%22inset%22%2C%20%22inside%22%2C%20%22intrinsic%22%2C%20%22invert%22%2C%0A%20%20%20%20%22italic%22%2C%20%22justify%22%2C%20%22kannada%22%2C%20%22katakana%22%2C%20%22katakana-iroha%22%2C%20%22khmer%22%2C%0A%20%20%20%20%22landscape%22%2C%20%22lao%22%2C%20%22large%22%2C%20%22larger%22%2C%20%22left%22%2C%20%22level%22%2C%20%22lighter%22%2C%0A%20%20%20%20%22line-through%22%2C%20%22linear%22%2C%20%22lines%22%2C%20%22list-item%22%2C%20%22listbox%22%2C%20%22listitem%22%2C%0A%20%20%20%20%22local%22%2C%20%22logical%22%2C%20%22loud%22%2C%20%22lower%22%2C%20%22lower-alpha%22%2C%20%22lower-armenian%22%2C%0A%20%20%20%20%22lower-greek%22%2C%20%22lower-hexadecimal%22%2C%20%22lower-latin%22%2C%20%22lower-norwegian%22%2C%0A%20%20%20%20%22lower-roman%22%2C%20%22lowercase%22%2C%20%22ltr%22%2C%20%22malayalam%22%2C%20%22match%22%2C%0A%20%20%20%20%22media-controls-background%22%2C%20%22media-current-time-display%22%2C%0A%20%20%20%20%22media-fullscreen-button%22%2C%20%22media-mute-button%22%2C%20%22media-play-button%22%2C%0A%20%20%20%20%22media-return-to-realtime-button%22%2C%20%22media-rewind-button%22%2C%0A%20%20%20%20%22media-seek-back-button%22%2C%20%22media-seek-forward-button%22%2C%20%22media-slider%22%2C%0A%20%20%20%20%22media-sliderthumb%22%2C%20%22media-time-remaining-display%22%2C%20%22media-volume-slider%22%2C%0A%20%20%20%20%22media-volume-slider-container%22%2C%20%22media-volume-sliderthumb%22%2C%20%22medium%22%2C%0A%20%20%20%20%22menu%22%2C%20%22menulist%22%2C%20%22menulist-button%22%2C%20%22menulist-text%22%2C%0A%20%20%20%20%22menulist-textfield%22%2C%20%22menutext%22%2C%20%22message-box%22%2C%20%22middle%22%2C%20%22min-intrinsic%22%2C%0A%20%20%20%20%22mix%22%2C%20%22mongolian%22%2C%20%22monospace%22%2C%20%22move%22%2C%20%22multiple%22%2C%20%22myanmar%22%2C%20%22n-resize%22%2C%0A%20%20%20%20%22narrower%22%2C%20%22navy%22%2C%20%22ne-resize%22%2C%20%22nesw-resize%22%2C%20%22no-close-quote%22%2C%20%22no-drop%22%2C%0A%20%20%20%20%22no-open-quote%22%2C%20%22no-repeat%22%2C%20%22none%22%2C%20%22normal%22%2C%20%22not-allowed%22%2C%20%22nowrap%22%2C%0A%20%20%20%20%22ns-resize%22%2C%20%22nw-resize%22%2C%20%22nwse-resize%22%2C%20%22oblique%22%2C%20%22octal%22%2C%20%22open-quote%22%2C%0A%20%20%20%20%22optimizeLegibility%22%2C%20%22optimizeSpeed%22%2C%20%22oriya%22%2C%20%22oromo%22%2C%20%22outset%22%2C%0A%20%20%20%20%22outside%22%2C%20%22overlay%22%2C%20%22overline%22%2C%20%22padding%22%2C%20%22padding-box%22%2C%20%22painted%22%2C%0A%20%20%20%20%22paused%22%2C%20%22persian%22%2C%20%22plus-darker%22%2C%20%22plus-lighter%22%2C%20%22pointer%22%2C%20%22portrait%22%2C%0A%20%20%20%20%22pre%22%2C%20%22pre-line%22%2C%20%22pre-wrap%22%2C%20%22preserve-3d%22%2C%20%22progress%22%2C%20%22push-button%22%2C%0A%20%20%20%20%22radio%22%2C%20%22read-only%22%2C%20%22read-write%22%2C%20%22read-write-plaintext-only%22%2C%20%22relative%22%2C%0A%20%20%20%20%22repeat%22%2C%20%22repeat-x%22%2C%20%22repeat-y%22%2C%20%22reset%22%2C%20%22reverse%22%2C%20%22rgb%22%2C%20%22rgba%22%2C%0A%20%20%20%20%22ridge%22%2C%20%22right%22%2C%20%22round%22%2C%20%22row-resize%22%2C%20%22rtl%22%2C%20%22run-in%22%2C%20%22running%22%2C%0A%20%20%20%20%22s-resize%22%2C%20%22sans-serif%22%2C%20%22scroll%22%2C%20%22scrollbar%22%2C%20%22se-resize%22%2C%20%22searchfield%22%2C%0A%20%20%20%20%22searchfield-cancel-button%22%2C%20%22searchfield-decoration%22%2C%0A%20%20%20%20%22searchfield-results-button%22%2C%20%22searchfield-results-decoration%22%2C%0A%20%20%20%20%22semi-condensed%22%2C%20%22semi-expanded%22%2C%20%22separate%22%2C%20%22serif%22%2C%20%22show%22%2C%20%22sidama%22%2C%0A%20%20%20%20%22single%22%2C%20%22skip-white-space%22%2C%20%22slide%22%2C%20%22slider-horizontal%22%2C%0A%20%20%20%20%22slider-vertical%22%2C%20%22sliderthumb-horizontal%22%2C%20%22sliderthumb-vertical%22%2C%20%22slow%22%2C%0A%20%20%20%20%22small%22%2C%20%22small-caps%22%2C%20%22small-caption%22%2C%20%22smaller%22%2C%20%22solid%22%2C%20%22somali%22%2C%0A%20%20%20%20%22source-atop%22%2C%20%22source-in%22%2C%20%22source-out%22%2C%20%22source-over%22%2C%20%22space%22%2C%20%22square%22%2C%0A%20%20%20%20%22square-button%22%2C%20%22start%22%2C%20%22static%22%2C%20%22status-bar%22%2C%20%22stretch%22%2C%20%22stroke%22%2C%0A%20%20%20%20%22sub%22%2C%20%22subpixel-antialiased%22%2C%20%22super%22%2C%20%22sw-resize%22%2C%20%22table%22%2C%0A%20%20%20%20%22table-caption%22%2C%20%22table-cell%22%2C%20%22table-column%22%2C%20%22table-column-group%22%2C%0A%20%20%20%20%22table-footer-group%22%2C%20%22table-header-group%22%2C%20%22table-row%22%2C%20%22table-row-group%22%2C%0A%20%20%20%20%22telugu%22%2C%20%22text%22%2C%20%22text-bottom%22%2C%20%22text-top%22%2C%20%22textarea%22%2C%20%22textfield%22%2C%20%22thai%22%2C%0A%20%20%20%20%22thick%22%2C%20%22thin%22%2C%20%22threeddarkshadow%22%2C%20%22threedface%22%2C%20%22threedhighlight%22%2C%0A%20%20%20%20%22threedlightshadow%22%2C%20%22threedshadow%22%2C%20%22tibetan%22%2C%20%22tigre%22%2C%20%22tigrinya-er%22%2C%0A%20%20%20%20%22tigrinya-er-abegede%22%2C%20%22tigrinya-et%22%2C%20%22tigrinya-et-abegede%22%2C%20%22to%22%2C%20%22top%22%2C%0A%20%20%20%20%22transparent%22%2C%20%22ultra-condensed%22%2C%20%22ultra-expanded%22%2C%20%22underline%22%2C%20%22up%22%2C%0A%20%20%20%20%22upper-alpha%22%2C%20%22upper-armenian%22%2C%20%22upper-greek%22%2C%20%22upper-hexadecimal%22%2C%0A%20%20%20%20%22upper-latin%22%2C%20%22upper-norwegian%22%2C%20%22upper-roman%22%2C%20%22uppercase%22%2C%20%22urdu%22%2C%20%22url%22%2C%0A%20%20%20%20%22vertical%22%2C%20%22vertical-text%22%2C%20%22visible%22%2C%20%22visibleFill%22%2C%20%22visiblePainted%22%2C%0A%20%20%20%20%22visibleStroke%22%2C%20%22visual%22%2C%20%22w-resize%22%2C%20%22wait%22%2C%20%22wave%22%2C%20%22white%22%2C%20%22wider%22%2C%0A%20%20%20%20%22window%22%2C%20%22windowframe%22%2C%20%22windowtext%22%2C%20%22x-large%22%2C%20%22x-small%22%2C%20%22xor%22%2C%0A%20%20%20%20%22xx-large%22%2C%20%22xx-small%22%2C%20%22yellow%22%0A%20%20%5D)%3B%0A%0A%20%20function%20keySet(array)%20%7B%20var%20keys%20%3D%20%7B%7D%3B%20for%20(var%20i%20%3D%200%3B%20i%20%3C%20array.length%3B%20%2B%2Bi)%20keys%5Barray%5Bi%5D%5D%20%3D%20true%3B%20return%20keys%3B%20%7D%0A%20%20function%20ret(style%2C%20tp)%20%7Btype%20%3D%20tp%3B%20return%20style%3B%7D%0A%0A%20%20function%20tokenBase(stream%2C%20state)%20%7B%0A%20%20%20%20var%20ch%20%3D%20stream.next()%3B%0A%20%20%20%20if%20(ch%20%3D%3D%20%22%40%22)%20%7Bstream.eatWhile(%2F%5B%5Cw%5C%5C%5C-%5D%2F)%3B%20return%20ret(%22def%22%2C%20stream.current())%3B%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%2F%22%20%26%26%20stream.eat(%22*%22))%20%7B%0A%20%20%20%20%20%20state.tokenize%20%3D%20tokenCComment%3B%0A%20%20%20%20%20%20return%20tokenCComment(stream%2C%20state)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%3C%22%20%26%26%20stream.eat(%22!%22))%20%7B%0A%20%20%20%20%20%20state.tokenize%20%3D%20tokenSGMLComment%3B%0A%20%20%20%20%20%20return%20tokenSGMLComment(stream%2C%20state)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%3D%22)%20ret(null%2C%20%22compare%22)%3B%0A%20%20%20%20else%20if%20((ch%20%3D%3D%20%22~%22%20%7C%7C%20ch%20%3D%3D%20%22%7C%22)%20%26%26%20stream.eat(%22%3D%22))%20return%20ret(null%2C%20%22compare%22)%3B%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%5C%22%22%20%7C%7C%20ch%20%3D%3D%20%22'%22)%20%7B%0A%20%20%20%20%20%20state.tokenize%20%3D%20tokenString(ch)%3B%0A%20%20%20%20%20%20return%20state.tokenize(stream%2C%20state)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%23%22)%20%7B%0A%20%20%20%20%20%20stream.eatWhile(%2F%5B%5Cw%5C%5C%5C-%5D%2F)%3B%0A%20%20%20%20%20%20return%20ret(%22atom%22%2C%20%22hash%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22!%22)%20%7B%0A%20%20%20%20%20%20stream.match(%2F%5E%5Cs*%5Cw*%2F)%3B%0A%20%20%20%20%20%20return%20ret(%22keyword%22%2C%20%22important%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(%2F%5Cd%2F.test(ch))%20%7B%0A%20%20%20%20%20%20stream.eatWhile(%2F%5B%5Cw.%25%5D%2F)%3B%0A%20%20%20%20%20%20return%20ret(%22number%22%2C%20%22unit%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%3D%20%22-%22)%20%7B%0A%20%20%20%20%20%20if%20(%2F%5Cd%2F.test(stream.peek()))%20%7B%0A%20%20%20%20%20%20%20%20stream.eatWhile(%2F%5B%5Cw.%25%5D%2F)%3B%0A%20%20%20%20%20%20%20%20return%20ret(%22number%22%2C%20%22unit%22)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(stream.match(%2F%5E%5B%5E-%5D%2B-%2F))%20%7B%0A%20%20%20%20%20%20%20%20return%20ret(%22meta%22%2C%20type)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(%2F%5B%2C%2B%3E*%5C%2F%5D%2F.test(ch))%20%7B%0A%20%20%20%20%20%20return%20ret(null%2C%20%22select-op%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22.%22%20%26%26%20stream.match(%2F%5E%5Cw%2B%2F))%20%7B%0A%20%20%20%20%20%20return%20ret(%22qualifier%22%2C%20type)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(ch%20%3D%3D%20%22%3A%22)%20%7B%0A%20%20%20%20%20%20return%20ret(%22operator%22%2C%20ch)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20if%20(%2F%5B%3B%7B%7D%5C%5B%5C%5D%5C(%5C)%5D%2F.test(ch))%20%7B%0A%20%20%20%20%20%20return%20ret(null%2C%20ch)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20%7B%0A%20%20%20%20%20%20stream.eatWhile(%2F%5B%5Cw%5C%5C%5C-%5D%2F)%3B%0A%20%20%20%20%20%20return%20ret(%22property%22%2C%20%22variable%22)%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%0A%20%20function%20tokenCComment(stream%2C%20state)%20%7B%0A%20%20%20%20var%20maybeEnd%20%3D%20false%2C%20ch%3B%0A%20%20%20%20while%20((ch%20%3D%20stream.next())%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20if%20(maybeEnd%20%26%26%20ch%20%3D%3D%20%22%2F%22)%20%7B%0A%20%20%20%20%20%20%20%20state.tokenize%20%3D%20tokenBase%3B%0A%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20maybeEnd%20%3D%20(ch%20%3D%3D%20%22*%22)%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20ret(%22comment%22%2C%20%22comment%22)%3B%0A%20%20%7D%0A%0A%20%20function%20tokenSGMLComment(stream%2C%20state)%20%7B%0A%20%20%20%20var%20dashes%20%3D%200%2C%20ch%3B%0A%20%20%20%20while%20((ch%20%3D%20stream.next())%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20if%20(dashes%20%3E%3D%202%20%26%26%20ch%20%3D%3D%20%22%3E%22)%20%7B%0A%20%20%20%20%20%20%20%20state.tokenize%20%3D%20tokenBase%3B%0A%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20dashes%20%3D%20(ch%20%3D%3D%20%22-%22)%20%3F%20dashes%20%2B%201%20%3A%200%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20ret(%22comment%22%2C%20%22comment%22)%3B%0A%20%20%7D%0A%0A%20%20function%20tokenString(quote)%20%7B%0A%20%20%20%20return%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20var%20escaped%20%3D%20false%2C%20ch%3B%0A%20%20%20%20%20%20while%20((ch%20%3D%20stream.next())%20!%3D%20null)%20%7B%0A%20%20%20%20%20%20%20%20if%20(ch%20%3D%3D%20quote%20%26%26%20!escaped)%0A%20%20%20%20%20%20%20%20%20%20break%3B%0A%20%20%20%20%20%20%20%20escaped%20%3D%20!escaped%20%26%26%20ch%20%3D%3D%20%22%5C%5C%22%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20if%20(!escaped)%20state.tokenize%20%3D%20tokenBase%3B%0A%20%20%20%20%20%20return%20ret(%22string%22%2C%20%22string%22)%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20return%20%7B%0A%20%20%20%20startState%3A%20function(base)%20%7B%0A%20%20%20%20%20%20return%20%7Btokenize%3A%20tokenBase%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20baseIndent%3A%20base%20%7C%7C%200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20stack%3A%20%5B%5D%7D%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20token%3A%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%2F%2F%20Use%20these%20terms%20when%20applicable%20(see%20http%3A%2F%2Fwww.xanthir.com%2Fblog%2Fb4E50)%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20rule**%20or%20**ruleset%3A%0A%20%20%20%20%20%20%2F%2F%20A%20selector%20%2B%20braces%20combo%2C%20or%20an%20at-rule.%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20declaration%20block%3A%0A%20%20%20%20%20%20%2F%2F%20A%20sequence%20of%20declarations.%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20declaration%3A%0A%20%20%20%20%20%20%2F%2F%20A%20property%20%2B%20colon%20%2B%20value%20combo.%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20property%20value%3A%0A%20%20%20%20%20%20%2F%2F%20The%20entire%20value%20of%20a%20property.%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20component%20value%3A%0A%20%20%20%20%20%20%2F%2F%20A%20single%20piece%20of%20a%20property%20value.%20Like%20the%205px%20in%0A%20%20%20%20%20%20%2F%2F%20text-shadow%3A%200%200%205px%20blue%3B.%20Can%20also%20refer%20to%20things%20that%20are%0A%20%20%20%20%20%20%2F%2F%20multiple%20terms%2C%20like%20the%201-4%20terms%20that%20make%20up%20the%20background-size%0A%20%20%20%20%20%20%2F%2F%20portion%20of%20the%20background%20shorthand.%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20term%3A%0A%20%20%20%20%20%20%2F%2F%20The%20basic%20unit%20of%20author-facing%20CSS%2C%20like%20a%20single%20number%20(5)%2C%0A%20%20%20%20%20%20%2F%2F%20dimension%20(5px)%2C%20string%20(%22foo%22)%2C%20or%20function.%20Officially%20defined%0A%20%20%20%20%20%20%2F%2F%20%20by%20the%20CSS%202.1%20grammar%20(look%20for%20the%20'term'%20production)%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20simple%20selector%3A%0A%20%20%20%20%20%20%2F%2F%20A%20single%20atomic%20selector%2C%20like%20a%20type%20selector%2C%20an%20attr%20selector%2C%20a%0A%20%20%20%20%20%20%2F%2F%20class%20selector%2C%20etc.%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20compound%20selector%3A%0A%20%20%20%20%20%20%2F%2F%20One%20or%20more%20simple%20selectors%20without%20a%20combinator.%20div.example%20is%0A%20%20%20%20%20%20%2F%2F%20compound%2C%20div%20%3E%20.example%20is%20not.%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20complex%20selector%3A%0A%20%20%20%20%20%20%2F%2F%20One%20or%20more%20compound%20selectors%20chained%20with%20combinators.%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20combinator%3A%0A%20%20%20%20%20%20%2F%2F%20The%20parts%20of%20selectors%20that%20express%20relationships.%20There%20are%20four%0A%20%20%20%20%20%20%2F%2F%20currently%20-%20the%20space%20(descendant%20combinator)%2C%20the%20greater-than%0A%20%20%20%20%20%20%2F%2F%20bracket%20(child%20combinator)%2C%20the%20plus%20sign%20(next%20sibling%20combinator)%2C%0A%20%20%20%20%20%20%2F%2F%20and%20the%20tilda%20(following%20sibling%20combinator).%0A%20%20%20%20%20%20%2F%2F%20%0A%20%20%20%20%20%20%2F%2F%20sequence%20of%20selectors%3A%0A%20%20%20%20%20%20%2F%2F%20One%20or%20more%20of%20the%20named%20type%20of%20selector%20chained%20with%20commas.%0A%0A%20%20%20%20%20%20if%20(stream.eatSpace())%20return%20null%3B%0A%20%20%20%20%20%20var%20style%20%3D%20state.tokenize(stream%2C%20state)%3B%0A%0A%20%20%20%20%20%20%2F%2F%20Changing%20style%20returned%20based%20on%20context%0A%20%20%20%20%20%20var%20context%20%3D%20state.stack%5Bstate.stack.length-1%5D%3B%0A%20%20%20%20%20%20if%20(style%20%3D%3D%20%22property%22)%20%7B%0A%20%20%20%20%20%20%20%20if%20(context%20%3D%3D%20%22propertyValue%22)%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(valueKeywords%5Bstream.current()%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22string-2%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(colorKeywords%5Bstream.current()%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22keyword%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22variable-2%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(context%20%3D%3D%20%22rule%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(!propertyKeywords%5Bstream.current()%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%2B%3D%20%22%20error%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(!context%20%7C%7C%20context%20%3D%3D%20%22%40media%7B%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22tag%22%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(context%20%3D%3D%20%22%40media%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(atMediaTypes%5Bstream.current()%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22attribute%22%3B%20%2F%2F%20Known%20attribute%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(%2F%5E(only%7Cnot)%24%2Fi.test(stream.current()))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22keyword%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(stream.current().toLowerCase()%20%3D%3D%20%22and%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%20%2F%2F%20%22and%22%20is%20only%20allowed%20in%20%40mediaType%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(atMediaFeatures%5Bstream.current()%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%20%2F%2F%20Known%20property%2C%20should%20be%20in%20%40mediaType(%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20Unknown%2C%20expecting%20keyword%20or%20attribute%2C%20assuming%20attribute%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22attribute%20error%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(context%20%3D%3D%20%22%40mediaType%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(atMediaTypes%5Bstream.current()%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22attribute%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(stream.current().toLowerCase()%20%3D%3D%20%22and%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22operator%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(%2F%5E(only%7Cnot)%24%2Fi.test(stream.current()))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%20%2F%2F%20Only%20allowed%20in%20%40media%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(atMediaFeatures%5Bstream.current()%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%20%2F%2F%20Known%20property%2C%20should%20be%20in%20parentheses%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20Unknown%20attribute%20or%20property%2C%20but%20expecting%20property%20(preceded%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20by%20%22and%22).%20Should%20be%20in%20parentheses%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(context%20%3D%3D%20%22%40mediaType(%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(propertyKeywords%5Bstream.current()%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%20do%20nothing%2C%20remains%20%22property%22%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(atMediaTypes%5Bstream.current()%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%20%2F%2F%20Known%20property%2C%20should%20be%20in%20parentheses%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(stream.current().toLowerCase()%20%3D%3D%20%22and%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22operator%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20if%20(%2F%5E(only%7Cnot)%24%2Fi.test(stream.current()))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%20%2F%2F%20Only%20allowed%20in%20%40media%0A%20%20%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%2B%3D%20%22%20error%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%20else%20if%20(style%20%3D%3D%20%22atom%22)%20%7B%0A%20%20%20%20%20%20%20%20if(!context%20%7C%7C%20context%20%3D%3D%20%22%40media%7B%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22builtin%22%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20if%20(context%20%3D%3D%20%22propertyValue%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20if%20(!%2F%5E%23(%5B0-9a-fA-f%5D%7B3%7D%7C%5B0-9a-fA-f%5D%7B6%7D)%24%2F.test(stream.current()))%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20style%20%2B%3D%20%22%20error%22%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%20else%20if%20(context%20%3D%3D%20%22%40media%22%20%26%26%20type%20%3D%3D%20%22%7B%22)%20%7B%0A%20%20%20%20%20%20%20%20style%20%3D%20%22error%22%3B%0A%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%2F%2F%20Push%2Fpop%20context%20stack%0A%20%20%20%20%20%20if%20(type%20%3D%3D%20%22%7B%22)%20%7B%0A%20%20%20%20%20%20%20%20if%20(context%20%3D%3D%20%22%40media%22%20%7C%7C%20context%20%3D%3D%20%22%40mediaType%22)%20%7B%0A%20%20%20%20%20%20%20%20%20%20state.stack.pop()%3B%0A%20%20%20%20%20%20%20%20%20%20state.stack%5Bstate.stack.length-1%5D%20%3D%20%22%40media%7B%22%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20else%20state.stack.push(%22rule%22)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20else%20if%20(type%20%3D%3D%20%22%7D%22)%20%7B%0A%20%20%20%20%20%20%20%20state.stack.pop()%3B%0A%20%20%20%20%20%20%20%20if%20(context%20%3D%3D%20%22propertyValue%22)%20state.stack.pop()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20else%20if%20(type%20%3D%3D%20%22%40media%22)%20state.stack.push(%22%40media%22)%3B%0A%20%20%20%20%20%20else%20if%20(context%20%3D%3D%20%22%40media%22%20%26%26%20%2F%5Cb(keyword%7Cattribute)%5Cb%2F.test(style))%0A%20%20%20%20%20%20%20%20state.stack.push(%22%40mediaType%22)%3B%0A%20%20%20%20%20%20else%20if%20(context%20%3D%3D%20%22%40mediaType%22%20%26%26%20stream.current()%20%3D%3D%20%22%2C%22)%20state.stack.pop()%3B%0A%20%20%20%20%20%20else%20if%20(context%20%3D%3D%20%22%40mediaType%22%20%26%26%20type%20%3D%3D%20%22(%22)%20state.stack.push(%22%40mediaType(%22)%3B%0A%20%20%20%20%20%20else%20if%20(context%20%3D%3D%20%22%40mediaType(%22%20%26%26%20type%20%3D%3D%20%22)%22)%20state.stack.pop()%3B%0A%20%20%20%20%20%20else%20if%20(context%20%3D%3D%20%22rule%22%20%26%26%20type%20%3D%3D%20%22%3A%22)%20state.stack.push(%22propertyValue%22)%3B%0A%20%20%20%20%20%20else%20if%20(context%20%3D%3D%20%22propertyValue%22%20%26%26%20type%20%3D%3D%20%22%3B%22)%20state.stack.pop()%3B%0A%20%20%20%20%20%20return%20style%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20indent%3A%20function(state%2C%20textAfter)%20%7B%0A%20%20%20%20%20%20var%20n%20%3D%20state.stack.length%3B%0A%20%20%20%20%20%20if%20(%2F%5E%5C%7D%2F.test(textAfter))%0A%20%20%20%20%20%20%20%20n%20-%3D%20state.stack%5Bstate.stack.length-1%5D%20%3D%3D%20%22propertyValue%22%20%3F%202%20%3A%201%3B%0A%20%20%20%20%20%20return%20state.baseIndent%20%2B%20n%20*%20indentUnit%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20electricChars%3A%20%22%7D%22%0A%20%20%7D%3B%0A%7D)%3B%0A%0ACodeMirror.defineMIME(%22text%2Fcss%22%2C%20%22css%22)%3B%0A%20%20%20%20%3C%2Fscript%3E%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%3C!--%20http%3A%2F%2Fcodemirror.net%2Fmode%2Fhtmlmixed%2Fhtmlmixed.js%20--%3E%3Cscript%3E%0ACodeMirror.defineMode(%22htmlmixed%22%2C%20function(config)%20%7B%0A%20%20var%20htmlMode%20%3D%20CodeMirror.getMode(config%2C%20%7Bname%3A%20%22xml%22%2C%20htmlMode%3A%20true%7D)%3B%0A%20%20var%20jsMode%20%3D%20CodeMirror.getMode(config%2C%20%22javascript%22)%3B%0A%20%20var%20cssMode%20%3D%20CodeMirror.getMode(config%2C%20%22css%22)%3B%0A%0A%20%20function%20html(stream%2C%20state)%20%7B%0A%20%20%20%20var%20style%20%3D%20htmlMode.token(stream%2C%20state.htmlState)%3B%0A%20%20%20%20if%20(style%20%3D%3D%20%22tag%22%20%26%26%20stream.current()%20%3D%3D%20%22%3E%22%20%26%26%20state.htmlState.context)%20%7B%0A%20%20%20%20%20%20if%20(%2F%5Escript%24%2Fi.test(state.htmlState.context.tagName))%20%7B%0A%20%20%20%20%20%20%20%20state.token%20%3D%20javascript%3B%0A%20%20%20%20%20%20%20%20state.localState%20%3D%20jsMode.startState(htmlMode.indent(state.htmlState%2C%20%22%22))%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20else%20if%20(%2F%5Estyle%24%2Fi.test(state.htmlState.context.tagName))%20%7B%0A%20%20%20%20%20%20%20%20state.token%20%3D%20css%3B%0A%20%20%20%20%20%20%20%20state.localState%20%3D%20cssMode.startState(htmlMode.indent(state.htmlState%2C%20%22%22))%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20style%3B%0A%20%20%7D%0A%20%20function%20maybeBackup(stream%2C%20pat%2C%20style)%20%7B%0A%20%20%20%20var%20cur%20%3D%20stream.current()%3B%0A%20%20%20%20var%20close%20%3D%20cur.search(pat)%2C%20m%3B%0A%20%20%20%20if%20(close%20%3E%20-1)%20stream.backUp(cur.length%20-%20close)%3B%0A%20%20%20%20else%20if%20(m%20%3D%20cur.match(%2F%3C%5C%2F%3F%24%2F))%20%7B%0A%20%20%20%20%20%20stream.backUp(cur%5B0%5D.length)%3B%0A%20%20%20%20%20%20if%20(!stream.match(pat%2C%20false))%20stream.match(cur%5B0%5D)%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20style%3B%0A%20%20%7D%0A%20%20function%20javascript(stream%2C%20state)%20%7B%0A%20%20%20%20if%20(stream.match(%2F%5E%3C%5C%2F%5Cs*script%5Cs*%3E%2Fi%2C%20false))%20%7B%0A%20%20%20%20%20%20state.token%20%3D%20html%3B%0A%20%20%20%20%20%20state.localState%20%3D%20null%3B%0A%20%20%20%20%20%20return%20html(stream%2C%20state)%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20maybeBackup(stream%2C%20%2F%3C%5C%2F%5Cs*script%5Cs*%3E%2F%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20jsMode.token(stream%2C%20state.localState))%3B%0A%20%20%7D%0A%20%20function%20css(stream%2C%20state)%20%7B%0A%20%20%20%20if%20(stream.match(%2F%5E%3C%5C%2F%5Cs*style%5Cs*%3E%2Fi%2C%20false))%20%7B%0A%20%20%20%20%20%20state.token%20%3D%20html%3B%0A%20%20%20%20%20%20state.localState%20%3D%20null%3B%0A%20%20%20%20%20%20return%20html(stream%2C%20state)%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20maybeBackup(stream%2C%20%2F%3C%5C%2F%5Cs*style%5Cs*%3E%2F%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20cssMode.token(stream%2C%20state.localState))%3B%0A%20%20%7D%0A%0A%20%20return%20%7B%0A%20%20%20%20startState%3A%20function()%20%7B%0A%20%20%20%20%20%20var%20state%20%3D%20htmlMode.startState()%3B%0A%20%20%20%20%20%20return%20%7Btoken%3A%20html%2C%20localState%3A%20null%2C%20mode%3A%20%22html%22%2C%20htmlState%3A%20state%7D%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20copyState%3A%20function(state)%20%7B%0A%20%20%20%20%20%20if%20(state.localState)%0A%20%20%20%20%20%20%20%20var%20local%20%3D%20CodeMirror.copyState(state.token%20%3D%3D%20css%20%3F%20cssMode%20%3A%20jsMode%2C%20state.localState)%3B%0A%20%20%20%20%20%20return%20%7Btoken%3A%20state.token%2C%20localState%3A%20local%2C%20mode%3A%20state.mode%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20htmlState%3A%20CodeMirror.copyState(htmlMode%2C%20state.htmlState)%7D%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20token%3A%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20return%20state.token(stream%2C%20state)%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20indent%3A%20function(state%2C%20textAfter)%20%7B%0A%20%20%20%20%20%20if%20(state.token%20%3D%3D%20html%20%7C%7C%20%2F%5E%5Cs*%3C%5C%2F%2F.test(textAfter))%0A%20%20%20%20%20%20%20%20return%20htmlMode.indent(state.htmlState%2C%20textAfter)%3B%0A%20%20%20%20%20%20else%20if%20(state.token%20%3D%3D%20javascript)%0A%20%20%20%20%20%20%20%20return%20jsMode.indent(state.localState%2C%20textAfter)%3B%0A%20%20%20%20%20%20else%0A%20%20%20%20%20%20%20%20return%20cssMode.indent(state.localState%2C%20textAfter)%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20electricChars%3A%20%22%2F%7B%7D%3A%22%2C%0A%0A%20%20%20%20innerMode%3A%20function(state)%20%7B%0A%20%20%20%20%20%20var%20mode%20%3D%20state.token%20%3D%3D%20html%20%3F%20htmlMode%20%3A%20state.token%20%3D%3D%20javascript%20%3F%20jsMode%20%3A%20cssMode%3B%0A%20%20%20%20%20%20return%20%7Bstate%3A%20state.localState%20%7C%7C%20state.htmlState%2C%20mode%3A%20mode%7D%3B%0A%20%20%20%20%7D%0A%20%20%7D%3B%0A%7D%2C%20%22xml%22%2C%20%22javascript%22%2C%20%22css%22)%3B%0A%0ACodeMirror.defineMIME(%22text%2Fhtml%22%2C%20%22htmlmixed%22)%3B%0A%20%20%20%20%3C%2Fscript%3E%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%3C!--%20http%3A%2F%2Fcodemirror.net%2Fmode%2Fmarkdown%2Fmarkdown.js%20--%3E%3Cscript%3E%0ACodeMirror.defineMode(%22markdown%22%2C%20function(cmCfg%2C%20modeCfg)%20%7B%0A%0A%20%20var%20htmlFound%20%3D%20CodeMirror.mimeModes.hasOwnProperty(%22text%2Fhtml%22)%3B%0A%20%20var%20htmlMode%20%3D%20CodeMirror.getMode(cmCfg%2C%20htmlFound%20%3F%20%22text%2Fhtml%22%20%3A%20%22text%2Fplain%22)%3B%0A%20%20%0A%20%20var%20codeDepth%20%3D%200%3B%0A%20%20var%20prevLineHasContent%20%3D%20false%0A%20%20%2C%20%20%20thisLineHasContent%20%3D%20false%3B%0A%0A%20%20var%20header%20%20%20%3D%20'header'%0A%20%20%2C%20%20%20code%20%20%20%20%20%3D%20'comment'%0A%20%20%2C%20%20%20quote%20%20%20%20%3D%20'quote'%0A%20%20%2C%20%20%20list%20%20%20%20%20%3D%20'string'%0A%20%20%2C%20%20%20hr%20%20%20%20%20%20%20%3D%20'hr'%0A%20%20%2C%20%20%20linkinline%20%3D%20'link'%0A%20%20%2C%20%20%20linkemail%20%3D%20'link'%0A%20%20%2C%20%20%20linktext%20%3D%20'link'%0A%20%20%2C%20%20%20linkhref%20%3D%20'string'%0A%20%20%2C%20%20%20em%20%20%20%20%20%20%20%3D%20'em'%0A%20%20%2C%20%20%20strong%20%20%20%3D%20'strong'%0A%20%20%2C%20%20%20emstrong%20%3D%20'emstrong'%3B%0A%0A%20%20var%20hrRE%20%3D%20%2F%5E(%5B*%5C-%3D_%5D)(%3F%3A%5Cs*%5C1)%7B2%2C%7D%5Cs*%24%2F%0A%20%20%2C%20%20%20ulRE%20%3D%20%2F%5E%5B*%5C-%2B%5D%5Cs%2B%2F%0A%20%20%2C%20%20%20olRE%20%3D%20%2F%5E%5B0-9%5D%2B%5C.%5Cs%2B%2F%0A%20%20%2C%20%20%20headerRE%20%3D%20%2F%5E(%3F%3A%5C%3D%7B1%2C%7D%7C-%7B1%2C%7D)%24%2F%0A%20%20%2C%20%20%20textRE%20%3D%20%2F%5E%5B%5E%5C%5B*_%5C%5C%3C%3E%60%20%22'(%5D%2B%2F%3B%0A%0A%20%20function%20switchInline(stream%2C%20state%2C%20f)%20%7B%0A%20%20%20%20state.f%20%3D%20state.inline%20%3D%20f%3B%0A%20%20%20%20return%20f(stream%2C%20state)%3B%0A%20%20%7D%0A%0A%20%20function%20switchBlock(stream%2C%20state%2C%20f)%20%7B%0A%20%20%20%20state.f%20%3D%20state.block%20%3D%20f%3B%0A%20%20%20%20return%20f(stream%2C%20state)%3B%0A%20%20%7D%0A%0A%0A%20%20%2F%2F%20Blocks%0A%0A%20%20function%20blankLine(state)%20%7B%0A%20%20%20%20%2F%2F%20Reset%20linkTitle%20state%0A%20%20%20%20state.linkTitle%20%3D%20false%3B%0A%20%20%20%20%2F%2F%20Reset%20CODE%20state%0A%20%20%20%20state.code%20%3D%20false%3B%0A%20%20%20%20%2F%2F%20Reset%20EM%20state%0A%20%20%20%20state.em%20%3D%20false%3B%0A%20%20%20%20%2F%2F%20Reset%20STRONG%20state%0A%20%20%20%20state.strong%20%3D%20false%3B%0A%20%20%20%20%2F%2F%20Reset%20state.quote%0A%20%20%20%20state.quote%20%3D%20false%3B%0A%20%20%20%20if%20(!htmlFound%20%26%26%20state.f%20%3D%3D%20htmlBlock)%20%7B%0A%20%20%20%20%20%20state.f%20%3D%20inlineNormal%3B%0A%20%20%20%20%20%20state.block%20%3D%20blockNormal%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20null%3B%0A%20%20%7D%0A%0A%20%20function%20blockNormal(stream%2C%20state)%20%7B%0A%20%20%20%20var%20match%3B%0A%20%20%20%20%0A%20%20%20%20if%20(state.list%20!%3D%3D%20false%20%26%26%20state.indentationDiff%20%3E%3D%200)%20%7B%20%2F%2F%20Continued%20list%0A%20%20%20%20%20%20if%20(state.indentationDiff%20%3C%204)%20%7B%20%2F%2F%20Only%20adjust%20indentation%20if%20*not*%20a%20code%20block%0A%20%20%20%20%20%20%20%20state.indentation%20-%3D%20state.indentationDiff%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20state.list%20%3D%20null%3B%0A%20%20%20%20%7D%20else%20%7B%20%2F%2F%20No%20longer%20a%20list%0A%20%20%20%20%20%20state.list%20%3D%20false%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(state.indentationDiff%20%3E%3D%204)%20%7B%0A%20%20%20%20%20%20state.indentation%20-%3D%204%3B%0A%20%20%20%20%20%20stream.skipToEnd()%3B%0A%20%20%20%20%20%20return%20code%3B%0A%20%20%20%20%7D%20else%20if%20(stream.eatSpace())%20%7B%0A%20%20%20%20%20%20return%20null%3B%0A%20%20%20%20%7D%20else%20if%20(stream.peek()%20%3D%3D%3D%20'%23'%20%7C%7C%20(prevLineHasContent%20%26%26%20stream.match(headerRE))%20)%20%7B%0A%20%20%20%20%20%20state.header%20%3D%20true%3B%0A%20%20%20%20%7D%20else%20if%20(stream.eat('%3E'))%20%7B%0A%20%20%20%20%20%20state.indentation%2B%2B%3B%0A%20%20%20%20%20%20state.quote%20%3D%20true%3B%0A%20%20%20%20%7D%20else%20if%20(stream.peek()%20%3D%3D%3D%20'%5B')%20%7B%0A%20%20%20%20%20%20return%20switchInline(stream%2C%20state%2C%20footnoteLink)%3B%0A%20%20%20%20%7D%20else%20if%20(stream.match(hrRE%2C%20true))%20%7B%0A%20%20%20%20%20%20return%20hr%3B%0A%20%20%20%20%7D%20else%20if%20(match%20%3D%20stream.match(ulRE%2C%20true)%20%7C%7C%20stream.match(olRE%2C%20true))%20%7B%0A%20%20%20%20%20%20state.indentation%20%2B%3D%204%3B%0A%20%20%20%20%20%20state.list%20%3D%20true%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20return%20switchInline(stream%2C%20state%2C%20state.inline)%3B%0A%20%20%7D%0A%0A%20%20function%20htmlBlock(stream%2C%20state)%20%7B%0A%20%20%20%20var%20style%20%3D%20htmlMode.token(stream%2C%20state.htmlState)%3B%0A%20%20%20%20if%20(htmlFound%20%26%26%20style%20%3D%3D%3D%20'tag'%20%26%26%20state.htmlState.type%20!%3D%3D%20'openTag'%20%26%26%20!state.htmlState.context)%20%7B%0A%20%20%20%20%20%20state.f%20%3D%20inlineNormal%3B%0A%20%20%20%20%20%20state.block%20%3D%20blockNormal%3B%0A%20%20%20%20%7D%0A%20%20%20%20if%20(state.md_inside%20%26%26%20stream.current().indexOf(%22%3E%22)!%3D-1)%20%7B%0A%20%20%20%20%20%20state.f%20%3D%20inlineNormal%3B%0A%20%20%20%20%20%20state.block%20%3D%20blockNormal%3B%0A%20%20%20%20%20%20state.htmlState.context%20%3D%20undefined%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20style%3B%0A%20%20%7D%0A%0A%0A%20%20%2F%2F%20Inline%0A%20%20function%20getType(state)%20%7B%0A%20%20%20%20var%20styles%20%3D%20%5B%5D%3B%0A%20%20%20%20%0A%20%20%20%20if%20(state.strong)%20%7B%20styles.push(state.em%20%3F%20emstrong%20%3A%20strong)%3B%20%7D%0A%20%20%20%20else%20if%20(state.em)%20%7B%20styles.push(em)%3B%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(state.code)%20%7B%20styles.push(code)%3B%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(state.header)%20%7B%20styles.push(header)%3B%20%7D%0A%20%20%20%20if%20(state.quote)%20%7B%20styles.push(quote)%3B%20%7D%0A%20%20%20%20if%20(state.list%20!%3D%3D%20false)%20%7B%20styles.push(list)%3B%20%7D%0A%0A%20%20%20%20return%20styles.length%20%3F%20styles.join('%20')%20%3A%20null%3B%0A%20%20%7D%0A%0A%20%20function%20handleText(stream%2C%20state)%20%7B%0A%20%20%20%20if%20(stream.match(textRE%2C%20true))%20%7B%0A%20%20%20%20%20%20return%20getType(state)%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20undefined%3B%20%20%20%20%20%20%20%20%0A%20%20%7D%0A%0A%20%20function%20inlineNormal(stream%2C%20state)%20%7B%0A%20%20%20%20var%20style%20%3D%20state.text(stream%2C%20state)%3B%0A%20%20%20%20if%20(typeof%20style%20!%3D%3D%20'undefined')%0A%20%20%20%20%20%20return%20style%3B%0A%20%20%20%20%0A%20%20%20%20if%20(state.list)%20%7B%20%2F%2F%20List%20marker%20(*%2C%20%2B%2C%20-%2C%201.%2C%20etc)%0A%20%20%20%20%20%20state.list%20%3D%20null%3B%0A%20%20%20%20%20%20return%20list%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20var%20ch%20%3D%20stream.next()%3B%0A%20%20%20%20%0A%20%20%20%20if%20(ch%20%3D%3D%3D%20'%5C%5C')%20%7B%0A%20%20%20%20%20%20stream.next()%3B%0A%20%20%20%20%20%20return%20getType(state)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Matches%20link%20titles%20present%20on%20next%20line%0A%20%20%20%20if%20(state.linkTitle)%20%7B%0A%20%20%20%20%20%20state.linkTitle%20%3D%20false%3B%0A%20%20%20%20%20%20var%20matchCh%20%3D%20ch%3B%0A%20%20%20%20%20%20if%20(ch%20%3D%3D%3D%20'(')%20%7B%0A%20%20%20%20%20%20%20%20matchCh%20%3D%20')'%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20matchCh%20%3D%20(matchCh%2B'').replace(%2F(%5B.%3F*%2B%5E%24%5B%5C%5D%5C%5C()%7B%7D%7C-%5D)%2Fg%2C%20%22%5C%5C%241%22)%3B%0A%20%20%20%20%20%20var%20regex%20%3D%20'%5E%5C%5Cs*(%3F%3A%5B%5E'%20%2B%20matchCh%20%2B%20'%5C%5C%5C%5C%5D%2B%7C%5C%5C%5C%5C%5C%5C%5C%5C%7C%5C%5C%5C%5C.)'%20%2B%20matchCh%3B%0A%20%20%20%20%20%20if%20(stream.match(new%20RegExp(regex)%2C%20true))%20%7B%0A%20%20%20%20%20%20%20%20return%20linkhref%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(ch%20%3D%3D%3D%20'%60')%20%7B%0A%20%20%20%20%20%20var%20t%20%3D%20getType(state)%3B%0A%20%20%20%20%20%20var%20before%20%3D%20stream.pos%3B%0A%20%20%20%20%20%20stream.eatWhile('%60')%3B%0A%20%20%20%20%20%20var%20difference%20%3D%201%20%2B%20stream.pos%20-%20before%3B%0A%20%20%20%20%20%20if%20(!state.code)%20%7B%0A%20%20%20%20%20%20%20%20codeDepth%20%3D%20difference%3B%0A%20%20%20%20%20%20%20%20state.code%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20return%20getType(state)%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20if%20(difference%20%3D%3D%3D%20codeDepth)%20%7B%20%2F%2F%20Must%20be%20exact%0A%20%20%20%20%20%20%20%20%20%20state.code%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20return%20t%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20return%20getType(state)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20if%20(state.code)%20%7B%0A%20%20%20%20%20%20return%20getType(state)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(ch%20%3D%3D%3D%20'%5B'%20%26%26%20stream.match(%2F.*%5C%5D%20%3F(%3F%3A%5C(%7C%5C%5B)%2F%2C%20false))%20%7B%0A%20%20%20%20%20%20return%20switchInline(stream%2C%20state%2C%20linkText)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(ch%20%3D%3D%3D%20'%3C'%20%26%26%20stream.match(%2F%5E(https%3F%7Cftps%3F)%3A%5C%2F%5C%2F(%3F%3A%5B%5E%5C%5C%3E%5D%7C%5C%5C.)%2B%3E%2F%2C%20true))%20%7B%0A%20%20%20%20%20%20return%20switchInline(stream%2C%20state%2C%20inlineElement(linkinline%2C%20'%3E'))%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(ch%20%3D%3D%3D%20'%3C'%20%26%26%20stream.match(%2F%5E%5B%5E%3E%20%5C%5C%5D%2B%40(%3F%3A%5B%5E%5C%5C%3E%5D%7C%5C%5C.)%2B%3E%2F%2C%20true))%20%7B%0A%20%20%20%20%20%20return%20switchInline(stream%2C%20state%2C%20inlineElement(linkemail%2C%20'%3E'))%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20if%20(ch%20%3D%3D%3D%20'%3C'%20%26%26%20stream.match(%2F%5E%5Cw%2F%2C%20false))%20%7B%0A%20%20%20%20%20%20var%20md_inside%20%3D%20false%3B%0A%20%20%20%20%20%20if%20(stream.string.indexOf(%22%3E%22)!%3D-1)%20%7B%0A%20%20%20%20%20%20%20%20var%20atts%20%3D%20stream.string.substring(1%2Cstream.string.indexOf(%22%3E%22))%3B%0A%20%20%20%20%20%20%20%20if%20(%2Fmarkdown%5Cs*%3D%5Cs*('%7C%22)%7B0%2C1%7D1('%7C%22)%7B0%2C1%7D%2F.test(atts))%20%7B%0A%20%20%20%20%20%20%20%20%20%20state.md_inside%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20stream.backUp(1)%3B%0A%20%20%20%20%20%20return%20switchBlock(stream%2C%20state%2C%20htmlBlock)%3B%0A%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20if%20(ch%20%3D%3D%3D%20'%3C'%20%26%26%20stream.match(%2F%5E%5C%2F%5Cw*%3F%3E%2F))%20%7B%0A%20%20%20%20%20%20state.md_inside%20%3D%20false%3B%0A%20%20%20%20%20%20return%20%22tag%22%3B%0A%20%20%20%20%7D%0A%20%20%20%20%20%20%0A%20%20%20%20var%20t%20%3D%20getType(state)%3B%0A%20%20%20%20if%20(ch%20%3D%3D%3D%20'*'%20%7C%7C%20ch%20%3D%3D%3D%20'_')%20%7B%0A%20%20%20%20%20%20if%20(state.strong%20%3D%3D%3D%20ch%20%26%26%20stream.eat(ch))%20%7B%20%2F%2F%20Remove%20STRONG%0A%20%20%20%20%20%20%20%20state.strong%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20return%20t%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(!state.strong%20%26%26%20stream.eat(ch))%20%7B%20%2F%2F%20Add%20STRONG%0A%20%20%20%20%20%20%20%20state.strong%20%3D%20ch%3B%0A%20%20%20%20%20%20%20%20return%20getType(state)%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(state.em%20%3D%3D%3D%20ch)%20%7B%20%2F%2F%20Remove%20EM%0A%20%20%20%20%20%20%20%20state.em%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20return%20t%3B%0A%20%20%20%20%20%20%7D%20else%20if%20(!state.em)%20%7B%20%2F%2F%20Add%20EM%0A%20%20%20%20%20%20%20%20state.em%20%3D%20ch%3B%0A%20%20%20%20%20%20%20%20return%20getType(state)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%20else%20if%20(ch%20%3D%3D%3D%20'%20')%20%7B%0A%20%20%20%20%20%20if%20(stream.eat('*')%20%7C%7C%20stream.eat('_'))%20%7B%20%2F%2F%20Probably%20surrounded%20by%20spaces%0A%20%20%20%20%20%20%20%20if%20(stream.peek()%20%3D%3D%3D%20'%20')%20%7B%20%2F%2F%20Surrounded%20by%20spaces%2C%20ignore%0A%20%20%20%20%20%20%20%20%20%20return%20getType(state)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%20%2F%2F%20Not%20surrounded%20by%20spaces%2C%20back%20up%20pointer%0A%20%20%20%20%20%20%20%20%20%20stream.backUp(1)%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20return%20getType(state)%3B%0A%20%20%7D%0A%0A%20%20function%20linkText(stream%2C%20state)%20%7B%0A%20%20%20%20while%20(!stream.eol())%20%7B%0A%20%20%20%20%20%20var%20ch%20%3D%20stream.next()%3B%0A%20%20%20%20%20%20if%20(ch%20%3D%3D%3D%20'%5C%5C')%20stream.next()%3B%0A%20%20%20%20%20%20if%20(ch%20%3D%3D%3D%20'%5D')%20%7B%0A%20%20%20%20%20%20%20%20state.inline%20%3D%20state.f%20%3D%20linkHref%3B%0A%20%20%20%20%20%20%20%20return%20linktext%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20return%20linktext%3B%0A%20%20%7D%0A%0A%20%20function%20linkHref(stream%2C%20state)%20%7B%0A%20%20%20%20%2F%2F%20Check%20if%20space%2C%20and%20return%20NULL%20if%20so%20(to%20avoid%20marking%20the%20space)%0A%20%20%20%20if(stream.eatSpace())%7B%0A%20%20%20%20%20%20return%20null%3B%0A%20%20%20%20%7D%0A%20%20%20%20var%20ch%20%3D%20stream.next()%3B%0A%20%20%20%20if%20(ch%20%3D%3D%3D%20'('%20%7C%7C%20ch%20%3D%3D%3D%20'%5B')%20%7B%0A%20%20%20%20%20%20return%20switchInline(stream%2C%20state%2C%20inlineElement(linkhref%2C%20ch%20%3D%3D%3D%20'('%20%3F%20')'%20%3A%20'%5D'))%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20'error'%3B%0A%20%20%7D%0A%0A%20%20function%20footnoteLink(stream%2C%20state)%20%7B%0A%20%20%20%20if%20(stream.match(%2F%5E%5B%5E%5C%5D%5D*%5C%5D%3A%2F%2C%20true))%20%7B%0A%20%20%20%20%20%20state.f%20%3D%20footnoteUrl%3B%0A%20%20%20%20%20%20return%20linktext%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20switchInline(stream%2C%20state%2C%20inlineNormal)%3B%0A%20%20%7D%0A%0A%20%20function%20footnoteUrl(stream%2C%20state)%20%7B%0A%20%20%20%20%2F%2F%20Check%20if%20space%2C%20and%20return%20NULL%20if%20so%20(to%20avoid%20marking%20the%20space)%0A%20%20%20%20if(stream.eatSpace())%7B%0A%20%20%20%20%20%20return%20null%3B%0A%20%20%20%20%7D%0A%20%20%20%20%2F%2F%20Match%20URL%0A%20%20%20%20stream.match(%2F%5E%5B%5E%5Cs%5D%2B%2F%2C%20true)%3B%0A%20%20%20%20%2F%2F%20Check%20for%20link%20title%0A%20%20%20%20if%20(stream.peek()%20%3D%3D%3D%20undefined)%20%7B%20%2F%2F%20End%20of%20line%2C%20set%20flag%20to%20check%20next%20line%0A%20%20%20%20%20%20state.linkTitle%20%3D%20true%3B%0A%20%20%20%20%7D%20else%20%7B%20%2F%2F%20More%20content%20on%20line%2C%20check%20if%20link%20title%0A%20%20%20%20%20%20stream.match(%2F%5E(%3F%3A%5Cs%2B(%3F%3A%22(%3F%3A%5B%5E%22%5C%5C%5D%7C%5C%5C%5C%5C%7C%5C%5C.)%2B%22%7C'(%3F%3A%5B%5E'%5C%5C%5D%7C%5C%5C%5C%5C%7C%5C%5C.)%2B'%7C%5C((%3F%3A%5B%5E)%5C%5C%5D%7C%5C%5C%5C%5C%7C%5C%5C.)%2B%5C)))%3F%2F%2C%20true)%3B%0A%20%20%20%20%7D%0A%20%20%20%20state.f%20%3D%20state.inline%20%3D%20inlineNormal%3B%0A%20%20%20%20return%20linkhref%3B%0A%20%20%7D%0A%0A%20%20function%20inlineRE(endChar)%20%7B%0A%20%20%20%20if%20(!inlineRE%5BendChar%5D)%20%7B%0A%20%20%20%20%20%20%2F%2F%20Escape%20endChar%20for%20RegExp%20(taken%20from%20http%3A%2F%2Fstackoverflow.com%2Fa%2F494122%2F526741)%0A%20%20%20%20%20%20endChar%20%3D%20(endChar%2B'').replace(%2F(%5B.%3F*%2B%5E%24%5B%5C%5D%5C%5C()%7B%7D%7C-%5D)%2Fg%2C%20%22%5C%5C%241%22)%3B%0A%20%20%20%20%20%20%2F%2F%20Match%20any%20non-endChar%2C%20escaped%20character%2C%20as%20well%20as%20the%20closing%20%0A%20%20%20%20%20%20%2F%2F%20endChar.%0A%20%20%20%20%20%20inlineRE%5BendChar%5D%20%3D%20new%20RegExp('%5E(%3F%3A%5B%5E%5C%5C%5C%5C%5D%2B%3F%7C%5C%5C%5C%5C.)*%3F('%20%2B%20endChar%20%2B%20')')%3B%0A%20%20%20%20%7D%0A%20%20%20%20return%20inlineRE%5BendChar%5D%3B%0A%20%20%7D%0A%0A%20%20function%20inlineElement(type%2C%20endChar%2C%20next)%20%7B%0A%20%20%20%20next%20%3D%20next%20%7C%7C%20inlineNormal%3B%0A%20%20%20%20return%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20stream.match(inlineRE(endChar))%3B%0A%20%20%20%20%20%20state.inline%20%3D%20state.f%20%3D%20next%3B%0A%20%20%20%20%20%20return%20type%3B%0A%20%20%20%20%7D%3B%0A%20%20%7D%0A%0A%20%20return%20%7B%0A%20%20%20%20startState%3A%20function()%20%7B%0A%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20f%3A%20blockNormal%2C%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20block%3A%20blockNormal%2C%0A%20%20%20%20%20%20%20%20htmlState%3A%20CodeMirror.startState(htmlMode)%2C%0A%20%20%20%20%20%20%20%20indentation%3A%200%2C%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20inline%3A%20inlineNormal%2C%0A%20%20%20%20%20%20%20%20text%3A%20handleText%2C%0A%20%20%20%20%20%20%20%20linkTitle%3A%20false%2C%0A%20%20%20%20%20%20%20%20em%3A%20false%2C%0A%20%20%20%20%20%20%20%20strong%3A%20false%2C%0A%20%20%20%20%20%20%20%20header%3A%20false%2C%0A%20%20%20%20%20%20%20%20list%3A%20false%2C%0A%20%20%20%20%20%20%20%20quote%3A%20false%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20copyState%3A%20function(s)%20%7B%0A%20%20%20%20%20%20return%20%7B%0A%20%20%20%20%20%20%20%20f%3A%20s.f%2C%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20block%3A%20s.block%2C%0A%20%20%20%20%20%20%20%20htmlState%3A%20CodeMirror.copyState(htmlMode%2C%20s.htmlState)%2C%0A%20%20%20%20%20%20%20%20indentation%3A%20s.indentation%2C%0A%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20inline%3A%20s.inline%2C%0A%20%20%20%20%20%20%20%20text%3A%20s.text%2C%0A%20%20%20%20%20%20%20%20linkTitle%3A%20s.linkTitle%2C%0A%20%20%20%20%20%20%20%20em%3A%20s.em%2C%0A%20%20%20%20%20%20%20%20strong%3A%20s.strong%2C%0A%20%20%20%20%20%20%20%20header%3A%20s.header%2C%0A%20%20%20%20%20%20%20%20list%3A%20s.list%2C%0A%20%20%20%20%20%20%20%20quote%3A%20s.quote%2C%0A%20%20%20%20%20%20%20%20md_inside%3A%20s.md_inside%0A%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20token%3A%20function(stream%2C%20state)%20%7B%0A%20%20%20%20%20%20if%20(stream.sol())%20%7B%0A%20%20%20%20%20%20%20%20if%20(stream.match(%2F%5E%5Cs*%24%2F%2C%20true))%20%7B%0A%20%20%20%20%20%20%20%20%20%20prevLineHasContent%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20return%20blankLine(state)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20if(thisLineHasContent)%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20prevLineHasContent%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20thisLineHasContent%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20thisLineHasContent%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%7D%0A%0A%20%20%20%20%20%20%20%20%2F%2F%20Reset%20state.header%0A%20%20%20%20%20%20%20%20state.header%20%3D%20false%3B%0A%0A%20%20%20%20%20%20%20%20state.f%20%3D%20state.block%3B%0A%20%20%20%20%20%20%20%20var%20indentation%20%3D%20stream.match(%2F%5E%5Cs*%2F%2C%20true)%5B0%5D.replace(%2F%5Ct%2Fg%2C%20'%20%20%20%20').length%3B%0A%20%20%20%20%20%20%20%20state.indentationDiff%20%3D%20indentation%20-%20state.indentation%3B%0A%20%20%20%20%20%20%20%20state.indentation%20%3D%20indentation%3B%0A%20%20%20%20%20%20%20%20if%20(indentation%20%3E%200)%20%7B%20return%20null%3B%20%7D%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20return%20state.f(stream%2C%20state)%3B%0A%20%20%20%20%7D%2C%0A%0A%20%20%20%20blankLine%3A%20blankLine%2C%0A%0A%20%20%20%20getType%3A%20getType%0A%20%20%7D%3B%0A%0A%7D%2C%20%22xml%22)%3B%0A%0ACodeMirror.defineMIME(%22text%2Fx-markdown%22%2C%20%22markdown%22)%3B%0A%20%20%20%20%3C%2Fscript%3E%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%3C%2Fhead%3E%0A%20%20%3Cbody%3E%0A%20%20%20%20%3Cdiv%20id%3D%22editor%22%3E%3C%2Fdiv%3E%0A%20%20%20%20%3Cp%3E%0A%20%20%20%20%20%20Local%3A%0A%20%20%20%20%20%20%3Cinput%20type%3D%22file%22%20onchange%3D%22localLoad(this.files)%3B%22%20%2F%3E%0A%20%20%20%20%20%20%3Cinput%20type%3D%22submit%22%20value%3D%22save%22%20onclick%3D%22window.open(localSave())%3B%22%3E%0A%20%20%20%20%20%20%7C%0A%20%20%20%20%20%20%3Cinput%20type%3D%22submit%22%20value%3D%22js%22%20onclick%3D%22myCodeMirror.setOption('mode'%2C%20'javascript')%3B%22%3E%0A%20%20%20%20%20%20%3Cinput%20type%3D%22submit%22%20value%3D%22html%22%20onclick%3D%22myCodeMirror.setOption('mode'%2C%20'htmlmixed')%3B%22%3E%0A%20%20%20%20%20%20%3Cinput%20type%3D%22submit%22%20value%3D%22markdown%22%20onclick%3D%22myCodeMirror.setOption('mode'%2C%20'markdown')%3B%22%3E%0A%20%20%20%20%3C%2Fp%3E%0A%20%0A%20%20%3C%2Fbody%3E%0A%20%20%3Cscript%3E%0A%20%20%20%20%0A%20%20%20%20%2F%2FCODE%20MIRROR%0A%20%20%20%20var%20myCodeMirror%20%3D%20CodeMirror(document.getElementById('editor')%2C%20%7B%0A%20%20%20%20%20%20lineNumbers%3A%20true%0A%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%2F%2FLOCAL%0A%20%20%20%20function%20localSave()%20%7B%0A%20%20%20%20%20%20return%20'data%3Atext%2Fplain%3Bcharset%3Dutf-8%2C'%2BencodeURIComponent(myCodeMirror.getValue())%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20function%20localLoad(files)%20%7B%0A%20%20%20%20%20%20if(files.length%20%3D%3D%201)%20%7B%0A%20%20%20%20%20%20%20%20document.title%3Descape(files%5B0%5D.name)%3B%0A%20%20%20%20%20%20%20%20var%20reader%20%3D%20new%20FileReader()%3B%0A%20%20%20%20%20%20%20%20reader.onload%20%3D%20function(e)%20%7B%0A%20%20%20%20%20%20%20%20%20%20myCodeMirror.setValue(e.target.result)%3B%0A%20%20%20%20%20%20%20%20%7D%3B%0A%20%20%20%20%20%20%20%20reader.readAsText(files%5B0%5D)%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%3C%2Fscript%3E%0A%3C%2Fhtml%3E"
        target="_blank">unhosted editor</a>. So by bookmarking that, or saving it to your filesystem, you will always be able to edit files in your
        browser, whether online or offline. I am using this editor right now to write this blogpost, and I will use it to write all other apps, scripts and
        texts that
        come up in the coming weeks. It is a good idea to save one working version which you don't touch, so that if you break your editor while editing it,
        you have
        a way to bootstrap back into your editor-editing world. :)</p>
      <p>That's it for this week. We have created the first unhosted web app of this blog series, and we will be using it as the development environment
        to create
        all other apps, as well as all server-side scripts in the coming episodes. I hope you liked it. If you did, then please share it with your
        friends and followers. Next week we'll  discuss how to set up your own personal server.</p>
<p><a href="https://groups.google.com/d/topic/unhosted/ANz3ofSyfmc/discussion">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-3" "id="#episode-3" href="#episode-3">3.</a> Setting up your personal server</h2>

      <p>(<a href="http://unhosted.bencharp.com/page/3-serveur,3.html">en Fran&#231;ais</a>)</p>
      <h3>Why you need a server</h3>
      <p>Last week we created an unhosted javascript/html/markdown editor that can run on a data URL, create other apps as data URLs,
        load files from the local file system, and also save them again. This doesn't however allow us to
        communicate with other devices, nor with other users, let alone people in other "web 2.0 worlds". At some point we
        will want to send and receive emails and chat messages, so to do those thing with an unhosted web app, we need a sort
        of proxy server.</p>
      <p>There are three important restrictions of unhosted web apps compared to hosted web apps:</p>
      <ul>
        <li>they are not addressable from the outside. Even if your device has its own static IP address, the application instance
          (for instance the editor we created last week) is running in one of the tabs of one of your browsers, and does not have
          the possibility to open any ports that listen externally on the internet address of your device.</li>
        <li>the data they store is emprisoned in one specific device, which is not practical if you use multiple devices, or if your device
          is damaged, lost or stolen.</li>
        <li>they cannot run when you have your device switched off, and cannot receive data when your device is not online, or
          on a low-bandwidth connection.</li>
      </ul>
      <p>For these reasons, you cannot run your online life from unhosted web apps alone. You will need a personal server on the web.
        To run your own personal server on the web, there are initially four components you need to procure:</p>
      <ul>
        <li>a virtual private server (VPS),</li>
        <li>a domain name registration (DNR),</li>
        <li>a zone record at a domain name service (DNS), and</li>
        <li>a secure server certificate (TLS).</li>
      </ul>
      
      <h3>Shopping for the bits and bobs</h3>
      <p>The VPS is the most expensive one, and will cost you about 15 US dollars a month from for instance Rackspace. The domain name will cost you
        about 10 US dollars per year from for instance Gandi, and the TLS certificate you can get for
        free from StartCom, or for very little money from other suppliers as well. You could in theory set up your DNS hosting on your VPS, but
        usually your domain name registration will include free DNS hosting.</p>
      <p>Unless you already have a domain name, you need to make an important choice at this point, namely choosing the domain name that will become
        your personal identity on the web. Most people have the same username in different web 2.0 worlds, for instance I often use 'michielbdejong'.
        When I decided it was time for me to create my own Indie Web presence, and went looking for a domain name a few months ago, 'michielbdejong.com'
        was still free, so I picked that. Likewise, you can probably find some domain name that is in some way related to usernames you already use
        elsewhere.</p>
      <p>I registered my TLS certificate for 'apps.michielbdejong.com' because I aim to run an apps dashboard on there at some point, but you could
        also go for 'www.' or 'blog.' or whichever subdomain tickles your fancy.
        In any case, you get one subdomain plus the root domain for free, plus as many extra origins as you want on ports other than 443.
        So you cannot create endless subdomains, but you can host different kinds of content in subdirectories (like this blog that is hosted on
        /adventures on the root domain of unhosted.org), and you can get for instance
        <a href="https://michielbdejong.com:10001/">https://michielbdejong.com:10001/</a> as an isolated javascript
        origin that will work on the same IP address and TLS certificate.</p>
      <p><em><strong>No Cookie Crew - Warning #1:</strong>
        Last week's tutorial could be followed entirely with cookies disabled. I am probably still the only person in the world who has all cookies
        disabled, but in case readers of this blog want to join the "No Cookie Crew", I will start indicating clearly where violations are required.
        Although Rackspace worked without cookies at the time of writing (they used URL-based sessions over https at the time, not anymore), StartCom uses client-side certificates in their wizard and
        other services are also likely to require you to white-list their cookies. In any case, you need to acquire three actual products here, which means you
        will need to white-list cookies from second-party e-commerce applications, and also corresponding control-panel applications which are hosted by each vendor.
        So that in itself is not a violation, but you will also probably need to use some desktop or hosted application to confirm your email address
        while signing up, and you will need something like an ssh and scp client for the next steps.</em></p>

      <h3>First run</h3>
      <p>Once you have your server running, point your domain name to it, and upload your TLS certificate to it. The first thing you always want to do
        when you ssh into a new server is to update it. On Debian this is done by typing:</p><pre><code>
apt-get update
apt-get upgrade
</code></pre>
      <p>There are several ways to run a
        server, but here we will use <a href="http://nodejs.org">nodejs</a>, because it's fun and powerful. So follow the instructions on the nodejs
        website to
        install it onto your server. Nodejs comes with the 'node' executable that lets you execute javascript programs, as well as the 'npm' package
        manager, that gives you access to a whole universe of very useful high-quality libraries.</p>
        
      <h3>Your webserver</h3>
      <p>Once you have node working, you can use the example from the
        <a href="http://docs.nodejitsu.com/articles/HTTP/servers/how-to-serve-static-files">nodejitsu docs</a>
        to set up your website; adapted here to make it serve your website over https:</p><pre><code>
var static = require('node-static'),
    http = require('http'),
    https = require('https'),
    fs = require('fs'),
    config = {
      contentDir: '/var/www',
      tlsDir: '/root/tls'
    };

http.createServer(function(req, res) {
  var domain = req.headers.host;
  req.on('end', function() {
    res.writeHead(302, {
      Location: 'https://'+domain+'/'+req.url.substring(1),
        'Access-Control-Allow-Origin': '*'
      });
    res.end('Location: https://'+domain+'/'+req.url.substring(1));
  });
}).listen(80);

var file = new(static.Server)(config.contentDir, {
  headers: {
    'Access-Control-Allow-Origin': '*'
  }
});

https.createServer({
  key: fs.readFileSync(config.tlsDir+'/tls.key'),
  cert: fs.readFileSync(config.tlsDir+'/tls.cert'),
  ca: fs.readFileSync(config.tlsDir+'/ca.pem')
}, function(req, res) {
  file.serve(req, res);
}).listen(443);
</code></pre>
      <p>Here, tls.key and tls.cert are the secret and public parts of your TLS certificate, and
        the ca.pem is an extra <a href="http://www.startssl.com/certs/sub.class1.server.ca.pem">StartCom chain certificate</a>
        that you <a href="https://www.startssl.com/?app=20">will need</a> if you use a StartCom certificate.</p>
      <p>Note that we also set up an http website, that redirects to your https website, and we have added
        <a href="http://enable-cors.org/">CORS headers</a> everywhere, to do our bit in helping break down the web's "Same Origin" walls.</p>
      <h3>Using 'forever' to start and stop server processes</h3>
      <p>Now that you have a script for a http server and a https server, upload them to your server, and then run:</p><pre><code>
npm install  node-static
npm install -g forever
forever start path/to/myWebServer.js
forever list
</pre></code>
      <p>If all went well, you will now have a new log file in ~/.forever/. Whenever it gets too long, you can issue 'echo > ~/.forever/abcd.log'
        to truncate the log of forever process 'abcd'.</p>
      <p>You can test that your http server redirects to your https website, and you can add some basic placeholder information to the data directory, or copy and paste
        your profile page from one of your existing web 2.0 identities onto there.</p>

      <h3>File sharing</h3>
      <p>One advantage of having your own website with support for TLS is that you can host files for other people there, and as long as your web server does
        not provide a way to find the file without knowing its URL, only people who know or guess a file's link, and people who have access to your server,
        will be able to retrieve the file. This includes employees of your VPS providers, as well as employees of any governments who exert power over that
        provider.</p>
      <p>In theory, employees of your TLS certificate provider can also get access if they have man-in-the-middle access to your TCP traffic or
        on that of the person retrieving the file, or if they manage to poison DNS for your domain name, but that seem very remote possibilities,
        so if you trust your VPS provider and its government, or you host your server under your own physical control, and you have a good way to generate
        a URL that nobody will guess, then this is a pretty feasible way to
        send a file to someone. If you implement it without bugs, then it would be more secure than standard unencrypted email, for instance.</p>
      <p>In the other direction, you can also let other people send files to you; just run something like the following script on your server:</p>
      <pre><code>
var https = require('https'),
    fs = require('fs'),
    config = {
      tlsDir: '/root/tls',
      uploadDir: '/root/uploads',
      port: 3000
    },
    formidable = require('formidable'),
    

https.createServer({
  key: fs.readFileSync(config.tlsDir+'/tls.key'),
  cert: fs.readFileSync(config.tlsDir+'/tls.cert'),
  ca: fs.readFileSync(config.tlsDir+'/ca.pem')
}, function(req, res) {
  var form = new formidable.IncomingForm();
  form.uploadDir = config.uploadDir;
  form.parse(req, function(err, fields, files) {
    res.writeHead(200, {'content-type': 'text/plain'});
    res.end('upload received, thank you!\n');
  });
}).listen(config.port);
</code></pre>
      <p>and allow people to post files to it with an html form like this:<pre><code>
&lt;form action="https://example.com:3000/"
    enctype="multipart/form-data" method="post">
  &lt;input type="file" name="datafile" size="40">
  &lt;input type="submit" value="Send">
&lt;/form>
</code></pre>

      <h3>Indie Web</h3>
      <p>If you followed this episode, then you will have spent maybe 10 or 20 dollars, and probably about one working day working out how to fit all
        the pieces together and get it working, but you will have made a big leap in terms of your technological freedom: you are now a member of the
        "Indie Web" - the small guard of people who run their own webserver, independently from any big platforms. It's a bit like musicians who publish
        their own vinyls on small independent record labels. :) And it's definitely something you can be proud of. Now that it's up and running, add some
        nice pages to your website by simply uploading html files to your server.</p>
      <p>From now on you will need your personal server in pretty much all
        coming episodes. For instance, next week we will explore a young but very powerful web technology, which will form an important basis for all
        communications between your personal server and the unhosted web apps you will be developing: WebSockets. And the week after that, we will
        connect your Indie Web server to Facebook and Twitter... exciting! :) Stay tuned, follow us, and spread the word:
        <a href="/adventures/feed.atom">atom</a>,
        <a href="https://groups.google.com/forum/#!forum/unhosted">mailing list</a>,
        <a href="http://webchat.freenode.net/?channels=#unhosted">irc channel</a>,
        <a href="https://twitter.com/unhosted">twitter</a>,
        <a href="https://facebook.com/unhostedwebapps">facebook</a></p>
<p><a href="https://groups.google.com/d/topic/unhosted/xUDoVNa21og/discussion">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-4" "id="#episode-4" href="#episode-4">4.</a> WebSockets</h2>

      <p>(<a href="http://unhosted.bencharp.com/page/4-websockets,4.html">en Fran&#231;ais</a>)</p>
      <p><em><strong>No Cookie Crew  - Warning #2:</strong> For this tutorial you will need to update your personal server using an ssh/scp client.</em></p>
        
      <p>WebSockets are a great way to get fast two-way communication working between your unhosted web app and your personal server.
        It seems the best server-side WebSocket support, at least under nodejs, comes from SockJS (but <a href="http://stackoverflow.com/questions/22134061/engine-io-or-sockjs-which-one-to-choose">see also engine.io</a>). Try installing this nodejs
        script:</p><pre><code>
var sockjs = require('sockjs'),
    fs = require('fs'),
    https = require('https'),
    config = require('./config.js').config;

function handle(conn, chunk) {
  conn.write(chunk);
}

var httpsServer = https.createServer({ 
  key: fs.readFileSync(config.tlsDir+'/tls.key'), 
  cert: fs.readFileSync(config.tlsDir+'/tls.cert'), 
  ca: fs.readFileSync(config.tlsDir+'/ca.pem') 
}, function(req, res) {
  res.writeHead(200); 
  res.end('connect a WebSocket please'); 
});
httpsServer.listen(config.port);

var sockServer = sockjs.createServer();
sockServer.on('connection', function(conn) {
  conn.on('data', function(chunk) {
    handle(conn, chunk);
  });
});
sockServer.installHandlers(httpsServer, {
  prefix:'/sock'
});
console.log('Running on port '+config.port);
</code></pre>
      <p>and accompany it by a 'config.js' file in the same directory, like this:</p><pre><code>
exports.config = {
  tlsDir: '/path/to/tls',
  port: 1234
};
</code></pre>
      <p>Start this script with either 'node script.js' or 'forever start script.js', and open this unhosted web app
        in your browser:</p><pre><code>
&lt;!DOCTYPE html lang="en">
&lt;html>
  &lt;head>
    &lt;meta charset="utf-8">
    &lt;title>pinger&lt;/title>
  &lt;/head>
  &lt;body>
    &lt;p>
      Ping stats for wss://
      &lt;input id="SockJSHost" value="example.com:1234" >
      /sock/websocket
      &lt;input type="submit" value="reconnect"
        onclick="sock.close();" >
    &lt;/p>
    &lt;canvas id="myCanvas" width="1000" height="1000">&lt;/canvas>
  &lt;/body>
  &lt;script>
    var sock,
        graph = document.getElementById('myCanvas')
          .getContext('2d');
      
    function draw(time, rtt, colour) {
      var x = (time % 1000000) / 1000;//one pixel per second
      graph.beginPath();
      graph.moveTo(x, 0);
      graph.lineTo(x, rtt/10);//1000px height = 10s
      graph.strokeStyle = colour;
      graph.stroke();
      graph.fillStyle = '#eee';
      graph.rect(x, 0, 100, 1000);
      graph.fill();
    }
    
    function connect() {
      sock = new WebSocket('wss://'
        +document.getElementById('SockJSHost').value
        +'/sock/websocket');
 
      sock.onopen = function() {
        draw(new Date().getTime(), 10000, 'green');
      }
    
      sock.onmessage = function(e) {
        var sentTime = parseInt(e.data);
        var now = new Date().getTime();
        var roundTripTime = now - sentTime;
        draw(sentTime, roundTripTime, 'black');
      }
 
      sock.onclose = function() {
        draw(new Date().getTime(), 10000, 'red');
      }
    }
    connect();
    
    setInterval(function() {
      var now = new Date().getTime();
      if(sock.readyState==WebSocket.CONNECTING) {
        draw(now, 10, 'green');
      } else if(sock.readyState==WebSocket.OPEN) {
        sock.send(now);
        draw(now, 10, 'blue');
      } else if(sock.readyState==WebSocket.CLOSING) {
        draw(now, 10, 'orange');
      } else {//CLOSED or non-existent
        draw(now, 10, 'red');
        connect();
      }
    }, 1000);
  &lt;/script>
&lt;/html>
</code></pre>
      <p>Here is a <a href="data:text/html;charset=utf-8,%3C!DOCTYPE%20html%20lang%3D%22en%22%3E%0A%3Chtml%3E%0A%20%20%3Chead%3E%0A%20%20%20%20%3Cmeta%20charset%3D%22utf-8%22%3E%0A%20%20%20%20%3Ctitle%3Epinger%3C%2Ftitle%3E%0A%20%20%3C%2Fhead%3E%0A%20%20%3Cbody%3E%0A%20%20%20%20%3Cp%3E%0A%20%20%20%20%20%20Ping%20stats%20for%20wss%3A%2F%2F%0A%20%20%20%20%20%20%3Cinput%20id%3D%22SockJSHost%22%20value%3D%22example.com%3A1234%22%20%3E%0A%20%20%20%20%20%20%2Fsock%2Fwebsocket%0A%20%20%20%20%20%20%3Cinput%20type%3D%22submit%22%20value%3D%22reconnect%22%0A%20%20%20%20%20%20%20%20onclick%3D%22sock.close()%3B%22%20%3E%0A%20%20%20%20%3C%2Fp%3E%0A%20%20%20%20%3Ccanvas%20id%3D%22myCanvas%22%20width%3D%221000%22%20height%3D%221000%22%3E%26lt%3B%2Fcanvas%3E%0A%20%20%3C%2Fbody%3E%0A%20%20%3Cscript%3E%0A%20%20%20%20var%20sock%2C%0A%20%20%20%20%20%20%20%20graph%20%3D%20document.getElementById('myCanvas')%0A%20%20%20%20%20%20%20%20%20%20.getContext('2d')%3B%0A%20%20%20%20%20%20%0A%20%20%20%20function%20draw(time%2C%20rtt%2C%20colour)%20%7B%0A%20%20%20%20%20%20var%20x%20%3D%20(time%20%25%201000000)%20%2F%201000%3B%2F%2Fone%20pixel%20per%20second%0A%20%20%20%20%20%20graph.beginPath()%3B%0A%20%20%20%20%20%20graph.moveTo(x%2C%200)%3B%0A%20%20%20%20%20%20graph.lineTo(x%2C%20rtt%2F10)%3B%2F%2F1000px%20height%20%3D%2010s%0A%20%20%20%20%20%20graph.strokeStyle%20%3D%20colour%3B%0A%20%20%20%20%20%20graph.stroke()%3B%0A%20%20%20%20%20%20graph.fillStyle%20%3D%20'%23eee'%3B%0A%20%20%20%20%20%20graph.rect(x%2C%200%2C%20100%2C%201000)%3B%0A%20%20%20%20%20%20graph.fill()%3B%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20function%20connect()%20%7B%0A%20%20%20%20%20%20sock%20%3D%20new%20WebSocket('wss%3A%2F%2F'%0A%20%20%20%20%20%20%20%20%2Bdocument.getElementById('SockJSHost').value%0A%20%20%20%20%20%20%20%20%2B'%2Fsock%2Fwebsocket')%3B%0A%20%0A%20%20%20%20%20%20sock.onopen%20%3D%20function()%20%7B%0A%20%20%20%20%20%20%20%20draw(new%20Date().getTime()%2C%2010000%2C%20'green')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%20%20sock.onmessage%20%3D%20function(e)%20%7B%0A%20%20%20%20%20%20%20%20var%20sentTime%20%3D%20parseInt(e.data)%3B%0A%20%20%20%20%20%20%20%20var%20now%20%3D%20new%20Date().getTime()%3B%0A%20%20%20%20%20%20%20%20var%20roundTripTime%20%3D%20now%20-%20sentTime%3B%0A%20%20%20%20%20%20%20%20draw(sentTime%2C%20roundTripTime%2C%20'black')%3B%0A%20%20%20%20%20%20%7D%0A%20%0A%20%20%20%20%20%20sock.onclose%20%3D%20function()%20%7B%0A%20%20%20%20%20%20%20%20draw(new%20Date().getTime()%2C%2010000%2C%20'red')%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20connect()%3B%0A%20%20%20%20%0A%20%20%20%20setInterval(function()%20%7B%0A%20%20%20%20%20%20var%20now%20%3D%20new%20Date().getTime()%3B%0A%20%20%20%20%20%20if(sock.readyState%3D%3DWebSocket.CONNECTING)%20%7B%0A%20%20%20%20%20%20%20%20draw(now%2C%2010%2C%20'green')%3B%0A%20%20%20%20%20%20%7D%20else%20if(sock.readyState%3D%3DWebSocket.OPEN)%20%7B%0A%20%20%20%20%20%20%20%20sock.send(now)%3B%0A%20%20%20%20%20%20%20%20draw(now%2C%2010%2C%20'blue')%3B%0A%20%20%20%20%20%20%7D%20else%20if(sock.readyState%3D%3DWebSocket.CLOSING)%20%7B%0A%20%20%20%20%20%20%20%20draw(now%2C%2010%2C%20'orange')%3B%0A%20%20%20%20%20%20%7D%20else%20%7B%2F%2FCLOSED%20or%20non-existent%0A%20%20%20%20%20%20%20%20draw(now%2C%2010%2C%20'red')%3B%0A%20%20%20%20%20%20%20%20connect()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%201000)%3B%0A%20%3C%2Fscript%3E%0A%3C%2Fhtml%3E"
        target="_blank">data URL</a> for it.
        Open it, replace 'example.com:1234' with your own server name and leave it running for a while. It  will ping your
        server once a second on the indicated port,
        and graph the round-trip time. It should look something like this:</p>
        <img src="pinger-example.png"/>
      <p>I have quite unreliable wifi at the place I'm staying now, and even so you see that most packets eventually arrive,
        although some take more than 10 seconds to do so. Some notes about this:</p>
        <ul>
          <li>The client uses the bare WebSocket exposed by the SockJS server, so that we do not need their client-side library,
            and mainly because on a connection as slow as mine, it would keep falling back to long-polling, whereas I know my
            browser supports WebSockets, so I do not need that backdrop.</li>
          <li>I spent a lot of time writing code that tries to detect when something goes wrong. I experimented with suspending my
            laptop while wifi was down, then restarting the server-side, and seeing if it could recover. My findings are that it
            often still recovers, unless it goes into readyState 3 (<code>WebSocket.CLOSED</code>).
            Whenever this happens, I think you will lose any data that was queued on both client-side and server-side, so make sure
            you have ways of resending that. Also make sure you discard the closed WebSocket object and open up a new one.</li>
          <li>The WebSocket will time out after 10 minutes of loss of connectivity, and then try to reconnect. In Firefox it does this with a beautiful
            exponential backoff. The reconnection frequency slows down until it reaches a frequency of once a minute.</li>
          <li>When you have suspended your device (e.g. closed the lid of your laptop) and come back, you will see it flatlining in blue.
            Presumably it would do another dis- and reconnect if you wait long enough, but due to the exponential backoff, you would probably
            need to wait up to a minute before Firefox attempts reconnection.
            So to speed this up, you can click 'Reconnect'. The line in the graph
            will go purple (you will see 'sock.readyState' went from 1 (open) to 2 (closing), and a few seconds later it will dis- and reconnect
            and you are good again. We could probably trigger this automatically, but for now it's good enough.</li>
          <li>There is another important failure situation; my explanation is that this happens when the server closes the connection, but is not
            able to let the client know about this, due to excessive packet loss. The client will keep waiting for a sign of life from the server,
            but presumably the server has already given up on the client. I call this "flatlining" because it looks like a flat line in my ping graph.
            Whenever this happens, if you know that the packet loss problem was just resolved, it is necessary to 
            reconnect. It will take a few seconds for the socket to close (purple line in the graph), but as soon as it closes and reopens,
            everything is good again. The client will probably always do this after 10 minutes, but you can speed things up this way. This is probably
            something that can be automated - a script could start polling /sock/info with XHR, and if there is an http response from there, but the 
            WebSocket is not recovering, presumably it is better to close and reopen.</li>
          <li>Chrome and Safari, as opposed to Firefox, do not do the exponential backoff, but keep the reconnection frequency right up. That means
            that in those browsers you probably never have to explicitly close the socket to force a reconnect.
            I did not try this in Explorer or Opera.</li>
          <li>Firefox on Ubuntu is not as good at detecting loss of connectivity as Firefox on OSX. This even means the WebSocket can get stuck in
            <code>WebSocket.CLOSING</code> state. In this case, you have to manually call <code>connect();</code> from the console, even though the existing WebSocket
            has not reached <code>WebSocket.CLOSED</code> state yet.
        </ul>
      <p>As another example, here's what disconnecting the wifi for 15 minutes looks like:</p>
        <img src="pinger-expbackoff.png"/>
      <p>And this is what "flatlining" looks like - the point where it goes purple is where I clicked "Reconnect".</p>
        <img src="flatlining.png"/>
        
      <p>All in all, WebSockets are a good, reliable way to connect your unhosted web app to your personal server. Next week, as promised, we will
        use a WebSocket for a Facebook and Twitter gateway running in nodejs. So stay tuned!</p>
<p><a href="https://groups.google.com/d/topic/unhosted/R_xyap_efWA/discussion">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-5" "id="#episode-5" href="#episode-5">5.</a> Facebook and Twitter from nodejs</h2>

      <p>(<a href="http://unhosted.bencharp.com/page/5-social,5.html">en Fran&#231;ais</a>)</p>
      <p><em><strong>No Cookie Crew  - Warning #3:</strong> This tutorial still requires you to update your personal server using an
        ssh/scp client.
        Also, to register your personal server with the respective APIs, you need to
        log in to Twitter and Facebook, accepting their cookies onto your device one last time...</em></p>
        
      <h3>Connecting to Facebook</h3>
      <p>Connecting to Facebook is easier than you might think. First, of course you need a Facebook account, so register one if you don't have one yet.
        Then you need to visit the <a href="https://developers.facebook.com/tools/explorer" target="_blank">Graph API Explorer</a>,
        and click 'Get Acces Token'. Log in as yourself, and click 'Get Access Token' a second time to get the dialog for requesting access scopes. In there,
        go to 'Extended Permissions', and select 'publish_stream'; it should look something like this:</p>
      <img src="fb-get-token.png">
      
      <p>The OAuth dance will ask you to grant Graph API Explorer access to your Facebook account, which obviously you have to allow for this to work.</p>
      <p>Once you are back on the Graph API Explorer, you can play around to browse the different kinds of data you can now access. You can also
        read more about this in <a href="https://developers.facebook.com/docs/getting-started/graphapi/">Facebook's Getting Started guide</a>.
        For instance, if you do a POST to /me/feed while adding a field "message" (click "Add a field") with some string value, that will post the message to your
        timeline.</p>
      <p>But the point here is
        to copy the token from the explorer tool, and save it in a config file on your personal server. Once you have done that, you can use the
        <code>http.Request</code>
        class from nodejs to make http calls to Facebook's API. Here is an example script that updates your status in your Facebook timeline:
        <pre><code>
var https = require('https'),
    config = require('./config').config;
    
function postToFacebook(str, cb) {
  var req = https.request({
    host: 'graph.facebook.com',
    path: '/me/feed',
    method: 'POST'
  }, function(res) {
    res.setEncoding('utf8');
    res.on('data', function(chunk) {
      console.log('got chunk '+chunk);
    });
    res.on('end', function() {
      console.log('response end with status '+res.status);
    });
  });
  req.end('message='+encodeURIComponent(str)
    +'&access_token='+encodeURIComponent(config.facebookToken));
  console.log('sent');
};

postToFacebook('test from my personal server');
</code></pre>
      
      <p>The result will look something like this:</p>
      <img src="fb-from-explorer.png">
      
      <p>If in the menu of the Graph API Explorer you click "apps" on the top right (while logged in as yourself), then you
        can define your own client app. The advantage of this is that it looks slightly nicer in the timeline, because you 
        can set the 'via' attribute to advertise your personal server's domain name, instead of the confusing and incorrect
        'via Graph API Explorer':</p>
      <img src="fb-from-app.png">
      
      <p>Normally, you would see the name of an actual application there, for instance 'via Foursquare' or 'via Spotify'.
        But since we are taking the application out of the server and putting it into the browser, and the access token is
        guarded by your personal server, not by the unhosted web app you may use to edit the text and issue the actual posting
        command, it is correct here to say that this post was posted via your personal server.</p>
      <p>This means that for everybody who federates their personal server with Facebook, there will effectively be one "Facebook
        client app", but each one will have only one user, because each user individually registers their own personal gateway server as such.</p>
      <p>There is a second advantage of registering your own app: it gives you an appId and a clientSecret with which you can exchange
        the one-hour token for a 60-day token. To do that, you can call the following nodejs function once, giving your appId, clientSecret, and 
        the short-lived token as arguments:</p><pre><code>
var https = require('https');

function longLiveMyToken(token, appId, clientSecret) {
  var req = https.request({
    host: 'graph.facebook.com',
    path: '/oauth/access_token',
    method: 'POST'
  }, function(res) {
    res.setEncoding('utf8');
    res.on('data', function(chunk) {
      console.log(chunk);
    });
    res.on('end', function() {
      console.log('status: '+res.status);
    });
  });
  req.end('grant_type=fb_exchange_token'
    +'&client_id='+encodeURIComponent(appId)
    +'&client_secret='+encodeURIComponent(clientSecret)
    +'&fb_exchange_token='+encodeURIComponent(token)
   );
};
</code></pre>
      <p>Once you run this script on your server, you will see the long-lived token on the console output, so you can paste it from there into
        your config file. You can also use the Graph API Browser to "Debug" access tokens - that way you see their permissions scope and 
        their time to live. As far as I know you will have to repeat this token exchanging process every 60 days, but maybe there is some way
        we could automate that. We will worry about that in two months from now. :)</p>

      <h3>Connecting to Twitter</h3>
      <p>And just because this is so easy in nodejs, here is the equivalent server-side script for twitter as well:</p>
        <pre><code>
var twitter = require('ntwitter'),
    config = require('./config').config;

var twit = new twitter({
  consumer_key: config.twitterConsumerKey,
  consumer_secret: config.twitterConsumerSecret,
  access_token_key: config.twitterAccessToken,
  access_token_secret: config.twitterAccessTokenSecret
});

function postToTwitter(str, cb) {
  twit.verifyCredentials(function (err, data) {
    if (err) {
      cb("Error verifying credentials: " + err);
    } else {
      twit.updateStatus(str, function (err, data) {
        if (err) {
          cb('Tweeting failed: ' + err);
        } else {
          cb('Success!')
        }
      });
    }
  });
}
postToTwitter('Sent from my personal server', function(result) {
  console.log(result);
}
</code></pre>
      <p>To obtain the config values for the twitter script, you need to log in to <a href="https://dev.twitter.com/apps">dev.twitter.com/apps</a>
        and click 'Create a new application'. 
        You can, again, put your own domain name as the app name, because it will be your server that effectively acts as the connecting app.
        Under 'Setting', set the Application Type to 'Read, Write and Access direct messages', and by default, for the twitter handle
        by which you  registered the app, the app will have permission to act on your behalf.</p>
      <p>At the time of writing, there is a <a href="https://github.com/AvianFlu/ntwitter/issues/74">bug in ntwitter</a> which means that tweets with
        apostrophes or exclamation marks will fail. A patch is given there, so if you are really eager to tweet apostrophes then you could apply that,
        but I haven't tried this myself. I just take this into account until the bug is fixed, and rephrase my tweets so that they contain no
        apostrophes. :)</p>
    
      <h3>A WebSocket-based gateway</h3>
      <p>The next step is to connect this up to a WebSocket. We simply integrate our postToFacebook and postToTwitter functions into the pinger.js
        script that we created last week. One thing to keep in mind though, is that we don't want random people guessing the port of the WebSocket,
        and being able to freely post to your Facebook and Twitter identities. So the solution for that
        is that we give out a token to the unhosted web app from which you will be connecting, and then
        we make it send that token each time it wants to post something.</p>
      <p>Upload this server-side script, making sure you have the right variables in a 'config.js' file in the same directory. You can run it using
        'forever':</p><pre><code>
var sockjs = require('sockjs'),
    fs = require('fs'),
    https = require('https'),
    twitter = require('ntwitter'),
    config = require('./config').config,
    twit = new twitter({
      consumer_key: config.twitterConsumerKey,
      consumer_secret: config.twitterConsumerSecret,
      access_token_key: config.twitterAccessToken,
      access_token_secret: config.twitterAccessTokenSecret
    });

function postToTwitter(str, cb) {
  twit.verifyCredentials(function (err, data) {
    if (err) {
      cb("Error verifying credentials: " + err);
    } else {
      twit.updateStatus(str, function (err, data) {
        if (err) {
          cb('Tweeting failed: ' + err);
        } else {
          cb('Success!')
        }
      });
    }
  });
}

function postToFacebook(str, cb) {
  var req = https.request({
    host: 'graph.facebook.com',
    path: '/me/feed',
    method: 'POST'
  }, function(res) {
    res.setEncoding('utf8');
    var str = '';
    res.on('data', function(chunk) {
      str += chunk;
    });
    res.on('end', function() {
      cb({
        status: res.status,
        text: str
      });
    });
  });
  req.end("message="+encodeURIComponent(str)
    +'&access_token='+encodeURIComponent(config.facebookToken));
};

function handle(conn, chunk) {
  var obj;
  try {
    obj = JSON.parse(chunk);
  } catch(e) {
  }
  if(typeof(obj) == 'object' && obj.secret == config.secret 
     && typeof(obj.object) == 'object') {
    if(obj.world == 'twitter') {
      postToTwitter(obj.object.text, function(result) {
        conn.write(JSON.stringify(result));
      });
    } else if(obj.world == 'facebook') {
      postToFacebook(obj.object.text, function(result) {
        conn.write(JSON.stringify(result));
      });
    } else {
      conn.write(chunk);
    }
  }
}

var httpsServer = https.createServer({ 
  key: fs.readFileSync(config.tlsDir+'/tls.key'), 
  cert: fs.readFileSync(config.tlsDir+'/tls.cert'), 
  ca: fs.readFileSync(config.tlsDir+'/ca.pem') 
}, function(req, res) {
  res.writeHead(200); 
  res.end('connect a WebSocket please'); 
});
httpsServer.listen(config.port);

var sockServer = sockjs.createServer();
sockServer.on('connection', function(conn) {
  conn.on('data', function(chunk) {
    handle(conn, chunk);
  });
});
sockServer.installHandlers(httpsServer, {
  prefix:'/sock'
});
console.log('up');
</code></pre>
      <p>And then you can use this simple unhosted web app as your new <a href="data:text/html;utf-8,%3C!DOCTYPE%20html%20lang%3D%22en%22%3E%0A%3Chtml%3E%0A%20%20%3Chead%3E%0A%20%20%20%20%3Cmeta%20charset%3D%22utf-8%22%3E%0A%20%20%20%20%3Ctitle%3Esocial%20dashboard%3C%2Ftitle%3E%0A%20%20%3C%2Fhead%3E%0A%20%20%3Cbody%3E%0A%20%20%20%20%3Cp%3E%0A%20%20%20%20%20%20Domain%3A%20%3Cinput%20id%3D%22domain%22%3E%0A%20%20%20%20%20%20Port%3A%20%3Cinput%20id%3D%22port%22%3E%0A%20%20%20%20%20%20Secret%3A%20%3Cinput%20id%3D%22secret%22%3E%0A%20%20%20%20%20%20%3Cinput%20type%3D%22submit%22%20value%3D%22connect%22%20onclick%3D%22connect()%3B%22%3E%0A%20%20%20%20%3C%2Fp%3E%0A%20%20%20%20%3Cp%3E%0A%20%20%20%20%20%20Text%3A%20%3Cinput%20id%3D%22text%22%20style%3D%22width%3A70em%22%3E%0A%20%20%20%20%20%20%3Cinput%20type%3D%22submit%22%20value%3D%22f%22%20onclick%3D%22sendTo('facebook')%3B%22%20style%3D%22background-color%3A%23008%3Bcolor%3A%23fff%22%3E%0A%20%20%20%20%20%20%3Cinput%20type%3D%22submit%22%20value%3D%22t%22%20onclick%3D%22sendTo('twitter')%3B%22%20style%3D%22background-color%3A%23bbf%3Bcolor%3A%23fff%22%3E%0A%20%20%20%20%3C%2Fp%3E%0A%20%20%3C%2Fbody%3E%0A%20%20%3Cscript%3E%0A%20%20%20%20var%20sock%3B%0A%20%20%20%20function%20v(id)%20%7B%20return%20document.getElementById(id).value%3B%20%7D%0A%20%20%20%20function%20connect()%20%7B%0A%20%20%20%20%20%20sock%20%3D%20new%20WebSocket('wss%3A%2F%2F'%2Bv('domain')%2B'%3A'%2Bv('port')%2B'%2Fsock%2Fwebsocket')%3B%0A%20%20%20%20%20%20sock.onopen%20%3D%20function()%20%7B%20console.log('open')%3B%20%7D%0A%20%20%20%20%20%20sock.onmessage%20%3D%20function(e)%20%7B%20console.log(e.data)%3B%20%7D%0A%20%20%20%20%20%20sock.onclose%20%3D%20function()%20%7B%20console.log('closed')%3B%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20setInterval(function()%20%7B%0A%20%20%20%20%20%20if(sock%20%26%26%20sock.readyState%20%3D%3D%20WebSocket.CLOSED)%20%7B%0A%20%20%20%20%20%20%20%20connect()%3B%0A%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%2C%201000)%3B%0A%20%20%20%20%0A%20%20%20%20function%20sendTo(world)%20%7B%0A%20%20%20%20%20%20sock.send(JSON.stringify(%7B%0A%20%20%20%20%20%20%20%20world%3A%20world%2C%0A%20%20%20%20%20%20%20%20id%3A%20new%20Date().getTime()%2C%0A%20%20%20%20%20%20%20%20object%3A%20%7B%0A%20%20%20%20%20%20%20%20%20%20text%3A%20v('text')%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20secret%3A%20v('secret')%0A%20%20%20%20%20%20%7D))%3B%0A%20%20%20%20%7D%0A%20%20%3C%2Fscript%3E%0A%3C%2Fhtml%3E"
        target="_blank">social dashboard</a>.</p>
        
      <h3>Federated or just proxied?</h3>
      <p>So now you can stay in touch with your friends on Facebook
        and Twitter, without you yourself ever logging in to either of these walled gardens,
        the monopoly platforms of web 2.0.</p>

      <p>Several people here at <a href="http://hackerbeach.org/">Hacker Beach</a>
        have reacted to drafts of this post, saying that proxying your requests through a server
        does not change the fact that you are using these platforms. I understand this reaction,
        but I do not agree, for several reasons:</p>

      <h3>Separating applications from namespaces.</h3>
      <p>Many online services offer a hosted web app, combined with a data storage service.
        But apart from application hosting and data storage, many of them define a "namespace",
        a limited context that confines who and what you interact with, and a walled garden in
        which your data "lives".</p>

      <p>For instance, the Facebook application will allow you to read about things that happen in the
        Facebook world, but not outside it. As an application, it is restricted to Facebook's "name space".
        This means this hosted application gives you a restricted view of the online universe; it is a
        software application that is specific to only one namespace. As an application, we can say that
        it is "namespace-locked", very similar to the way in which a mobile phone device can be "SIM-locked"
        to a specific SIM-card provider.</p>

      <p>The way we circumvent this restriction is by interacting with the namespace of a service *without*
        using the namespace-locked application that the service offers. Namespace-locked applications limit our
        view of the world to what the application provider wants us to interact with.</p>

      <p>So by communicating with the API of a service instead of with its web interface, we open up the possibility
        of using an "unlocked" application which we can develop ourselves, and improve and adapt however we want,
        without any restrictions imposed by any particular namespace provider. While using such a namespace-lock-free
        application, our view of the online world will be more universal and free, and less controlled and influenced
        by commercial interests.</p>

      <h3>Avoiding Cookie federation</h3>
      <p>Both Facebook and Google will attempt to platformize your web experience. Using your server as a proxy between your browser
        and these web2.0 platforms avoids having their cookies in your browser while you browse the rest of the web.</p>
      
      <h3>Your account in each world is only a marionet, you own your identity.</h3>
      <p>Since you use your own domain name and your own webserver as your main identity, the identities you appear as
        on the various closed platforms are no longer your main online identity; they are now a shadow, or hologram, of
        your main identity, which lives primarily on your Indie Web site.</p>
      <h3>Your data is only mirrored, you own the master copy.</h3>
      <p>Since all posts go through your server on the way out, you can easily relay posts outside the namespace you
        originally posted them to, and hold on to them as long as you want in your personal historical data log. You can also
        easily post the same content to several namespaces at the same time
        when this makes sense.</p>
      
      <h3>What if they retract your API key and kick your "app" off their platform?</h3>
      <p>That's equivalent to a mailserver blacklisting you as a sender; it is not a retraction of your right to send messages from
        your server, just (from our point of view) a malfunction of the receiving server.</p>
      
      <h3>Conclusion</h3>
      <p>The big advantage of using a personal server like this is that you are only sending data to each web 2.0 world when this is needed to interact
        with other people on there. You yourself are basically logged out of web 2.0, using only unhosted web apps, even though your friends still see
        your posts and actions through these "puppet" identities. They have no idea that they are effectively looking at a hologram when they interact
        with you.</p>
      <p>In order to use Facebook and Twitter properly from an unhosted web app, you will also need things like controlling more than one Twitter handle,
        receiving and responding to Facebook friend requests, and everything else. These basic examples mainly serve to show you how easy it is to
        build a personal server that federates seamlessly with the existing web 2.0 worlds.</p>
      <p>Also, if you browse through the API documentation of both Twitter and Facebook, you will see all kinds of things you can control through there.
        So you can go ahead yourself and add all those functions to your gateway
        (just make sure you always check if the correct secret is being sent on the WebSocket), 
        and then build out this social dashboard app to do many more things.</p>
      <p>You may or may not be aware that most other web2.0 websites actually have very similar REST APIs, and when
        the API is a bit more complicated, there is probably a nodejs module available that wraps it up, like in the case of Twitter here.
        So it should be possible this way to, for instance, create an unhosted web app that posts github issues, using your personal server of a gateway
        to the relevant APIs.</p>
      <p>Have fun! I moved this episode forward in the series from where it was originally, so that you can have a better feeling of where we are going
        with all this, even though you still have to do all of this through ssh. Next week we will solve that though, as we add what you could call
        a "webshell" interface to the personal server. That way, you can use an unhosted web app to upload, modify, and run nodejs scripts on your server,
        as well as doing any other server maintenance which you may now be doing via ssh. This will be another important step forward for the
        No Cookie Crew. See you next week: same time, same place!</p>
<p><a href="https://groups.google.com/d/topic/unhosted/0AaK1KHi0o0/discussion">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-6" "id="#episode-6" href="#episode-6">6.</a> Controlling your server over a WebSocket</h2>

      <p>(<a href="http://unhosted.bencharp.com/page/6-webshell,6.html">en Fran&#231;ais</a>)</p>
      <p><em><strong>No Cookie Crew  - Warning #4:</strong> This tutorial is the last time you still need to update your personal server using an
        ssh/scp client.</em></p>
        
      <h3>Web shell</h3>
      <p>Unhosted web apps are still a very new technology. That means that as a member of the No Cookie Crew, you
        are as much a mechanic as you are a driver. You will often be using unhosted web apps with the web console open in your browser, so that
        you can inspect variables and issue javascript commands to script tasks for which no feature exists. This is equally true of the services
        you run on your personal data server.</p>
      <p>So far, we have already installed nodejs, "forever", a webserver with TLS support, as well as gateways to Twitter and to Facebook. And as we
        progress, even though we aim to keep the personal server as minimal and generic as possible, several more pieces of software and
        services will be added to this list. To install, configure, maintain, and (last but not least) develop these services, you will need to have
        a way to execute commands on your personal server.</p>
      <p>In practice, it has even proven useful to run a second personal server within your LAN, for instance on your laptop, which you can then access
        from the same device or from for instance a smartphone within the same wifi network. Even though it cannot replace your public-facing personal server,
        because it is not always on, it can make certain server tasks, like for instance streaming music, more practical. We'll talk more about this
        in future posts, but for now suffice to say that if you choose to run two personal servers, then of course you need "web shell" access to both of them
        in order to administer them effectively from your browser.</p>
      <p>There are several good software packages available which you can host on your server to give it a "web shell" interface. One that I can
        recommend is <a href="http://liftoffsoftware.com/Products/GateOne">GateOne</a>. If you install it on Ubuntu, make sure you
        <code>apt-get install dtach</code>, otherwise the login screen will crash repeatedly. But other than that, I have been using it as an
      alternative to my laptop's device console (Ctrl-Shift-F1), with good results so far.</p>
      <p>The GateOne service is not actually a webshell directly into the server it runs on, but rather an ssh client that allows you to ssh into
        the same (or a different) server. This means you will also need to run <code>ssh-server</code>, so make sure all users on there have good
        passwords.</p>
      <h3>Unhosted shell clients</h3>
      <p>You can host web shell software like this on your server(s), but this means the application you use (the web page in which
      you type your interactive shell commands) is chosen and determined at install-time. This might be OK for you if you are installing your personal server
      yourself and you are happy with the application you
      chose, but it is a restriction on your choice of application if this decision was made for you by your server hosting provider. This problem can be
      solved by using an <em>unhosted shell client</em> instead of a hosted one. The principle of separating unhosted web apps from minimal server-side
      gateways and services is of course the main topic of this blog series, so let's also try to apply it here.</p>
      <p>A minimal way to implement a command shell service would be for instance by opening a WebSocket on the server, and executing commands that get sent
        to it as strings. You could put this WebSocket on a hard-to-guess URL, so that random people cannot get access to your server without your permission.</p>
      <p>An unhosted web app could then provide an interface for typing a command and sending it, pretty much exactly in the same way as we did for the
        <a href="../5/Facebook-and-Twitter-from-nodejs.html">social dashboard</a> we built last week.</p>
      <p>But there are two things in that proposal that we can improve upon. First, we should document the "wire protocol", that is, the exact format of messages that
        the unhosted web app sends into the WebSocket, and that come back out of it in response. And second, if we open a new WebSocket for each service we add
        to our personal server, then this can become quite unwieldy. It would be nicer to have one clean interface that can accept various kinds of commands,
        and that dispatches them to one of several functionalities that run on the server.</p>
      <h3>Sockethub to the rescue</h3>
      <p>Nick Jennings, who was also at the <a href="http://2012.unhosted.org/">the 2012 unhosted unconference</a>, and who is now also here at Hacker Beach, recently
        received <a href="http://nlnet.nl/">NLnet</a> funding to start a project called <a href="http://sockethub.org/">Sockethub</a>. It is a
        redis-based nodejs program that introduces exactly that: a WebSocket interface that lets unhosted web apps talk to your server. And through your server, they
        can effectively communicate with the rest of the world, both in a sending and a receiving capacity.</p>
      <p>So let's have a look at how that would work. The command format for Sockethub is loosely based on <a href="http://activitystrea.ms/">ActivityStreams</a>.
        In that regard it is very similar to Evan Prodromou's new project, <a href="http://pump.io/">pump.io</a>. A Sockethub command has three required fields:
        <code>rid</code>, <code>platform</code>, and <code>verb</code>. Since multiple commands may be outstanding at the same time, the <code>rid</code> (request
        identifier) helps to know which server response is a reply to which of the commands you sent. The <code>platform</code> determines which code module will handle
        the request. That way, it's easy to write modules for Sockethub almost like writing a plugin for something. And finally, the <code>verb</code> determines which
        other fields are required or optional. Some verbs may only exist for one specific platform, but others, like 'post', make sense for multiple platforms, so 
        their format is defined only once, in a platform-independent way wherever possible.</p>
      <p>For executing shell commands, we will define a 'shell' platform that exposes an 'execute' verb. The way to do this in Sockethub is described in the <a href="https://github.com/sockethub/sockethub/blob/master/doc/adding_a_platform.md">instructions for adding a platform</a>. The API has changed a little bit now, but at the time of writing, this meant adding a file called
        <code>shell.js</code> into the <code>lib/protocols/sockethub/platforms/</code> folder of the Sockethub source tree, with the following content:</p>
<pre><code>
var https = require('https'),
    exec = require('child_process').exec;

module.exports = {
  execute: function(job, session) {
    exec(job.object, function(err, stdout, stderr) {
      session.send({
        rid: job.rid,
        result: (err?'error':'completed'),
        stdout: stdout,
        stderr: stderr
      });
    });
  }
};
</code></pre>
      <p>We also need to add 'shell' the PLATFORMS variable in <code>config.js</code>, add the 'execute' verb and the 'shell' platform to
        <code>lib/protocols/sockethub/protocol.js</code>, and add the 'execute' command to <code>lib/protocols/sockethub/schema_commands.js</code> with a required
      string property for the actual shell command we want to have executed. We'll call this parameter 'object', in keeping with ActivityStreams custom:</p>
<pre><code>
  ...
  "execute" : {
    "title": "execute",
    "type": "object",
    "properties": {
      "object": {
        "type": "string",
        "required" : true
      }
    }
  },
  ...
</code></pre>
      <h3>Conclusion</h3>
      <p>Sockethub was still only a week old when I wrote this episode in January 2013, but it promises to be a very useful basis for many of the gateway functionalities we want to open up to
        unhosted web apps, such as access to email, social network platforms, news feeds, bittorrent, and any other platforms that expose server-to-server APIs, but 
        are not directly accessible for unhosted web apps via a public cross-origin interface.</p>
      <p>Especially the combination of Sockethub with <a href="http://remotestorage.io/">remoteStorage</a> and a web runtime like for instance Firefox OS looks
        like a promising all-round app platform. More next week!</p>
<p><a href="https://groups.google.com/d/topic/unhosted/smrr28JTQu8/discussion">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-7" "id="#episode-7" href="#episode-7">7.</a> Adding remote storage to unhosted web apps</h2>

      <p>(<a href="http://unhosted.bencharp.com/page/7-remotestorage,7.html">en Fran&#231;ais</a>)</p>
      <h3>Apps storing user data on your personal server</h3>
      <p>So far our unhosted web apps have relied on the browser's "Save as..." dialog to save files.
        We have set up our own personal server, but have only used it to host a profile and to run
        <a href="http://sockethub.org/">Sockethub</a> so that we can relay outgoing messages
        through it, to the servers it federates with. This week we will have a look at
        <a href="http://remotestorage.io/">remoteStorage</a>, a protocol for allowing unhosted web apps to use
        your personal server as cloud storage.</p>
      <p>The protocol by which a client interacts with a remoteStorage server is described in
        <a href="https://tools.ietf.org/id/draft-dejong-remotestorage-03.txt">draft-dejong-remotestorage-03</a>,
        an IETF Internet-Draft that is currently in version -03. At its core are the http protocol, TLS, and
        <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS headers</a>.</p>
      <p>A remoteStorage server allows you to store, retrieve, and remove documents in a directory structure,
        using http PUT, GET, and DELETE verbs, respectively. It will respond with
        CORS headers in the http response, so
        that your browser will not forbid your web app from making requests to the storage origin.</p>
      <p>As an app developer, you will not have to write these http requests yourself. You can use the
        <a href="http://remotestorage.io/integrate/">remotestorage.js</a> library (which now also has
        experimental support for cross-origin Dropbox and GoogleDrive storage).</p>
      
      <h3>Reusing reusable user data</h3>
      <p>The remotestorage.js library is divided up into modules (documents, music, pictures, ...),
        one for each type of data. Your app would typically only
        request access to one or two such modules (possibly read-only). The library then takes care of displaying a widget in the top right of
        the window, which will obtain access to the corresponding parts of the storage using OAuth2's Implicit Grant flow:</p>
      <img src="widget.png" />
      <p>The Implicit Grant flow is special in that there is no requirement for server-to-server communication, so it can
        be used by unhosted web apps, despite their lack of server backend.
        The OAuth "dance" consists of two redirects: to a dialog page hosted by the storage provider,
        and back to the URL of the unhosted web app. On the way back, the storage provider will add an access token to the URL fragment,
        so the part after the '#' sign. That means that the token is not even sent to the statics-server that happens to serve up the
        unhosted web app. Of course the app could contain code that does post the data there, but at least such token leaking would be
        detectable.</p>
      <p>By default, OAuth requires each relying party to register with each service provider, and the remoteStorage spec
        <a href="http://tools.ietf.org/html/draft-dejong-remotestorage-03#page-10">states</a> that
        servers "MAY require the user to register applications as OAuth clients
        before first use", but in practice most remoteStorage servers allow their users full freedom in their choice of which apps to 
        connect with.</p>
      <p>As an app developer you don't have to worry about all the ins and outs of the OAuth dance that goes on when the user connects
        your app to their storage. You just use the methods that the modules expose.</p>
      <p>Since there are not yet a lot of modules, and those that exist don't have a lot of methods in them yet, you are likely to end up
        writing and contributing (parts of) modules yourself. Instructions for how to do this are all linked from
        <a href="http://remotestorage.io/">remotestorage.io</a>.</p>
        
      
      <h3>Cloud sync should be transparent</h3>
      <p>As an app developer, you only call methods that are exposed by the various remotestorage.js modules. The app is not at all concerned
        with all the data synchronization that goes on between its instance of remotestorage.js, other apps running on the same device, apps
        running on other devices, and the
        canonical copy of the data on the remoteStorage server. All the sync machinery is "behind" each module, so to speak, and the module
        will inform the app when relevant data comes in.</p>
      <p>Since all data your app touches needs to be sent to the user's remoteStorage server, and changes can also arrive from there without
        prior warning, we have so far found it easiest to develop apps using a variation on what emberjs calls "the V-model".</p>
      <p>Actions like mouse clicks and key strokes from the user are received by DOM elements in your app. Usually, this DOM element could 
        determine by itself how it should be updating its appearance in reaction to that. But in the V-model, these actions are only passed
        through.</p>
      <p>The DOM element would at first leave its own state unchanged, passing the action to the controller, to the javascript code that
        implements the business logic and determines what the result (in terms of data state) of the user action should be. This state change
        is then effectuated by calling a method in one of the remoteStorage modules. So far, nothing still has changed on the screen.</p>
      <p>If we were to completely follow the V-model, then the change would first move further down to the storage server, and then ripple
        all the way back up (in the shape of a letter V), until it reaches the actual DOM elements again, and updates their visual state.</p>
      <p>But we want our apps to be fast, even under bad network connections. In any case, waiting an entire http round-trip time before
        giving the user feedback about an action would generally take too long, even when the network conditions are good.</p>
      <p>This is why remoteStorage modules receive change events about outgoing changes at the moment the change travels out over the wire,
        and not after the http request completes. We jokingly call this concept
        <a href="https://github.com/offlinefirst/research/issues/9">Asynchronous Synchronization</a>: the app does not have to wait
        for synchronization to finish; synchronization with the server happens asynchronously, in the background.</p>
      
      <h3>Two easy ways to connect at runtime</h3>
      <p>We mentioned that the remoteStorage spec uses OAuth to allow a remotestorage.js module to get access, at runtime, to its designated
        part of the user's storage. To allow the remotestorage.js library to make contact with the user's remoteStorage server, the user inputs
        their remoteStorage address into the widget at the top right of the page. A remoteStorage address looks like an email address, in that
        it takes the form 'user@host'. But here of course 'host' is your remoteStorage provider, not your email provider, and 'user' is whatever
        username you have at that provider.</p>
      <p>The protocol that is used to discover the connection details from this 'user@host' string is called webfinger. Luckily, webfinger
        supports CORS headers, so it can be queried from an unhosted web app without needing to go through a server for that.
        We actually successfully <a href="https://groups.google.com/d/msg/webfinger/kfcVkqBX0tQ/T0lAsDSITbwJ">campaigned</a>
        for that support last year once we realized how vital this is for unhosted
        web apps. It is very nice to see how the processes around open standards on the web actually allowed us to put this issue on the agenda in
        this way.</p>
      <p>So the way this looks to the user is like this:</p>
      <ol>
        <li>Click 'connect remoteStorage'</li>
        <li>Type your 'user@host' remoteStorage address into the widget</li>
        <li>Log in to your remoteStorage provider (with Persona or otherwise)</li>
        <li>Review which modules the app requests</li>
        <li>If it looks OK, click 'Accept'</li>
        <li>You are back in the app and your data will start appearing</li>
      </ol>
      <p>We call this the 'app first flow'. Steps 4 and 5 will look something like this (example shown is <a href="https://5apps.com">5apps</a>):</p>
      <img src="app-first.png" />
      <p>Another way to connect an unhosted web app and a remoteStorage account at runtime is if you have an app launch panel that is already
        linked to your remoteStorage account. You will get this for instance when you install the
        <a href="https://github.com/michielbdejong/owncloud-owa">ownCloud app</a>. Apps will simply appear with their icons in the web interface
        of your storage server, and because you launch them from there, there is no need to explicitly type in your remoteStorage address once
        the app opens.</p>
      <p>We call this the 'storage first flow', Fran&#231;ois invented it this summer when he was in Berlin.
        The launch screen will probably look a bit like the home screen of a smartphone, with one icon per app (example shown is
        <a href="https://github.com/michielbdejong/owncloud-owa">ownCloud</a>):</p>
      <img src="storage-first.png" />
      <h3>Featured apps</h3>
      <p>The remotestorage.js library had just reached its first beta version (labeled 0.7.0) at the time of writing (it is now at version 0.10), and we have collected a number of
        <a href="https://unhosted.org/apps/">featured apps</a> that use this version of the library. So far, I am using the
        <a href="https://music-unhosted.5apps.com/">music</a>, <a href="https://editor-michiel.5apps.com/">editor</a> and
        <a href="https://grouptabs-xmartin.5apps.com/">grouptabs</a> apps for my real music-listening, text-editing, and peer-to-peer bookkeeping
        needs, respectively.</p>
      <p>There is also a minimal writing app on there called <a href="http://litewrite.net/">Litewrite</a>, a video-bookmarking
        app called <a href="https://vidmarks.5apps.com/">Vidmarks</a>,
        a generic <a href="https://remotestorage-browser.5apps.com/">remoteStorage browser</a>, and a
        <a href="https://social-unhosted.5apps.com/">number</a> of
        <a href="https://todo-unhosted.5apps.com/">demo</a>
        <a href="http://myfavoritedrinks.5apps.com/">apps</a>. If you don't have a remoteStorage account yet, you can get one at
        <a href="https://5apps.com/">5apps</a>. For more options and more info
        about remoteStorage in general, see <a href="http://remotestorage.io/">remotestorage.io</a>.</p>
      <p>After you have used the <a href="https://todo-unhosted.5apps.com">todo app</a> to add some tasks to your remote storage, try out the 
        <a href="http://shybyte.github.io/unhosted-time-tracker/">unhosted time tracker</a> app. You will see it retrieve your task list from
        your remote storage even though you added those tasks using a different app. So that is a nice first demonstration of how remoteStorage
        separates the data you own from the apps you happen to use.</p>
      <p>Remote storage is of course a vital piece of the puzzle when using unhosted web apps, because
        they have no per-app server-side database backend of themselves. The remoteStorage protocol and the 
        remotestorage.js library are something many of us have been working on really hard for years, and since last week, finally, we are able to
        use it for a few real apps. So we are really enthusiastic about this recent release, and hope you enjoy it as much as we do! :)</p>
<p><a href="https://groups.google.com/d/topic/unhosted/BLx6IGK_5EU/discussion">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-8" "id="#episode-8" href="#episode-8">8.</a> Collecting and organizing your data</h2>

      <p>(<a href="http://unhosted.bencharp.com/page/8-vos-donnees,8.html">en Fran&#231;ais</a>)</p>
<p>As a member of the No Cookie Crew you will be using unhosted web apps for everything you currently use hosted web apps for.
None of these apps will store your user data, because they do not have a server backend to store it on. You will have to
store your data yourself.</p>
<p>Collecting and organizing your own data is quite a bit of work, depending on how organized you want to be about it.
This work was usually done by the developers and system administrators of the hosted web apps you have been using.
The main task is to "tidy your room", like a kid putting all the toys back in the right storage place inside their bedroom.</p>

<h3>Collecting your data from your own backups</h3>
<p>We sometimes like to pretend that the Chromebook generation is already here, and that all our data is in the cloud. In reality,
obviously, a lot of our data is still just on our laptop hard disk, on external hard disks, on USB sticks, and on DVDs that we
created over the years.</p>
<p>The first step towards making this data usable with unhosted web apps is to put it all together in one place. When I started
doing this, I realised I have roughly four types of data, if you split it by the reason why I'm keeping it:</p>
<ul>
  <li>Souvenirs: mainly folders with photos, and videos. I hardly ever access these, but at the same time they are in a way
    the most valuable, since they are unique and personal, and represent powerful memories.</li>
  <li>Products: things I published in the past, like for instance papers I wrote as a student, code I published over the years,
    and the content of my website. In several cases I have source files that were not published as such, for instance original
    vector graphics files of designs that were published only as raster images, or screen-printed onto a T-shirt. It's all the original raw copies
    of the things that took me some effort to create, and that I may want to reuse in the future.</li>
  <li>Media Cache: my music collection, mostly. It used to be that when you lost a CD, you could no longer listen to it, but for
    all but the most obscure and rare albums, this is no longer the case, and should you lose this data, then it's easy to get
    it back from elsewhere. The only reason you cache it is basically so that you don't have to stream it.</li>
  <li>Working Set: the files I open and edit most often, but that are part of a product that is not finished yet, or that
    (unlike souvenirs) have only a temporary relevance.</li>
</ul>
<p>Most work goes into pruning the ever growing Working Set: determining which files and folders can be safely deleted (or moved
to the "old/" folder), archiving all the source files of products I've published, and deciding which souvenirs to keep and which
ones really are just more of the same.</p>
<p>My "to do" list and calendar clearly fit into "Working Set", but the one thing that doesn't really fit into any of this is my address
book. It is at the same time part of my working set, my products, and my souvenirs. I use it on a daily basis, but many contacts
in there are from the past, and I only keep them just in case some day I want to reuse those contacts for a new project, and of course
there is also a nostalgic value to an address book.</p>

<h3>Some stuff on your Indie Web server, the rest on your FreedomBox server</h3>
<p>At first, we had the idea of putting all this data of various types into one remoteStorage account. This idea quickly ran into three
problems: first, after scanning in all my backup DVDs, even after removing all the duplicate folders, I had gathered about 40 Gigs, and my
server only has 7 Gigs of disk space. It is possible to get a bigger server of course, but this didn't seem like an efficient thing to
spend money on, especially for the Media Cache data.</p>
<p>Second, I am often in places with limited bandwidth, and even if I would upload 40 Gigs to my remote server, it would still be a waste
of resources to try to stream music from there for hours on end.</p>
<p>Third, even though I want to upload my photos to a place where I can share them with friends, I have a lot of my photos in formats
that take up several Megabytes, and typically photos you share online would probably be more around 50 K for good online browsing
performance. So even if I upload all my photos to my Indie Web server, I would want to upload the "web size" version of them, and not
the huge originals.</p>
<p>After some discussion with Basti and François, I concluded that having one remote storage server is not enough to cover all use
cases: you need two. The "Indie Web" one should be always on, on a public domain name, and the "FreedomBox" one should be in your home.</p>
<p>On your Indie Web server, you would store only a copy of your Working Set data,
plus probably sized down derivatives of some of your products and
souvenirs. On your FreedomBox you would simply store everything.</p>
<p>This means you will already have to do some manual versioning, probably, and think about when to upload something to your Indie Web
server. At some point we will probably want to build publishing apps that connect to both accounts and take care of this, but for now, since
  we have webshell access to both servers, we can do this with a simple <code>scp</code> command.</p>

<h3>FreedomBox and the remoteStorage-stick</h3>
<p>The topic of having a data server in your home brought up the work Markus and I did on combining the
  <a href="http://freedomboxfoundation.org/">FreedomBox</a> with remoteStorage. Our idea was to split the FreedomBox into the actual plug
  server and a USB drive that you stick into it, for the data storage. The two reasons for splitting the device this way are that it makes it
  clear to the user where their data is and how they can copy it and back it up, and that it makes tech support easier, since the device contains
  no valuable data, and can thus easily be reset to factory settings.</p>
<p>To allow this FreedomBox to also serve a public website, we would sell a package containing:</p>
<ul>
  <li>the plug server</li>
  <li>the 'remoteStorage-stick'</li>
  <li>a <a href="https://pagekite.net/">Pagekite</a> account to tunnel through</li>
  <li>a TLS certificate for end-to-end encryption</li>
  <li>tokens for flattering unhosted web apps in the 5apps store</li>
</ul>
<p>There is still a long way to go to make this a sellable product, but it doesn't hurt to start experimenting with its architecture ourselves
  first, which is why I bought a usb drive, formatted it as ext4 with encryption, and mounted it as my 'remoteStorage' stick. It's one of those
  tiny ones that have the hardware built into the connector and don't stick out, so I leave it plugged in to my laptop by default.</p>

<h3>Putting your data into your remoteStorage server</h3>
<p>By way of FreedomBox prototype, I installed ownCloud on my localhost and pointed a 'freedombox' domain to 127.0.0.1 in my <code>/etc/hosts</code>.
To make your data available through a remoteStorage API, install one of the remoteStorage-compatible personal data servers listed under 'host your own storage'
  on <a href="http://remotestorage.io/get/">remotestorage.io/get/</a>. I went for the ownCloud one here, because (like the php-remoteStorage one) it maps data
  directly onto the filesystem (it
uses extended attributes to store the Content-Types). Nowadays you would probably go for
<a href="https://github.com/jcoglan/restore">reStore</a> instead, because it's easier to get working. If you just want to get started quickly with remoteStorage, try the <a href="https://github.com/remotestorage/starter-kit">starter-kit</a>. This means you can just import data onto your remoteStorage account by copying it onto your
  remoteStorage-stick. Do make sure your remoteStorage-stick is formatted with a filesystem that supports extended file attributes.</p>

<h3>Export your data from Google, Facebook and Twitter</h3>
<p><em><strong>No Cookie Crew  - Warning #5:</strong> You will have to log in to these services now, because apart from Twitter, they do not offer this same
  functionality through their APIs.</em></p>

<p>This part is quite fun: Data Liberation! :) It is actually quite easy to download all your data from Google. This is what it looks like:</p>
  <img src="google.png" />

<p>Facebook offers a similar service, even though the contacts export is quite rudimentary, but you can export at least your photos:</p>
<img src="facebook.png" />

<p>And this is what the LinkedIn one looks like:</p>
<img src="linkedin.png" />

<p>For twitter, tweet data is mostly transient, so there is not much point probably in exporting that. Instead, you could start saving a copy of everything you
  tweet through sockethub onto your remoteStorage from now on. But to export your contacts,
  if there are not too many, you can simply scrape <a href="https://twitter.com/following">https://twitter.com/following</a> and
  <a href="https://twitter.com/followers">https://twitter.com/followers</a> by
 opening the web console (Ctrl-Shift-K in Firefox), and pasting:
<pre><code>
  var screenNames = [],
    accounts = document.getElementsByClassName('account');
  for(var i=0; i&lt;accounts.length; i++) {
    screenNames.push(
        accounts[i].getAttribute('data-screen-name'));
  }
  alert(screenNames);
</code></pre>
<p>Do make sure you scroll down first to get all the accounts in view.
  You could also go through the api of course (see <a href="../5/Facebook-and-Twitter-from-nodejs.html">episode 5</a>), and nowadays Twitter also lets you download a zip file from the <a href="https://twitter.com/settings/account">account settings</a>.</p>

  <h3>Converting your data to web-ready format</h3>
  <p>Although you probably want to keep the originals as well, it makes sense to convert all your photos to a 50Kb "web size". If
    you followed <a href="../3/Setting-up-your-personal-server.html">episode 3</a>, then you have an Indie Web server with end-to-end
    encryption (TLS), so you can safely share photos with your friends by uploading them to unguessable URLs there. It makes sense
    to throttle 404s when you do this, although even if you don't, as long as the URLs are long enough, it is pretty unlikely that anybody
    would successfully guess them within the lifetime of our planet.</p>
  <p>In order to be able to play music with your browser, you need to convert your music and sound files to a format that your browser of
    choice supports, for instance ogg. On unix you can use the <code>avconv</code> tool for this (previously known as <code>ffmpeg</code>):</p>
<pre><code>
    for i in `ls */*/*` ; do
      echo avconv -i $i -acodec libvorbis -aq 60 \
        ~/allmydata/mediaCache/$i.ogg ;
     done | sh
</code></pre>

    <p>To convert your videos to ogg, you could try something like:</p>
<pre><code>
    for i in `ls *.AVI` ; do
      echo avconv -i $i -f ogg \
        ~/allmydata/souvenirs/$i.ogg ;
    done | sh
</code></pre>
<p>I had some trouble with the resulting video quality, and sound didn't work for some files, but that is a matter of playing around with the
  media conversion software on your computer until you get it the way you want it.</p>
  
  <h3>Playing your music through your browser</h3>
  <p>If you're setting up your remoteStorage server to serve your music files, then make sure you put them under <code>/public/music/</code> on your
    remoteStorage, so you can use François' <a href="https://music-unhosted.5apps.com/">Unhosted Music Player</a>. Otherwise,
you can also store your music in IndexedDB using Mozilla's <a href="http://mozilla.github.io/localForage/#setitem">localForage</a> library, or use <code>file:///</code>
    URLs to play your music. In the folder containing the files, simply add an html file that acts as a playlist app for them:
<pre><code>
&lt;!DOCTYPE html>
&lt;html lang="en">
  &lt;head>
    &lt;meta charset="utf-8" />
    &lt;title>Yo Skrill, drop it hard (playlist)</title>
  &lt;/head>
  &lt;body>
    &lt;h1>Programming</h1>
    &lt;audio id="player"></audio>
    &lt;ul id="playlist"></ul>
  &lt;/body>
  &lt;script>
    var songs = [
      '99 problems.ogg',
      'skrillex.ogg',
      'minimal.ogg'
    ];
    var i=0;    
    document.getElementById('player').controls=false;
    
    function go() {
      document.getElementById('player').src=songs[i];
      document.getElementById('player').play();
      var str ='';
      for(var j=0; j&lt;songs.length; j++) {
        if(j==i) {
          str += '&lt;li>&lt;strong>'+songs[j]+'&lt;/strong>(playing)';
        } else {
          str += '&lt;li>'+songs[j]+'&lt;input type="submit" '
              + 'value="play" onclick="i='+j+'; go();" />&lt;/li>';
        }
      }
      document.getElementById('playlist').innerHTML = str;
    }
    
    document.querySelector('audio')
        .addEventListener('pause', function() {
      i = (i+1) % songs.length;
      go();
    }, false);
    go();
  &lt;/script>
&lt;/html>
</code></pre>
<h3>Use html to organize your data</h3>
<p>Remember, it's the web. You drive. You can easily add html pages similar to the music playlist above, to create your own
  photo album designs. You can create photo albums that mix videos in them, using the html5 <code>&lt;video></code> tag,
  and even add css animations, svg graphics, 3D effects, and interactive navigation features to your photo albums and 
  souvenir scrapbooks. Maybe 
  even make some sound recordings when you are on holiday, and add them into your next
  "photo album".</p>
<p>I also found that so far, it has been far more important to me to have all my imported contacts in <em>some</em> format
  on my remoteStorage, even if it is just a text file that I search through with Ctrl-F, than to necessarily have a polished
  app for each task. I also use javascript a lot to, for instance, read in csv files and do some spreadsheet calculations on
  them.</p>
<p>A lot of the applications we usually assume are necessary on a computer (spreadsheets are a prime example) become irrelevant as soon as
  you learn how to develop your own unhosted web apps. And having the power of the web at your own fingertips, instead of being
  tied to what software providers give you, also gives a satisfying feeling of freedom and opportunity. And it makes being a
  member of the No Cookie Crew so much more fun! :)</p>
<p><a href="https://groups.google.com/d/topic/unhosted/WBJBToqMvwk/discussion">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-9" "id="#episode-9" href="#episode-9">9.</a> Sending and receiving email from unhosted web apps</h2>

<!-- title: Sending and receiving email from unhosted web apps -->
      <p>(<a href="http://unhosted.bencharp.com/page/9-email,9.html">en Fran&#231;ais</a>)</p>
<h3>Unhosting email</h3>
<p>The posterchild of hosted web apps is arguably GMail. It was one of the first apps
  to use AJAX to its full potential, and redefined our expectations of what can and
  cannot be done inside a browser. This also means it is one of the hosted web apps
  that will be hardest to replace.</p>

<p>The idea of unhosting email is simple: take, essentially, the client-side javascript
  app that for instance GMail puts into your browser, and make its backend swappable,
  so that the user can connect their own backend at runtime.</p>

<p>For storing email messages, both received ones and sent ones, we will use
  <a href="http://remotestorage.io/">remoteStorage</a>. For relaying the outgoing
  messages and receiving the incoming messages, we will use
  <a href="http://sockethub.org/">Sockethub</a>. This kind of pattern should become familiar
  to you by now if you have been following the previous episodes of this handbook.</p>

<h3>What to put on port 25</h3>
<p>As I'm writing this, it has been three months since I started using unhosted web apps
  as much as possible for everything. During this time I have experimented with various
  incoming mail servers - most of them based on the <a href="https://github.com/andris9/simplesmtp">simplesmtp</a>
  nodejs package. This has gone reasonably well; I had anticipated losing a small percentage
  of my incoming mail during this period, and also warned people about this possibility.</p>

<p>Spam levels are also still manageable; I registered this domain name 6 months ago, so only
  about 50% of incoming messages are spam, and it's not too much work for me to just click
  through them.</p>

<p>Hosting mailservers is, however, not fun. This is why this week I decided to switch my domain
  to <a href="http://gandi.net/">Gandi</a> and get their standard mail hosting package. You could
  also of course use GMail as your incoming and outgoing mailserver, that is in itself equivalent.</p>

<p>Pointing the MX records of your domain to an email hosting provider resolves a significant part of
  the engineering problem, and means we don't have to run anything on port 25 (the standard TCP port for
  incoming email) ourselves. Instead, our Sockethub server only has to retrieve the email from that email
  hosting provider, using either
  POP3 or IMAP.</p>

<h3>Sending mail out</h3>
<p>Outsourcing the email hosting for your IndieWeb domain to a standard hosting provider also resolves
  another problem: it gives you a trusted outgoing relay. In the old days, you could send email messages
  straight from your email client to the receiving mailserver. Nowadays, that is entirely impossible.
<p>First of all, the remote receiving mailserver will probably block your IP address purely based on the
  fact that it is likely listed as a "residential" IP block. Second, your ISP is likely to not even allow
  your computer to connect out to any remote port 25 over TCP.</p>
<p>But even if that weren't the case, you would have to configure all sorts of things like reverse DNS matching your email domain
  in order to get even a chance at delivering an email message somewhere.</p>
<p>Services like <a href="http://www.mailgun.com/">Mailgun</a> and <a href="http://sendgrid.com/">SendGrid</a>
  fix this problem. They are specialized in relaying outgoing emails. Their main customers would normally be
  hosted web app developers who need to send out notification emails to their users, but if you ask nicely,
  they will probably also give you an account for your personal outgoing mail.</p>
<p>I have been using SendGrid for the last three months (if you received email from me you may have noticed
  the 'via sendgrid.me' header), but switching my incoming mail to Gandi will also give me an outgoing relay server
  that I can easily use.</p>
  
<h3>Fitting Sockethub into the picture</h3>
<p>Unhosted web apps can only open http connections, since a few years WebSocket connections,
  and since a few weeks, PeerConnections. They cannot open SMTP connections, IMAP connections, or POP3 connections.</p>
<p>Sockethub takes on the role of connecting a WebSocket on the side of the unhosted web app with an SMTP, IMAP, or POP3
  connection on the side of the remote server, and relaying the communication in two directions. It plays the role of a hub
  inbetween WebSockets on the one hand, and TCP sockets on the other.</p>
<p>For outgoing email, the unhosted web app sends an Activity with verb 'send' to Sockethub, putting the message into the
  Activity's object field, the various types of recipients into the target field, and the From: address into the actor field.</p>
<p>Sockethub then transforms this Activity into an SMTP message (using <a href="https://github.com/andris9/Nodemailer">Nodemailer</a>),
  and gives it to the relay server you specified it to use. The relay server then serves mainly to comply with all the spam rule
  obligations, and to queue the message in case the receiving mailserver is temporarily down or unreachable.</p>
<p>For incoming email, you tell Sockethub to retrieve email from your mailserver, and put it into your remoteStorage account. At the
  time of writing, that part is not implemented yet: I am still using a separate script that handles this part.</p>  
<p>The <a href="https://github.com/sockethub/sockethub#setup">Sockethub setup instructions</a> include an example page for sending email. You can also check out <a href="https://meute.5apps.com/">meute.5apps.com</a> for inspiration.</p>

<h3>Main features of an email message</h3>
<p>The email system is super old, at least on the scale of internet history, and has many different partial options and features. At
  first, I only supported sending email messages with a text-body and a subject from my email address to the recipient's email address.</p>
<p>After a few complaints from several of my friends though, I realised I should really add 'In-Reply-To' and 'References' headers when replying
  to a thread. I hadn't at first realised that this was so vital, but if you don't do this, then other people's mail clients will start a
  new thread each time you reply to something. The value of these header fields should be the Message-ID of the email message you are replying to.</p>
<p>Adding sender and recipient names is also useful; since I'm using 'anything@michielbdejong.com', I show up in people's addressbooks as the user
  'anything'. That's a bit ugly. The proper way is to specify for instance 'Michiel B. de Jong &lt;anything@michielbdejong.com&gt;' instead. And the same
  for recipient addresses.</p>
<p>The latest feature I added to my email sending app is support for multiple To: addresses as well as multiple Cc: addresses. It seem SendGrid does not
  implement Bcc:, and I also never use this feature, so I left that out, at least for outgoing emails.</p>
<p>For incoming emails, I used a separate app at the time of writing (later, I switched to using <a href="https://meute.5apps.com/">Meute</a>). This is a bit of a nuisance because I have to cut-and-paste each message I reply to, but as a work-in-progress,
  I manage with it. I store incoming emails on my remoteStorage in the 'messages' modules,
  and the way I keep the synchronization overload under control is by having two layers of folders: one layer for the Megasecond, and one layer for the
  Kilosecond.</p>
<p>This means that at one click of a button I can retrieve all email from the current Kilosecond (about 17 minutes), which is rarely more than two or three
  messages.</p>
<p>On top of that, each Megasecond (about 11 days), my email is archived to a different folder. The messages are saved in filenames with millisecond precision,
  so if you send me an email right now, then it will be stored
  on my remoteStorage as something like: <code>messages/1360/680/123456.json</code>. Whenever I receive an html-only email, or an email with attachments, I
  have to go into my VPS using the <a href="https://unhosted.org/adventures/6/Controlling-your-server-over-a-WebSocket.html">webshell</a> access,
  to get to that additional content.</p>
<p>I'm telling you all this to make clear that, although we have this working, and I have been using this for months as my email client, it is far from
  "workable" for end-users, and there is still quite a long way
  to go before we can say we "solved" the challenge of writing an unhosted email client.</p>
  
<h3>Spam filtering</h3>
<p>If you host your own mailserver, then it is advisable to run some sort of spam filter software on there. Strictly speaking we could
  argue that this is an application-level task that should be handled by the unhosted web app that acts as the email client, but since
  spam filtering is such an integral part of the email platform nowadays, I think it's defendable to make it part of the server.</p>
<p>Anyway, if you outsource your mail hosting to a hosting provider, they wil take care of the spam filtering for you.</p>

<h3>Pretty Good Privacy</h3>

  <p>Last week, Eben Moglen and Bdale Garbee gave a keynote at FOSDEM about
    <a href="https://fosdem.org/2013/schedule/event/freedombox/">FreedomBox 1.0</a>. As we mentioned
    <a href="https://unhosted.org/adventures/8/Collecting-and-organizing-your-data.html">last week</a>, the general concept of using a
    FreedomBox, that's to say a plugserver or other piece of hardware that is always on, running free software in your home, is a central
    piece of the puzzle we are trying to solve with unhosted web apps.</p>
  <p>In the keynote, Bdale made it clear that PGP is a central part of how FreedomBox will provide freedom to its users. And I feel this
    makes total sense. PGP is a tested system for end-to-end encryption of email messages that people send each other. By itself, the
    email platform does not support much in the way of encryption and protection against eavesdropping.</p>
  <p>Also, the move of more and more users away from desktop-based email clients like Thunderbird and Outlook, and onto webmail services
    like GMail, makes end-to-end encryption impossible.</p>
  <p>But with sockethub, provided you run your sockethub server inside your home, or at least inside your trusted local network, we have
    an opportunity to implement end-to-end encryption in a way that is entirely transparent to the unhosted web apps that send and receive
    the emails.</p>
  <p>So far, I have added PGP clearsigning to Sockethub (this has now been removed again), using the '<a href="https://github.com/drudge/node-gpg">gpg</a>' nodejs package.
    This is still an early proof-of-concept, and
    especially generating and storing the keys still needs a lot of work, but I think we should include this as a basic part of our platform.</p>
  <p>When not all recipients of an email message have a PGP key, the message needs to be sent in cleartext, and PGP can only be used to sign the
    message, so that recipients can check from whose computer (or in this case, from whose sockethub server) it was sent.</p>
  <p>When the sender knows the PGP keys of all recipients, the message can be encrypted before it is signed and sent, to protect it from
    third parties reading the content of the messages. They will still of course be able to detect the fact that a message was sent at a
    certain time, and roughly what length it had, but it's still a vital improvement over the current situation where commercial companies
    and random nation state governments have, by default, full access to spy at will on pretty much everything we do online.</p>

<h3>Inbox search</h3>
  <p>A feature which many current GMail users will have grown fond of, is inbox search. For now, I am using <code>grep</code> to search through
    my emails on the filesystem of my server, and although it's not as good as GMail search, this still actually works pretty well on the whole.</p>
  <p>In the future we may want to generate search indexes based on keywords or at least based on sender/recipient pairs, to make search easier.</p>
  <p>And as more and more people will (one day!) start joining the No Cookie Crew, using their own home grown unhosted email apps, and submitting
    improvements back and forth to these apps, we will probably also see support for sorting by topic using tags and/or mail folders, as well as
    hopefully nice integrations with unhosted addressbook apps.</p>
  <p>I guess the main message here is, it works, but there is still quite a long way to go before most of you who read this will be ready
    to start using your own unhosted email app.</p>
  <p>But email and PGP are an essential part of decentralized online freedom, and it is important that a few of us live through these growing pains
    so that, as Eben said in the FOSDEM <a href="https://fosdem.org/2013/interviews/2013-bdale-garbee-and-eben-moglen/">interview</a>,
    "by the time you know you need a FreedomBox, we will have it ready for you." The No Cookie Crew is looking for brave pioneer members, to make this
    true also for unhosted web apps. :)</p>
  <p><a href="https://groups.google.com/forum/#!topic/unhosted/DkaJornuhnk">comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-10" "id="#episode-10" href="#episode-10">10.</a> Linking things together on the world wide web</h2>

<!-- linking: Linking things together on the world wide web -->
      <p>(<a href="http://unhosted.bencharp.com//page/10-web-linking,10.html">en Fran&#231;ais</a>)</p>
<h3>The web as a database</h3>
<p>If, like me, you got into unhosted web app development from the software engineering
  side, then you will have to learn a few tricks to make that switch. First of all, of 
  course, JavaScript and the Document Object Model (DOM) that we manipulate with it,
  lend themselves much more to asynchronous, event-driven programming than to procedural
  or object-oriented programming.</p>
<p>Organizing variables in closures instead of in classes and weaving code paths from callbacks
  all takes a bit of getting used to. Recently, there is a move towards
  <a href="https://en.wikipedia.org/wiki/Futures_and_promises">promises</a> which makes this
  a bit more intuitive, but as always when you switch programming platforms, you can learn the
  syntax in a day, but learning the mindset can take a year.</p>
<p>This is not the only paradigm switch you will have to go through, though. Remember the web
  was originally designed as a collection of interlinked hypertext documents. Links are its most
  basic atomic structure. This implies two big differences with traditional software engineering.</p>
<p>First, each data record, or in web terms each document, refers to other records using pointers
  that live in the untyped global namespace of URLs, and that may or may not work.</p>
<p>Second, the data is not enumerable. You can enumerate the data that is reachable by following
  links from one specific document, but you can never retrieve an exhaustive list of all the web's content.</p>
<p>Of course, both these characteristics can be overcome by restricting the data your app uses to
  one specific DNS domain. But in its design, the web is open-ended, and this makes it a very
  funny sort of database.</p>

<h3>In-app content</h3>
<p>Suppose you develop an app for a newspaper, which allows people to read issues
  of that newspaper on a tablet, in a "rich" way, as they say, so with a responsive, full-screen
  layout and with interactive use of swipe gestures, etcetera. You would probably split this into
  a "shell", which is all the parts of the app that stay the same, and "content" which is the
  actual content of that day's newspaper issue, so the text, images, etcetera.</p>
<p>If you were to develop such an app using non-web technology, then the newspaper content would
  be locked into the app, in the sense that the user would not have an obvious way to share a
  specific newspaper article with a friend. But if you develop this app as a web app,
  then linking to content would suddenly be easy.</p>
<p>The user should be able to exit full-screen mode at any point, and see a URL in the address bar
  that uniquely identifies the current content of the screen. In a hosted web app, this URL can be
  relative to the currently logged-in user, as determined by the Cookie.</p>
<p>In an unhosted web app, there is no Cookie, and no logged-in user. However, there can be state
  that is relative to for instance a remoteStorage account that was connected to the app at runtime.</p>
<p>The URL in the address bar will change when a user clicks a link, but you will often want to design
  your app so that content is retrieved asynchronously instead of loading a new page on each click. This
  type of app architecture is often called a one-page app, or "OPA". In that case you will need to use
  <a href="https://developer.mozilla.org/en-US/docs/DOM/Manipulating_the_browser_history">history.pushState()</a>
  to update the current URL to reflect the current app state.</p>
<p>Apart from using URLs to represent app state, in a way that allows users to link deeply into specific
  states (pages) of your app, you should also think about the URLs of the data your app retrieves in the background.</p>
<p>This leads us to the next important topic, the web of data.</p>

<h3>Linked data</h3>
<p>As we said earlier, the web started as a collection of hypertext documents, and evolved from there into
  the "html5" app platform we know today. But very early on, the potential of using the web for not only human-readable
  but also machine-readable data was discovered.</p>
<p>Suppose you publish an unhosted web app that contains a map of the world. This probably means you will split your app
  up into on the one hand a "shell" that is able to display parts of a map, and on the other hand the actual map data.</p>
<p>Now thanks to the open design of the web there are two things you can do, which would not be so easy to do on other
  app platforms. First, you can allow other apps to reuse the map data that forms part of your app. Just as long as it
  is in a well-known data format, if you tell other app developers the URLs on which you host the data that your app fetches
  asynchronously, they will be able to reuse it in their apps.</p>
<p>And likewise, you will be able to seamlessly reuse data from other publishers in your app, as long as those other publishers
  use a data format that your app shell can read, and you trust what they publish.</p>
<p>There is no way for the user to easily extract the URLs of data that your app fetches in the background. The developers of other
  apps will have to either study your app to reverse-engineer it, or read your app's API documentation. To make this job easier, it
  is good practice to include documentation links in your data. Many good data formats actually contain this requirement. For instance,
  many of the data formats that our remoteStorage modules use contain an '@context' field that points to a documentation URL. Other
  developers can find those links when looking at the data, and that way they stand a better chance of decyphering what your data means.</p>
<p>There is a second advantage of including documentation URLs inside data: it makes data formats uniquely recognizable. A URL is a Universal
  Resource Locator, but at the same time it can act as a "URI": a Universal Resource Identifier that uniquely identifies a concept as well as pointing to
  a document about it. The chance that your format's unique documentation URL shows up in
  a file by accident is pretty much zero, so if a file contains your URI then that tells the reader
  that the file is indeed claiming to comply with your format, as <em>identified</em> by that string.</p>
<p>In practice, this is not working very well yet because there are a lot of equivalent data formats, each with their own URI, that overlap and
  that could be merged. For instance, Facebook publishes machine-readable data about users with the URI
  "<a href="http://graph.facebook.com/schema/user">http://graph.facebook.com/schema/user</a>" in there. This URI is Facebook-specific, so it doesn't 
  help a lot in generalizing the data format. Of course, the data that Facebook exposes <em>is</em> in large part Facebook-specific, and there is no
  obviously good way to map a Facebook Like to a Twitter Retweet, so this is all partially inevitable.</p>

<h3>Emerging intelligence is a myth</h3>
<p>A lot of things that computers do seem like magic. If you are not a programmer (and even if you are) then it's often hard to predict what computers
  will be able to do, and what they won't. Specifically, there seems to be a belief among the general public that machine-readable data allows a machine
  to "understand" the data, in the sense that it will be able to adopt to fluctuations in data formats, as long as those fluctuations are documented in
  ways that are again machine-readable. I'm sorry if this is news to you, but that is simply not true.</p>
<p>It all stands and falls with how you define "understanding" of course, but in general, the rule of thumb is that each app will have a finite list of
  data formats it supports. If a data format is not in this list, then the app will not be able to make sensible use of data in that format, in terms of
  the app's functionality. The app developer has to put support for each data format into an app one-by-one, writing unit tests that describe each significant
  behavioral response to such data, and if those tests pass, then the app supports the new data format.</p>
<p>Once a data format is supported, the app can read it without supervision of the programmer (that is what we mean by machine-readable), and using the URIs,
  or other unique markers, it can even detect on the fly, and with reasonable certainty, <em>if</em> a document you throw at it was intended by its publisher
  to be in a certain data format.</p>
<p>But an app cannot learn how to react to new data formats. At least not at the current stance of Artificial Intelligence engineering.</p>
<p>The only exception to this are "data browser" apps: their only task is to allow the user to browse data, and these apps process whole families of data formats
  because all they have to do with them is maybe a bit of syntax highlighting or at most some data type validation. They do not interact "deeply" with the data,
  which is why they can deal with data from any domain - the domain of the data is simply irrelevant to the app's functionality. Even so, even those apps cannot
  learn to read json formats, however compliant and self-describing the format, if they were designed to read xml formats.</p>

<h3>Hash URIs and 303s</h3>
<p>There is a school in web architecture (I always half-jokingly call it the "URI purism" school), which states that whenever you use a URL as a URI (i.e., to
  denote a concept), then you may not call it a URL (you have to call it either URI or URN), and it should either have a hash ('#') in it, <em>or</em> respond
  with a 303 status code. I don't see the point of this; everybody outside of URI purism just uses URLs without these imho random complications, which is
  a lot simpler and works fine, too.</p>
<p>I'm only mentioning this here for completeness, not as an actual recommendation from my side. :)</p>


<h3>Design each convention independently</h3>
<p>For a programmer, there is often no bigger joy than inventing something from scratch. Trying to come up with the ultimate
  all-encompassing solution to a problem is fun.</p>
<p>We already saw this effect in <a href="/adventures/1/Personal-servers-and-unhosted-web-apps.html">episode 1</a>; when faced
  with the problem of closed Social Networking Sites (SNSs), most programmers will set out to build an open SNS system from scratch.</p>
<p>But it's not how we should be developing the web platform. The web is extensible, and we have to add small pieces bit-by-bit,
  letting each of them win adoption or not, based on what that small piece does.</p>
<p>This makes developing the web platform a bit harder than developing a closed platform. At the same time, it leads to a more
  robust result.</p>
<p>To make this a bit clearer, I will give two examples. First, suppose we want to allow users of a remoteStorage-based app to
  set an avatar for themselves, and display avatars of their friends. We could for instance add  <code>setAvatar()</code> and
  <code>getAvatar()</code> methods. We then submit this addition to the <code>remoteStorage.profile</code> module upstream,
  and this way, other remoteStorage-based apps can use the same avatars in an app-independent way.</p>
<p>But we can do even better: we can use the avatar people advertise in their webfinger profile. That way, the system we use for
  avatars is independent of remoteStorage as a specific storage API.</p>
<p>The other example I want to give is the separation of data formats and interaction protocols. For instance, an ActivityStreams
  document can be published in an atom feed or in many other ways, and likewise many other data formats can be used when publishing
  data through an atom feed; these two things are independently swappable building blocks. This flexibility is what sometimes makes
  the web chaotic as an application platform, but ultimately it's also what makes it very decentralized and robust.</p>
  
<h3>Read-write web</h3>
<p>We can take the avatar-example from the last paragraph even a bit further. By adding a link from their webfinger file to a
  public document on their remoteStorage account, users can still edit their avatar using remoteStorage. We added support for
  Content-Type headers to <a href="https://tools.ietf.org/id/draft-dejong-remotestorage-01.txt">draft-dejong-remotestorage-01.txt</a>
  specifically to make the data on a user's remoteStorage account be data that is fully "on the web" in every sense, and to make
  things like this possible. It turns the user's remoteStorage account into a "read-write web" site: a
  website, where the content can be edited over its normal primary http interface, using verbs other than GET (in our case PUT
  and DELETE).</p>

<h3>Semantic markup</h3>
<p>There is one last thing I want to mention about the architecture of the web: documents that are primarily human-readable, but also
  partially machine-readable. Whenever you publish a human-readable document, it is good practice to add some machine-readable links
  inside the html code. This page for instance has a link to the atom feed of this blog series, and a machine-readable link to my own
  Indie Web site, with a link-relation of "author".</p>
<p>This means for instance that if you have the 'Subscribe' button 
<a href="https://support.mozilla.org/en-US/kb/customize-firefox-controls-buttons-and-toolbars#w_how-do-i-customize-or-rearrange-toolbar-items">enabled on your Firefox toolbar</a>,
  you will see it light up, and your browser will be able to find the machine-readable
  atom feed through which updates to this blog will be published. Likewise, search engines and other "meta" websites can display
  meta-data about a web page just by parsing these small machine-readable hints from the html. Google also provides instructions on
  <a href="http://support.google.com/webmasters/bin/answer.py?hl=en&answer=173379">how to mark up recipes</a> so that they will become
  searchable in a "deep" way.</p>
<p>As an unhosted web app developer you will probably deal more with documents that are already primarily machine-readable, but it's
  still an important feature to be aware of, that one document on the web can form part of the human-readable document web, and of the
  machine-readable data web, at the same time.</p>

<h3>Conclusion</h3>
<p>The loosely coupled architecture of web linking is an essential part of its power as a platform, but mainly also it is what gives
  the web its openness. The web is what people do in practice. Some technologies will need support from browser vendors, in which case
  it may for instance happen that Firefox and Chrome both implement a version of the feature, then compare notes, choose one standard version of
  the feature, and document that so that other browsers can implement it too.</p>
<p>For features that require no changes to how browsers work, literally anyone can try to start a convention, blog about it, and try
  to convince other people with the same problem to join in. It is a truly open system.</p>

<p><a href="https://groups.google.com/forum/#!topic/unhosted/fHxfGOwqtd0">comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-11" "id="#episode-11" href="#episode-11">11.</a> App hosting</h2>

<!-- app hosting: App hosting -->
<h3>Hosting is a telecommunications transport through space and time.</h3>
<p>This blogpost goes from me to you. I am writing this at a Starbucks in Bukit Bintang, on a rainy Saturday.
You are reading this in a different place, at a later time. Hosting is just a transport that makes this possible.</p>
<p>Even when consuming hosted content, we should not forget to design our internet applications with the
<a href="https://en.wikipedia.org/wiki/End-to-end_principle">end-to-end principle</a> in mind. If we want the internet to
empower people, then we should model all communication as taking place between people. This may disrupt a few assumptions that
you will have been fed during the age of hosted software.</p>

<h3>TLS is not secure unless combined with on-premises hosting</h3>
<p>TLS (formerly known as SSL, the technology behind <code>https://</code> URLs), stands for Transport Layer Security.
  It establishes a secure tunnel between the client and the server. Third parties can see that this tunnel exists, and roughly
  how much data travels through it, in which direction, and in which timing patterns, but they cannot see the unencrypted content
  that is being sent back and forth.</p>
<p>On top of TLS, the web uses a Public Key Infrastructure (PKI) based on Certificate Authorities (CAs). This system has
its own problems because it centralizes power,
I'm not even talking about that.</p>
<p>Purely the client-server security architecture in itself is an outdated
approach to security. It makes the assumption that the server is under the physical control of the person or organization publishing
the content. This was probably
true for 90% of the first websites, 20 years ago, but this percentage is probably closer to 10% (or even less) nowadays. This means
we should consider servers as intermediate hops, not end points, in the end-to-end communication model.</p>
<p>The problem is reasonably limited with co-located servers, where the data center hosting your server does not have the root password
to it. In this case, any intrusion would at least be detectable, provided your co-located server has good sensors for "case open"
and similar alerts.</p>
<p>But current-day Infrastructure-as-a-Service hosting provides virtualized servers, not physical ones. This is good because it allows
the IaaS provider to move your server around for load-balancing and live resizing, but it also means that the host system has access to
your private TLS key.</p>
<p>At a good IaaS company, only systems administrators under <a href="https://www.usenix.org/lisa/system-administrators-code-ethics">sysadmin oath</a>
and the management above them will have access to your server. Good managers at IaaS companies will only use their access to grant newly employed
sysadmins the necessary access, and maybe a few nation state governments, in whom society trusts to spy on everybody to help them identify dangerous terrorists.</p>
<p>You can always recognize sysadmins because they will look away with a resolute gesture when you type your password in their presence. Even if it's the
password that you just asked them to reset. It is in a sysadmin's professional genes to be very precise about security and privacy. Still, TLS-hosted
websites
can no longer be sensibly called end-to-end secure in the age of web 2.0 and "the cloud", since the communicating parties (Alice and Bob, as we
often call them) do not have a secure channel between them.</p>
<p>So where does that leave us? Let's look specifically at app hosting.</p>

<h3>Wait, isn't hosting an unhosted web app a contradiction? :)</h3>
<p>Yes, of course, to be very precise, we should have called unhosted web apps 'statics-only web apps', since what we mean is 'web apps whose functionality is not produced by code that <em>runs</em> server-side, even though the <em>source files</em> of the app are still hosted as static content'. But that just didn't sound as intriguing. ;)</p>
<p>The web has no way of signing web apps. When hosting an unhosted ('statics-only') web app, we just serve each of the files that make up the app on a website,
and the only way to know whether you are seeing the web app that the developer wanted you to see, is if the webserver is under the physical control of
the developer. This doesn't often happen, of course (especially with nomadic developers!), so in most cases we will have to compromise a little bit on security.</p>
<p>In practice, security is always relative, and unless you mirror the apps you use, and host them yourself inside your LAN,
in almost all cases we will have to trust at least one intermediate party: the app hoster. There is just one
exception to this: <a href="http://mailman.klaki.net/mailman/listinfo/revprotun">RevProTun</a> systems like Pagekite.</p>

<h3>RevProTun and Pagekite</h3>
<p>If you have a <a href="http://freedomboxfoundation.org/">FreedomBox</a> in your home, or you otherwise run a server that is always-on in a place that you physically
control, then you can put the unhosted web apps you publish on there, hosted on a simple statics server with TLS. You can use a nodejs script for this like the one we
  described in <a href="/adventures/3/Setting-up-your-personal-server.html">episode 3: setting up your personal server</a>. Once you have a TLS-enabled
  website running on localhost, you can
publish your localhost to the world using a RevProTun service. A good example, personal friends of mine and also the main drivers behind the development of RevProTun,
are <a href="https://pagekite.net/">Pagekite</a>. You open a tunnel account with them, install their client app in a place where it can "see" the localhost service
you want to publish, and it will start delivering traffic from the outside world to it, functioning as a reverse proxy tunnel from your publically accessible URL
  to your locally ran TLS-secured statics hosting service.</p>
<p>RevProTun is an important part of how we want to add Indie Web hosting to FreedomBox. These are still future plans for which we always struggle to find time, but we
are determined to make a "freedom-compatible home hosting" solution like this available in a format that is also usable by end-users who may not want to know all the exact
details of how reverse proxy tunnels work. If you do want to know more about them, a good place to start is Bjarni's
<a href="https://pagekite.net/wiki/Floss/Video/">FOSDEM talk about Pagekite</a>. Unfortunately, it seems there has not been a lot of progress on the RevProTun standard since it was proposed in 2012.

<h3>How origins work</h3>
<p>Each web app should be hosted on its own "origin", meaning its own unique combination of scheme, host and port.</p>
<p>The reason for this is that your browser will shield off apps from each other, putting them each in their own limited sandbox.
If you would host two apps on the same origin, then your browser would allow these apps to access each other's data (for instance,
the data they store in localStorage), and then things would generally just become a big mess. So don't ever try to do this. When hosting apps, host each one
on its own origin.</p>
<p>This also means that, even though <a href="https://github.com/dropbox/dropbox-js#readme">dropbox.js</a> and
GitHub are great tools for unhosted web app developers, you don't want to publish any unhosted web apps directly on
<a href="https://tech.dropbox.com/2012/08/some-love-for-javascript-applications-2/">https://dl.dropbox.com/</a>, or host more than
one app on each <a href="http://pages.github.com/">http://username.github.com/</a>, unless maybe if they are apps that will not handle
any user data (for short-lived and self-contained html5 games for instance, this security consideration may be less important).</p>
<p>So suppose you have your Indie Web domain name and you want to publish some unhosted web apps to the world.
For http hosting (without TLS), this is not so difficult to do. Remember an origin is defined by scheme, host and port. The scheme of each app's origin will always
  be 'http', but you can point as many subdomain hosts
to your IP address as you want; especially if you use a
<a href="https://en.wikipedia.org/wiki/Wildcard_DNS_record">wild-card CNAME</a>. Then you can just use
<code>http://app1.example.com/</code>, <code>http://app2.example.com/</code>, etcetera as origins for the apps you host.</p>
<p>If you want to do this properly however, and get at least the amount of security we can despite your server probably being hosted on insecure
IaaS infrastructure, then you should always host apps on https. This brings into play the limitations of which origins your TLS cert will work on.
Unless you own a wild-card certificate, you will probably only have two hosts, probably "something.example.com" and its parent, "example.com".</p>
<p>But luckily, origins are defined by scheme, host, <em>and port</em>. This means you can host tens of thousands of apps using the same cert; simply
use origins like "https://apps.yourdomain.com:42001/", "https://apps.yourdomain.com:42002/", etcetera.</p>

<h3>Using SNI to host multiple TLS certs</h3>
<p>Five or ten years ago SNI didn't exist yet, and you had to get one dedicated IPv4 address for each and every TLS cert.
  Until recently I thought this was still the case, but as Bjarni explained to me the other day, this is now a resolved problem.
  <a href="http://nodejs.org/api/tls.html#tls_npn_and_sni">Using</a>
  <a href="http://en.wikipedia.org/wiki/Server_Name_Indication#Browsers_with_support_for_TLS_server_name_indication.5B5.5D">SNI</a>, you can host as many TLS certs
  on one virtual server as you like, without having to request extra IPv4 addresses and paying the extra fee for them. I hadn't switched to this myself yet, since
  I have published my unhosted web apps apps all through 5apps, but nowadays <a href="https://groups.google.com/d/msg/unhosted/OwyPm1AV47A/T9ObILeq2gsJ">unhosted.org is SNI-hosted together with 3pp.io</a>. I did have two IPv4 addresses on my server, one for nodejs and one for apache,
  and your server will need two IP addresses to do <a href="https://en.wikipedia.org/wiki/STUN">STUN</a> in a few episodes from now (yes! we're going to play with 
  PeerConnections soon), but in general, SNI is a good thing to know about when you're hosting apps.</p>

<h3>5apps</h3>
<p>There is a very cool Berlin start-up, again, also personal friends of mine, called <a href="https://5apps.com/">5apps</a>. They specialize in app
hosting for unhosted web apps. You may have seen them mentioned on our <a href="https://unhosted.org/tools/">tools</a> page, and most of our
<a href="https://unhosted.org/apps/">featured apps</a> are hosted on 5apps. They have just
  <a href="https://blog.5apps.com/2013/02/18/new-subdomains-and-ssl-for-everybody.html">launched</a> support for https hosting last week
  (using their wildcard TLS cert for
*.5apps.com), and deploying your app to their hosting gives you a number of advantages over home-baking your own app hosting. They will automatically
generate an appcache manifest for your app (more about this below), resize your icon for the various favicon formats for browsers as well as for instance
  iPad devices, and generate all the various file formats for submitting your app to various review sites and app stores (more about that next week).</p>
<p>On top of that, they offer a number of things which "make your app nice", like browser compatibility detection, a user feedback widget, and JavaScript
  minification. Statics hosting is a mature market; you can find various companies who specialize in it. But the advantage of 5apps over for instance
  Amazon S3 is that 5apps specialize specifically in the hosting of your unhosted web apps. And like with Pagekite, I can personally confirm that
  they are nice people, who care about re-decentralizing the web. :)</p>
<p>For completeness, let me mention that <a href="https://appcloudy.com/">AppCloudy</a> provide a similar product to 5apps, and there are probably some others.
  StackMob and Tiggzy also offer html5 app hosting as a sideline to their backend service for native mobile apps. As of September 2014, 5apps are the top hit for &quot;html5 app hosting&quot; on both DuckDuckGo and Google, but I will update this section as the market
  evolves (tips welcome!).</p>

<h3>Mirroring and packaging.</h3>
<p>Since the early days of the web, important websites, especially if they contain big downloadable files, have been mirrored. An unhosted web app
  is statics only, so it can be serialized
  as a folder tree
  containing files. This folder tree can be packaged as an FTP directory, a git repo, a zip file, a zip file with a '.crx' extension (as used by Chrome extensions),
  or a bittorrent for example. If you transport it over one or more of those media, then it can easily be mirrored by more than one app hoster.</p>
<p>We call a statics-only web app that is underway from one mirror to another in such a way a "packaged web app".</p>
<p>There is a fascinating aspect in the concept of such packaged web apps: they are robust against attacks on our DNS system.</p>
<p>Sometimes, governments block websites.
  Probably in almost all cases this is done by people who think they are doing the right thing: they really honestly think that Facebook is bad for Vietnam, or that
  Wikileaks is bad for the USA, or that ThePirateBay is bad for the Netherlands, and that such censorship is eventually in the interest of the people who installed them as
  government employees.</p>
<p>Or maybe they honestly think the interests of Communism, or the interests of National Security, or the interests of Entertainment Industry are more
  important than considerations about freedom of communication.</p>
<p>Whatever the reasons of such actions, and whatever the moral judgement on whether Facebook, Wikileaks and ThePirateBay are evil websites, from a technological design
  principle of "kill-switch resilience", it would be nice if we had a way to publish unhosted web apps in a decentralized way.</p>
<p>It would also just be nice from a practical point of view to have a local copy of a lot of information which we often look up online. I am writing this right now in a place
  without wifi, and so far I have made five notes of things I should look up on <a href="http://developer.mozilla.org/">MDN</a> later. If I had a local copy of MDN, that would
  make me a lot less reliant on connectivity.</p>
<p>As an example, let's take Wikipedia. A very big chunk of all human knowledge is on there. You can download a compressed xml file containing all the text (not the images)
  of the English edition. It's about 9 Gigabytes. Massaging this a bit, and adding the necessary rendering code, we could make this into an unhosted web app that can be run
  on localhost, using a simple statics hosting script like the ones we've seen in previous episodes.</p>
<p>The obvious way to distribute such a multi-Gigabyte file would be bittorrent. So that sounds totally feasible: we put huge unhosted web apps into torrent files, and
  everybody can cooperate in seeding them. We could do this for Wikipedia, MDN,
  <a href="https://www.khanacademy.org/">Kahn Academy</a>,
  <a href="http://oyc.yale.edu/">Open Yale Courses</a>, this year's
  <a href="https://youtube.com/results?search_query=%22Edge+Conference+-+Panel%22">EdgeConf panel</a> discussions, any knowledge you would like all humans to have
  <a href="https://en.wikipedia.org/wiki/Hacker_ethic">access</a> to.
  Given how cheap a 1 Terabyte external hard drive is nowadays (about 80 USD), you could even unhost the entire
  <a href="http://www.gutenberg.org/">Gutenberg project</a>, and still have some disk space left.</p>
<p>And of course, you could use this for small apps as well. Even if unhosted web apps cache themselves in your browser when you use them, it would be nice to have an
  app server somewhere inside your LAN that just hosts thousands of unhosted web apps on local URLs, so that you can access them quickly without relying on connectivity.</p>
<p>This is an idea that I started thinking about a couple of weeks ago, and then Nick found out that there is a project that does exactly this!
  :)
  It's called <a href="http://www.kiwix.org/wiki/Main_Page">Kiwix</a>. They use the <a href="https://en.wikipedia.org/wiki/ZIM_%28file_format%29">ZIM</a> file format, which
  is optimized for wiki content. They also provide an application that discovers and retrieves ZIM files, and serves them up on port 8000, so you can open a mirrored version
  of for instance a packaged website about Venezuela on one of your many localhost origins, for instance
  <code>http://127.13.37.123:8000/wikipedia_es_venezuela_11_2012/</code> (remember the localhost IP space is a 
  "/8" as they say,
  it covers any IP address that starts with "127.", so there are enough origins there to host many apps on).</p>
<p>Since then, Rahul Kondi and I did <a href="http://fizno.com/">Fizno</a> as a Torrent-based &quot;physical node&quot; at a hackathon in Bangalore, and later I discovered the existence of the excellent <a href="http://librarybox.us/">LibraryBox</a> build-or-buy project.</p>

<h3>Packaged app hosting conventions</h3>
<p>There are a few conventions that you should keep in mind when writing a webserver that hosts static content. Most of those are well known in web engineer folklore, and
  if you use software like Apache or node-static, then this will all just work automatically by default.</p>
<p>A packaged web app, regardless of whether it is packaged into a torrent file or a zip file or git repository, is a folder 
  with documents and/or subfolders. Each subfolder can again contain more documents and subfolders.
  No two items in one same folder can have the same name, names are case-sensitive, and although in theory all UTF-8 characters should be
  allowed in them, you should be aware of the escape sequences
  required by the format in which you are packing it up.
  <!-- Nesting depth and
  string length of each name are in theory unlimited, but in practice the maximum total length of the resulting concatenation should not exceed 2000 characters.
  -->
  Of course the documents in this folder structure
  map onto documents that should be made available over http 1.1, https, http 2.0 and/or SPDY, splitting the URL path along the forward slashes, and mapping that onto the folder structure, taking
  into account again the escape sequences defined for URIs and IRIs.</p>
<p>The file extension<!--(the document name's shortest suffix that starts with a '.')--> determines which 'Content-Type' header should be sent. A few examples:</p>
<ul>
  <li><code>.html</code> -> <code>text/html</code></li>
  <li><code>.js</code> -> <code>application/javascript</code></li>
  <li><code>.css</code> -> <code>text/css</code></li>
  <li><code>.png</code> -> <code>image/png</code></li>
  <li><code>.svg</code> -> <code>image/svg+xml</code></li>
  <li><code>.jpg</code>, <code>.jpeg</code> or even <code>.JPG</code> -> <code>image/jpeg</code></li>
  <li><a href="https://www.iana.org/assignments/media-types">etcetera</a></li>
</ul>
<p>The server should also set a character set header (<a href="http://www.openwebdevice.com/partners/pages/hosting.html">usually UTF-8</a>),
  and then make sure it also serves the contents of each document in that character set.</p>
<p>To allow the browser to cache the files you serve, and then retrieve them conditionally, you should implement support for ETag and If-None-Match headers.</p>
<p>Whenever a URL maps to a folder (either with or without a forward slash at the end) instead of to a document,
  if an index.html document exists in that folder, you should serve that.</p>
<p>If the requested document does not exist, but one exists whose full path differs only in case (e.g. <code>foo/bar.html</code> was requested,
  but only <code>Foo/Bar.html</code> exists), then redirect to that.</p>
<p>Apart from that, if a URL maps to no existing item, serve either the '404.html' document from the
  root folder if it exists, or some standard 404 page, and in this case of course send a 404 status instead of a 200 status.</p>
<p>Additionally implementing support for Byte-ranges is nice-to-have, but not essential.</p>

<h3>Caching and the end-to-end principle</h3>
<p>Appcache is a way for a web app to tell a browser to pro-actively cache parts of it. It is still a relatively new technology, and if you want to know
  how it got its nickname of 'appdouche cachebag', you should definitely watch at least the first 10 minutes of this video:</p>
<script>
  function showVideo(that) {
    that.innerHTML = '<iframe width="560" height="315" src="http://www.youtube.com/embed/Oic22dQMRXQ" frameborder="0" allowfullscreen></iframe>';
  }
</script><h4 style="text-align: center" onclick="showVideo(this);">(show http://www.youtube.com/embed/Oic22dQMRXQ)</h4>
<p>An improved successor to Appcache is being prepared with <a href="https://github.com/slightlyoff/ServiceWorker">ServiceWorkers</a>, but these are not yet usable in mainstream browsers.</p>
<p>One good thing about appcache is that, like the browser's http cache, it works end-to-end. The web of documents was designed with caching of GET requests
  in mind. A lot of hosted web apps will cache the content produced by their webservers using something like <a href="http://www.squid-cache.org/">squid</a>
  or <a href="http://www.varnish-cache.org/">varnish</a>, behind an https offloading layer. Often, this will be outsourced to a
  <a href="https://en.wikipedia.org/wiki/Content_delivery_network">CDN</a>. After that, in theory researchers thought that multicasting would become big on the
  internet, but this didn't really happen, at least not for web content. Instead, content providers like youtube and CDNs like Akamai extended their tentacles
  right into the exchange hubs where they peer with ISPs. In a sense, we have the multicast backbone that academia tried to develop, but it's now privately
  owned by companies like the two I just mentioned.</p>
<p>So once the content reaches the ISP, it will often be cached again by the ISP, before it is delivered to the Last Mile. None of this works when you use end-to-end
  encryption, though. Multicasting traffic is a lot like deduplicating content-addressable content, only harder because of the time constraints. And 
  as the rule of thumb goes, out of 1) end-to-end encryption, 2) multicast(/deduplication), and 3) making sense, you can only pick two. :)</p>
<p>Using <a href="https://en.wikipedia.org/wiki/Convergent_encryption">convergent encryption</a>, a form of encrypted multicast would be possible if you only care about protecting the contents of secret document, but this would still allow eavesdroppers on the same multicast tree to discover which documents you are streaming, so such a setup wouldn't be as private as a https connection.</p>

<p>This means that on https, any request that misses cache on your device, will have to make the round trip
    all the way to the app hoster. Mirroring can decrease the distance between the app hoster and the user, but whenever that distance causes page load times to be
    noticable (say, multiple tenths of a second), the thing you will want to use is <a href="http://appcachefacts.info/">appcache</a>.</p>

<h3>The appcache discussion</h3>
<p>First of all, when you use appcache you should only cache the "shell" of your entire app, so all its layout and functionality,
  but not any content it may include (this is also explained in the video above). For caching content that may be relevant this session, but already replaced next time
  the user uses the app,
  you may want to implement your own custom caching system inside your app, using for instance
  <a href="http://pouchdb.com/">PouchDB</a>  or <a href="http://brian.io/lawnchair/">LawnChair</a>.</p>
<p>As is also mentioned in the video, Mozilla and Google are cooperating to 'fix appcache'. There will probably be a more powerful API with less surprises.</p>
<p>The result of using appcache though, once you get used to deployed changes <a href="http://alistapart.com/article/application-cache-is-a-douchebag">not showing up</a> on the first refresh, is amazing. Your apps will Just Work,
  even if there is no wifi connection. And if there is a wifi connection, then they will load very fast, much faster of course than if you wouldn't cache them.</p>

<h3>Conclusion</h3>
<p>Sorry if this episode was a bit long, but
  I think this covers most of the topics you have to keep in mind about app hosting. One of the nice things of unhosted web apps is that they are so easy to host,
  you don't have to set up a backend with database servers etcetera. This also makes them very cheap to host, compared to hosted web apps
  (in the sense of 'dynamic' web content as opposed to 'static' web content).</p>
<p>Unhosted web apps are also easier to mirror for kill-switch resilience, and they are very suitable as a cross-platform alternative for native smartphone
  apps and native tablet apps.</p>
<p>Next week we will put together what we discussed about linking and hosting, and talk about how with unhosted web apps, the web itself becomes an app store.
  See you then! :)</p>

<p><a href="https://groups.google.com/forum/#!topic/unhosted/l3lbe0RP4o8">comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-12" "id="#episode-12" href="#episode-12">12.</a> App discovery</h2>

<!-- app discovery: App discovery -->
<h3>App discovery (was: App distribution).</h3>
<p>So you developed an unhosted web app, and it's ready for your potential future customers 
  to get your app onto all their nice and shiny mobile, portable, and transportable devices.
  So to make that happen, you should "distribute" your app through an app store, or some other
  kind of app distribution channel, right? No. Wrong.</p>
<p>This is the web, it gets
  it power from being slightly different from conventional software platforms. In the last two
  episodes we talked about web linking and app hosting. And if you combine them, then you already
  have all you need. But with a huge advantage: the web is open.</p>
<p>The web is open-ended, in that it has no boundary that defines where it stops. It can go on and
  on into virtual infinity.</p>
<p>But it also has an "open beginning", so to speak. The web is a graph where most other systems are trees, as
  Melvin likes to say.</p>
<p>So what is needed for your potential future users to be able to launch your app? Exactly those two 
  things: web linking and app hosting. They will need a hyperlink to the URL on which your app is hosted,
  that's all. It's not a coincidence that I brought these three episodes up in this order. :)</p>
<p>So we will not talk about how to distribute your product. Apart from the mirroring we discussed last week, content distribution happens via URLs on the web. We will instead talk about how to make
  it discoverable, assuming that you are hosting it somewhere.</p>

<h3>Hyperlink style guides (was: Manifest files).</h3>
<p>A web app manifest is a small file that you need for "putting a web app onto your device".
  Right? No. Wrong again. It's a guide for <em>styling</em> something that is essentially just a good old hyperlink.</p>
<p>In hypertext, a link is presented to the user as a (usually underlined) anchor text. The anchor text is
  supposed to describe, in the context of the current document, what you will see when you click on the link.</p>
<p>For linking to apps, we would like to do a bit more. Often, the link will be presented in a loose context
  (for instance, an unstructured list like on our <a href="https://unhosted.org/apps/">examples page</a>), and as
  the app publisher you will have some ideas on how you want your product to appear in such listings. That is why
  app publishers often provide a sort of "hyperlink style guide", which describes "if you are going to publish a
  link to my app, then please do it in this and this way".</p>
<p>There are several formats for publishing such a hyperlink style guide; they are called manifest files in web app lingo.
  The two prime examples are the <a href="https://marketplace.firefox.com/developers/docs/manifests">Open Web App</a> format
  <a href="https://dvcs.w3.org/hg/app-manifest/raw-file/tip/index.html">proposed</a>
  by Mozilla, and the <a href="https://developers.google.com/chrome/apps/docs/developers_guide#live">hosted Chrome app</a>
  format proposed by Google.</p>
<p>At the end of the day, these style guide formats are very simple: they basically define a few icons in various sizes,
  the preferred name to display, in the right spelling and capitalization, and some other additional fields, like maybe a
  short description of the app and of its author. And of course the URL of the app itself, which is what the hyperlink should link to.</p>
<p>Both these manifest file formats also let you predict which elevated privileges (like geolocation or webcam access) your app will
  request once the user clicks on the
  hyperlink, but this is a silly thing to put into a hyperlink style guide, for reasons we'll discuss below. So let's ignore that part for now.</p>
<p>You might be a bit surprised that there are various alternative proposals for this "hyperlink style guide" format that we call manifest
  files: why can't we just agree on one common format for this?
  I was also surprised by this splintering, but once you realize how simple and basic these files are, it becomes obvious that it's trivial
  to just provide your style guide
  in both formats, and that in practice this is simply just a very small problem that hasn't made itself very urgent to resolve yet.
  It's probably even possible to create one JSON document that will work as both formats, just make sure your <code>launch_path</code>
  field matches the URL path of your <code>app.launch.web_url</code> field. The topic of these many formats was also briefly discussed
  in the "Privileged Access" panel at EdgeConf (see minute 20:40 and further):</p>
  <script>
  function showVideo(that) {
    that.innerHTML = '<iframe width="560" height="315" src="http://www.youtube.com/embed/ytJKdipILiU" frameborder="0" allowfullscreen></iframe>';
  }
</script><h4 style="text-align: center" onclick="showVideo(this);">(show http://www.youtube.com/embed/ytJKdipILiU)</h4>
<p>Also, when you host your apps on 5apps, you will have a tool there for generating manifest files automatically, in
  the latest version of both formats.</p>

<h3>Review sites (was: App stores).</h3>
<p>What, so that's it? What about the whole thing with the app stores? How can people use my app if I don't put it into all the major app stores?</p>
<p>If you look at what app stores are and what they do, they are actually nothing more than review sites. Or maybe something in between a review
  site, a directory, a portal, and a search engine.</p>
<p>People go to an app store to find links to apps. Often, there will be a certain chain of trust at play there: the user trusts a certain review site
  (app store), and the review site has reviewed a certain app and not found any obvious malware in it, so the user can be a bit more certain that the
  app they launch is relatively trustworthy.</p>
<p>On our Indie Web sites, we can also all present lists of apps that we recommend. It will give our friends some more information about which apps might
  be worth trying out - a bit like a Retweet or a Like. All you need is a hyperlink.</p>
<p>Given that we have these hyperlink style guides we talked about earlier, let's try to create a bit of javascript that generates nice styleguide-compliant
  html on the fly. Here is one for Open Web App manifest files:</p><pre><code>
&lt;!DOCTYPE html>
&lt;html lang="en">
  &lt;body>
    &lt;a class="launchbutton" data-hyperlinkstyleguide=
        "https://editor-michiel.5apps.com/michiel_editor.webapp"
      href="https://editor-michiel.5apps.com/">editor&lt;/a>
  &lt;/body>
  &lt;script src="/adventures/12/launchbutton.js">
  &lt;/script>
&lt;/html>
</code></pre>
<p>If you include this into your website (you might want to copy the
  <a href="launchbutton.js">launchbutton.js</a> file and host it yourself), that script will look for the <code>data-hyperlinkstyleguide</code>
  attribute on any element that has the "launchbutton" class, and make what would have been a normal link:</p>
  <div style="text-align:center">
    &hellip;
    <a href="https://editor-michiel.5apps.com/">editor</a>
    &hellip;
  </div>
<p>look more like this instead:</p>

  <div style="text-align:center">
    <a
        class="launchbutton"
        data-hyperlinkstyleguide="https://editor-michiel.5apps.com/michiel_editor.webapp"
        href="https://editor-michiel.5apps.com/"
    >(if you see this then wait a little bit or check the console...)</a>
    <script src="/adventures/12/launchbutton.js"></script>
  </div>

<p>As you can see, there is nothing stopping you from being an app store yourself! Just add a bit of rounded corners and
  drop shadow to your hyperlinks. ;) If you do this, then you should consider one thing: the value of
  a portal site is in the things that are not on it. The Apple platform is so popular <em>because</em> it is closed. The fact that "fart apps" are banned
  from the iOS App Store is what sets the quality level. Building a strict and prestigious portal site is not evil, it is a good thing. What is regrettable
  about the Apple platform is that it locks in hardware choice with software choice, and that it takes an extortionate profit margin, made possible
  by this monopoly situation.</p>
<p>But in itself, rejecting apps from your recommendation list, if it is done with the user's interests in mind, can lead to a sort of Michelin guide to
  unhosted web apps. You just have to look at the value of Debian ("if it's in Debian, then you can be sure it's stable"), to see a precedent of this in the
  free software world.</p>

<h3>System apps (was: packaged web apps).</h3>
<p>Last summer, Google decided to hardcode their Chrome Web Store into their Chrome Browser as the only allowed source of packaged web apps.</p>
<p>A packaged web app is a zip file containing the static files that make up an unhosted web app. It is essentially the same as a browser extension, add-on,
  or plugin in many ways. At first I was quite
  <a href="https://groups.google.com/a/chromium.org/d/topic/chromium-apps/AZcMm413xww/discussion">upset about this</a>,
  but after thinking a lot more about app discovery, and watching the
  "Privileged Access" panel from EdgeConf embedded above, in my head I have assigned a different interpretation to this move.</p>
<p>Chrome packaged apps should be regarded as "System apps". Through the elevated priviliges they can get at install-time, they form a part of the actual Chrome
  operating system, not of the content you visit with it.</p>

<p>Both manifest formats we saw earlier provide ways to describe <em>as part of</em> the hyperlink that the manifest provides styling for,
  some elevated permissions the app would like to request upfront, if opened from that specific hyperlink. This would then presumably not change the behavior for
  when you visit the web app directly by typing its URL in the address bar.</p>
<p>In general, when you visit a website, you want to interact with that website irrespective of which link lead you there. The website
  should not suddenly be able to turn on your webcam just because you arrived at that website through a link with a high PageRank. ;)</p>
<p>The mechanism for asking you to allow geolocation or webcam access
  should be something that's equal for all websites you visit, and should not be influenced
  by any sort of nepotism from the device or browser manufacturer.
  Remember "launch buttons" are still just hyperlinks that lead you to web pages in an open-minded way. We are still talking about content on the web, and the web is an
  <em>open</em> space where every DNS domain name is in principle equal in its ability to host content, even if nobody important links to it.</p>

<p>But as web technology makes it deeper into our operating systems, we encounter a need for web apps that are more a part of our actual devices, rather than being part of
  the content of the web. Firefox OS has the concept of
  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Firefox_OS/Security/Installing_and_updating_applications">Core Applications</a>, like the
  <a href="https://github.com/mozilla-b2g/gaia/blob/master/apps/communications/manifest.webapp">Dialer</a>, and the
  <a href="https://github.com/mozilla-b2g/gaia/blob/master/apps/settings/manifest.webapp">Settings</a> dialogs. They have to be distributed through the
  same channel as the operating system itself of course, since they are on the "system" side of the operating system's application sandbox barrier.
  Otherwise you can't design a stable device operating system.</p>
<p>Apart from the fact that they use the same technology, system apps are an entirely different game from the unhosted web apps that you run as applications. It makes
  sense for system apps to be packaged rather than hosted, because you ship them as pluggable parts of a device operating system, and not as generic
  unhosted "userland" software.</p>
<p>For all applications other than system apps, it makes sense to use (statics-only) app hosting rather than packaging, since that way their components are not locked in,
  and users can use all the standard web tricks to, for instance, view their source code, or refer to the app, or to some of the content inside the app, with a
  normal hyperlink as we've always done.</p>

<p>In any case, try out the "launchbutton.js" file I showed above, and link to some apps from your website. App hosting and web linking should be all you need here.
  The web doesn't need a new "app distribution layer" like Apple's iOS App Store. The web <em>already is</em> one big, infinite app store.</p>
<p>I hope this episode was not too opinionated or too confusing, so <a href="https://groups.google.com/forum/#!topic/unhosted/GuAkJxTRsf0">comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-13" "id="#episode-13" href="#episode-13">13.</a> Dealing with users in unhosted web apps</h2>

<!-- users: Dealing with users in unhosted web apps -->
<h3>Database sharding.</h3>
<p>When you design a hosted web app, all data about all users goes into your database. You probably have a <code>users</code> table that contains the password
  hashes for all valid usernames on your website, and maybe some profile information about each user, like email address and full name, as
  supplied when the user signed up. If you allow users to sign in with Persona, Facebook, Twitter, Google, or github, then your <code>users</code> table would have
  columns linking to the user's identifier at their identity provider.</p>
<p>Depending on the type of application, there will be various other tables with other kinds of data, some of which will be keyed per user, and some of
  which will not. For instance, you may have a <code>photo_albums</code> table, where each photo album is owned by exactly one user, so that the <code>owner_id</code>
  field in the <code>photo_albums</code> table refers to the <code>user_id</code> of the owning user in the <code>users</code> table.</p>
<p>Other tables may be unrelated to specific users, for instance you may have a <code>cities</code> table with information about cities where some sort of
  events can take place in your app, but you would not have an <code>owner_id</code> field on that table like on the <code>photo_albums</code> table.</p>
<p>Tables where each row is clearly owned by, or related to, a specific user-id can be
  <a href="http://en.wikipedia.org/wiki/Shard_%28database_architecture%29">sharded</a> by user-id. This means you split up the table into, say,
  100 smaller tables, and store photo albums owned by a user-id ending in, say, '37' in the table named <code>photo_albums37</code>. For small websites this is
  not necessary, but as soon as you start having about a million rows per table, you need to shard your application's database tables in this way.</p>
<p>If you use Oracle as your database software, then it will do this transparently for you. But most hosted web applications use a database like for instance MySQL,
  for which you have to do the sharding in your backend code. Once a table is sharded, you can no longer do full-table searches or JOINs. Each query to a sharded table will have to have a 'WHERE owner_id=...' clause. I learned
  this while working as a scalability engineer at <a href="http://corporate.tuenti.com/en/corporate">Tuenti</a>, before starting to think about unhosted web apps.</p>

<h3>Per-user data</h3>
<p>In a big hosted web app, data is generally stored and accessed per-user, with no possibility to take advantage of the fact that you have all the data of all users
  in one centralized place. Only generic information (like the <code>cities</code> database), and search indexes will usually be designed in a way that does not shard
  the database architecture per-user.</p>
<p>It was this realization that made me think that per-user data storage could be possible, and through conversations with Kenny
  (the original programmer of Tuenti's website), got the idea to start this research project. Since that day, and alongside
 many <a href="https://unhosted.org/people/">people who joined</a> the 'unhosted web apps' movement that it grew into,
  I have dedicated myself to trying to save
  the web from web 2.0's platform monopolies, whose business model is based on putting the data of as many users as possible in one centralized place that they
  control.</p>
<p>As a group, we then developed <a href="http://remotestorage.io">remoteStorage</a>
  as a way for unhosted web apps to store data of the <em>current</em> user in a place that
  this user decides at run-time. This does not, however, say anything about how the app can refer to other users, and to data owned by those others.</p>

<h3>Webfinger</h3>
<p>To let the user connect their remoteStorage account at run-time, we rely on
<a href="http://en.wikipedia.org/wiki/Webfinger">Webfinger</a>. This is a simple protocol that allows the app to discover the configuration
  parameters of the current user's remoteStorage server, based on a <code>user@host</code> identifier. It also allows any app to directly discover public profile data
  about any user, like for instance their full name, public PGP key, or avatar URL.</p>
<p>There is some controversy, and a lot of bikeshedding, about how to use Webfinger records to refer to a user on the web. One option is to consider
  <code>acct:user@host</code> as a URL (the Webfinger spec, at least in some of its versions, registers <code>acct:</code> as a new URI scheme). Another option is
  to use the <code>user@host</code> syntax only in user-facing contexts, and use the actual document location (with either <code>https:</code> or <code>http:</code> as
  the scheme) when constructing linked data documents.</p>
<p>In order for Webfinger to work well, the data offered in a Webfinger record should be user-editable. For instance, if a user wants to publish a new PGP key, they should
  have an easy way to do that at their identity provider. Currently, the easiest way, if not the only way, to have full control over your Webfinger record, is to host it
  yourself, on your Indie Web domain.</p>
<p>It is quite easy to add a Webfinger record to your domain, simply follow the instructions in <a href="http://tools.ietf.org/html/draft-ietf-appsawg-webfinger">the
  Webfinger spec</a>.</p>

<h3>Contacts</h3>
<p>Many apps will give users a way to connect and interact with each other. For this we defined the
  <a href="https://github.com/remotestorage/modules/blob/master/contacts.js">remoteStorage.contacts</a> module. It acts as an addressbook, in that it allows an app to store
  basic contact information about other users.</p>
<p>Storing the current user's contacts in <code>remoteStorage.contacts</code> has two big advantages: it keeps this personal and possibly sensitive data under the user's
  control, rather than under the control of the app developer, and it allows multiple apps to reuse one same addressbook.</p>
<p>You could write a social unhosted app to retrieve your friends list from Facebook (you would have to add this as a verb on Sockethub's Facebook platform), and store them on your remoteStorage. You could then set a contact from your
  addressbook as a target for something you post (and the message would automatically be sent via Facebook chat if it's a Facebook contact).</p>
<p>This could then be made into a generic messaging app, from where you can contact any of your friends from one addressbook, seamlessly across the borders of Facebook, Twitter and email.</p>

<h3>User search</h3>
<p>Another goal is to create an unhosted web app that contains index data for the public profiles of millions of people, again, seamlessly spanning across various platforms.
  I created a prototype for this last year, and called it <a href="https://github.com/unhosted/useraddress">useraddress</a>. At the time, we were thinking about making this a centralized
  service, but I think it's better to package this index into a bittorrent file, and distribute it to anybody who wants to
  <a href="https://unhosted.org/adventures/11/App-hosting.html">mirror</a> it.</p>
<p>All this is still in a very early stage of development, and currently for most unhosted web apps we still have to type user addresses (like email addresses or Twitter
  handles) from memory each time.
  But we are very determined to get this part working well, because it is often lack of searchability that limits the usefulness of federated social
  servers. And liberating the social graph is a big part of liberating users from the grip of platform monopolies.</p>

<h3>Contacting other users</h3>
<p>The web does not have a way to contact people. It has a way to see other people's profile pages, and to follow updates from them through rss/atom and maybe pubsubhubbub.
  And on a profile page there may be a human-readable contact form, but this is not currently something that is standardized in any way. The closest thing we have to a
  standardized "contact me" link is the <code>mailto:</code> URI scheme, but even this is usually handled by some application outside the web browser.</p>
<p>We could propose a link-relation for this, for instance 'post-me-anything', and thus someone's Webfinger record could have a machine-readable link to a URL to which an
  app can post messages using http POST (it would need CORS headers). But proposing this in itself doesn't help us either, this would only be valuable if a significant number
  of people would also actually implement it on their Indie Web domains.</p>
<p>I am still thinking about what we can do about this situation, and I'm very curious what other people think about this. If you have any ideas about this, or about any other
  topic touched upon in this episode, or you would like to help build unhosted web apps around remoteStorage.contacts, then please reply to the
  <a href="https://groups.google.com/forum/#!topic/unhosted/V6-XKdHbBtU">mailing list</a>!</p>
</div><div class="episode">      <h2><a name="episode-14" "id="#episode-14" href="#episode-14">14.</a> Peer-to-peer communication</h2>

<!-- p2p: Peer-to-peer communication -->
<h3>Routability</h3>
<p>To establish communication between two people, one of them generally has to have a way to find the other. In a client/server situation,
it is generally the client who finds the server starting from a domain name, through a DNS lookup, and then establishes a tcp connection going
out from the client, routed over IP, and into a TCP port on which the server is listening. This requires the server to be listening on a port which
was agreed beforehand (probably a default port for a certain protocol, or one included alongside the server's domain name in a URL), and requires
the server to be online at the time the client initiates the communication, on the IP address advertised in DNS.</p>
<p>Suppose we were to use this system for peer-to-peer communication, where the caller and the callee have a similar device setup.
Unless the callee stays on one static IPv4 address, they would then have to use dynamic DNS to keep their IP address up to date, and would also need to be able to open a public port on their device.</p>
<p>While the first is often possible, the second is often not; especially when you're on the move.
An easy solution for this is to route all incoming traffic to an unhosted web app through sockethub.</p>

<h3>Send me anything</h3>
<p>We already used Webfinger in <a href="../7/Adding-remote-storage-to-unhosted-web-apps.html">episode 7</a>
to announce the location of a user's remoteStorage server. We can easily add an additional line to the user's webfinger record,
announcing a URL on which the user may be contacted. If the goal is to send a message to the user (a string of bytes), then we can use http post for that, or
a websocket. The benefit of using a websocket is that a two-way channel stays open, over which real-time communication ('webrtc') can be established, if it is
upgraded from a WebSocket to a PeerConnection. Here is an example webfinger record that announces a 'post-me-anything' link for http posts, and a 'webrtc' link
for establishing a webrtc control channel:</p>
<pre><code>
{
  "subject": "acct:anything@michielbdejong.com",
  "aliases": [ "https://michielbdejong.com/" ],
  "links": [
    { "rel": "post-me-anything",
        "href": "https://michielbdejong.com:11547/" },
    { "rel": "webrtc",
        "href":"wss://michielbdejong.com:11548/" }
  ]
}
</code></pre>
<p>Both would probably be an end-point on your personal server, not directly on your device, since your
device is usually not publically addressable. But using the 'webrtc' platform module of the <a href="https://github.com/michielbdejong/sockethub">adventures fork</a>
of sockethub, an unhosted web app can instruct sockethub to open a public WebSocket on a pre-configured port.</p>
<p>Any traffic coming into this WebSocket will then
transparently be forwarded to the unhosted web app, and reversely the unhosted web app can send commands to sockethub that will be forwarded back to the contacting
peer. In that sense it's very much like Pagekite - a sort of reverse proxy tunnel. For the post-me-anything handler you could use
a variation on the post handler we set up in <a href="../3/Setting-up-your-personal-server.html">episode 3</a>, when we discussed file sharing.</p>
<p>A <a href="http://social.unhosted.5apps.com/chat.html">small example script</a> allows you to tell sockethub that
you are online and willing to take incoming calls, and also to check if a certain webfinger user is online, and chat with them if they are.</p>
<p>So this simple demo app uses webfinger and sockethub to implement a simple text chat. It's still not very usable, since sockethub was
not really designed to listen on ports;
this means you can have only one chat conversation at a time. But we'll
<a href="https://github.com/sockethub/sockethub/issues/63">work on that</a> and will eventually get it working as a proper chat app,
with an addressbook and everything.</p>

<h3>Caller ID</h3>
<p>So combining websockets with webfinger, participating users can now send byte strings to each other.
Anybody can send any byte string to anybody, just like in email. But unlike email,
right now there is no way to claim or prove a sender identity; every caller appears as an anonymous peer.</p>
<p>The receiver will be able to reply to the real sender
in the http response, or for as long as the caller keeps the websocket open. But other than that, you would have to tell the callee with words who you are,
and also convince them with words that you actually are who you say you are. Both these things could be automated, for instance, the sockethub server could accept
<a href="http://tools.ietf.org/id/draft-prodromou-dialback-00.txt">DialBack</a> authentication.</p>
<p>Dialback is a work-in-progress and currently in expired state,
but it's a very simple way
to find out if a request is from the person it claims to be from, without the need to implement any cryptography, neither on the identity provider side, nor on the
relying party side.</p>
<p>Other options would be using PGP signatures inside the message, or WebID client certificates at the transport level, but both would probably require the help of
the sender's personal server, or the sender's browser would have to be improved to better support such features.</p>
<p>Also, all caller ID systems would break down if the caller's device has been compromised. That problems is usually left out-of-scope in technical solutions to this
problem.</p>
<p>But in general, what we see on the PGP-less email platform is that being able to receive a message from any stranger is a feature, and if that stranger claims
to be 'ebay-central-support.com' then the user could still be tricked in thinking they are from ebay, even with a "secure" caller ID system in place.</p>
<p>Likewise, on irc we usually assume that nobody is going to supplant other people's identities in a public real-time chat, and we often take the things said in the
content of the message as effectively sufficient proof of the sender's identity.</p>

<h3>The universal language problem and the polyglot solution</h3>
<p>If a message arrives as a finite byte string in your inbox, then how do you know how to interpret it? If it came in over http, then there might have been
a <code>Content-Type</code> header included in the requests, that will definitely help in most cases, and usually inspecting the first few bytes, or the filename extension
can give some hints as to what the format of the message might be, but that does not take away the fact that these are hints and tricks derived from common practice.</p>
<p>It is, in a way, only an extension to the collection of human languages which are common knowledge between sender and receiver. Take for instance a file you find
on a <a href="http://wiki.opencaching.us/index.php/Dead_Drop_Caches">dead drop cache</a>. These are USB drives in public spaces where anyone can leave or retrieve
files for whoever finds them. Each file on there is just a string of bytes, and there is no out-of-band channel between the sender and the receiver to give context,
other than the knowledge that the sender is probably human and from planet Earth. The filename extension, and other markers (you could see such metadata as just part
of the byte string making up the message) are conventions which are common knowledge among human app developers on this planet, so an app can often make sense of many
types of files, or at least detect their format and display a meaningful error message.</p>
<p>The problem becomes even more interesting if you look at the ultimate dead drop cache, the
<a href="https://en.wikipedia.org/wiki/Voyager_Golden_Record">Voyager Golden Records</a> which Carl Sagan et al. sent into outer space.
Hofstadter explains this wonderfully in the book "G&ouml;del Escher Bach", alongside many other fundamental concepts of information and intelligence,
as the fundamental impossibility of a "universal language". If there is no common knowledge between sender and receiver, then the receiver doesn't even have a way
to extract the byte string out of the physical object, or even to understand that the physical object was intended to convey a message.</p>
<p>In practice, even though we created a way here for the receiver to know that someone wanted them to receive a certain string of bytes, it is
from there on up to the
app developer to implement heuristics, based on common practice, so that messages in plain utf8 human languages, html, various image, audio and video formats, and maybe
formats like pdf and odf, can all be displayed meaningfully to the user.</p>
<p>There are many such well-defined document formats that are independent of messaging network, data transport, and to some extent even display medium
(e.g. print vs screen). But I cannot think of any that's not based on the habit of transporting and storing documents as byte strings. And many of these document formats
have been designed to be easy to recognize and hard to confuse, often with some unique markers in the first few bytes of the file.</p>
<p>So an app that receives "any message" that is sent to the user should take a polyglot approach when trying to display or interpret the message: try to accept as many
languages as possible, rather than trying to push for one "winner" language. That way we can
separate the document format from the messaging platform.</p>

<h3>Using PeerConnection</h3>
<p>One thing you may want to send to another user over a WebSocket, might be an offer for a WebRTC PeerConnection.
Because making all traffic go through the sockethub server of the callee is not really peer-to-peer. But that's at the same time an important point
to make in general: unless you use a distributed hash table to establish a peer-to-peer messaging session,
the first handshake for such a session always starts with a request to a publically addressable server.</p>
<p>However, using the new
PeerConnection technology, it is possible to upgrade to a shortcut route, once first contact has been made. I attempted to write a
<a href="http://social.unhosted.5apps.com/friend.html">caller</a> and <a href="http://social.unhosted.5apps.com/me.html">callee</a> script to demo this, but ran into some
problems where both Firefox Nightly and Chrome give an error which I wasn't expecting from the documentation.</p>
<p>I'm sure I just made some silly mistake somewhere though,
. This is all still quite new ground to explore - you will probably find some interesting up-to-date demo projects when searching the web. The main point I want to make and repeat is that PeerConnection
is a way to establish a shortcut route between two peers, once first contact has <em>already</em> been established. This will lead to lower latency, and will enable the
use of end-to-end encryption between the two peers. So it's really quite valuable. But it is not a serverless protocol.</p>
<p>Eventually, when we get this working, we will be able to replace Skype, and use an unhosted web app (with a little help from sockethub) instead. Next week we will have
a look at one last piece in the puzzle to complete what I think of as the first part of this handbook for the No Cookie Crew:
after having dumped GMail, Dropbox, Google Docs, Spotify, Facebook,
Twitter, Flickr, and with this episode also having opened the way for dumping Skype,
the last cookied platform we will need to replace in order to cover "the basics" is github. I'm already looking forward to that one, hope you are too.</p>
<p><a href="https://groups.google.com/forum/#!topic/unhosted/1YlbDM57_kU">comments welcome</a>!</p>
</div><div class="episode">      <h2><a name="episode-15" "id="#episode-15" href="#episode-15">15.</a> Unhosted web apps and OAuth</h2>

<!-- unhosted oauth: Unhosted web apps and OAuth. -->
<h3>The unhosted approach to OAuth</h3>
<p>OAuth is a very important recent development on the open web, and maybe partially because of that, also a
  <a href="http://tech.slashdot.org/story/13/03/22/1439235/a-truckload-of-oauth-issues-that-would-make-any-author-quit">troubled</a> one.</p>
<p>Making hosted applications interact with each other in such a way that the user understands the security model is hard. Many casual users of the web don't
  understand what a server is, so it's not easy to explain to them that two instead of one servers will now have access to their data, and what that means.</p>
<p>In this episode of the handbook, we're going to help make the confusion even worse. :) We're going to use unhosted applications to interact with the APIs of hosted ones.</p>

<h3>Terms of Service</h3>
<p>One of the reasons that hosted software presents a fundamental 
  <a href="https://www.gnu.org/philosophy/who-does-that-server-really-serve">violation</a>
  of software freedom is that the user needs to agree to terms of service which are often
unreasonable. Even
though we are creating unhosted software that can replace most hosted software, hosted applications will likely still exists for some time to come, so
we set up a project where we review the terms of service of all the big hosted applications, and rate them for how well they respect consumer rights. It's called
  <a href="http://tosdr.org/">Terms of Service; Didn't Read</a>, and is now an independent project with its own donations budget, run by community of volunteers, and a team
  led by Hugo.</p>
<p>To make the reviewing process easier, we decided we want to build a web form that directly creates pull requests on the github repo of the website. The tosdr.org website
is made up of html, generated from json files using a build script. Previously, it was an unhosted web app that dynamically rendered the views from JSON data,
  but since this was slow to load in most browsers, and the prominent
use case for the website is to access the reviews as read-only documents, we moved the scripts into the build script. The site is now almost entirely static; it is hosted
as static content on 5apps, and you just click through the content without much javascript getting executed.</p>
<p>This means it's not currently possible to edit the website without using a git client. In fact,
  contributing to ToS;DR (both editing the website and participating in comment threads) requires me to log in to github, where both the code and the issue tracker are
  hosted. So far in the preceding episodes we have 
  discussed how to give up hosted applications like GMail, Facebook, Flickr and Twitter, and how to give up native applications like Skype and Spotify, but github is still
  a platform we rely on every day in the life of an unhosted web app developer.</p>

<h3>Cross-origin access to github</h3>
<p>Github exposes an API with which you can do, by the looks of it, everything you can do via its web and git interfaces. For instance, you can create a blob, create a commit,
  and create a pull request to suggest a change to the code in a github repo. This is exactly what we need for tosdr.org.</p>
<p>At first I started adding github as a platform to sockethub, but later I realised that if we use a non-branded OAuth client, plus the 
  <a href="https://blog.5apps.com/2013/03/02/new-service-cors-ssl-proxy.html">5apps cors proxy</a>, then we don't need anything else. It is possible to access github from an
  unhosted web app, without using sockethub. If you mirror the app, you would use your own cors proxy of course, and we should probably allow users to configure a cors proxy
  of their choice at runtime, but for now, we are trusting 5apps, who already host tosdr.org's source code anyway, to also host the cors proxy for it.
  Let me explain how it works.</p>
<p>In order to access the github API, you need to register an app. This gives you a client_id and a client_secret. The
  <a href="http://developer.github.com/guides/basics-of-authentication/">documentation</a> says you should never, ever, publish your client secret. The name 'client secret'
  also obviously implies this. :) However, this is part of a security model where a hosted application gets access to github. The word 'client' here refers to the second
  hosted application being a client when connecting to the github API.</p>
<p>Some APIs, like for instance the <a href="http://developers.flattr.net/api/">Flattr API</a>, offer cross-origin access, using the same technique as remoteStorage:
  OAuth 
  <a href="http://tools.ietf.org/html/rfc6749#section-4.2">implicit grant</a> flow to obtain a bearer token, and then CORS headers on the API responses to allow cross-origin ajax from the client-side.</p>
<p>Whereas Flattr supports the implicit grant flow like intended by the authors of the OAuth spec, Dropbox offers OAuth 1.0, and 
  <a href="https://tech.dropbox.com/2012/08/some-love-for-javascript-applications-2/">suggests</a> you publish your client secret.
  Github tells you not to expose your client secret, but does not provide a reason for that.
  I asked them about this, and they replied that this enables them to rate limit and
  block malicious traffic on a per-app basis. It basically turns hosted apps into gatekeepers that stand in between the user and the API.</p>
<p>In order to stop a third party from pretending to be us, I used an anonymous app registration, in a github account that I created specifically for this purpose
  naming the app after its redirect URL. The user
  is redirected to our web form on tosdr.org when they authorize the app, so I think most attack vectors will be pretty unrealistic, but at least by not using the
  official "tosdr" github user for the app
  registration, we can be sure that the value of the secret is no larger than what an attacker could just register themselves by creating a new github user.</p>
<p>At first, the redirect will provide an access code, which still has to be exchanged for an access token. We do this as follows, using the 5apps CORS proxy. Note that
  despite the fact that github says you should never, ever do this, I put the client secret into the client-side code:
<pre><code>
  var githubClient = {
    id: '3365a610f873704cff3a',
    secret: 'e9b3c5161bf15a2518046e95d64efc880afcfc58',
    proxy1: 'https://cors.5apps.com/?uri=https://github.com',
    proxy2: 'https://cors.5apps.com/?uri=https://api.github.com'
  };
  function post(path, payload, cb) {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', githubClient.proxy1+path, true);
    xhr.setRequestHeader('Content-Type',
        'application/x-www-form-urlencoded');
    xhr.setRequestHeader('Content-Length', payload.length);
    xhr.onload = function () {
      console.log(xhr.status);
      console.log(xhr.responseText);
    }
    xhr.send(payload);
  }
  function extractParam(key) {
    var pairs = location.search.substring(1).split('&amp;');
    for(var i=0; i&gt;pairs.length; i++) {
      var kv = pairs[i].split('=');
      if(decodeURIComponent(kv[0])==key) {
        return decodeURIComponent(kv[1]);
      }
    }
  }
  function codeToToken() {
    var code = extractParam('code');
    if(code) {
      post('/login/oauth/access_token',
        'client_id='+githubClient.id
        +'&amp;client_secret='+githubClient.secret
        +'&amp;code='+code, function(){
      });
    }
  }
  codeToToken();
</code></pre>
<p>I haven't written the code for the whole pull request creation yet, but at least the access to github is working with this.
  It might be a bit of a hack, and in general you should of course never expose secrets, but in this case it is empowering unhosted web apps,
  and resolves a dependency on hosted server-side software, so I think it's justified whenever the preferable
  <a href="http://tools.ietf.org/html/rfc6749#section-4.2">implicit grant</a> flow is not being offered. But please
  <a href="https://groups.google.com/forum/#!topic/unhosted/j3QAL4msUyo">comment</a> if you think this type of hack is harmful in any way.</p>
</div><div class="episode">      <h2><a name="episode-16" "id="#episode-16" href="#episode-16">16.</a> Our plan to save the web</h2>

<!-- our platform: Our plan to save the web. -->
<h3>End of part one</h3>
<p>In the last 15 episodes we layed the basis for our software platform, based on unhosted html5 apps.
  So with this episode, we will complete the first part of our handbook. None of it is finished, but it should give a first direction for all the topics
we covered.</p>
<p>I'll keep writing weekly blog posts here, doing a more in-depth review of all kinds of background knowledge, like a sort of
textbook, but highlighting for each topic how it is relevant to unhosted web apps, and then linking to more detailed resources of all the related fields. Things like
  encryption, DHTs, networking considerations, and other related technologies will come up.</p>
  
  <p>The posts will probably be a bit shorter, and with lots of links, because
  it's more useful to point readers to the actual expert sources about all such topics than to try to rewrite it - other than insofar this makes sense, to highlight the
  specific relevance to unhosted web apps.</p>
  <p>After that, the third and last part would be about building apps (discussing things like sync and MVC) - 34 episodes in total, and bundled into a <a href="https://unhosted.org/book/">HTML book</a>.</p>
<p>In this last episode of part one we'll have a look at the redecentralized web, and try to figure out how we can make it into a successful software platform.</p>

<h3>What should run on your freedombox?</h3>
<p>In order to <a href="http://redecentralize.org/">redecentralize the web</a>, we need people to run some kind of own server. This can be their normal PC or other client device, or a pod/seed/node/account run by
  a trusted and replaceable party, or a purpose-built device like a freedombox on a plugserver. But the big question is: what should run on there?</p>
<p>You can run a &quot;meta-software&quot; product like <a href="https://owncloud.org/">ownCloud</a>, <a href="https://cozy.io/">Cozy</a>, <a href="https://arkos.io/">ArkOS</a>, <a href="https://yunohost.org/">Y U No Host</a>, or <a href="https://sandstorm.io/">SandStorm</a>
  to have an &quot;app dashboard&quot; with lot of web 2.0's functions like sharing photos, listening to music, and administering your personal calendar, in one extensible server install.
This is definitely a good option, and François and I are also advising the European university networks to use ownCloud. It is an appealing and understandable
  product that solves real "cloud" needs in a decentralized way.</p>
<p>Another option, if you're mainly thinking of data storage, is
  <a href="https://tahoe-lafs.org/trac/tahoe-lafs">tahoe-lafs</a>. The good thing about tahoe-lafs is that it's encrypted, resilient, and decentralized. It is
  basically a way to create a very good clustered database server out of semi-untrusted nodes. As I said, its main focus is on data storage, the user-facing UI is that of a
  filesystem.</p>
<p><a href="http://couchdb.apache.org/">CouchDB</a> is a lot more specifically "webby" in its approach than the previous two, using http and javascript as some of its core components.
  But at the same time it's more a backend technology that a developer would build upon, than a
  consumer-facing product. Unhosted web apps can synchronize easily with a hosted CouchDB instance by replicating with an in-browser
  <a href="http://pouchdb.com/">PouchDB</a> instance. Also, with
  <a href="https://github.com/ryanramage/garden20">Garden20</a>,
  an app paradigm based on CouchDB (this idea is also sometimes called "Couch apps"), an end-user could interchange
  apps with other users, and that way have web apps running on their own node.</p>
<p><a href="https://github.com/photo/frontend">OpenPhoto</a> (the software behind Trovebox) and
  <a href="http://www.mediagoblin.org/">MediaGoblin</a> are similar to ownCloud, but more specialized; in Flickr-like photo hosting and Youtube-like video hosting,
  respectively.</p>
<p>There are many options if you want to run a node in a specific decentralized social network: StatusNet, Diaspora, BuddyCloud, Friendica, etcetera. But as we discussed
  in episode 3, if you run a node of platform X, then you will generally <em>mainly</em> interact with other people on that same platform. There is some interoperability,
  but this is not complete, and is often no more than a bridge between what are still separate islands.</p>
<p>A promising option to make your server able to send and receive ActivityStreams is <a href"http://pump.io/">pump.io</a>; it allows you to publish your own news feed
on your own website, and also helps you to receive updates from your friends.</p>
<p>And then there's the Locker Project, which by the looks of it is now only maintained as the hosted service called Singly, and a few more projects like
  <a href="http://camlistore.org/">camlistore</a> and
  <a href="http://themineproject.org/about/">the Mine! project</a>, all of which are valid options, and most of which are used in production by their
  creators and other pioneers.</p>
<p>You can also go old school,
  and run a roundcube-enabled mailserver, plus an ejabberd instance and a wordpress blog. It mainly depends on which part of the problem you want
  to solve first.</p>

<h3>Indie Web + ActivityStreams + remoteStorage + sockethub</h3>
<p>In all of these options, you can install a software application on a server under your physical control, or you can let a trusted provider do that on your behalf, and you
  will then be able to put your data into that software application, and use it in a meaningful way, so that your data stays on the server you trust.</p>
<p>With some of the options (this mainly applies to ownCloud and Garden20 as far as I can see), the user is expected to go scout out third-party apps, and install them.
  That already provides some software freedom.</p>
<p>There are also unhosted web apps that do <em>not</em> require the user to run their own server; instead, they connect to the user's account
  on a proprietary cloud platform
  like Dropbox, Google Drive, Facebook or as we saw in the previous episode, github.</p>
<p>All of this is great, don't get me wrong, I love all projects that decentralize data hosting, and I also love all projects that separate apps from data hosting.
  When I point out things that are still missing from the state of the art, please don't interpret it like I'm saying something negative about the parts that we
  <em>do</em> have. On the contrary,
  I think all these projects contribute little building blocks to the public domain of technology, and the real progress is in the sum of these building blocks.</p>
<p>But to save the web from becoming centralized into a small number of proprietary platforms,
  I think we need both: decentralization of data hosting, and separation between application and data hosting. Putting those two ideas together,
  we can save the web from the platform monopolies that have been taking control over it more and more for the last 5 years or so.</p>
<p>I think everybody should have their own Indie Web domain name to start with, with a TLS certificate, a web page with an ActivityStreams feed,
  and an email address with PGP. Call me old-fashioned. :) Only one of those technologies is a recent invention, the others are all decades old.
  I think a big part of the solution is in making these older technologies usable, not in designing a new
solution to replace them.</p>
<p>Your website should run on a server under your control, or under the control of a trusted hosting provider; the good thing is, since you own your DNS domain name,
  this hosting provider will be 100% replaceable. If your server has no static public IP address, you will need a dynamic DNS service,
  or a RevProTun service like Pagekite to make it publically visible.</p>
<p>Once you have these things, then, by all means, add free software applications like ownCloud, tahoe-lafs, OpenPhoto, Mediagoblin and Diaspora
  to your server, and use them.</p>
<p>But this is the web platform we have, and I'm trying to look at the things we don't have - the pieces in the puzzle that are still missing, to make the decentralized
  web as good as other app platforms like iOS, Android, and Facebook Apps.</p>
<p>And the things I would add to those would be simple data storage, and simple messaging - running on your own server, but accessible
  cross-origin, so I can connect it with unhosted web apps at runtime, wherever I see the corresponding icons on a web page somewhere.</p>
<p>That is why we are developing remoteStorage and sockethub, as minimal services that allow unhosted web apps to function. And at the same time we are developing unhosted
  web apps that use remoteStorage and sockethub, and we encourage you to do the same.</p>

<h3>Marketing</h3>
<p>You may have followed the discussion about whether the No Cookie Crew is useful at all, or whether we should take a more pragmatic approach to dogfooding, concentrating
only on a few specific apps. I talked a lot about this with Nick, Basti, Niklas, Jan, Martin and Pavlik, and my conclusion is more or less that we'll move the strict
approach of the No Cookie Crew to the background a little bit, in favor of the more pragmatic dogfooding of apps like Litewrite and Dogtalk, but I think there is a place
for both approaches.</p>
<p>In terms of marketing, unhosted web apps have basically five markets, from small to big:
<ul>
  <li><strong>prototype</strong>
    the strict No Cookie Crew market, a bit like Richard Stallman on free desktop software,
    or vegans on food, users in this market use only unhosted web apps for all their
computing needs, unless there is an explicit and identifiable need to break that principle. Currently just me. :)</li>
<li><strong>dogfood</strong>
  the dogfooders market, people who are actively involved in developing unhosted web apps and their accompanying tools, and who will go through extra effort to use
unhosted web apps where they exist, with the specific purpose of helping those apps to get some first milage.</li>
<li><strong>early adopters</strong> the early adopters market, people who will try out unhosted web apps, but who will not keep using them if they don't work well.</li>
<li><strong>consumers</strong>
  the general public, people who would probably not know the difference between an unhosted web app and a hosted one, and who would use unhosted web apps almost
"by accident", only if they are good apps by their own merit. Compare this for instance with the many users who use Firefox as their browser, but who don't know that
unlike the other major browsers, Firefox is published by a non-profit organization.</li>
<li><strong>enterprise</strong> business users are like consumers, except they have more money to spend, and have different requirements when it comes to integration
  with existing infrastructure.</li>
</ul>
<p>We have been talking about unhosted web apps for four years now, and have been trying to build some useful remoteStorage-based apps.
We have overcome a lot of hurdles, but are still only at the beginning of unhosted web apps actually being used in production in any of these five markets. But the future looks bright. I think our movement
will keep growing both in number of developers involved, and in market reach of the unhosted web apps we develop. If you're interested in joining, then let us know!</p>
<p><strong>We are always looking for more talented javascript developers.</strong> If you develop an unhosted web app, then you can add it to the
<a href="https://unhosted.org/apps/">examples page</a>; most of the apps mentioned on there have issue trackers on github, so you can submit bug reports there if you
have any problems using any of the apps, and if you have any questions or remarks in general, then just send them to the
<a href="https://groups.google.com/forum/#!forum/unhosted">forum</a>. Comments very welcome!</p>
</div><div class="episode">      <h2><a name="episode-17" "id="#episode-17" href="#episode-17">17.</a> Cryptography</h2>

<!-- cryptography: Cryptography -->
<h3>Alice got a brand new bag</h3>
<p>When I first published this episode, Justin correctly <a href="https://groups.google.com/d/msg/unhosted/b1irZwo4HC4/jlSt5KudJyQJ">pointed out</a> that it should start with a security model, describing the assumptions we are making about which devices/persons are trusted, and which ones are untrusted.</p>
<p>So let me have a stab at that: in good tradition, let's suppose Alice wants to send a message to Bob, through The Cloud. :)</p>
<p>Unfortunately for her, but making it more interesting for us, she had her bag stolen last week, with her laptop in it... :( Anyway, not to worry, because she just bought a brand new bag and a new commodity laptop, and just finished installing Ubuntu on it.</p>
<p>Alice has been following part I of this handbook and runs her own Indie Web website, on a (virtual) server which she rents from an IaaS provider. She doesn't remember the root password of the server, and she only had the ssh key for it on the laptop that was stolen. But she remembers the login (username and weak password) for the control panel at her IaaS provider, and is able to gain access to her server again.</p>
<p>She generates a new PGP key, revokes the old one, and publishes her new public key to a PGP key server, as well as on her own website. Now she's ready to message Bob. Luckily she remembers his user address by heart.</p>
<p>Bob also just lost his bag and got a brand new one. And he has lost all his data, because the bag contained the Raspberry Pi from which he was running his website (using a <a href="http://mailman.klaki.net/mailman/listinfo/revprotun">reverse proxy tunnel</a>), and he had no good backups.</p>
<p>But he has managed to get a new Raspberry Pi, get his reverse proxy tunnel configured again, and obtained a new private TLS key for his website from his CA. On top of that, he knows Alice's user address by heart, and recognizes it when the message comes in.</p>
<p>Bob also has to generate a new PGP keypair and publish his public key both on his website and to a PGP keyserver. Since all main PGP keyservers are synchronized with each other (thanks to Bryce for
<a href="https://groups.google.com/d/msg/unhosted/b1irZwo4HC4/UOszCJYzbSQJ">
pointing this out</a>), publishing your public PGP key once is enough to claim your own PGP identity globally. Other people can then sign your key to help you to strengthen your claim.</p>
<p>Now suppose Charlie is up to no good and wants to intercept and/or alter the message. Which attack angles would he have?</p>
<h3>Some attack angles</h3>
<p>Charlie could put eavesdropping hardware or firmware into the devices Alice and Bob buy. Bob bought his device with the operating system already on it, but for Alice he could try to somehow make her download a compromised version of Ubuntu.</p>
<p>Another weak point is of course Alice's VPS hosting. So Charlie could get a job at her IaaS provider, or at a government or police force whose jurisdiction is recognized by this provider. That way he could change the public key Alice publishes there, upload his own one, and replace the message with a different one without Bob noticing.</p>
<p>He would however be found out if Bob checks the key on Alice's website against a PGP keyserver. So DNS+TLS and the keyserver network cover each other's backs, there.</p>
<p>But let's assume Charlie fails at that, and all employees of Alice's IaaS provider and related law enforcement organizations do their job without attacking Alice's data. Then we have a situation where Alice and Bob now both have trusted devices with no malware on them, and Alice additionally has a server at an IaaS provider which she trusts.</p>
<p>Since Alice and Bob both remember their own exact DNS domain name, as well as each other's, they can use the DNS+TLS system to bootstrap trust. Using asymmetric cryptography, Alice can encrypt her message with Bob's public key, and sign it with her own keypair.</p>
<p>Charlie could upload a competing public PGP key for Bob, hoping to make Alice encrypt her message with that key instead of with Bob's real one. This would mean Charlie, and not Bob, would be able to decrypt the message, provided he is able to intercept it.</p>
<p>This would be quite hard for Charlie to pull off, though, because the conflict with Bob's real new key would immediately be visible, and Alice or someone else could easily check Bob's website to see which one of the two really comes from Bob.</p>
<p>So as long as Alice successfully encrypts her message with Bob's correct new public PGP key, then Charlie will not be able to read the content of the message, because he doesn't have access to Bob's (new) private key, which is safely on Bob's new Raspberry Pi.</p>
<p>He will also not be able to replace the message with a malicious one, because Bob can get Alice's public key from her website, and validate the PGP signature on the message.</p>

<h3>Key pair management</h3>
<p>Asymmetric cryptography requires you to publish a public key, and to keep a private key private. If your communication partner knows your domain name,
  then publishing your public key "only" requires a trusted https server with a TLS certificate on your domain name.</p>
<p>If this web server is not under your physical control (i.e. either in your house, in your bag, or in your pocket), then
  the rest of the story all depends partially on trusting your hosting provider, as well as (nowadays) their IaaS provider.</p>
<p>The party hosting your public key can fool your peers, pretending to be you when sending a message. It would be a bit harder for them to read your incoming
  messages without you noticing, but at least if you don't have control over the webserver where you publish your public key, then security is compromised.</p>
<p>But given that your hosting provider would be subject to being found out if they published a different public key for you, this is still a relatively solvable
  problem. You should publish your public PGP key as far and wide as you can, so that a sort of "neighborhood watch" can detect any attempt of your hosting provider to put a different one on your website.</p>
<p>PGP keyservers are built for this. They are networked for synchrony, so if Alice and Bob have both uploaded their public key to one of the keyservers connected to this network, then it would be pretty much impossible for Charlie to convincingly publish a competing public key for either one of them.</p>
<p>Using PGP keyservers, it would even be possible to use an identity on a domain you do not own. You could for instance publish a public PGP key for your gmail account, and use a mail client to send PGP-signed message out through it. But this is of course not advisable, since it ties your identity to a domain name you don't control.</p>
<p>You could use an identity at a domain you don't control if this domain provides a context for that identity. For instance, you may have a context-specific identity at your club, like for instance your "@fsfe.org" address if you are an
<a href="https://fellowship.fsfe.org/">FSFE fellow</a>, and you may publish a PGP key for such an acccount to a key server, without necessarily having a way to publish it on the domain's website.</p>
<p>So this may lead to PGP keys existing that can only be checked through keyservers and their Web of Trust, and not through DNS+TLS. But you should ideally only use such extra identities in the context which they pertain to.
You should ideally always have your own DNS domain name for your "root" identity on the web.</p>

<h3>How to keep a secret</h3>
<p>The real problem is in keeping the private key private. Because once an attacker has access to it, they can use it at will, and will only be detected through the
  damage they cause with it. They will be able to send outgoing messages with your signature, and decrypt any incoming messages they intercept.</p>
<p>If you have a storage device under your control,
  to which only you have access, and to which you always have access when you want to send a message, then this can be used
  to store your private key. Examples may be a usb stick on a (physical) key ring, a chip card in your wallet, or your smart phone.</p>
<p>A device without a reverse proxy tunnel providing access into it, is already probably not good enough, unless maybe it is your smartphone, which you have on you whenever you are outside the shower, 24/7. Especially when travelling,
  it is easy to get into a situation where you need to access your messages, but would
  not have such a device with you. You need to be able to access your keys from any trusted device, anywhere in the world.</p>
<p>If you lose the storage device that holds your private key then you will lose all the data that was encrypted with that key pair, so it's important to make good
  backups, for instance you can store a copy of your private key in a safe place inside your house, or just store an unencrypted copy of your important data there. It would have to be a very safe place though. :)</p>
<p>It gets interesting if (like most normal users) you do not want to walk around with a usb stick. Many people will be unwilling to walk around with an extra 
<a href="https://www.crypto-stick.com/">physical</a>
<a href="https://www.yubico.com/products/yubikey-hardware/yubikey/">object</a>, but they will be able to remember "a log in", that's to say,
  a domain name, a user name, and a weak password.</p>
<h3>Weak passwords</h3>
<p>A weak password is a string, memorized by the user,
  with an entropy that is high enough to practically stop it from being guessable in, say, 10 attempts, but not high enough to
  stop it from being guessable using, say, 1 year of computing power on a standard PC.</p>
<p>A 4-digit PIN code is a good example of a weak password: the chance you can guess it in 10 attempts is one in a thousand, and usually an ATM will block the card
  after the third attempt. It has an entropy of just over 13 bits.</p>
<p>With a bit of effort, it is possible to remember a password that would be strong enough to withstand
  a brute-force attack. For instance, a sequence of five words from a dictionary, could still be memorized with a bit of effort, but if the dictionary would contain
  say 2^16 (about 65,000) words, then you could still achieve 80 bits of entropy with it, which would keep you safe from most attackers, depending on their
  persistence and resources.</p>
<p>But the reality is that most people don't want to have to remember such strong passwords, and they also want their passwords to be recoverable in some way. We need to present users with a place where they can store their private key under their control, while still being able to access it from any location, using any standard trusted computer, plus their domain name, user name, and (weak) password.</p>
<p>Encrypted communication sessions should subsequently use <a href="https://en.wikipedia.org/wiki/Forward_secrecy#Perfect_forward_secrecy">Perfect Forward Secrecy</a> for extra protection.</p>

<h3>Conclusion</h3>
<p>You can use some sort of a freedombox to store both your private key and your public key. The private key would only be accessible over TLS and behind
a password, where multiple wrong guesses would result in captchas and time delays showing up, to stop brute-force attacks against the weak password.</p>
<p>The public key would be publically available, but also only over TLS.</p>
<p>The DNS+TLS system has a slightly strange architecture, something which <a href="">DNSSEC</a> is trying to fix, although even with those improvements, the system will in practice still be controlled by capitalism, as we saw for instance with the hostile takedown of the Wikileaks website.</p>
<p>Additionally, even if your website is available on the internet in general, in many geographical regions there may be local bans by other governments, armies, and industry powers. For instance, www.facebook.com is being blocked at the DNS level by several Asian governments.</p>
<p>But as long as your personal Indie Web domain is up, you type all domain names carefully, you don't click any
malicious "look-alike" phishing links (like, say, https://goog1e.com/ pretending to be https://google.com/), and you trust all the certificate authorities that your browser includes,
then I think DNS+TLS+PGP should be a safe way to communicate.</p>
<p>There is one more thing you may want to do: if you have a small trusted server and a large semi-trusted server, then you may want to let
the small server encrypt blobs, to store on the large semi-trusted server. This would, however, work best server-side, behind the TLS connection, rather than inside the browser's javascript execution environment. A good piece of software that does this is
<a href="https://tahoe-lafs.org/trac/tahoe-lafs">tahoe-lafs</a>.</p>
<p>The situation where you have only a semi-trusted server and not a small trusted one is irrelevant, because there you would also not be able to host your keypair (unless you rely on keyservers for the public one, and a physical device for the private one).</p>
<p>The proof of concept that originally appeared on this website back in 2010 when we launched it, centered heavily on implementing end-to-end encryption between browser environments. But we learned a lot since then, and hopefully this episode explains the reason why we now advise you to use TLS to a freedombox instead of that.</p>
<p>Security stands and falls with correcting people when they get it wrong. And even though we're discussing the topic in this episode, this is mainly to make sure our handbook covers this important topic, and "IANASE", that's to say: I am <strong>not</strong> a security expert! :)</p>
<p>So this time especially, even more than other times, <a href="https://groups.google.com/d/msg/unhosted/b1irZwo4HC4/_tPnu8_iMpgJ">comments are very welcome</a>, especially if you see an error in the security arguments.</p> 
</div><div class="episode">      <h2><a name="episode-18" "id="#episode-18" href="#episode-18">18.</a> Distributed hash tables</h2>

<!-- DHTs: Distributed hash tables -->
<h3>Content-addressable data</h3>
<p>The simplest type of database is probably the key-value store: it couples a potentially long string (the value) to a potentially short string (the key), so that you can later retrieve the value that was stored, by presenting its key. Generally, it is possible to store any value under any key. But if for a key-value store, the key of each item is fully determined by the value, we say the data is content-addressable: if you know the content (the value), then you know its address (the key).</p>
<p>Content-addressable data stores are efficient when the same value is stored many times in the same store: each duplicate entry will map to the same key, meaning the data is automatically de-duplicated. On the other hand, the limitation that you cannot choose the key at the time of storing some data, means that in practice content-addressable data stores are only useful when combined with a generic key-value store.</p>
<p>Storing something in such a "blobs+index" store means that large data items are first stored as blobs in a content-addressable data store, mapping them onto short strings which are deterministically derived from the data item in question. Usually some sort of hashing function is used for this.</p>
<p>And then the second step is to store the hash of the blob in the "index", where you can give it the variable name under which you will want to find it back later.</p>

<h3>A ring of hashes</h3>
<p>When storing content-addressable data redundantly on a cluster of servers, you probably want to be able to add and remove servers without taking the cluster down. If you generate the keys from the values using a hashing function that more or less randomly spreads the resulting keys over their namespace, then you can use that property to easily and fairly determine which servers should store which item.</p>
<p>Imagine the namespace of hashes as a circle, where each point on the circle corresponds to a certain item key. Then you can deploy the servers you have available to each serve a section of that circle.</p>
<p>You may introduce redundancy by making the sections overlap. Then, if a node fails, you can redistribute the nodes by moving them gradually, so that they elastically adapt. Likewise, if you want to add more servers, you can insert them at a random position on the circle, and gradually let the new set of servers settle to their optimal distribution.</p>
<p>Moving a server clockwise or anti-clockwise on the ring means forgetting items on one end of its circle section, while at the same time obtaining new ones at the other end. If you make sure that each item is always stored at least twice (by overlapping each section 50% with each of its neighbors), then if one node fails, the nodes that neighbored it can immediately start moving towards each other to get full duplicated coverage of the section again.</p>
<p>This doesn't help of course when two adjacent nodes fail, and if you lose a server, then the load on the remaining servers of course becomes proportionally bigger. But running a cluster like this can be a lot easier for a sysadmin then running, say, a master-slave cluster of database servers.</p>

<h3>Erasure coding</h3>
<p>Taking this concept to a more generic level, leads to erasure coding, a strategy implemented by for instance tahoe-lafs. Here, each blob is stored <code>n</code> times instead of necessarily exactly two times. Advantages of storing data multiple times include:</p>
<ul>
<li>disaster recovery, including easy organization of maintenance windows,</li>
<li>easy expansion and reduction of the cluster size in response to throughput and storage size demand,</li>
<li>increased throughput when the traffic is not uniform (for instance, if only one item is being retrieved at a given time, you can use all servers that store it to serve a part of the item's value),</li>
<li>possibility of using low-quality servers, or when encryption is used even semi-trusted servers, thanks to the inherent robustness of the architecture.</li>
</ul>

<h3>Convergent encryption</h3>
<p>Encrypted blobs can easily be stored as content-addressable data. Thus, you can send a short string to the recipient of your message, which would then translate to a potentially very long string on the DHT to which both sender and receiver have access.</p>
<p>To set this up you need a trusted server that does the encryption, and a set of semi-trusted servers that do the actual blob storage.</p>
<p>Do keep in mind that if two people both encrypt the same file (say, a specific webm-file, or a popular linux install CD), then they will not generally result in the same blob, and thus the system will not be able to take advantage of de-duplication.</p>
<p>Convergent encryption fixes this. It uses a different encryption key for each blob, and derives that encryption key from the blob's entropy, such that it's not derivable from the item key (the blob's hash, which is used as the item's address)</p>
<p>Bitcasa, the company that was the subject of the TechCrunch scandal a couple of years ago, claimed that it could
do both encryption and de-duplication, using convergent encryption as their
 <a href="http://techpinions.com/bitcasas-clever-encryption-trick/2677">clever trick</a>.
For Mega.co.nz it is
<a href="http://arstechnica.com/business/2013/01/megabad-a-quick-look-at-the-state-of-megas-encryption/">believed</a>
that they may also be using convergent encryption, although this has apparently not been confirmed by the company itself.</p>
<p>It is important to note, as this last link also explains, that de-duplication exposes some information about the data people are storing.
For instance, a copyright holder could upload their own movie to Mega.co.nz, and ask Mega to report which users own a file that deduplicates against that.</p>
<p>So depending on the reasons you had to encrypt data in the first place, convergent encryption may not be what you are looking for. You may need to use an encryption technique that makes de-duplication impossible.</p>

<h3>Indexes to the data</h3>
<p>As already stated earlier, content-addressable data by itself is in a way useless by definition. Nobody wants to use hashes as variable names. You need an extra layer that translates ultimately human-memorable, or at least human-intelligible labels to the machine-generated hashes that allow looking up the actual full data items in the DHT.</p>
<p>A good example of this is git: it stores blobs, and then trees of commits that reference these blobs. This is also how git does de-duplication, which can be quite important depending on how you branch and move files around in your version control repo.</p>

<h3>Zooko's triangle</h3>
<p>A naming scheme can be (source: <a href="https://en.wikipedia.org/wiki/Zooko%27s_triangle">wikipedia</a>):
<ul>
<li>Decentralized and human-meaningful (this is true of nicknames people choose for themselves),
<li>Secure and human-meaningful (this is the property that domain names and URLs aim for), or
<li>Secure and decentralized (this is a property of OpenPGP key fingerprints)
</ul>
<p>However, Zooko's triangle states that is impossible to have all three at the same time. A naming scheme cannot be decentralized,
human-meaningful, and secure, all at the same time.</p>
<p>Don't confuse the word "distributed" in the abbreviation "DHT" with "decentralized". For instance, bittorrent.com publishes the Mainline DHT in which bittorrent peers can participate voluntarily, but this DHT is fundamentally centralized in the domain name of its publisher.</p>
<p>The fact that DHTs derive item keys from item values means that the "secure" part of Zooko's triangle can at least be verified: if you arrive at the wrong item value for a given item key, then you can at least know that this happened.</p>
<p>At the same time, it means that item keys in a DHT are not human-meaningful (unless the human in question is able to calculate hash functions in their head).</p>

<h3>Uniqueness through dominance</h3>
<p>There is in practice a way out of the dilemma introduced by Zooko's triangle: since our planet has a finite size, and a finite population, it is possible to populate a vast majority of all instances of a certain system with the same data, thus in practice (though not in theory) removing the need to choose one authorative instance.</p>
<p>DNS, TLS, PGP keyservers, and Bittorrent's Mainline DHT all use this approach. Even if the authorative single point of failure of these systems goes down, the data still "floats around" in enough places.</p>
<p>If the data is additionally verifiable, like DHT data is, then you can in practice make data blobs globally available in a way that becomes independent of the original publisher.</p>

<h3>Conclusion</h3>
<p>When storing small items of data, you need an actual key-value store. When the items are big, though, you can combine a first-level key-value store with a second-level content-addressable store, such that the first forms an index to the latter. Doing this also opens up opportunities to use semi-trusted servers on the second level. The first-level index can also be stored as a blob on the second level, meaning your client will only need to remember one hash string - the hash of the index.</p>
<p>Truly decentralized storage of generic key-value data (with human-memorable item names) is impossible, but decentralized storage of content-addressable data can be achieved "in practice", by dominating the finite set of Earthly servers that claim to participate in your DHT, and if clients verify that the values they obtain actually hash back to the item keys they requested.</p>
<p>As always, <a href="https://groups.google.com/d/msg/unhosted/o-M2ejb_Cc8/ak--jrLrLzoJ">comments welcome</a>!</p>
</div><div class="episode">      <h2><a name="episode-19" "id="#episode-19" href="#episode-19">19.</a> BGP, IP, DNS, HTTP, TLS, and NAT</h2>

<!-- internet: BGP, IP, DNS, HTTP, TLS, and NAT -->
<h3>Connecting your computer to the internet</h3>
<p>If you have a new computer which you would like to properly connect to the decentralized internet, then the first thing you need is an Autonomous System Number
(<a href="https://en.wikipedia.org/wiki/Autonomous_system_%28Internet%29">ASN</a>), at least one
<a href="https://en.wikipedia.org/wiki/Border_Gateway_Protocol">BGP</a> peer, a network connection (probably
<a href="https://en.wikipedia.org/wiki/Fiber-optic_communication">fiber</a>) between you and that peer, and at least one block of internet IP addresses. You can then announce your block to your peer, and start sending and receiving traffic.</p>
<p>Of course in practice you would probably leave the task of setting this up to an established internet service provider (ISP), hence the popular practice of connecting a computer to the internet with a wifi password instead. :)
But the fact that you could in theory become an autonomous system is important, and
prices for doing this <a href="https://groups.google.com/d/msg/unhosted/hIVOKI_pNQI/cME2IkarjhcJ">are coming down</a>.</p>
<p>Since connectivity is its own reward, there is a strong drive for all smaller networks to become part of "the" Earthly internet. This means that although (modulo the assignment of ASN numbers) the internet is a decentralized and non-unique system, there is one "winner" internet, which is not unique in theory, but is unique in practice through dominance.</p>
<p>If ASNs were longer (not human-memorable), then you would not need to obtain them from the centralized IANA registry, and the system would be even more decentralized. In practice this is not a big issue however, since the threshold in hardware investment, and cost of the specialized sysadmins required to run an AS are still so high that there are only about 45,000 autonomous systems on Earth, and there don't seem to have been any hostile take-down attempts against any of them yet.</p>
<p>As Leen <a href="https://groups.google.com/d/msg/unhosted/hIVOKI_pNQI/duaAK4x3lGEJ">remarks</a>, you cannot run an autonomous system and be anonymous. The registry (and your peers as well, probably), will want to know your real-world identity.
More about anonymity next week, when we discuss the concept of online identities and single sign-on, as well as in episode 25.</p>

<h3>Routing traffic</h3>
<p>Once you peer with other autonomous systems on the internet, you can make your computers addressable via IPv4, IPv6, or both. It is hardly an exaggeration to say that all computers that are connected to the internet at all, will be able to connect to your computer over IPv4.</p>
<p>On the internet, there are four major routing schemes:
<a href="http://blog.cloudflare.com/cloudflares-architecture-eliminating-single-p">Unicast, Multicast, Broadcast, and Anycast</a>. Using BGP-level anycast, if Bob knows Alice's IP address, she could publish a message at several autonomous systems, each of which would announce Alice's IP address, and as long as Bob has a route to at least one of them, he would be able to retrieve the message. This would be properly hard to shut down.</p>
<p>IPv6 connectivity is less ubiquitous, and if Bob is behind an ISP then it is not necessarily possible for him to reach Alice's content on an IPv6 IP address. In fact, unless he explicitly goes shopping for an IPv6-enabled DSL line, Bob would pretty much
<a href="http://www.google.com/ipv6/statistics.html#tab=per-country-ipv6-adoption">have to be in France</a>, and even then he would only have about a 1 in 20 chance to be able to reach Alice's message on its IPv6 address.</p>
<p>IPv4 famously ran out of addresses last year, but for the moment it seems ISPs are simply assigning each IP address to a bigger group of people instead of being in a hurry to introduce IPv6.</p>
<p>Also, IaaS providers nowadays often seem to put their entire infrastructure behind a single IPv4 address instead of worrying too much about giving each customer their own address.</p>

<h3>TCP, HTTP, and Transport-layer Security</h3>
<p>If your computer has its own (IPv4) internet address, then it can accept incoming TCP conversations. On top of IP, which is a best-effort end-to-end packet routing protocol, TCP offers fault tolerance and abstraction from dropped packets. On top of TCP, Transport Layer Security
(<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>) implements protection against eavesdropping and tampering through asymmetric encryption.</p>
<p>With Server Name Indication (<a href="http://en.wikipedia.org/wiki/Server_Name_Indication">SNI</a>), it is possible to host several DNS domain names on the same IP address, and still use TLS. Since SNI happens
<a href="http://journal.paul.querna.org/articles/2005/04/24/tls-server-name-indication/">as part of</a> the TLS negotiation, it seems to me that it should be possible to get end-to-end TLS with each of several servers behind the same IP address, as long as the server that handles the negotiation knows which vhost lives where.</p>
<p>But in practice that is probably a bit of an academic issue, since the party who gives you the shared IPv4 address is probably an IaaS provider who has physical access to your server anyway. </p>

<h3>Naming and trust</h3>
<p>If Alice has access to several autonomous systems, she can announce her IP address several times. But not many people have this. In fact, as we just saw, having even one entire IP address is becoming rare. So another approach to make routing more robust, would be if Alice gave Bob several alternative IP addresses for the same content, which can for instance be done at the DNS level, with round-robin DNS.</p>
<p>Alice can register a domain name, get DNS hosting somewhere, and announce one or more IP addresses there, for the content she wants to send to Bob. Apart from the added level of indirection which gives Alice more ways of adapting to adversity, it makes the identifier for her message human-memorable.</p>
<p>The DNS system is centralized and often controlled by political powers, so it's not a very robust part of the architecture of the internet. Even with the DNSSEC improvements, governments have the power to selectively take down certain domain names, and many nation state governments around the globe have already shown they are willing to use this power.</p>
<p>TLS is also centrally controlled, but at least it offers Bob a way to actually know whether he is talking to Alice. Everything before that point is only best-effort, and based on assumptions.</p>
<p>In practice, people often find each other at yet a higher level of routing: search. Instead of Alice giving her IP address or domain name to Bob via an out-of-band channel, Bob will in practice often simply search for a string (like "Alice A. Alison") on Facebook or Google, check whether some of the content found matches some out-of-band reference knowledge he has about Alice (for instance, the avatar roughly matches what she looks like in real life), and then follow the link to find Alice's home page with the message.</p>
<p>This search need not be centralized; it can in theory go through friend-of-a-friend networks like
<a href="https://en.wikipedia.org/wiki/FOAF_(software)">FOAF</a>, which would again create a system that is more decentralized than DNS and than Facebook/Google search.</p>
<p>Some friends and I are also planning on scraping (once we have some time to work on this) a large part of the internet's social graph, as far as it's public, and leak all this information into the public domain in the form of for instance a CouchDB database or a torrent, in a project we called <a href="https://github.com/unhosted/useraddress">useraddress</a>.</p>
<p>But for now, since DNS is vulnerable to government attacks, and IPv4 addresses are owned by specific ISPs, it is actually pretty hard to reliably send a message over the internet. Neither IP addresses nor domain names can really be trusted. Unless one of the parties has their own ASN, the best way would probably be to consider DNS and IP untrusted and use an extra security layer like PGP on top of them.</p>

<h3>Network Address Translation</h3>
<p>So will IPv6, if it ever comes, be any better than IPv4? One thing its proponents like about IPv6 is that it allows a LAN administrator to let individual devices go out on their own address. Historically, it doesn't seem like this is something LAN administrators <em>want</em> to do, though.</p>
<p>Through Network Address Translation
(<a href="https://en.wikipedia.org/wiki/Network_address_translation">NAT</a>), the identity of each device can be pooled with that of all other devices on a LAN, thus making it harder to attack them from outside that LAN. This means treating those devices basically as internet clients, rather than as internet participants.</p>
<p>A device that is behind a NAT is not accessible from the outside. WebRTC will try to use
<a href="https://en.wikipedia.org/wiki/STUN">STUN</a> to "traverse" the NAT, and at the same time provides a way into the javascript runtime from the outside.</p>
<p>In general, the view of each device being a neutral player in the network is incorrect. In practice, the internet is (now) made up of addressable servers in the center, and many subordinate clients in the periphery. More about this soon, in the episode about Network Neutrality.</p>

<p>So quite a short and dense episode this week, but I hope all the links to wikipedia articles give enough ways into further reading about this vast and important area of engineering. At least when thinking about unhosted web apps, it's important to understand a little bit about routing and addressability, and to know that the internet is actually not much more than a stack of hacks, and each layer has its flaws, but we make it work. And as always, <a href="https://groups.google.com/d/msg/unhosted/hIVOKI_pNQI/5DPch8V6EKkJ">comments welcome</a>!</p>
</div><div class="episode">      <h2><a name="episode-20" "id="#episode-20" href="#episode-20">20.</a> Persona, OpenID, SAML, WebID, and Webfinger</h2>

<!-- identity: Webfinger, Persona, WebID, OpenID, SAML -->
<h3>Virtualization of sessions</h3>
<p>A sound system can usually be operated by whoever has physical access to it. This is a very simple system which humans understand well. If you
want only the DJ to play music, then you just construct a physical DJ booth, and people naturally sense that they're not allowed to enter it, or to
lean over the table from the other side. For gaming consoles and PCs this can also still work. Laptops usually have a password-protected lock screen,
which means a thief of the physical object can't access the data on there. And shared computers will have multiple user accounts,
to shield users from each other, and restrict
admin (root) access to the device's configuration.</p>
<p>This means that a single device often already provides a concept of accounts and sessions: a session is one user currently using the device, and
during such a session, the user has unemcumbered access both to the device's capabilities, and to that user's own data. A session is started by providing
some sort of account credentials, and exists for a finite contiguous timespan.</p>
<p>When you connect computers with each other into a network, all of this becomes immensely more complicated. First of all, physical access is no longer
needed to open a session on a device, and largely because of this, there can be multiple sessions active simultaneously on the same device.</p>
<p>Most networking protocols provide a way to establish such remote sessions. This is sufficient if a user habitually uses the same client device to log
in to the same server device. But the virtualization and decentralization of applications and services we use in everyday life introduces two problems.
First, we need to log in to many different servers, and managing all those credentials becomes a complicated task.</p>

<h3>Client-side master sessions</h3>
<p>A simple solution for this is to store a "master session" on the client device, which can give access to an unlimited number of remote server sessions.</p>
<p><a href="https://dvcs.w3.org/hg/WebID/raw-file/tip/spec/tls-respec.html">WebID-TLS</a> is based on this idea: you create an asymmetric key pair inside your browser profile on your favorite
client device, and use that to establish remote sessions at servers that support WebID-TLS. The same setup is often used for ssh, git, and other
protocols that support asymmetric cryptography.</p>
<p>But this also brings us to the second problem: we increasingly want to log in <em>from</em> many different clients. You can link your account on a
client device to your remote accounts on thirty different services, but then you can access your remote accounts only from that one client device.</p>
<p>A first step to solving this is to "sync" devices with each other.
<a href="https://en.wikipedia.org/wiki/Comparison_of_browser_synchronizers">Browser synchronizers</a> like Firefox Sync
allow you to synchronize your laptop's master session between for
instance your laptop and your smartphone. I'm not sure whether any of them also sync your client-side SSL certificates, but let's imagine they do.
For some people this is a great solution, because you can use multiple client devices, and always have seamless access to all your server-side accounts
and sessions. Also, having your master session synchronized over multiple client devices, automatically acts as a backup of all these credentials.</p>
<p>But whether or not this is a good enough way to organize your decentralized user accounts, heavily depends on your usage patterns.
A lot of people (for instance the kids at village internet cafes
  in rural Bali) don't own their own client device. They just use a random public computer when they need to access any of their server-side accounts.
  Also, many people
want to be able to use a random client device to access their stuff under special circumstances, for instance, when travelling. This is where the client-side
master session breaks down as a viable solution.</p>

<h3>Federated login</h3>
<p>If you want to have less different credentials for many servers where you have accounts, but you don't want to rely on any particular client device or
  set of client devices, then federated login is another possible solution. For instance, if you have your own server, then you can create your master
  session on there, and use it as a
  <a href="http://blog.industrialdefender.com/?p=612">jump box</a>, a server you can reach from any client device, and from there have your access to 
  all the other servers you may need to open sessions on.</p>
<p>Application providers could provide free jump box functionality to all their users, and that way they would effectively
  be "federated": you promote one your remote accounts to become the master account from which all your other accounts are reachable.</p>
<p>The server that is in the middle, in the jump box role, is then seen to provide "identity": you log in to control an imaginary puppet on that server,
  and that puppet (your online identity) then logs into the eventual session you want to use. Through clever tricks it's even possible to use the intermediate
  server only to establish trust during the <em>session setup</em>
  between the client and the application server, and not throughout the duration of the remote session.
  This is why such a federated jump box service is also known as an identity provider.</p>
<p>If all servers where you want to establish remote sessions support
  <a href="https://en.wikipedia.org/wiki/OpenID">OpenID</a>, then you can promote one of these servers by making it your identity provider,
  and use the trust between these servers to log in with that identity.</p>
<p>Unfortunately many servers do not provide OpenID, when they do they often only accept a certain whitelist of identity providers, and the process of using
  OpenID to log in on a website is often confusing and cumbersome, which in turn has hindered adoption.</p>
<p>Native <a href="https://en.wikipedia.org/wiki/Mozilla_Persona">Persona</a> with a primary identity provider is better than OpenID in its user interface, because it
  uses the browser chrome to transport trust between two open browser tabs. In case none of your remote accounts are Persona primaries, there is also a
  centralized secondary identity provider which allows you to create an identity account, bootstrapped from your email account.</p>
<p>In fact, the way Persona is presented to the user, the assumption is that you will use your main email address
  as your online identity. This makes sense because
  a lot of online services provide email-based password resets anyway, which already turns your primary email adress into your de facto identity provider.</p>
<p>Within enterprise intranets, services are often linked together using <a href="https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language">SAML</a>,
  which is a well-established framework for federated login, but which was designed for closed ecosystems instead of open ones, so that makes it more suitable
  for use on intranets than for use on the internet as a whole.</p>
<p>In the <a href="http://indiewebcamp.com/">IndieWeb community</a>, <a href="https://indieauth.com/">IndieAuth</a> is a popular way to allow polyglot federated login, using various social network sites for the identity plumbing.</p>

<h3>Own your identity</h3>
<p>In practice, at the time of writing, Facebook Connect is probably the most popular cross-origin
  login scheme. It is proprietary and centralized, and together with
  the Facebook Like button, it gives Facebook mighty powers over the web as a whole. Some other application providers provide comparable niche
  schemes, like logging in with Twitter and logging in with Github. Many relying parties seem to have replaced their "log in with OpenID" button with a
  "log in with Google" button.</p>
<p>This is a big problem, of course. As I already emphasized in previous episodes, your online identity should derive
  directly from a DNS domain name that you own.</p>
<p>This also allows you to host your own public profile, with some basic public information about yourself, as a web page.
  At the same time you can then use <a href="https://en.wikipedia.org/wiki/Webfinger">Webfinger</a> to provide a machine-readable version of that same
  public profile page. And of course, you should add email hosting
  to your domain name, and become your own OpenID provider, as well as your own Persona provider, on your own DNS domain name.</p>
<p>That is the only proper way to deal with identity on the web: don't outsource your identity to Facebook or Google, own it yourself!</p>

<h3>And the ultimate solution...: don't log in!</h3>
<p>All this talk about logging in to hosted sessions, disgusting! ;) Our goal with remoteStorage, Sockethub, and unhosted web apps,
is of course to decentralize applications away from specific application servers, meaning
  you don't have to log in to an application-specific server at all.</p>
<p>When you use an unhosted web app, you do not log in to the application. Instead you <em>connect</em> the application, which runs client-side, to your
  own <em>per-user server</em>. This completely eradicates hosted applications, and with it the problem of logging in to many different hosted applications.</p>
<p>The word "identity" is often used in two different ways: once as the address where other users can find you, and once when talking about the identity with which you log in to a service. For the first one you can register your own DNS domain name, as your Indie Web presence, or get an account at a shared domain name. You can then host a human-readable public profile page on there, as well as a machine-readable public webfinger profile, or keep it "stealthy", and for instance only give out your email address to your closest friends. Whether public or not, this is your identity towards other users.</p>
<p>The second one, identity for login, is not a problem in unhosted applications: there are no per-application sessions, only per-user sessions. Still, I wanted to dedicate an episode
  to it, since it's an important background topic, and we often get the question "how do unhosted web apps interact with Persona". So now you know.
  The answer is: they don't have the problem that Persona solves. :)</p>
<p><a href="https://groups.google.com/d/msg/unhosted/tMPYfxwF2O8/VZ4v4XsbzsgJ">comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-21" "id="#episode-21" href="#episode-21">21.</a> Client-side sessions, origins, browser tabs, and WebIntents</h2>

<!-- sessions: client-side sessions, origins, browser tabs, and WebIntents -->
<h3>Client-side sessions</h3>
<p><a href="../20/Persona,-OpenID,-SAML,-WebID,-and-Webfinger.html">Last week</a>
  we looked at how you can manage your login-identity when you do your computing on multiple servers and/or multiple clients.
Sessions turned out to play a significant role in this, because they can link the current user on a client to a current user on a server, and remove this link
when the user on the client finishes the session. This way, you only have to establish trust once, and can then use the remote server without any further login prompts.</p>
<p>This week we'll look a bit more closely into this concept, especially in relation to client-side applications. Because web browsers have a (sandboxed) way of retrieving
source code from a remote server, and then running it client-side, it is possible to establish a session that stays within this sandbox, and does not exist on the server
that served up the web app.</p>
<p>This is, in my view, <em>the</em> core concept of unhosted web apps, and the reason I keep nagging about the No Cookie Crew, disabling all cookies
 by default, with the goal of pushing the web away from server-side sessions, and towards client-side sessions.
  Sorry we had to get to episode 21 before I bring up its fundamental details. :)</p>
<p>With client-side sessions, the server serves up the source code of an application, instead of serving up its user interface.
This means no server-side session is established. The website is served up in a stateless, RESTful way, as static content. But once the web app's html, css, and javascript
code have reached the client-side, it "comes to life", that is, it starts to behave dynamically.</p>
<p>Behaving dynamically is of course again a vague term, but it definitely implies that the application's output cannot be mapped one-to-one to the user's latest action.
A rudimentary form of client-side dynamic behavior is for instance a <code>textarea</code> element that builds up a text in response to consecutive keystrokes. Unless
the app puts the entire current state into the URL, the app has "client-side state", and its behavior can be called dynamic.</p>
<p>When there is no server-side session, a lot of things change. Most web developers have formed their brain by thinking in terms of the LAMP stack and similar server-side
frameworks, and it was only in recent years that people started to make the paradigm shift to thinking about client-side sessions.
For instance, OAuth did not have a client-side flow before 2010, and the webfinger spec has only mentioned CORS headers since 2011. </p>

<h3>Web app origins</h3>
<p>Even if the code runs on the client-side, the trust model of the web keeps its basis in
  <a href="https://en.wikipedia.org/wiki/Same_origin_policy#Origin_determination_rules">origins</a>:
  depending on the server that hosted the code that has been loaded into
the current browser tab (the 'host', or 'origin' of the web app), it may interact with other pieces of code in the same and other tabs.</p>
<p>The <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Same_origin_policy_for_JavaScript">same-origin policy</a> describes the exact rules for
this. For instance, a web app is often not allowed to include <a href="https://blog.mozilla.org/tanvi/2013/04/10/mixed-content-blocking-enabled-in-firefox-23/">mixed content</a>,
the <a href="https://developer.mozilla.org/en-US/docs/HTTP/X-Frame-Options">X-Frame-Options</a> header can restrict iframing, and technologies like
<a href="https://developer.mozilla.org/en-US/docs/DOM/window.postMessage">window.postMessage</a>,
<a href="https://developer.mozilla.org/en-US/docs/DOM/Storage">DOM storage</a> and
<a href="https://developer.mozilla.org/en-US/docs/DOM/Using_web_workers">Web workers</a> are also usually sandboxed by script origin.</p>
<p>For data URIs, file: URLs and <a href="https://en.wikipedia.org/wiki/Bookmarklet">bookmarklets</a>, you can get into all sorts of edge-cases. For instance,
  <a href="javascript:alert(location.host);">this bookmarklet</a> inherits the scope of the page you're on when you click it, but
  <a href="javascript:location='data:text/html,%3Cscript%3Ealert(location.host)%3B%3C%2Fscript%3E'">this one</a> will execute parent-less,
  with the empty string as its origin, because it was encapsulated into a redirection.</p>
<p>Another way to reach the empty origin from a bookmarklet is to become a hyperlink and click yourself. :)
  Don't try these things at home though, I'm only mentioning this for entertainment value. In general, your unhosted web apps should always have a unique origin,
  that starts with
  <code>https://</code>.</p>

<h3>Browser tabs</h3>
<p>As the browser starts to replace some of the roles of the operating system (mainly, the window manager), it becomes more and more likely that we want the app that runs
in one tab to interact with an app that runs in another one. Or, an "in-tab dance" may be necessary: App 1 redirects to app 2, and app 2 redirects back to app 1.
  OAuth is based on this concept, as we've already discussed in <a href="https://unhosted.org/adventures/15/Unhosted-web-apps-and-OAuth.html">episode 15</a>. We use OAuth's
  in-tab dance in the <a href="http://remotestorage.io/integrate/">remoteStorage widget</a>, to connect an unhosted web app with the user's remote storage provider.
  Another example is when opening an app from an apps launch screen, like for instance this
  <a href="https://apps.unhosted.org/launcher.html">example launcher.html</a>. Such a launch
  screen eventually replaces the 'Start' menu of your window manager, or the home screen of your smart phone.</p>
<p>The user experience of opening a new tab, and of performing
  in-tab dances, is always a bit clumsy. Browser tabs are not as versatile on a
  client device as native citizens of the windows manager, mainly because of how they are sandboxed. The barrier for opening a URL is lower than the barrier for installing
a native application, and a lot of UX research is currently going into how to let a user decide and understand the difference between system apps that have elevated
  privileges and sandboxed apps that should not be able to exert any significant lasting effects on your device.</p>
<p>A prime example of this is native support for Mozilla Persona in browsers: the browser takes over the role of managing the single sign-on, which is the main point
  where native Persona is fundamentally more powerful than OpenID.</p>

<h3>WebIntents</h3>
<p>Using redirects to implement interaction between browser tabs is not only clumsy because of how the result looks, but also because of the difficulties of apps
  discovering each other. This can be resolved with <a href="http://webintents.org/">WebIntents</a>.
  First, app 2 (the app that needs to be opened) tells the browser that it can handle a certain type of intents. Then, app 1 only needs to tell the browser that it wants
  an intent of a certain type to be handled. The browser then takes on the task of tracking which app can handle what.</p>
<p>Most of this is all still research in progress, and it brings up a lot of questions about what "installing a web app" means in terms of privileges. We may at some point
  use WebIntents to improve the "connect your remote storage" experience of the remoteStorage widget, but for now this is definitely an area in which the web still
  lags behind on "other" device operating systems. :)</p>
  
<p><a href="https://groups.google.com/d/msg/unhosted/1Mm3fRPuvIg/016QHDEfzCwJ">comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-22" "id="#episode-22" href="#episode-22">22.</a> How to locate resources</h2>

<!-- search: How to locate resources -->
<p>Last week, Adrian suggested that this blog really needs an episode about search. I totally agree, so here it is! :)</p>

<h3>URLs, DNS, and DNR</h3>
<p>The DNS system is a distributed (but centralized) database that maps easy-to-remember domain names onto hard-to-remember IP addresses. In the process, it provides
a level of indirection whereby the IP address of a given service may change while the domain name stays the same.</p>
<p>These two characteristics make DNS+HTTPS the perfect basis for weaving together hypertext documents. One downside of DNS is that it is subject to attacks from
  (especially) nation state governments. Another is that registering a domain name costs money. The money you pay for a domain name is not so much a contribution to
  the cost of running the world's DNS infrastructure, but more a
  <a href="https://en.wikipedia.org/wiki/Proof-of-work_system">proof-of-work</a> threshold which curbs domain name squatting to some extent. If registering a domain name
  were cheaper, then it would be even harder to find a domain name that is not yet taken.</p>

<h3>Portals and search engines</h3>
<p>Domain names are sufficient for keeping track of the SMTP, FTP, SSH and other accounts you connect to, but to look up general information on the web, you often
  need to connect to servers whose domain name you don't know by heart, or might not even have heard of before starting a given lookup.
  Using just DNS to locate resources on the web was just not going to work. You will only be able to find information you have seen before.
  So portals were invented, effectively as an augmentation of DNS.</p>
<p>A portal effectively replaces the DNS system, because instead of remembering that the information you were looking for is hosted on
  <a href="http://www.myfriendtheplatypus.com/">www.myfriendtheplatypus.com</a>,
  you would typically have <a href="http://dir.yahoo.com/">dir.yahoo.com</a> as your home page, and roughly remember that you could get to it by clicking
  Science -> Biology -> Zoology -> Animals, Insects, and Pets -> Mammals -> Monotremes -> Platypus.</p>
<p>The big advantage of this was of course that you only have to remember these strings receptively, not productively: you are presented with multiple-choice
  questions, not one open question. And apart from that, it is interactive: you take multiple smaller steps and can reach your target step-by-step.</p>
<p>A big disadvantage is of course that it takes one or two minutes to traverse Yahoo's directory until you get to the page that contains the information you need.
  Also, you have to know that a platypus is a monotreme. In this case, while writing out this example, I actually used a search engine to look that up. ;)</p>
<p>So, search engines then. They became better, and over the decades we arrived at a web where "being on the web" means you have not only done your
  Domain Name Registration (DNR), but also your Search Engine Optimization (SEO). The similarity between domain names and search terms is emphasized by the fact
  that several browsers now provide one input field as a combined address bar and search widget.</p>

<h3>Bookmarks and shared links</h3>
<p>For general information, portals and search engines make most sense, but the web is also often used for communication that is "socially local": viewing photos
  that your friends uploaded, for instance. Or essays on specific advanced topics which are propagated within tiny specialist expert communities.</p>
<p>For this, links are often shared through channels that are socially local to the recipient and the publisher of the link, and maybe even the publisher of the resource.</p>
<p>This can be email messages, mailing lists, people who follow each other on Twitter, or who are friends on Facebook, etcetera. You can even propagate links to web resources
  via voice-over-air (in real life, that is).</p>
<p>It is also quite common for (power) users of the web to keep bookmarks as a sort of addressbook of content which you may want to find back in the future.</p>
<p>All these "out of band" methods of propagating links to web resources constitute decentralized alternatives to the portals and search engines as augmentations of DNS.</p>

<h3>Link quality, filter bubbles, collaborative indexes and web-of-trust</h3>
<p>Portals used to be edited largely by humans who somehow guarded the quality threshold for a web page to make it into the directory. Search engines are often filled on the
  basis of mechanical crawling, where algorithms like
  <a href="https://en.wikipedia.org/wiki/PageRank">PageRank</a> extract quality information out of the web's hyperlink graph. With
  <a href="https://www.facebook.com/about/graphsearch">GraphSearch</a>, Facebook proposes to offer a search engine which is biased towards the searcher's reported interests
  and those of their friends.</p>
<p>In the case of bookmarks and shared links, the quality of links is also guarded by the human choice to retweet something or to forward a certain email. In a way, this
principle allows the blogosphere to partially replace some of the roles of journalism. It is also interesting how this blurs the barrier between objective knowledge and
socially local opinions or viewpoints.</p>
<p>If you use Google in Spanish, from Spain, while being logged in with your Google account, you will not see all the same information an anonymous searcher may find
  when searching from a different country and in a different language. This effect has been called
  the <a href="http://www.seroundtable.com/google-search-bubble-response-13591.html">Filter Bubble</a>.</p>
<p>Whether you see the filter bubble as an enhancement of your search experience or as a form of censorship may depend on your personal preference, but in any case it is
  good to be aware of it, so you can judge the search results you get from a search engine a bit more accurately. In a real life situation you would also always take into
  account the source of the information you consume, and <a href="https://en.wikipedia.org/wiki/Meme">memes</a> generally gain value by travelling (or failing to travel)
through the web of trust, and in collaborative indexes.</p>
<p>Socially local effects on search results are often implemented in centralized ways. For instance, Amazon was one of the first websites to pioneer the "people who bought
  this product also bought this other one" suggestions.</p>

<h3>Don't track us</h3>
<p>Offering good suggestions to users from a centralized database requires building up this database first, by tracking people. There are several ways to do this; in order
  to protect people's privacy, it is important to anonymize the logs of their activity before adding it to the behavioral database. It is also questionable if such
  information should be allowed to be federated between unrelated services, since this leads to the build-up of very strong concentrations of power.</p>
<p>Whereas Amazon's suggestion service mainly indexes products which Amazon sells to its users itself, Google and Facebook additionally track what their users do on unrelated
  websites. When a website includes Google Ads or Google Analytics, information about that website's users is leaked to Google. If a website displays a 'Like' button,
  it leaks information about its visitors to Facebook.</p>
<p>All this tracking information is not only used to improve the search results, but also to improve the targetting of the advertising that appears on websites. If you read
  <a href="http://thegooglestory.com/">The Google Story</a>, it becomes clear how incredibly lucrative it is to spy on your users.
  Microsoft even crawls hyperlinks which it obtains by
  <a href="http://yro.slashdot.org/story/13/05/14/1516247/microsoft-reads-your-skype-chat-messages">spying on your Skype chat logs</a>.
  In my opinion it is not inherently evil 
  for a service to spy on its users, as long as the user has the option to choose an alternative that doesn't. A restaurant that serves meat is not forcing anyone to eat
  meat (unless it sneaks the meat into your food without telling you).</p>
<p>The free technology movement is currently not really able to offer viable alternatives to Google and to Facebook. A lot of projects that try come and go, or don't hit
  the mark, and it sometimes feels like an uphill struggle. But I'm confident that we'll get on top of
  this again, just like the free-tech alternatives to all parts of the Microsoft stack have eventually matured. Ironically, one of the main nails in the coffins of the
  Microsoft monopoly, Firefox, was largely supported with money from the Google monopoly. Placing Google as the default search engine in the branded version of Firefox
  generated so much revenue that it allowed the project to be as successful as it is today.</p>
<p>I don't know which part of Google's revenue is caused purely by searchterm-related advertising, and which part is caused by Google tracking its users, but in any case
  users of Firefox, and users of the web in general, have the option to use a different search engine. The leading non-tracking search engine seems to be
  DuckDuckGo currently. Although its search results for rare specialist searches are not as good as those of market leader Google, I find that for 95% of the searches I do,
  it gives me the results I was looking for, which for me is good enough to prefer it over Google. In occasions where you still want to check Google's results, you can add
  a "!g " bang at the front of the search term, and it will still direct you to a Google results page.</p>
<p>DuckDuckGo doesn't track you, and also does not currently display any advertising. Instead, it gets its revenue
<a href="http://www.quora.com/Search-Engines/What-is-DuckDuckGos-business-model">from affiliate sales</a>, which seems to me like a good option for financing
  freedom-respecting products. I would say it's basically comparable to how Mozilla finances Firefox. And another nice feature of DuckDuckGo is of course that they sponsor
  us and other free software projects. :)</p>
<p>There are also decentralized search engine projects like <a href="http://www.yacy.net/en/">YaCy</a>, but they have a barrier for use
  in that you need to install them first, and when I tried out YaCy right now, searching for a few random terms showed that unfortunately it's not really usable
  as an everyday primary search engine yet.</p>

<h3>Leaking the social graph into the public domain</h3>
<p>Locating information on the web is one thing, but what about contacting other web users? When meeting people in real life, you can exchange phone numbers, email addresses,
  or personal webpage URLs. Most people who have a personal webpage, have it on Facebook (their profile page). This has lead to a situation where instead of asking
  "Are you on the web?", many people ask "Are you on Facebook?". There are two reasons for this.</p>
<p>First of all, of course, the Facebook application allows me to send and receive messages and updates in a namespace-locked way: as a Facebook user, I can only communicate
  with users whose web presence is on Facebook.</p>
<p>The second reason is that Facebook's people search only indexes personal web pages within its own namespace, not outside it. This means that if I use Facebook as a
  social web application, searching for you on the web will fail, unless your webpage is within the Facebook namespace.</p>
<p>This is of course a shortcoming of the Facebook user search engine, with the effect that people whose personal webpage is outside Facebook are not only harder to
  communicate with, they are even harder to find.</p>
<p>And Facebook is not the only namespace-locked user search engine. There's also LinkedIn, Twitter, Google+, and Skype. Searching for a user is a different game from
  searching for content. The "social graph", that is, the list of all personal web pages, and their inter-relations, is not that big in terms of data size. Let's make a
  quick calculation: say the full name of a user profile is about 20 characters long on average, with about 5 bits of entropy for each character, then that would require
  100 bits.</p>
<p>Let's estimate the same
  for the profile URL and the avatar URL. If we want to accommodate 1 billion users, then a friend link would occupy about 30 bits, but that would be compressible again
  because the bulk of a user's connections will be local to them in some way. So to store 150 connections for each
  user, we would need about 3*100+150*30=4800 bits, less than 1 Kb. That means the Earth's social graph, including 150 friendships per human, plus
  a full name, photo, and profile URL for each, would occupy about 1 billion Kilobytes, or one Terabyte. That easily fits on a
  commodity hard disk nowadays.</p>
<p>A search engine that indexes information on the web needs to be pretty huge in data size and crawler traffic in order to be useful. And the web's hypertext architecture
  keeps it more or less open anyway, as far as findability of information is concerned. In a way, a search engine is just a website that links to other websites.</p>
<p>But for user search, the situation is very different. If you are not findable on the web as a user, then you cannot play along. It's like you are not "on" the web.
  The current situation is that you have to say which namespace your web presence falls under, in order to be findable. So instead of saying "Yes, I am on the web", we
end up saying "Yes, I am on Facebook", so that people know that the html page that constitutes my web presence can be found using that specific namespace-locked user
search engine.</p>
<p>I think it is our duty as defenders of free technology to build that one-Terabyte database which indexes all public user profiles on the web.</p>
<p>It is important of course to make sure only publically accessible web pages appear in this database. If you happen to know the private email address of someone, you
  shouldn't submit it, because that would only lead to a breach of that person's privacy. They would probably start receiving spam pretty soon as a result.</p>
<p>Since a lot of websites now put even their public information behind a login page, it may be necessary to log in as a random "dummy user" to see a certain page. That
  is then still a public page, though. Examples are <a href="https://facebook.com/michielbdejong">my Facebook page</a>, the Quora page I linked to earlier, and although
  a <a href="https://twitter.com/michielbdejong">Twitter profile page</a> is accessible without login,
  a <a href="https://twitter.com/michielbdejong/following">list of followees</a> is not. Such pages can however be accessed if you create a dummy account for the
  occasion, so I still classify them as "public content on the web".</p>
  <p>Independent of whether
 people's user profiles appear in one of the big namespaces, or on a user's own Indie Web domain name, we should add them to our database. Constructing this may technically
    breach the terms of service of some social network hosting companies, but I don't think that they can claim ownership over such user content if that went to court.
    So once we have this dump of the web's social graph, 
  we can simply seed it on bittorrent, and "leak" it into the public domain.</p>
<p>This is an irreversible project though, so <a href="https://groups.google.com/d/msg/unhosted/DnxSdQ8xU0E/FioTHzT01soJ">please comment</a>
if you think it's a bad idea, or have any other reactions to this episode.</p>
</div><div class="episode">      <h2><a name="episode-23" "id="#episode-23" href="#episode-23">23.</a> Network neutrality, ubiquitous wifi, and DRM</h2>

<!-- neutrality: Network Neutrality -->
<h3>Technology as a tradable asset</h3>
<p>When a caveman invents a hammer, he can choose whether or not to share this invention with others within the same tribe. He, or the tribe as a whole, can then further decide whether or not to share this invention with other tribes. Once these cavemen develop a bit of business sense, such an invention can also be licensed and traded against other knowledge, objects, or services. Apart from that, the actual hammer itself can be sold as a tool or rented out.</p>
<p>From the fact that humans and tribes of humans interact voluntarily, and can choose each time whether they will do so peacefully or aggressively, it is obvious that the knowledge of an invention is usable as an advantage over the other party in such interactions. Hence the idea of technology as something you can possess. When this possession and tradability of technology is regarded as ownership, some people call that <a href="https://en.wikipedia.org/wiki/Intellectual_property#The_term_itself">intellectual property</a>.</p>
<p>The same is true for the possession of objects, especially scarce ones like maybe the hammer you just invented and made, as well as skills, and even the occupation of land. They all become property as soon as they are negotiated over in interaction with other humans.</p>

<h3>Common knowledge and infrastructure</h3>
<p>On the other hand, it will be hard to prevent other cavemen from copying an invention once they see it. Within a tribe there may be a social rules system that forbids copying each other's inventions, but once an invention is "out there", it belongs to nobody, and to everybody at the same time. It can no longer be used as a "tradable proprietary asset" in a negotiation, as it will have become common knowledge. Tradability depends on scarcity.</p>
<p>Common knowledge becomes, in a way, part of the world itself. A similar thing happens with public infrastructure. It is natural to humans to have a sense of territory and land ownership, but the network of roads and rivers that connects these places, the transport infrastructure, should not be owned by anyone. That way, everybody can travel freely without bothering anybody else, and interaction stays voluntary.</p>
<p>Now let's try to apply this picture to the modern day. IP networks are the public roads of our time, and instead of borrowing hammers from other cavemen, we may for instance watch videos on each other's websites. But the principles are still the same.</p>

<h3>Network neutrality</h3>
<p>The term <a href="http://timwu.org/network_neutrality.html">network neutrality</a> can be defined as a design principle, dictating that
internet service providers (ISPs) should offer connectivity as a <a href="http://www.rageboy.com/stupidnet.html">dumb pipe</a>. This is of course hard to dictate, because ISPs are commercial ventures that offer a service on a take-it-or-leave-it basis, in a free market.</p>
<p>But because the internet is so important to humanity, it seems fair to consider internet connectivity more a part of the world's infrastructure than a tradable product. And this last-mile connectivity should be agnostic of which specific online resource or destination you connect to. As Tim Berners-Lee puts it, <a href="http://dig.csail.mit.edu/breadcrumbs/node/132">we each pay to connect to the Net, but no one can pay for exclusive access to me</a>.</p>
<p>One good thing about <a href="https://unhosted.org/decentralize/19/BGP,-IP,-DNS,-HTTP,-TLS,-and-NAT.html">the decentralized architecture of BGP</a> is that it is not possible to monopolize internet access. It is always possible to start another ISP. This is not necessarily true for the existing last-mile infrastructure though, the cables and frequency bands that are closest to the user's device. There are often government regulations and economies of scale there that mean that a consumer may only have a choice of one or two ISPs.</p>
<p>And when this happens, ISPs have a monopoly power over the product the consumer receives, which it can leverage to offer your last-mile connectivity in a selective way, filtering part of your traffic based on who you connect to, or charging the websites you connect to money, while threatening to selectively block them otherwise.</p>

<h3>Ubiquitous public connectivity</h3>
<p>Regulating ISPs is one solution to this problem. They often need a license from a nation state government to operate, and you can make that license conditional on them offering a network neutral product.</p>
<p>A more fundamental solution would be to install globally ubiquitous public connectivity. The <a href="https://openwireless.org/">Open Wireless Movement</a> promotes sharing your wifi connections with others near you, and in many backpacker destinations it is common to find wifi networks without a password on them.</p>
<p>Unfortunately, opening up your wifi in for instance Germany makes you responsible for the traffic that goes through it, which means a lot of people are hesitant to do so. Also, wifi was not designed to be <a href="https://www.eff.org/deeplinks/2011/04/open-wireless-movement">open and encrypted at the same time</a>, which means that in practice you need to either set up two separate SSIDs, or give up encryption for your own use.</p>
<p>More countries should follow <a href="http://marginalrevolution.com/marginalrevolution/2012/04/the-internet-in-estonia.html">Estonia's example</a>, where ubiquitous public wifi is apparently a reality already. But publically sharing wifi connections is not the only part of the solution. It does in fact not even, in itself, do anything to safeguard the openness of the last mile, since at some point all the traffic still goes through an ISP who installed the wifi point that is being shared.</p>
<p>There is a lot of interesting research going on in mesh wifi. Community projects like <a href="http://guifi.net/en/node/38392">guifi.net</a>, <a href="http://www.funkfeuer.at/index.php?id=42&L=1">funkfeuer.at</a> and <a href="http://wiki.freifunk.net/Kategorie:English">freifunk.net</a>, and technology projects like <a href="http://villagetelco.org/">Village Telco</a>, <a href="http://thefnf.org/">the Free Network Foundation</a> and <a href="http://www.servalproject.org/">Serval</a> are promising that it may one day be possible to circumvent ISPs altogether for at least part of our connectivity.</p>

<h3>Digital Rights Management</h3>
<p>Last-mile neutrality is important, but so far all attempts to sell "partial connectivity" have all failed. Phone companies and TV manufacturers have tried to offer walled gardens with curated content to which you may connect from your device, but so far, consumers have always chosen devices that give access to the whole internet.</p>
<p>A principle that may be at least as decisive for maintaining a neutral web is what you could call "device neutrality". Many devices are sold with closed-source software on them that limits them from accessing certain parts of the web.</p>
<p>A prime example is of course the iPhone on which you may only install apps from Apple's App Store. Although an iPhone allows you to visit any website you want, native apps can only be installed from Apple, and not from other software channels. Here it is not the ISP, but the device manufacturer who is using their position to dictate which other devices you should (not) communicate with.</p>
<p>A more subtle variation on this is Digital Rights Management (DRM), a setup where a device's capabilities are reduced on purpose, in order to limit the ways in which you interact with some of the content you find online.</p>
<p>Through DRM, the device you use effectively becomes an extension of a service that is offered via the internet. The Amazon Kindle is a prime example of this, it is an extension of Amazon's online shopping website, and allows Amazon to limit, post-sale, your access to the eBooks you purchased.</p>
<p>Of course, there is nothing wrong with Amazon offering the Kindle for sale, or Apple offering the iPhone for sale, they do so on a take-it-or-leave-it basis. Humanity as a whole is still free to keep developing free and neutral internet connectivity, as well as free and neutral devices with which you can access a wealth of free and neutral online resources.</p>
<p>What <em>is</em> very wrong, is that <a href="http://www.w3.org/QA/2013/05/perspectives_on_encrypted_medi.html">the W3C is now supporting DRM</a>, even though <a href="https://www.eff.org/deeplinks/2013/03/defend-open-web-keep-drm-out-w3c-standards">the EFF asked them not to</a>. The W3C should be on the side of open and neutral technology, and not on the side of closed and encumbered technology. The former is fragile and needs protecting, the latter is lucrative and will exist anyway.</p>
<p>It is not bad that closed technology exists, but an organization like W3C supporting it sends the wrong signal and is of course detrimental to its mission. It is hard to understand how it has been possible for the W3C to make this mistake, and we can only hope they will give their own mission statement another good read, discover their folly, and revert it.</p>
<p>To be fair though, the W3C's recent behavior is not nearly as disappointing as Google's and Twitter's abandonment of rss and xmpp, as we'll discuss in next week's episode, which will be about <em>federation</em>! :)
Until then, if anyone would like to comment on this episode, <a href="https://groups.google.com/d/msg/unhosted/4smSXyEfTVs/kRGo8nG_DuIJ">please do!</a></p>
</div><div class="episode">      <h2><a name="episode-24" "id="#episode-24" href="#episode-24">24.</a> Decentralizing the web by making it federated</h2>

<!-- federation: Decentralizing the web by making it federated -->
<h3>Clients and servers</h3>
<p>The end-to-end principle that underlies the basic design of the internet treats all devices in the same neutral way. But in practice, that is not what the internet does. There is quite a strict distinction between client devices in one role, and (clusters of) servers in the other.</p>
<p>Generally speaking, a server is addressable, and a client is not. A server usually has a domain name pointing to it, and a client device usually doesn't. A big chunk of internet traffic is communication between one client device and one server. When two client devices communicate with each other, we call that peer-to-peer communication. And the third category is server-to-server traffic, where two or more servers communicate with each other.</p>

<h3>Server-to-server traffic</h3>
<p>The actual consumption of the usefulness of the internet happens on the client devices. The servers only ever play an intermediate role in this. This role can be to execute a certain data processing task, to store data for future use, or to be an addressable intermediate destination where data can be routed to.</p>
<p>The ability to store and process data is pretty generic and replaceable. It is the addressibility of servers, and restrictions based on that addressability, that can give them an irreplaceable role in certain communication sessions.</p>
<p>As an example, let's have a look at XMPP. This protocol is used a lot for text chat and other real-time communication. The standard describes a client-to-server protocol and a server-to-server protocol. If alice@alice.com wants to contact bob@bob.com, then she tells her client device to connect to her alice.com server. Bob also tells his client device to connect to the bob.com server, so that he is online and reachable. After that, the alice.com server can contact the bob.com server to successfully deliver a message to Bob. So the message travels from Alice's client, to Alice's server, to Bob's server, to Bob's client.</p>
<p>It is obvious why the message cannot travel directly from Alice's client device to Bob's client device: even if Bob is online (his client device is connected to the internet), client devices are not (practically) addressable, so at least one server is needed as an intermediate hop that can bounce the message on to Bob's current network location.</p>
<p>What is maybe not so obvious is why the client-server-server-client trapezium is needed, instead of a client-server-client triangle. The reason for this is that it makes it easier to check sender identity.</p>
<p>When the bob.com server receives a message from somewhere, this message might be spam. It needs some way to check that the message really came from Alice. The alice.com server can in this case guard and guarantee Alice's sender identity. The XMPP protocol
<a href="http://xmpp.org/rfcs/rfc3920.html#stanzas">uses SASL</a> to allow the bob.com server to know that it is the alice.com server that is contacting it.</p>
<p>It would be possible to do something like that in a client-server-client triangle route, but that would require the client to provide a proof of identity, for instance if the sending client creates a message signature from the private part of an asymmetric key pair, like PGP does. Even then, people usually relay outgoing email through their mailserver because email from domestic IP addresses is often blocked, both by the actual ISP, and by many recipient mailservers.</p>
<p>The client-server-server-client trapezium can also help to act as a proof-of-work on part of the sender, thus making massive spam operations more expensive: the sender needs to maintain a sending server, which is more work than just connecting directly to the receiving server.</p>
<p>Web hosting is a prime example where the client-server-client triangle route is used, but in this case it is the sender's server that is used, since the recipient of the content of a web page does not need to be addressable. Messaging protocols don't have that luxury, so most of them use the client-server-server-client trapezium route where server-to-server traffic forms the central part.</p>

<h3>The internet as a federation of servers</h3>
<p>For internet traffic that follows a trapezium-shaped client-server-server-client route, both the sending and the receiving user connect their client device to their own server. So clients are grouped around servers like moons around planets, and server-to-server connections form the actual federated network, where any server that has a domain name pointing to it and that speaks the right protocols, can participate.</p>

<h3>Alas, not really</h3>
<p>Unfortunately, this picture is only how the federated internet was designed. It doesn't truthfully reflect the current-day situation in practice. First of all, the vast majority of users don't run their own server, and don't even have their own domain name; not even a subdomain. In fact, only a handful of DNS domainnames are used to create user identities, "*@facebook.com" currently being the most important one.</p>
<p>Furthermore, a lot of the interconnections between servers are missing. This means that a user needs to establish a client-to-server connection to the Google XMPP interface <em>as well as</em> the Facebook XMPP interface, in order to successfully chat with all their friends.</p>
<p>Facebook chat has always been a "walled garden" in this sense; you can connect your own client device using its xmpp interface, but you're connecting into "the Facebook chat world", which is limited to conversations with both ends inside the Facebook namespace. Google used to offer proper xmpp hosting, just like it offers email hosting, but they recently announced that they are
<a href="http://eschnou.com/entry/whats-next-google--dropping-smtp-support--62-24930.html">discontinuing XMPP federation</a>.</p>
<p>When you search for a user, Facebook search will only return Facebook users among the results,
so to a user who has their identity on facebook.com, it looks as if only the people exist who happen to be on facebook.com too. Google Search
still returns results from web pages that are hosted on other domain names, but the Google+ people search does not show results from Facebook, it only returns links to profiles of people who happen to host their identity on plus.google.com.</a>
<p>The <a href="http://eschnou.com/entry/what-the-hell-happened-to-federated-social-networks-62-24936.html">federated social web</a>
effort consists of projects like buddycloud, diaspora, friendika, statusnet and others, which offer software and services that fix this. But as discussed in <a href="https://unhosted.org/adventures/1/Personal-servers-and-unhosted-web-apps.html">episode 1</a>, these project often only federate with themselves, not with each other, let alone with the "big players" like Google, Facebook, Twitter, etcetera.</a></p>
<p>The big identity providers have stopped federating, so in order to still communicate with humans, your server should become a client to each platform, rather than federating with it. This is a sad fact, but it's the situation we face. Instead of simply running an xmpp server to connect with users on other domains, you now <em>also</em> have to run multiple xmpp clients to connect to users on Google and Facebook.</p>

<h3>A non-profit hosting provider</h3>
<p>Ten years ago, when the web was still federated, I used to work at a hosting company. People who wanted to be on the web would register a domain name, and upload a website via FTP. They would set up email accounts through our control panel, and maybe add our "site chat" widget to their site, so their website visitors could also contact them for live chat. Nowadays, people who want to be on the web, sign up at Facebook, Twitter, Google, or a combination of them. The federated web that used to exist has been replaced by a "platformized" web.</p>
<p>In the light of this situation, I think it is necessary that someone sets up a non-profit hosting provider. This provider would offer web hosting, but not with an ftp or ssh interface; instead, the user experience would be very similar to setting up your profile on Facebook or Twitter. The service could be entirely open source, be
<a href="http://tantek.com/2013/113/b1/first-federated-indieweb-comment-thread">federated using web standards</a>,
allow people to use their own domain name, and be based on unhosted web apps, so people can choose to only use the app, or only use the
data hosting, or both.</p>
<p>The business model could be similar to how Mozilla develops Firefox (they get money for setting the default search engine), in-app sales, a freemium model, a "free for personal use" setup, or simply asking its own users for a contribution once a year, like Wikipedia do.</p>

<p>During the past three years we have worked on developing <a href="http://www.ietf.org/id/draft-dejong-remotestorage-03.txt">specs</a>,
<a href="http://remotestorage.io/">software</a> <a href="http://sockethub.org/">libraries</a>, <a href="https://unhosted.org/apps/">apps</a>,
and <a href="http://tosdr.org/">campaigns</a>. We can use unhosted web apps ourselves, but for most end-users the entry threshold is still too high. We can convince sysadmins (like for instance those at European universities) to offer remoteStorage accounts to their users, and we can convince app developers to accept unhosted accounts, but we're not reaching any end-users directly with that. Using remoteStorage and Sockethub as the basis for a "Mozilla-style Facebook" would be a much more tangible result.</p>
<p>Also as Laurent remarked, it would simply be very funny if Unhosted becomes a Hosting provider. :) So I'll take a short break from writing this blog, and look into setting something like that up during the summer months. If anyone would like to comment on this plan, or on anything else mentioned in this episode, <a href="https://groups.google.com/d/msg/unhosted/34ZEm3VcL1U/VauLNerMFPEJ">please do!</a>. In any case, I'll let you know when I have something ready for alpha testing, and hope to see you all in <a href="http://2013.unhosted.org/">Unho&#353;&#357;</a>!</p>
</div><div class="episode">      <h2><a name="episode-25" "id="#episode-25" href="#episode-25">25.</a> Anonymity</h2>

<!-- Anonymity -->
<h3>Freedom of Expression, Privacy, and Anonymity</h3>
<p>I'm resuming this blog after a one-year break. When reading back the first 24 episodes, which were
written &quot;pre-Snowden&quot;, it struck me
how much the topic of government surveillance was already present in our conversations about internet freedom.
But even more so now that we live in a &quot;post-Snowden&quot; world, it seems to be a default assumption
that internet freedom projects are about protection from government spying.</p>

<p>Even when you explicitly say your
aim is to break the web 2.0 monopolies, many people assume that the ultimate goal of this is to get everyday
communication away from the reach of NSA spying. This is also confirmed as Francis
<a href="http://redecentralize.org/blog/2014/01/10/four-motivations.html">summarizes</a>
common motivations for redecentralization
with privacy as the most important one, before resilience, competition and fun.</p>

<p>The first pre-requisites for freedom of expression are access and know-how: you need access to a device through which you
can send your message towards its destination, and you need to know how to use this device to do this. When a government
blocks Twitter, it becomes harder for its citizens to express their political views, because they may not be aware of
other channels and how to use them. A big task for the hacker community is to provide access and know-how to citizens whose
freedom of expression is under attack.</p>

<p>The third pre-requisite is freedom from prosecution after expressing your opinion. This is where anonymity
can play a role, and contribute to freedom of expression. When you express your political views under an ad-hoc identity
or a pseudonym, successfully erase all traces back to you as a physical person, and for the rest of your life keep it a
secret that it was you who published this opinion under this pseudonym, then the politicians who want to shut you up may be
unable to find you. Alternatively, you can move your life outside the jurisdiction of these politicians, as Edward Snowden did
by moving from Hawaii to Moscow Airport.</p>

<p>Another reason to want privacy is that eavesdropping is immoral and annoying. We want to be able to have a conversation
with the audience of our choice, without having to think about who else is able to follow what is being said. Keeping the
content of a conversation private does not require any expensive equipment. As an engineering problem, it is solved by for instance PGP.
In practice, however, it requires quite a lot of extra effort and know-how, so that hardly anyone bothers.</p>

<h3>Ad-hoc Identities vs. Pseudonyms</h3>

<p>Hiding the fact itself that you are having a conversation with someone, is quite a bit harder. For your pre-existing contacts
and real-world contacts, you could create a set of one-time-use identities, and give these out inside encrypted conversations. You
can then shut down your public identity, and only communicate through these unrecognizable identities. As long as you manage to hide the last
mile where you retrieve the incoming messages onto a device at your physical location, an outsider will have a hard time finding out
when you communicated with which of your friends.</p>

<p>There are also situations when you want to publish a message to an open-ended audience, without exposing your real-world identity.
For this, you can use a pseudonym. The Bitcoin software was published this way, for instance, and it is to this day unknown who is the
real person or group of persons behind the <a href="https://en.wikipedia.org/wiki/Satoshi_Nakamoto">Satoshi Nakamoto</a> pseudonym.</p>

<p>It's important not to use a pseudonym where what you need is ad-hoc identities. Many people use an online nickname which is unrelated
to their birthname. In some situations, this will give some limited anonymity in interactions with other online identities, but in the end
it's practically impossible to have normal everyday interactions under such a nickname without the link to your real-world identity becoming
known.</p>

<p>In both real-world and online conversations, someone is bound to use your pseudonym and your real name in a careless combination and expose
their relation sooner or later. Examples are <a href="https://en.wikipedia.org/wiki/Batman">Bruce Wayne</a> and
<a href="https://en.wikipedia.org/wiki/Why_the_lucky_stiff">Jonathan Gilette</a>.

<h3>Tor, freenet, and i2p</h3>
<p>An important tool for anonymously accessing the internet is <a href="http://torproject.org/">Tor</a>. It mixes up your internet traffic
by adding a few extra random hops to the route of each request. It is popular with political activists who need to worry about who is watching
their actions. Do make sure though that your device is not backdoored, and that you don't reveal your identity by logging in to any of your
email or other accounts when using Tor. Tor can anonymize your client traffic, but it is also possible to expose a server via Tor, such that
other people can access your server without finding out where this server is physically located.</p>

<p>When publishing important content anonymously, an alternative to running your own server as a Tor hidden service is to publish it on Freenet, or
through Wikileaks or a journalist you trust. It may seem paradoxical that in such a case, encrypting and signing your messages with your PGP
identity can form an important part of establishing the trust between you and the journalist, so you end up using verifiable identities to ultimately
achieve anonymity.</p>

<p>In practice, it is hard to keep multiple identities separate, and not many people use anonymity to protect their privacy on a day-to-day basis.
A small group of people use PGP to hide the content of their personal communication from third-party eavesdropping, but this involves publishing your
PGP identity, and unless you use ad-hoc identities, this probably actually hurts rather than helps your anonymity. Using a pseudonymous PGP identity
may work to some extent, but in practice only one leak will be enough to link all communication under that pseudonym to your other pseudonyms and your
real-world identity as a physical person.</p>

<p>So in practice, I think we can achieve two things with online privacy and anonymity: first of all,
freedom of speech for important messages, where it matters enough to go through extra trouble. This can be achieved using off-the-shelf technology.
The main difficulty here is not technical, but human: you need a good poker face when people keep asking you "Are you [Batman/Nakamoto/...]?".</p>

<p>The other thing we can achieve is an internet where conversations stay between the participants unless these participants choose to leak what
was said. For the content of the conversation, this is already achieved by using an encrypted protocol like for instance WebRTC. I am not aware
of any software application or protocol that automatically generates and uses ad-hoc identities between contacts, but you could do this manually:
Whenever you send an email, use a randomly generated from and reply-to address which you will use only once, and include your signature inside the encrypted
payload, so that only the intended recipient of your message will discover that this message was actually from you.</p>

<p><a href="https://groups.google.com/d/msg/unhosted/4PB9y2iNgB8/dDQLsq8kH6kJ">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-26" "id="#episode-26" href="#episode-26">26.</a> Decentralized reputation systems</h2>

<!-- reputation: Decentralized reputation systems -->
<h3>Decentralized reputation systems</h3>

<p>When communicating with pre-existing contacts, trust is simply established by making sure the other person is who they say they are.
As discussed in <a href="../17/Cryptography.html">episode 17</a>, this can be done using a combination of DNS, PGP, and checking whether
the other person sounds like themselves in how they interact with you. But when interacting with strangers, trust can be based on reputation.</p>

<p>Basing trust on reputation is fundamentally unreliable, since a person's past behavior is no guarantee for their future behavior. But a certain
game theoretical assurance can be achieved when people not only prove that they have a certain reputation from past behavior, but also risk this
reputation. Assuming the other person is a rational agent, they will not destroy a valuable reputation in order to trick you once in a relatively
small interaction. A seller on ebay or airbnb is unlikely to treat you unfairly if they risk getting a negative review from you.</p>

<p>This means the person being reviewed, in turn, assumes the reviewer will be fair. It is not always clear what the game theoretical advantage is
of reviewing people fairly, but there is also no advantage in reviewing people unfairly, and I guess people are just fundamentally nice to each other
when they have nothing to lose by it. In any case, in most reputation systems, reviewing is a voluntary act of altruism, both (in case of a
positive review) towards the person you are reviewing, and towards the other future users of the system or website to which you are adding the review.
Examples of such systems are <a href="https://news.ycombinator.com/">Hacker News</a>, <a href="https://stackoverflow.com/">Stack Overflow</a>,
<a href="https://twitter.com/">Twitter</a>, <a href="https://linkedin.com/">Linked In</a>,
<a href="http://www.ebay.com/">eBay</a>, <a href="https://amazon.com/">Amazon</a> (reviewing books rather than humans),
and <a href="https://airbnb.com/">AirBnB</a>.</p>

<p>On your Indie Web site, you will probably link to some of your &quot;claims to fame&quot;, so that people who look you up online can see how many
Twitter followers and Github projects you have. This way, you can bootstrap your reputation from your reputation inside these centralized web2.0 walled
gardens. You could also post PGP-signed recommendations from other people on your website, for instance a few customer reviews of products you offer.</p>

<p>Reputation is not a scalar. You can be a good JavaScript programmer on Stack Overflow, but a poor host on AirBnB. If we are to automate
decentralized reputation
on the web then we would have to take this into account.</p>

<p>The most reliable way to let people review each other would seem to be if reviewers take a certain risk when inaccurately reviewing someone -
for instance their own reputation. Humans dedicate a considerable part of their brain activity to reputation of themselves and others in a group,
and a lot of human activity is dedicated solely to establishing a good reputation, status and fame. Even people who don't have enough money to buy
proper food, health, and education for themselves, often spend a lot of money on jewellery and flashy cars which basically act as proof-of-work to
increase their social status within the village or group.</p>

<p>We have only just started the era in which people tout their prosperity online instead of in the material world, and I think a lot will change
in how the economy works when people care ever more about their number of Twitter followers, and ever less about the brand of their car.</p>

<h3>Reputation spam</h3>
<p>A very interesting system implementing reputation on top of pseudonymity is <a href="https://gnunet.org/">gnunet</a>. It uses the principle that
a newly created user account should have a value of zero, otherwise an adversary can simply destroy their reputation and then create a new user account.</p>

<p>Reputation in gnunet is built up using a sort of tit-for-tat scheme, which they call an <a href="https://gnunet.org/ebe">excess-based economic model</a>, since newcomers can only use the network's excess capacity. This boils down to: don't trust your neighbours a priori; at first, you will only answer their requests when you're idle. Over time, allow them to invest in their relationship with you
by answering <em>your</em> queries, while not sending too many queries themselves. As their score increases, you will eventually allow them to send requests at higher effective priorities as well.</p>

<h3>Peer education</h3>
<p>Universities have an often centuries-old reputation, giving them the power to judge which students pass and which students fail their tests, even though
there is a big monetary incentive to give out false diplomas. If we want online peer education to become bigger, we need a system like that, where a teacher
can gain reputation, and a student can become a teacher. Good teachers could charge money for their classes, while teaching material can be (and already is)
available in the public domain.</p>

<p>Likewise, a student can get a &quot;diploma&quot; from a renowned teacher when they pass a test. This test can even be highly automated as an online service
to improve efficiency, but the value of the diploma would come from the reputation of the teacher who (digitally) signed it.</p>

<p>A lot of space for future research is open in this area, and I expect a lot of exciting developments over the coming years. This episode concludes the second
part of this blog series, about theoretical foundations for building freedom from web2.0's platform monopolies. In the third and last part, we will look at
practical issues related to building unhosted web apps.
<a href="https://groups.google.com/forum/#!topic/unhosted/O0LTSqga9RA">Comments welcome!</a></p>
</div><div class="episode">      <h2><a name="episode-27" "id="#episode-27" href="#episode-27">27.</a> Persisting data in browser storage</h2>

<!-- Storing data locally -->

<p>Today we'll look at storing and caching data. As we said in the <a href="/">definition of an unhosted web app</a>, it does not send the user's data to its server (the one from which its source code was served).
It stores data either locally inside the browser, or at the user's own server.</p>

<p>The easiest way to store data in an unhosted web app is in the DOM, or in JavaScript variables. However, this technique has one big
dangerous enemy: the page refresh.</p>

<p>Refreshing a page in a hosted web app usually means the data that is displayed on the page, is retrieved again from the server.
But while using an unhosted web app,
no user data is stored on the server, so unless the app takes care to store it locally or at the user's server,
if the user refreshes the page, all data that is stored in JavaScript variables, is removed from memory.
This does not happen when pressing the &quot;back&quot; or &quot;forward&quot; button, although
in Chrome (not in Firefox), pressing &quot;back&quot;,
&quot;refresh&quot;, &quot;forward&quot; does flush the memory, also for the forward page.</p>

<p>It's possible to warn the user when they are about to leave the page, using the
<a href="https://developer.mozilla.org/en-US/docs/Web/Events/beforeunload">beforeunload event</a>.
Also, the current URL can be used as a tiny data storage which is page refresh resistant,
and it is often used for storing the current state of menu and dialog navigation.
However, in-memory data as well as the current URL will still be lost when the user shuts down their computer, so for any app that
manages important data, it's necessary to save the data in something more persistent than DOM or JavaScript memory.</p>

<h3>Places that cache remote data</h3>

<p>Apart from surviving the page refresh, and the device reboot, another reason to store data locally,
is to cache,
so that a copy of remote data is available faster, more reliably,
and more efficiently. Http is built to allow transparent caching at any point. Your ISP is probably caching popular
web pages to avoid retrieving them all the time. When your browser sees a "304 Not Modified" response to a conditional
GET request, this may come from the cache at the ISP level, or at any other point along the way.</p>

<p>However, when syncing user data over the web, you would usually be using a protocol that is end-to-end encrypted at the transport
layer, like https, spdy or wss, so between the
point where the data leaves the server or server farm, and the point where the browser receives it, the data is
unrecognizable and no caching is possible.</p>

<p>Your browser also caches the pages and documents it retrieves, so it's even possible that an XHR request looks like it
got a 304 reponse code, but really the request didn't even take place. The browser just fulfilled the XHR request with
a document from cache.</p>

<p>Then there are
<a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Social_API/Service_worker_API_reference">ServiceWorkers</a>
and their predecessor,
<a href="https://developer.mozilla.org/de/docs/Web/HTML/Using_the_application_cache">AppCache</a>, which allow for yet another
layer of client-side caching.</p>

<p>In your application code, you probably also cache data that comes from XHR requests in memory as JavaScript objects,
which you then may also save to IndexedDB or another in-browser data store.</p>

<p>And finally, the data you see on the screen is stored in the DOM, so when your app needs to re-access data it retrieved
and displayed earlier, it could also just query the DOM to see what is there.</p>

<p>So even with transport layer encryption, if all these caching layers are active, then one piece of data may be stored
(1) on-disk server-side, (2) in database server memory or memcache server-side,
(3) possibly in process memory server-side, (4) at a reverse proxy server-side, (5) in the browser's http cache, (6) in appcache,
(7) maybe in a ServiceWorker cache, (8) in <code>xhr.response</code>,
(9) in memory client-side, (10) in the DOM. For bigger amounts of data it
can obviously be inefficient to store the same piece of data so many times, but for smaller pieces, caching can lead to a big speedup.
It's definitely advisable to use one or two layers of client-side caching - for instance IndexedDB, combined with DOM.</p>

<h3 id="persisting-client-side-data">Persisting client-side data</h3>

<p>Whether you're caching remote data or storing data only locally, you'll soon end up using one of the browser's persistent stores.
<strong>Do not ever use localStorage</strong>, because it unnecessarily blocks the browser's execution thread.
If you're looking for an easy way to store a tiny bit of data, then use
<a href="https://hacks.mozilla.org/2014/02/localforage-offline-storage-improved/">localForage</a> instead.</p>

<p>There's also a <a href="https://developer.mozilla.org/en-US/docs/Web/API/FileSystem">FileSystem</a> API, but it was never adopted by any browser other than Chrome, so that's not (yet) practical. That brings us to <a href="https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API">IndexedDB</a>.</p>

<p>When working directly with IndexedDB, the performance may not be what you had hoped for, especially when storing thousands of small items. The performance of IndexedDB relies heavily on batching writes and reads into transactions that get committed at once. IndexedDB transactions get committed automatically when the last callback from an operation has finished.</p>

<p>When you don't care about performance, because maybe you only store one item every 10 seconds, then this works fine. It's also useless in this case; transactions only matter when you update multiple pieces of data together. Typically, you would edit an item from a collection, and then also update the index of this collection, or for instance a counter of how many items the collection contains. In old-fashioned computer science, data in a database is assumed to be consistent with itself, so transactions are necessary.</p>

<p>This way of designing databases was largely abandoned in the <a href="http://en.wikipedia.org/wiki/NoSQL">NoSQL</a> revolution, about 5 years ago, but IndexedDB still uses it. To minimize the impact on the brain of the web developer, transactions are committed magically, and largely invisibly to the developer. As soon as you start storing more than a thousand items in IndexedDB, and reading and writing them often, this goes horribly wrong.</p>

<h3>Fixing IndexedDB by adding a commit cache</h3>

<p>In my case, I found this out when I decided to store all 20,000 messages from my email inbox in an unhosted web app.
The data representation I had chosen
stores each message by messageID in a tree structure, and additionally maintains a linked-list index for messages from each sender,
and a chronological tree index, meaning there are about 80,000 items in my IndexedDB database (probably about 100Mb).</p>

<p>Storing a thousand items one-by-one in IndexedDB takes about 60 seconds, depending on your browser and system. It is clear that this makes IndexedDB unusable, unless you batch your writes together. In version 0.10 of <a href="http://remotestorage.io/integrate/">remotestorage.js</a>
we implemented a &quot;commit cache&quot;, which works as follows:</p>
<ul>
<li>If no other write request is running, we pass the new write request straight to IndexedDB.</li>
<li>If another write request is still running, then we don't make the request to IndexedDB yet. Instead, we queue it up.</li>
<li>Whenever a write request finishes, we check if any other requests are queued, and if so, we batch them up into one new request.</li>
<li>There is always at most one IndexedDB write request running at a time.</li>
<li>Read requests are checked against the commit cache first, and the new value from a pending write is served if present.</li>
<li>Read requests that don't match any of the pending writes, are passed straight to IndexedDB, without any queueing or batching.</li>
</ul>
<p>This speeded up the process of storing lots of small items into IndexedDB by about an order of magnitude (your mileage may vary). You can see the actual implementation of our commit cache <a href="https://github.com/remotestorage/remotestorage.js/commit/395af3f8f80c8961b6bdf8c7d74fbb768a253dda">on github</a>.</p>

<h3>Other problems when working with IndexedDB</h3>

<p>With the commit cache in place, IndexedDB works pretty well. Just make sure you prevent page refreshes if an IndexedDB request is running, otherwise you will see an AbortError after the page refresh. Before I was using this commit cache, I often saw thousands of AbortErrors happening after a page refresh. This would sometimes take 10 or 15 minutes before the page was usable again.</p>

<p>If the user runs out of disk space, you'll get an UnknownError which you can't catch from your JavaScript code. In general, it's good to
keep track of which request you have sent to IndexedDB, and whether it is still running. I would advice against sending a new write request to
IndexedDB if the previous one is still running, to prevent the browser from becoming unresponsive.</p>

<p>It's also worth noting that <a href="http://caniuse.com/indexeddb">Safari 7 lacks IndexedDB support</a>, so you probably want to use a fallback
or polyfill for that. In the case of remotestorage.js we use a fallback to localStorage, but since localStorage blocks the JavaScript execution
thread, it's better to use a
<a href="http://nparashuram.com/IndexedDBShim/">polyfill over WebSQL</a> so that you can serve Safari 7 users.</p>

<p>But in general, depending on your application, you'll probably have to store data in IndexedDB. This can be data that will never leave the browser, data that is on its way to the user's server or to some third-party server, or data that you retrieved from somewhere, and that you want to cache. IndexedDB is one of the biggest friends of the unhosted web app developer!</p>

<p>Next week we'll look at sync. Comments welcome!</p>
</div><div class="episode">      <h2><a name="episode-28" "id="#episode-28" href="#episode-28">28.</a> Synchronizing browser storage with server storage</h2>

<p>When you use multiple devices, it's practical to have your data automatically copied from one device to another. Also, when you want to publish data on your web site to share it with other people, it's necessary to copy it from your device to your server.</p>

<p>Going one step further, you can use a setup in which the server, as well as each device, is considered to contain a version of essentially one and the same data set, instead of each holding their own independent one. In this case, copying data from device to server or from server to device always amounts to bringing the data set version at the target location up to date with the data set version at the source location.</p>

<p>When this happens continuously in both directions, the locations stay up-to-date with each other; the version of the data set each contains is always either the same, or in the process of becoming the same; the timing at which the data changes to a new version is almost the same at both locations. This is where the term &quot;synchronization&quot; (making events in multiple systems happen synchronously, i.e. at the same time) comes from.</p>

<p>In practice, there can be significant delays in updating the data version in all locations, especially if some of the synchronized devices are switched off or offline. Also, there can be temporary forks which get merged in again later, meaning the data set doesn't even necessarily go through the same linear sequence of versions on each location. We still call this coordination &quot;sync&quot; then, even though what we mean by it is more the coordination of the eventual version than of the timing at which the version transitions take place.</p>

<h3>Star-shaped versus mesh-shaped sync</h3>
<p>In the <a href="http://remotestorage.io/">remoteStorage</a> protocol there is only one server, and an unlimited number of clients. Versions in the form of ETags are generated on the server, and the server also offers a way of preventing read-then-write glitches with conditional writes that will fail if the data changed since a version you specify in the <code>If-Match</code> condition.</p>
<p>This means a client keeps track of which version it thinks is on the server, and sends a conditional request to update it whenever its own data set has been changed. The client can also use conditional GETs that make sure it receives newer versions from the server whenever they exist.</p>
<p>Essentially, the server is playing a passive role in the sense that it never initiates a data transfer. It is always the client that takes the initiative. The server always keeps only the latest version of the data, and this is the authoritative &quot;current&quot; version of the data set. It is up to each client to stay in sync with the server. The client can be said to keep a two-dimensional
<a href="http://en.wikipedia.org/wiki/Vector_clock">vector clock</a>, with one dimension being its local version, and the other one being the latest server version that this client is aware of.</p>
<p>In mesh-shaped sync, each node plays an equivalent role, and no particular node is the server or master copy. Each node will typically keep a vector clock representing which versions it thinks various other nodes are at. See
Dominic Tarr's <a href="https://github.com/dominictarr/scuttlebutt">ScuttleButt</a> for an example.</p>

<h3>Tree-based versus Journal-based sync</h3>
<p>In <a href="http://couchdb.apache.org/">CouchDB</a>, each node keeps a log (journal) of which changes the data set went through as a whole, and other nodes can subscribe to this stream. The destination node can poll the source node for new changes periodically, or the source node can pro-actively contact the destination node to report a new entry in the journal. This works particularly well for master-slave replication, where the source node is authorative, and where both nodes keep a copy of the whole data set.</p>
<p>When some parts of the data set are more important than others, it can help to use tree-based sync: give the data set a tree structure, and you can sync any subtree without worrying about other parts of the tree at that time.</p>
<p>It's also possible to simultaneously copy one part of the tree from node A to node B, while copying a different part from B to A. Tree-based sync is also more efficient when a long chain of changes has only a small effect - for instance because one value gets changed back and forth many times. Tree-based sync only compares subtrees between the two nodes, and narrows down efficiently where the two data sets currently differ, regardless of how both datasets got into that state historically.</p>

<p>The remoteStorage protocol offers <a href="http://tools.ietf.org/html/draft-dejong-remotestorage-03#page-5">folder listings</a>, which allow a client to quickly check if the ETag of any of the documents or subfolders in a certain folder tree have changed, by querying only the root folder (a GET request to a URL that ends in a slash). This principle is used even more elegantly in <a href="http://en.wikipedia.org/wiki/Merkle_tree">Merkle trees</a>, where the version hash of each subtree can deterministically be determined by any client, without relying on one authoritative server to apply tags to subtree versions.</p>

<h3>Asynchronous Synchronization and Keep/Revert events</h3>
<p>When all nodes are constantly online, it's possible to synchronize all changes in real-time. This avoids the possibility of forks and conflicts occurring. But often, the network is slow or unreliable, and it's better for a node to get on with what it's doing, even though not all changes have been pushed out or received yet. I call this <a href="https://github.com/offlinefirst/research/issues/9">asynchronous synchronization</a>, because the synchronization process is not synchronized with the local process that is interacting with the data set.</p>
<p>When remote changes happen while local changes are pending to be pushed out, conflicts may occur. When this happens in the remoteStorage protocol, the precondition of the PUT or DELETE request will fail, and the client is informed of what the ETag of the current remote version is. The client saves this in its vector clock representation, and schedules a GET for the retrieval of the remote version.</p>
<p>Since the app will already have moved on, taking its local version (with the unpushed changes) as its truth, the app code needs to be informed that a change happened remotely. The way we signal this in the 0.10 API of remotestorage.js is as an incoming change event with origin <code>'conflict'</code>.</p>
<p>The app code may treat all incoming changes the same, simply updating the view to represent the new situation. In this case, it will look to the user like they first successfully changed the data set from version 1 to version 2, and then from another device, it was changed from version 2 to version 3.</p>
<p>The app may give extra information to the user, saying &quot;Watch out! Your version 2 was overwritten, click here to revert, or here to keep the change to version 3&quot;. This is why I call these events &quot;keep/revert&quot; events, you simply keep the change to let the server version win, or revert it (with a new outgoing change, going from version 3 to version 2) to let the client version win.</p>
<p>Of course, from the server's point of view, the sequence of events is different: it went from version 1 to version 3, and then a failed attempt came from the client to change to version 2.</p>

<h3>Caching Strategies</h3>
<p>Since the remoteStorage protocol was designed to support tree-based sync, whenever a change happens in a subtree, the ETag of the root of that subtree also changes. The folder description which a client receives when doing a GET to a folder URL also conveniently contains all the ETags of subfolders and documents in the folder. That way, a client only needs to poll the root of a subtree to find out if any of potentially thousands of documents in that subtree have changed or not.</p>
<p>In remotestorage.js we support three caching strategies: FLUSH, SEEN, and ALL. FLUSH means a node is forgotten (deleted from local storage) as soon as it is in sync with the server. Only nodes with unpushed outgoing changes are stored locally.</p>
<p>In the SEEN strategy (the default), all nodes that have passed through will be cached locally, and the library will keep that copy up-to-date until the user disconnects their remote storage.</p>
<p>In the ALL strategy, remotestorage.js will pro-actively retrieve all nodes, and keep them in sync. Caching strategies can be set per subtree, and the strategy set on the smallest containing subtree of a node is the one that counts.</p>
<p>I realize this episode was pretty dense, with lots of complicated information in a short text! Sync and caching are complex problems, about which many books have been written. If you plan to write offline-first apps professionally, then it's a good idea to read and learn more about how sync works, and how conflict resolution affects your application. Next week we'll talk about other aspects of <a href="http://offlinefirst.org/">offline first</a> web apps. So stay tuned for that!</p>
<p>As always, comments are very welcome, either in person tomorrow at <a href="http://www.meetup.com/Paris-Meetup-pour-la-decentralisation-dInternet/events/193618842/">Decentralize Paris</a>, or through the <a href="https://groups.google.com/forum/#!topic/unhosted/T_-p-wGFo-g">Unhosted Web Apps</a> mailing list.</p>
</div><div class="episode">      <h2><a name="episode-29" "id="#episode-29" href="#episode-29">29.</a> Offline-first web app design</h2>

<!-- "offline first": "Offline-first web app design" -->
<p>Last week we already talked about asynchronous synchronization,
the tactic of synchronizing the client-side data set with the server-side data set independently from the timing of data-changing actions that happen on the client-side. This is a typical &quot;offline-first&quot; strategy: it makes sure the client-side app keeps working in the same way, regardless of whether the network connection is good, slow, or absent.</p>
<p><a href="http://offlinefirst.org/">Offline-first web app design</a> is basically the method of giving the client-side application its own stand-alone event cycle, independent from any server-side processing.</p>
<p>Of course, if an application's functionality requires something to happen on a remote server, this can only work when the device is online. But the way the user interacts with the application need not be interrupted if a remote action is queued for sending later, instead of being executed immediately.</p>
<p>An offline-first application doesn't treat network failure as an exception or error state. Queueing up remote actions until they can be completed is part of the normal flow of the application's event logic. If the application is online, this queue will simply empty immediately, but the fact that this queue exists means that temporary network failures do not change the code path that is taken.</p>

<h3>Anonymous Mode</h3>
<p>If the user doesn't connect a remote storage or other per-user backend to an unhosted web app, the user's data has nowhere to go. It has to stay inside the browser tab. The user's identity is also undefined in this case - the user is not authenticated against any username or domain name, it's simply the user that happens to be physically handling the device. We call this situation &quot;anonymous mode&quot;.</p>
<p>A lot of hosted web apps also use this sort of anonymous mode, allowing you to start using the application already before logging in or registering. For instance, a hotel booking website might allow you to search and browse hotels and offers, and maybe even reserve a room already for a short time, postponing the authentication step to the last moment, where you authorize the creditcard payment. This way, the barrier to browse the website's offers is as low as possible.</p>
<p>For apps where anonymous mode doesn't make sense (for instance,
<a href="https://ghost.5apps.com/">gHost</a>, which centers on publishing webcam pictures to your connected remote storage), the first view of the app (the splash screen, if you will), will not allow the user to interact anonymously; the application's functionality stays hidden until you connect a remote storage account. Other apps, like <a href="http://litewrite.net/">LiteWrite</a>, do include an anonymous mode, where you can use the app in the same way (writing and editing text documents, in this case), but simply without the sync.</p>

<h3>Connection States</h3>
<p>As part of remotestorage.js, we created a uniform &quot;widget&quot;, which all apps can include in the same way, at the top right of the page. It allows the user to switch from anonymous mode to connected mode by putting in their user address, and going through the OAuth dance.</p>
<p>Whenever a remote storage is connected, the widget also shows the sync state, flashing when sync is busy, grey when there is no connectivity, and showing an error message when an unrecoverable error has occurred.</p>
<p>When the access token has expired, or has been revoked, the widget will prompt the user to reconnect. The widget also allows the user to manually trigger a full sync cycle with one button, and to disconnect with another one.</p>
<p>When the user goes from anonymous mode to connected mode, data that exists locally is preserved. But when the user goes back from connected to anonymous, all data that exists locally is deleted. This ensures that no data stays behind on the device when a user stops using an app.</p>

<h3>Conclusion</h3>
<p>This sort of logic is often a bit different in offline-first apps than in online-first apps, and the JavaScript developer community is collectively learning how to do this, through talks at <a href="http://berlinjs.org/apps">user groups</a>, <a href="http://alistapart.com/article/offline-first">blog posts</a>, and <a href="https://github.com/offlinefirst/research/issues">discussions</a>.</p>
<p>The important thing here is probably to realize that offline-first design is an important &quot;mind switch&quot; you will have to make when starting to develop unhosted web apps, or even just mobile web apps in general. Next week we'll talk about Backend-as-a-Service, <a href="https://groups.google.com/forum#!forum/unhosted">stay tuned</a>!</p>
</div><div class="episode">      <h2><a name="episode-30" "id="#episode-30" href="#episode-30">30.</a> Backend-as-a-Service platforms</h2>

<!-- "baas": "Backend-as-a-Service platforms",//open source ones = noBackend frameworks -->
<p>Unhosted web apps have no own server-side part, by definition. The same is true for native mobile apps: although a lot of native mobile apps communicate with a server-side API of the same vendor, the native app itself is only what is downloaded from the app store onto the user's device.</p>
<p>In both cases, it can make sense for an application provider to use a <a href="http://en.wikipedia.org/wiki/Backend_as_a_service">Backend-as-a-Service</a> system, or &quot;BaaS&quot;, for short.</p>

<h3>Single-provider BaaS systems</h3>
<p>A lot of BaaS providers offer a backend system of which they host the only instance. This means that there is only one (usually commercial) party providing that system, and if at any point you're unhappy with them, you have nowhere to migrate to without switching to a different system with a different API. Examples which have not yet shut down are
<a href="http://www.kinvey.com/">Kinvey</a>,
<a href="http://apigee.com/about/products/apis/edge-api-baas">Apigee</a>,
<a href="http://backendless.com/">Backendless</a>,
<a href="http://en.kii.com/">Kii</a>,
<a href="https://www.built.io/">built.io</a>,
<a href="https://www.firebase.com/">Firebase</a>,
<a href="http://encore.io/">Encore.io</a>,
<a href="http://appeariq.com/">AppearIQ</a>,
<a href="http://www.anypresence.com/">AnyPresence</a>, <!-- <a href="http://downforeveryoneorjustme.com/www.kidozen.com">Kidozen</a>, -->
<a href="http://www.feedhenry.com/mobile-application-platform/mbaas/">FeedHenry</a>,
<a href="http://www.syncano.com/">Syncano</a>,
<a href="http://www.apstrata.com/">Apstrata</a>, <!-- <a href="http://downforeveryoneorjustme.com/manage.sencha.io">sencha.io</a> --> <!-- CloudyRec [link?] -->
<a href="http://fanignite.com/">FanIgnite</a>,
<a href="https://cloudmine.me/">CloudMine</a>,
<a href="http://iknode.com/">iKnode</a>,
<a href="http://fatfractal.com/">FatFractal</a>,
<a href="http://www.kumulos.com/">Kumulos</a>,
<a href="http://www.netmera.com/">Netmera</a>,
<a href="http://buddy.com/">Buddy</a>, 
<a href="http://www.apiomat.com/">apiOmat</a>,
<a href="http://www.applicasa.com/">Applicasa</a> (especially for in-app purchases), <!-- <a href="">ScottyApp</a> [link?], -->
<a href="http://appglu.com/">AppGlu</a> (especially for product catalogs),
<a href="http://www.flurry.com/">Flurry</a> (especially for advertising and analytics), <!-- <a href="">Stackmob</a>, R.I.P. -->
Facebook's <a href="https://parse.com/">Parse</a>,
<a href="http://www.appcelerator.com/">Appcelerator</a>
(including <a href="https://www.singly.com/">singly</a>),
Amazon's <a href="http://aws.amazon.com/mobile/">AWS Mobile Services</a>
(including <a href="http://aws.amazon.com/cognito/">Cognito</a>, analytics, storage, and push notifications),
and Apple's <a href="https://developer.apple.com/icloud/documentation/cloudkit-storage/">CloudKit</a>.</p>

<p>These platforms typically offer things like data storage, real-time sync, push notification, media streaming, map tiles, user management, analytics, payment processing, etcetera. Kinley created a <a href="http://www.kinvey.com/blog/121/the-backend-as-a-service-ecosystem-map-update-amp-new-trends-migration-toward-the-middle">map of the BaaS ecosystem</a> which lists all these many BaaS startups, including pacman symbols to show who is being acquired by whom.</p>

<p>Examples that seem to have existed previously, but no longer do, are Kidozen, Sencha.io, ScottyApp, Stackmob, yorAPI and CloudyRec. Given that Backend-as-a-Service is only about three years old, and already 6 out of 34 providers I found links to no longer seem to be live, it seems reasonable to assume the provider of your choice may also shut down at any time. It is therefore probably wiser to choose an open source BaaS system, which you can host in-house, or at any third party, should the original provider go out of business.</p>

<h3>Open-source Backend Systems</h3>
<p>An open source backend system has the big advantage that in theory it doesn't depend on the startup behind it surviving, for you to keep using it. In practice, of course, if there are not a lot of apps using a certain platform anymore, then new features may no longer be added, your pull requests may be ignored by the core developers, and there is a risk of <a href="http://en.wikipedia.org/wiki/Software_rot">bit rot</a>, but at least you always have the option to <a href="http://en.wikipedia.org/wiki/Fork_%28software_development%29">fork</a>, and your app will not stop working abruptly due to a provider bankruptcy or takeover. Examples of open source backend systems are
<a href="http://usergrid.incubator.apache.org/">usergrid_</a>,
<a href="http://www.baasbox.com/">BaasBox</a>,
<a href="https://www.dreamfactory.com/">DreamFactory</a>,
<a href="http://deployd.com/">deployd</a>,
<a href="https://www.meteor.com/">Meteor</a>,
<a href="http://sockethub.org/">sockethub</a>, and
<a href="http://hood.ie/">Hoodie</a>.</p>

<h3>Comparison to per-user backend</h3>
<p>Next week we'll look at per-user backend, a fundamentally different concept, in that your app's users, rather than (just) you as an app developer, have their own account at a provider of such a backend service. A per-user backend system is a service provided directly to the end user, instead of a business-to-business service provided to an app developer.</p>
<p>I think the concept of per-user backend is the most important concept discussed in this whole blog series. If you are just going to read or link to only one episode, make it next week's one!</p>
</div><div class="episode">      <h2><a name="episode-31" "id="#episode-31" href="#episode-31">31.</a> Allowing the user to choose the backend server</h2>

<!--  "per-user backend": "Allowing the user to choose the backend server",//prop./open source/open protocol -->

<h3>Users who own their backend</h3>
<p>The architecture of the web originally focused on allowing independent publishers to have their own web site on which they publish public content. In the web 2.0 architecture, bigger web sites started hosting user content - public as well as limited-audience and private. In the meantime, desktop and mobile operating systems did allow users to own their data storage - at least the local data storage on a hard disk or memory card.</p>

<p>What we're trying to do with unhosted web apps and per-user backends, is to change the web to a software platform on which owning your data is possible. Unhosted web apps by themselves allow you to use the local on-device data storage, but to add device-to-device sync and cloud backup, it is necessary for the user to own some place where this data can be stored: a per-user backend.</p>

<h3>Per-user storage</h3>
<p>The first and most important requirement for per-user backend is storage. If you're willing to rely on proprietary technology, there are a number of providers of per-user cloud storage available to you:
Google's <a href="https://drive.google.com/">GoogleDrive</a>,
Microsoft's <a href="https://onedrive.live.com/about/en-us/">OneDrive</a>,
Apple's <a href=""https://www.icloud.com/>iCloud</a>, and
Dropbox <a href="https://www.dropbox.com/developers/datastore">Dropbox Platform</a>, for instance.
Of these, Google and Microsoft offer cloud storage as an addition to their offering of cloud services; Microsoft and Apple offer cloud storage sign up from the operating systems that are pre-installed on Windows and iOS/OSX devices respectively, and Dropbox is the only one in this list who just offers per-user cloud storage as their main proprietary product.</p>
<p>Other smaller-scale providers of per-user cloud storage include <a href="https://www.box.com/">box.com</a>, <a href="https://www.powerfolder.com/">powerfolder</a>, <a href="http://www.sparkleshare.org/">SparkeShare</a>, <a href="http://www.mesh.com/">LiveMesh</a>, <a href="http://www.sugarsync.com/">SugarSync</a>, several <a href="https://owncloud.org/providers/">ownCloud providers</a>, and for instance the startup behind tahoe-lafs, <a href="https://leastauthority.com/product_s4/">LeastAuthority</a>.</p>
<p><a href="https://mega.co.nz/">megaSYNC</a> resells storage space from their own network of independent hosters, <a href="https://www.wuala.com/">Wuala</a> invites users to share some of their own storage space, and <a href="http://www.bittorrent.com/">BitTorrent</a> uses only storage space at connected clients.</p>
<p>In the context of unhosted web apps like <a href="https://export.5apps.com/">export.5apps.com</a>, we are mainly interested in the ones that offer a cross-origin API. That limits the choice to Google, Dropbox, and all providers of 
<a href="http://tools.ietf.org/html/draft-dejong-remotestorage-03">remoteStorage</a> (currently only <a href="https://5apps.com/storage/beta">5apps</a>).

<h3>Per-user backend protocols</h3>
<p>The only non-proprietary protocol we are aware of that allows unhosted web apps to communicate with per-user backends, is our own remoteStorage protocol. It could make sense to define more such protocols, for other functionalities than just storage, but in practice most projects publish one specific software application which users can run on their own server, and retrospectively declare the API of that software application to be an open protocol which other software applications may choose to mimick. Also, the UX flow of the end-point discovery is often left undefined.</p>
<p>Examples are
Firefox Sync (at the browser level, Firefox only),
<a href="http://couchdb.apache.org/">CouchDB</a> (if you enable CORS headers on it),
<a href="http://owncloud.org/">ownCloud</a> (CORS headers are now <a href="https://github.com/owncloud/core/issues/10415">available</a> in its middleware layer),
and <a href="http://sockethub.org/">Sockethub</a>.
Often, the user would have to paste the exact base URL of their server's API into a text field somewhere in the settings of an application, to connect one of these per-user backends.</p>
<p>For <a href="http://hood.ie/">Hoodie</a>, use as a per-user backend has always been part of the plan, and there is an <a href="https://github.com/hoodiehq/hoodie-server/pull/288">open pull request</a> for this, but it's not currently supported yet.</p>

<h3>Per-user backend other than storage</h3>
<p>Server-side functionality that you need to keep between sessions revolves mainly around addressability (in other words, hosting the user's online identity), data storage, and push notifications. Other server-side services, like message relaying, payment processing, generating map tiles, etcetera, are arguably less urgent to keep under the user's control, since their role is more transient.</p>
<p>If one day I use one tiles server, I can easily use a different one the next day. As soon as my usage session ends, my relationship with that server has ended. This means that per-user backend functionalities other than storage are actually not as important. It may still make sense to allow the user a free choice of Sockethub server, but unlike with remoteStorage accounts, not each user needs to run their own Sockethub server.</p>
<p>Sockethub, Firefox Loop, and soon Hoodie, all provide per-user backend functionality beyond just storage. Arguably,
Facebook's <a href="https://developers.facebook.com/docs/payments">Facebook Platform</a> is also a per-user backend, providing identity, storage, messaging and payment processing, albeit a proprietary one which allows for only one instance of it to exist.</p>
<p>Facebook's API (as well as the APIs of Twitter and other identity providers) are still to be considered per-user backends, even though their protocols are tied to one specific instance. The point is that end users, and not application publishers, directly have a customer relationship with these service providers.</p>

<h3>Conclusion</h3>
<p>Apart from the remoteStorage protocol, there is not a lot of standardization going on in the space of per-user online services. If per-user online services offer a cross-origin web API at all, then it's often one that is specific to one implementation (couchdb, sockethub), or even to one specific instance (GoogleDrive, Dropbox).</p>
<p>Talking about this topic over the course of the past four years, I have slowly shifted my hope away from universal standardization of per-user backends, and more towards the idea of polyglot clients. One client-side library can be compatible with more than one server-side API, thus removing the need for all these APIs to converge.</p>
<p>Next week we look at such client-side libraries. <a href="https://groups.google.com/forum#!forum/unhosted">Stay tuned</a>!</p>
</div><div class="episode">      <h2><a name="episode-32" "id="#episode-32" href="#episode-32">32.</a> Client-side libraries for per-user backend</h2>

<!-- "per-user clients": "Client-side libraries for per-user backend",//dropbox.js, nimbusbase, remotestorage.js, hoodie.js -->
<p>In order to make it easier to let your unhosted web app talk with the user's backend, you would typically use a client-side library.</p>

<h3>Single-API clients</h3>
<p>For talking to the user's Dropbox account, you can use <a href="https://github.com/dropbox/dropbox-js">Dropbox.js</a>, and there is a similar <a href="https://developers.google.com/drive/web/quickstart/quickstart-js">client-side library</a> for GoogleDrive.</p>
<p><a href="http://pouchdb.com/">PouchDB</a> acts both as an in-browser database engine, and a client for replicating data from and to a remote CouchDB instance with CORS enabled, which may be the user's own CouchDB server.
Likewise, <a href="https://github.com/sockethub/sockethub-client">sockethub-client</a> makes it easier to communicate with a Sockethub API which may be on the user's own server, and <a href="https://github.com/hoodiehq/hoodie.js">hoodie.js</a> does the same for Hoodie's API.</p>
<p>All these libraries have a one-to-one relationship with a specific backend API. For PouchDB this is not such a limiting restriction, because there are <a href="http://pouchdb.com/faq.html#what_can_pouchdb_sync_with">quite a few</a> software products that expose a CouchDB-compatible API. But as far as I know, only Sockethub itself exposes a sockethub-compatible API, and only Hoodie itself exposes a Hoodie-compatible API. That means that basing your app on them may allow the user to choose where they want their backend hosted, but in practice they do not have a free choice out of more than one backend software implementation.</p>
<p>Of course, Dropbox-js and the GoogleDrive JS library are even worse in that sense, because they only allow you to sync with per-user backend storage at one specific storage <em>provider</em>, so that's even more restrictive. That's why it is interesting to look at client-side libraries that try to be as generous as possible in the per-user backend they are compatible with.</p>

<h3>Polyglot per-user backend clients</h3>
<p>A polyglot per-user backend client allows several, rather than one specific API specification with which the user's backend server may be compatible. At this point, I'm aware of only two polyglot per-user backend clients:
<a href="http://nimbusbase.com/">NimbusBase</a> (supporting GoogleDrive and Dropbox), and 
 <a href="http://remotestorage.io/integrate/">remotestorage.js</a> (supporting remoteStorage, GoogleDrive, and Dropbox). It would be nice if in the future there are more such libraries, and if they will support more cross-origin backends. In the future we may add other backends to remotestorage.js, like for instance Hoodie, tahoe-lafs, or ownCloud.</p>

<h3>Native support</h3>
<p>At <a href="http://www.meetup.com/Paris-Meetup-pour-la-decentralisation-dInternet/events/193618842/">Decentralize Paris</a> we talked about the possibility of integrating parts of remotestorage.js into Firefox OS. If successful, and if this would also get picked up by other browser and phone platforms, this could help in making per-user storage a more integrated part of the web as a software platform, in the way it's also part of other software platforms like iOS with iCloud. But for now, it seems we have to accept the situation that per-user data is not natively supported on the web in the same integrated way as it is on for instance Apple's iOS software platform.</p>

<h3>Conclusion</h3>
<p>Unfortunately, there's not a whole lot to say yet about client-side libraries for per-user backends. Maybe this will change in the future, and maybe such libraries will become part of browsers and devices at some point. But I wanted to dedicate an entire episode to the topic nonetheless, because I think it's one of the most important future directions for the unhosted web apps movement.</p>
<p>The last three episodes have been in a way about &quot;backend functionality for unhosted web apps&quot;. Next week, we'll talk about the frontend functionality, and the week after that will be the conclusion of this blog series. <a href="https://groups.google.com/forum#!forum/unhosted">Stay tuned</a>!</p>
</div><div class="episode">      <h2><a name="episode-33" "id="#episode-33" href="#episode-33">33.</a> Client-side frontend development</h2>

<!-- "client-side frontend": "Client-side frontend development",//mvc, routing, templating, responsive, progr. enh., testing -->
<p>I personally never write a lot of frontend code. I usually write apps with very minimal user interfaces, which I manually program directly into the page. But if you want to create an unhosted web app with a significant user interaction surface, you're probably going to need some of the standard frontend development techniques.</p>

<h3>MVC</h3>
<p>To keep track of how dialogs and panes in your app interact with data, you can use the
<a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">Model-View-Controller</a> approach.
Models describe the data format for different types of items in your data set.
Views describe how items are selected for display, from collections they belong to, and connect these data formats to on-screen shapes.
Controllers describe what each button or input element in such a view does to the data.</p>
<p>You can use one of the <a href="http://todomvc.com/">many frameworks</a>, like <a href="http://backbonejs.org/">Backbone</a>, <a href="http://emberjs.com/">Ember</a> or <a href="http://angularjs.org/">Angular</a> to help you set up the MVC structure in your application's source code.</p>

<h3>Routing</h3>
<p>An unhosted web app can have many different screens and dialogs, and it's a good idea to give each such &quot;place&quot; in your application's navigation a URL. Keeping track of these URLs and how they relate to which views should be on the screen, is called routing. Most JavaScript frameworks like Ember and Angular help you to define and manage routes in your app's source code.</p>

<h3>Templating</h3>
<p>When building the html code of a view, some parts will be hardcoded, and other parts of the page content will be pulled from the data. The hardcoded parts may also be available in alternative locales and foreign languages. By creating templates, with placeholders at the points where data should be filled in, you can separate this hardcoded content from the active code of your app, which is a useful separation of concerns.</p>
<p>You can use a JavaScript framework for this, a
<a href="https://en.wikipedia.org/wiki/JavaScript_templating">templating engine</a> like for instance <a href="https://mustache.github.io/">Mustache</a> or <a href="http://handlebarsjs.com/">Handlebars</a>, or you can write a simple string-replace function yourself.</p>

<h3>Responsiveness</h3>
<p>Web pages can be viewed on many different screen sizes, which means that it's a good idea to test your app's graphical user interface (GUI)
for bigger as well as smaller screens. On many devices, the user may also switch between landscape and portrait orientation, so you may want to make your GUI react to this, and optimize which parts are on the screen and at which size.</p>
<p>Changing the layout of your app in response to screen size and orientation is known as
<a href="https://en.wikipedia.org/wiki/Responsive_web_design">responsive design</a>. Twitter's <a href="http://getbootstrap.com/">Bootstrap</a> gives a bit of guidance with this, and for instance Firefox developer tools will help you
<a href="https://developer.mozilla.org/en-US/docs/Tools/Responsive_Design_View">emulate smaller screen sizes</a> for testing it out.</p>

<h3>Progressive Enhancement</h3>
<p><a href="https://en.wikipedia.org/wiki/Progressive_enhancement">Progressive enhancement</a> is basically the same as graceful degradation, but it's often used as a term to apply specifically to browser compatibility. HTML is well suited for creating web apps in such a way that they are still usable, even if for instance JavaScript is disabled, or the page is displayed via a text-only medium instead of being shown on a graphical screen.</p>

<h3>Testing</h3>
<p>Any software project of, say, 500 lines or more, is more easily maintainable, and less likely to contain bugs, if it has tests. Thanks to server-side JavaScript engines like
<a href="http://nodejs.org/">NodeJS</a>, it's now easy to write automated tests for the data processing code of your app.</p>
<p>To test the graphical parts of your app, you probably want to use a headless browser like
<a href="http://phantomjs.org/">PhantomJS</a>, so that you can define tests that click on buttons and test
if certain DOM elements appear or change as a result of the interaction.</p>

<h3>Conclusion</h3>
<p>This is obviously just a short list of topics you will want to read more about if you start to develop unhosted web apps professionally. Consider it the &quot;what to read next?&quot; section at the end of this blog series. I am not a frontend developer myself, but from what I've heard, these topics are the most important
<a href="http://rmurphey.com/blog/2012/04/12/a-baseline-for-front-end-developers/">stuff you want to learn</a> for a successful professional carreer as an unhosted web app developer.</p>
<p>Next week will be the last episode! :) We'll look back on this whole blog series, and at what the future of unhosted web apps may hold. <a href="https://groups.google.com/forum#!forum/unhosted">Stay tuned</a>!</p>
</div><div class="episode">      <h2><a name="episode-34" "id="#episode-34" href="#episode-34">34.</a> Conclusions</h2>

<!-- "conclusions": "Conclusions"//the web for apps, minimal per-user servers, the road ahead (towards DHT-based?), thanks again, everyone! -->
<h3>The Web for Apps</h3>
<p>The web was originally a platform for hypertext documents. Then it became a user interface platform, where the browser can be used to interact with software that runs on a server somewhere. Now, it's in itself a software platform, which can run apps on the client side. This called for a lot of new technology.</p>
<p>A lot of the technology that needed to be added was pushed by Google and html5. A lot of the missing parts were then added by the Firefox OS project, which makes sure everything a modern hardware device offers up to the software stack, is also made available to web apps through the Web API.</p>
<p>In four years of the Unhosted project and movement, we studied a lot of issues related to unhosted web apps, and came up with a lot of ideas. I tried to summarize the conclusions of this research in this blog series.</p>

<h3>Minimal per-user servers</h3>
<p>One central conclusion is that unhosted web apps need per-user servers. The more minimal such servers are, the more generic they are. We theerefore made the remoteStorage protocol as basic as possible.</p>
<p>However, aiming just for universal standardization of per-user servers does not look feasible. Instead, it's probably better to create polyglot clients, that abstract differences between incompatible server APIs into one client-side API.</p>
<p>Such client-side libraries, that provide access to per-user servers, including discovery, auth, and client-side caching, could maybe one day also be made part of the browser, below the Web API.</p>
<p>Apart from plain data storage, other more transient services like messaging could also be organized per-user, but the most pressing features of a per-user server would still be storage and addressability (identity), because they, by their nature, have to span multiple sessions and stay in place also when none of the user's devices are online.</p>

<h3>The road ahead</h3>
<p>Looking at things that are brewing in the <a href="http://redecentralize.org/">redecentralize</a> movement, the road ahead will probably steer in the direction of more end-to-end encryption, peer-to-peer communication, and distributed hash tables. However, for now these three topics are still not really off-the-shelf technology, especially when it comes to addressability and password recovery.</p>
<p>This is why the &quot;per-user servers&quot; architecture will probably still be important for at least another 10 years. After that, maybe we will have a real working peer-to-peer web, who knows!</p>
<p>Since per-user servers are currently important, I will from now on dedicate myself predominantly to the <a href="https://indiehosters.net/">IndieHosters</a> project: a guild of system administrators who will run your own server for you, based on all the open source personal server and <a href="http://indiewebcamp.com/">IndieWeb</a> applications available.</p>
<p>I will, however, also still maintain the remoteStorage protocol, stay part of the remotestorage.js core team, as well as continuing to develop the <a href="http://tosdr.org/">Terms of Service; Didn't Read</a> crowd-reading site.</p>

<h3>Thanks for an amazing four years!</h3>
<p>Although the future of unhosted web apps <strong>has only just begun</strong>, this first research phase of four years is now completed. As a product of all the work we've done together, I have packaged this blog as an <a href="https://unhosted.org/book/">html book</a>, and <a href="http://remotestorage.io/">the remoteStorage project</a> as well as <a href="http://sockethub.org/">the Sockethub project</a> will continue to evolve, as open source projects. We've come this far since the initial crowd-funding campaign (thanks again to <a href="https://unhosted.org/thankyou.html">all the donators</a>!), and the continued support from <a href="http://nlnet.nl/">NLnet</a> and <a href="http://wauland.de/">Wau Holland Stiftung</a>. I will present these conclusions tonight at <a href="http://lanyrd.com/2014/decentralizejs/">Decentralize.js</a>. As always, also for this last episode, <a href="https://groups.google.com/forum#!forum/unhosted">comments welcome</a>!</p>
</div>    </article>	
  </body>
</html>
